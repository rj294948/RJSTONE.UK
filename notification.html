<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Notifications | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ============================================
   SAME THEME AS CART.HTML
   ============================================ */
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 20px rgba(0,0,0,0.12);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
    scroll-behavior: smooth;
}

/* ============================================
   HEADER - HOME PAGE STYLE WITH ENHANCED SCROLL
   ============================================ */
header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(10px);
    padding: 8px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 1000;
    gap: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    height: 60px;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateY(0);
}

header.hidden {
    transform: translateY(-100%);
}

.logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    min-width: 120px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 18px;
}

.logo span {
    font-size: 16px;
    font-weight: 700;
    color: var(--white);
    font-family: 'Roboto Slab', serif;
}

/* Back Button */
.back-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
    color: var(--white);
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: var(--transition);
    white-space: nowrap;
    min-width: 70px;
    text-decoration: none;
}

.back-btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}

.action-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 14px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
    transform: scale(1.05);
}

.cart-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: var(--white);
    font-size: 9px;
    font-weight: 600;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ============================================
   MAIN CONTENT - HOME PAGE STYLE
   ============================================ */
.main-content {
    padding: 80px 15px 20px;
    max-width: 1200px;
    margin: 0 auto;
}

/* Page Header - Home Page Style */
.page-header {
    margin-bottom: 25px;
    text-align: center;
    background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.6));
    padding: 20px 15px !important;
    margin: 0 !important;
    min-height: 90px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    position: relative;
    overflow: hidden;
    border-radius: var(--border-radius);
    margin-bottom: 20px !important;
}

.page-header h1 {
    font-size: 18px !important;
    font-weight: 600 !important;
    margin-bottom: 5px !important;
    color: var(--white);
    font-family: 'Roboto Slab', serif;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.page-header p {
    font-size: 12px !important;
    color: rgba(255, 255, 255, 0.9);
    max-width: 700px;
    margin: 0 auto;
    line-height: 1.4;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    font-weight: 400;
    opacity: 0.9;
}

/* ============================================
   NOTIFICATION FILTER - NEW DESIGN
   ============================================ */
.notification-filter {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    border: 1px solid #f0f0f0;
}

.filter-btn {
    padding: 8px 15px;
    border-radius: 20px;
    border: 2px solid #e0e0e0;
    background: var(--white);
    color: var(--text-dark);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.filter-btn:hover {
    border-color: var(--primary-gold);
    color: var(--primary-gold);
}

.filter-btn.active {
    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
    color: var(--white);
    border-color: var(--primary-gold);
}

.filter-btn i {
    font-size: 12px;
}

/* ============================================
   NOTIFICATIONS LIST - NEW DESIGN
   ============================================ */
.notifications-container {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    border: 1px solid #f0f0f0;
}

.notification-item {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
}

.notification-item:hover {
    background: var(--bg-light);
}

.notification-item.unread {
    background: rgba(201, 162, 39, 0.05);
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.notification-title {
    font-weight: 600;
    font-size: 14px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Roboto Slab', serif;
}

.notification-type {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.notification-type.payment-pending {
    background: rgba(255, 107, 107, 0.1);
    color: #ff6b6b;
    border: 1px solid rgba(255, 107, 107, 0.2);
}

.notification-type.payment-advance {
    background: rgba(255, 146, 43, 0.1);
    color: #ff922b;
    border: 1px solid rgba(255, 146, 43, 0.2);
}

.notification-type.payment-full {
    background: rgba(81, 207, 102, 0.1);
    color: #51cf66;
    border: 1px solid rgba(81, 207, 102, 0.2);
}

.notification-type.processing {
    background: rgba(51, 154, 240, 0.1);
    color: #339af0;
    border: 1px solid rgba(51, 154, 240, 0.2);
}

.notification-type.ready-to-ship {
    background: rgba(255, 146, 43, 0.1);
    color: #ff922b;
    border: 1px solid rgba(255, 146, 43, 0.2);
}

.notification-type.shipped {
    background: rgba(116, 143, 252, 0.1);
    color: #748ffc;
    border: 1px solid rgba(116, 143, 252, 0.2);
}

.notification-type.out-for-delivery {
    background: rgba(204, 93, 232, 0.1);
    color: #cc5de8;
    border: 1px solid rgba(204, 93, 232, 0.2);
}

.notification-type.delivered {
    background: rgba(64, 192, 87, 0.1);
    color: #40c057;
    border: 1px solid rgba(64, 192, 87, 0.2);
}

.notification-type.cancelled {
    background: rgba(250, 82, 82, 0.1);
    color: #fa5252;
    border: 1px solid rgba(250, 82, 82, 0.2);
}

.notification-type.returned {
    background: rgba(134, 142, 150, 0.1);
    color: #868e96;
    border: 1px solid rgba(134, 142, 150, 0.2);
}

.notification-type.order {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.notification-type.shipping {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    border: 1px solid rgba(59, 130, 246, 0.2);
}

.notification-type.system {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.notification-time {
    font-size: 11px;
    color: var(--text-light);
    white-space: nowrap;
}

.notification-message {
    color: var(--text-dark);
    margin-bottom: 15px;
    line-height: 1.5;
    font-size: 13px;
}

/* ============================================
   NOTIFICATION HIGHLIGHT - NEW DESIGN
   ============================================ */
.notification-highlight {
    background: rgba(255, 107, 107, 0.05);
    border-left: 4px solid #ff6b6b;
    padding: 12px 15px;
    margin: 10px 0;
    border-radius: 0 6px 6px 0;
    font-size: 12px;
}

.notification-highlight .highlight-title {
    font-weight: 600;
    color: #ff6b6b;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.notification-highlight .highlight-amount {
    font-size: 16px;
    font-weight: 700;
    color: #ff6b6b;
    margin: 8px 0;
}

.notification-highlight .highlight-deadline {
    font-size: 11px;
    color: var(--text-light);
    font-style: italic;
}

/* ============================================
   PRODUCT IMAGE IN NOTIFICATION
   ============================================ */
.notification-product {
    display: flex;
    gap: 12px;
    margin: 15px 0;
    padding: 15px;
    background: var(--bg-light);
    border-radius: 8px;
    border: 1px solid #f0f0f0;
}

.product-image {
    width: 70px;
    height: 70px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-details {
    flex: 1;
}

.product-name {
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--stone-dark);
    font-size: 13px;
}

.product-meta {
    font-size: 11px;
    color: var(--text-light);
    margin-bottom: 8px;
}

.product-price {
    font-weight: 600;
    color: var(--primary-gold);
    font-size: 13px;
}

/* ============================================
   NOTIFICATION ACTIONS - NEW DESIGN
   ============================================ */
.notification-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.action-btn-small {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 5px;
    border: 1px solid #e0e0e0;
    background: var(--white);
}

.action-btn-small:hover {
    background: var(--bg-light);
}

.action-btn-small.primary {
    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
    color: var(--white);
    border-color: var(--primary-gold);
}

.action-btn-small.primary:hover {
    opacity: 0.9;
}

.action-btn-small.success {
    background: #51cf66;
    color: var(--white);
    border-color: #51cf66;
}

.action-btn-small.success:hover {
    background: #40c057;
}

.action-btn-small.danger {
    background: #ff6b6b;
    color: var(--white);
    border-color: #ff6b6b;
}

.action-btn-small.danger:hover {
    background: #fa5252;
}

.action-btn-small.info {
    background: #339af0;
    color: var(--white);
    border-color: #339af0;
}

.action-btn-small.info:hover {
    background: #228be6;
}

/* ============================================
   PAY NOW BUTTON SPECIAL
   ============================================ */
.pay-now-btn {
    background: linear-gradient(135deg, #ff6b6b, #ff4757);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    width: 100%;
    justify-content: center;
    margin-top: 10px;
}

.pay-now-btn:hover {
    background: linear-gradient(135deg, #ff4757, #ff3838);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
}

.pay-now-btn:active {
    transform: translateY(0);
}

/* ============================================
   EMPTY STATE - NEW DESIGN
   ============================================ */
.empty-state {
    text-align: center;
    padding: 40px 20px;
}

.empty-state i {
    font-size: 36px;
    color: #e0e0e0;
    margin-bottom: 15px;
}

.empty-state h3 {
    color: var(--text-light);
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 16px;
}

.empty-state p {
    color: var(--text-light);
    margin-bottom: 20px;
    font-size: 13px;
    max-width: 250px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.5;
}

/* ============================================
   SIGN IN REQUIRED MESSAGE
   ============================================ */
.signin-required {
    text-align: center;
    padding: 60px 20px;
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    margin-top: 20px;
}

.signin-required-icon {
    font-size: 60px;
    color: var(--primary-gold);
    margin-bottom: 20px;
}

.signin-required h2 {
    font-size: 22px;
    color: var(--stone-dark);
    margin-bottom: 10px;
    font-family: 'Roboto Slab', serif;
}

.signin-required p {
    color: var(--text-light);
    margin-bottom: 25px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.6;
    font-size: 14px;
}

.signin-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
    color: white;
    padding: 12px 30px;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 600;
    font-size: 14px;
    transition: var(--transition);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.signin-btn:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

/* ============================================
   LOADING & NOTIFICATIONS
   ============================================ */
.loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border: 3px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-gold);
    animation: spin 1s ease-in-out infinite;
    z-index: 9999;
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

.toast {
    position: fixed;
    top: 15px;
    right: 15px;
    background: var(--primary-gold);
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    box-shadow: var(--shadow-md);
    z-index: 9999;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    max-width: 250px;
    display: none;
    font-size: 13px;
}

.toast.show {
    transform: translateX(0);
    display: block;
}

.error-message {
    position: fixed;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: #ff4757;
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    box-shadow: var(--shadow-md);
    z-index: 9999;
    display: none;
    max-width: 250px;
    text-align: center;
    font-size: 13px;
}

/* ============================================
   BOTTOM NAVIGATION - ENHANCED SCROLL BEHAVIOR
   ============================================ */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(15px);
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 999;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    height: 65px;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateY(0);
}

.bottom-nav.hidden {
    transform: translateY(100%);
}

.nav-btn {
    text-align: center;
    font-size: 10px;
    color: rgba(255, 255, 255, 0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    transition: var(--transition);
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 8px;
    min-width: 55px;
    text-decoration: none;
    height: 45px;
    justify-content: center;
    position: relative;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(255, 255, 255, 0.1);
}

.nav-btn.active {
    color: var(--primary-gold);
    background: rgba(255, 255, 255, 0.05);
}

.nav-btn i {
    font-size: 16px;
}

.nav-badge {
    position: absolute;
    top: 2px;
    right: 5px;
    background: #ff4757;
    color: var(--white);
    font-size: 8px;
    font-weight: 600;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ============================================
   HEADER ACTIONS - NEW DESIGN
   ============================================ */
.header-actions-container {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.header-action-btn {
    padding: 8px 15px;
    border-radius: 20px;
    border: 2px solid #e0e0e0;
    background: var(--white);
    color: var(--text-dark);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.header-action-btn:hover {
    border-color: var(--primary-gold);
    color: var(--primary-gold);
}

.header-action-btn.primary {
    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
    color: var(--white);
    border-color: var(--primary-gold);
}

/* ============================================
   RESPONSIVE DESIGN
   ============================================ */
@media (min-width: 768px) {
    header {
        padding: 10px 20px;
        height: 65px;
    }
    
    .logo {
        min-width: 140px;
    }
    
    .logo i {
        font-size: 20px;
    }
    
    .logo span {
        font-size: 18px;
    }
    
    .back-btn {
        padding: 9px 16px;
        font-size: 13px;
    }
    
    .action-btn {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
    
    .main-content {
        padding: 85px 20px 20px;
    }
    
    .page-header {
        min-height: 100px;
        padding: 25px 20px !important;
    }
    
    .page-header h1 {
        font-size: 20px !important;
    }
    
    .page-header p {
        font-size: 13px !important;
    }
    
    .notification-filter {
        padding: 20px;
        gap: 10px;
    }
    
    .filter-btn {
        padding: 10px 20px;
        font-size: 13px;
    }
    
    .notification-item {
        padding: 20px;
    }
    
    .notification-title {
        font-size: 15px;
    }
    
    .notification-message {
        font-size: 14px;
    }
    
    .pay-now-btn {
        padding: 10px 20px;
        font-size: 13px;
    }
    
    .product-image {
        width: 80px;
        height: 80px;
    }
    
    .signin-required {
        padding: 80px 40px;
    }
    
    .signin-required-icon {
        font-size: 80px;
    }
    
    .signin-required h2 {
        font-size: 26px;
    }
    
    .signin-required p {
        font-size: 16px;
        max-width: 500px;
    }
    
    .signin-btn {
        padding: 14px 35px;
        font-size: 15px;
    }
    
    .bottom-nav {
        height: 70px;
        padding: 12px 0;
    }
    
    .nav-btn {
        min-width: 65px;
        font-size: 11px;
    }
    
    .nav-btn i {
        font-size: 18px;
    }
}

@media (max-width: 480px) {
    header {
        padding: 6px 10px;
        height: 55px;
        gap: 5px;
    }
    
    .logo {
        min-width: 100px;
    }
    
    .logo i {
        font-size: 16px;
    }
    
    .logo span {
        font-size: 14px;
    }
    
    .back-btn {
        padding: 6px 10px;
        font-size: 11px;
        min-width: 60px;
    }
    
    .action-btn {
        width: 32px;
        height: 32px;
        font-size: 13px;
    }
    
    .main-content {
        padding: 65px 12px 15px;
    }
    
    .page-header {
        min-height: 80px;
        padding: 15px 12px !important;
        margin-bottom: 15px !important;
    }
    
    .page-header h1 {
        font-size: 16px !important;
    }
    
    .page-header p {
        font-size: 11px !important;
    }
    
    .notification-filter {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-btn {
        width: 100%;
        justify-content: center;
    }
    
    .notification-header {
        flex-direction: column;
        gap: 8px;
    }
    
    .notification-time {
        align-self: flex-start;
    }
    
    .notification-product {
        flex-direction: column;
    }
    
    .product-image {
        width: 100%;
        height: 120px;
    }
    
    .notification-actions {
        flex-direction: column;
    }
    
    .action-btn-small, .pay-now-btn {
        width: 100%;
        justify-content: center;
    }
    
    .signin-required {
        padding: 40px 20px;
    }
    
    .signin-required-icon {
        font-size: 50px;
    }
    
    .signin-required h2 {
        font-size: 18px;
    }
    
    .signin-required p {
        font-size: 13px;
        max-width: 300px;
    }
    
    .signin-btn {
        padding: 10px 20px;
        font-size: 13px;
    }
    
    .bottom-nav {
        height: 60px;
        padding: 8px 0;
    }
    
    .nav-btn {
        min-width: 50px;
        font-size: 9px;
        padding: 4px 6px;
    }
    
    .nav-btn i {
        font-size: 14px;
    }
}
</style>
</head>

<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Toast Message -->
<div class="toast" id="toast"></div>

<!-- Error Message -->
<div class="error-message" id="errorMessage"></div>

<!-- Header -->
<header id="mainHeader">
    <a href="index.html" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
    </a>
    
    <div class="logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
    </div>
    
    <div style="display: flex; gap: 8px; align-items: center;">
        <a href="account.html" class="action-btn" title="Account">
            <i class="fas fa-user"></i>
        </a>
        <a href="cart.html" class="action-btn" style="position: relative;">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
        </a>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="page-header">
        <h1><i class="fas fa-bell"></i> Notifications</h1>
        <p>Stay updated with your orders and activities</p>
    </div>
    
    <!-- Content will be loaded dynamically -->
    <div id="mainContentContainer">
        <!-- Content will be loaded here -->
    </div>
</main>

<!-- Bottom Navigation -->
<div class="bottom-nav" id="bottomNav">
    <a href="index.html" class="nav-btn">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="products.html" class="nav-btn">
        <i class="fas fa-th-large"></i>
        <span>Products</span>
    </a>
    <a href="account.html" class="nav-btn">
        <i class="fas fa-user"></i>
        <span>Account</span>
    </a>
    <a href="orders.html" class="nav-btn">
        <i class="fas fa-box"></i>
        <span>Orders</span>
    </a>
    <a href="notification.html" class="nav-btn active">
        <i class="fas fa-bell"></i>
        <span>Alerts</span>
        <span class="nav-badge" id="bottomNavBadge" style="display: none;">0</span>
    </a>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  query, 
  orderBy, 
  onSnapshot,
  updateDoc,
  doc,
  deleteDoc,
  where,
  getDocs,
  getDoc
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5",
  measurementId: "G-6YM1FLYN48"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ============================================
// AUTHENTICATION SYSTEM - NO AUTO SIGN-IN
// ============================================

let currentUserId = null;
let currentUserName = null;
let currentUserEmail = null;
let isUserLoggedIn = false;

async function checkUserAuthentication() {
  return new Promise((resolve) => {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // ‚úÖ User is signed in with Firebase
        currentUserId = user.uid;
        currentUserName = user.displayName || 'User';
        currentUserEmail = user.email;
        isUserLoggedIn = true;
        
        console.log("‚úÖ Firebase user authenticated:", currentUserId);
        
        // Save user info
        localStorage.setItem('irya_stone_auth_user', JSON.stringify({
          uid: user.uid,
          name: user.displayName,
          email: user.email,
          photoURL: user.photoURL,
          isFirebaseUser: true
        }));
        
        resolve({ isLoggedIn: true, userId: currentUserId });
        
      } else {
        // üî¥ User is not signed in - NO AUTO GUEST CREATION
        console.log("üî¥ User not signed in - notifications disabled");
        isUserLoggedIn = false;
        
        // Clear any previous auth data
        localStorage.removeItem('irya_stone_auth_user');
        
        // Show sign in required message
        showSignInRequired();
        
        resolve({ isLoggedIn: false, userId: null });
      }
    });
  });
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
  try {
    console.log("üì± Notifications page loaded");
    
    // Check if user is authenticated
    const authStatus = await checkUserAuthentication();
    
    if (authStatus.isLoggedIn) {
      // Load notifications for authenticated user
      await loadNotifications();
    }
    
  } catch (error) {
    console.error("‚ùå Error initializing:", error);
    showError("Failed to initialize. Please refresh the page.");
  }
});

// ============================================
// SIGN IN REQUIRED MESSAGE
// ============================================

function showSignInRequired() {
  const container = document.getElementById("mainContentContainer");
  
  container.innerHTML = `
    <div class="signin-required">
      <div class="signin-required-icon">
        <i class="fas fa-user-lock"></i>
      </div>
      <h2>Sign In Required</h2>
      <p>Please sign in to view your notifications. Notifications are only available for registered users.</p>
      <a href="sign.html" class="signin-btn">
        <i class="fas fa-sign-in-alt"></i>
        Sign In / Register
      </a>
      <p style="margin-top: 20px; font-size: 12px; color: var(--text-light);">
        Don't have an account? <a href="sign.html" style="color: var(--primary-gold); text-decoration: none;">Create one now</a>
      </p>
    </div>
  `;
  
  // Hide filter and actions for non-logged in users
  const pageHeader = document.querySelector('.page-header p');
  if (pageHeader) {
    pageHeader.textContent = "Sign in to view your notifications";
  }
}

// ============================================
// GLOBAL VARIABLES
// ============================================

let notifications = [];
let currentFilter = 'all';
let notificationsUnsubscribe = null;

// ============================================
// NOTIFICATIONS MANAGEMENT
// ============================================

async function loadNotifications() {
  try {
    if (!isUserLoggedIn || !currentUserId) {
      showSignInRequired();
      return;
    }
    
    console.log("üì± Loading notifications for user:", currentUserId);
    
    // Show notification UI for logged in users
    showNotificationUI();
    
    // Setup notifications listener
    setupNotificationsListener();
    
    // Update cart badge
    updateCartBadge();
    
  } catch (error) {
    console.error("‚ùå Error loading notifications:", error);
    showEmptyState("Failed to load notifications. Please try again.");
  }
}

function showNotificationUI() {
  const container = document.getElementById("mainContentContainer");
  
  container.innerHTML = `
    <!-- Notification Filter -->
    <div class="notification-filter">
      <button class="filter-btn active" onclick="filterNotifications('all')">
        <i class="fas fa-bell"></i> All
      </button>
      <button class="filter-btn" onclick="filterNotifications('unread')">
        <i class="fas fa-envelope"></i> Unread
      </button>
      <button class="filter-btn" onclick="filterNotifications('payment')">
        <i class="fas fa-money-bill-wave"></i> Payments
      </button>
      <button class="filter-btn" onclick="filterNotifications('shipping')">
        <i class="fas fa-truck"></i> Shipping
      </button>
      <button class="filter-btn" onclick="filterNotifications('order')">
        <i class="fas fa-box"></i> Orders
      </button>
    </div>
    
    <!-- Header Actions -->
    <div style="margin-bottom: 15px; display: flex; gap: 8px;">
      <button class="header-action-btn" onclick="markAllAsRead()">
        <i class="fas fa-check-double"></i> Mark all read
      </button>
      <button class="header-action-btn" onclick="clearAllNotifications()">
        <i class="fas fa-trash"></i> Clear all
      </button>
    </div>
    
    <!-- Notifications Container -->
    <div class="notifications-container" id="notificationsList">
      <div style="padding: 40px; text-align: center; color: var(--text-light);">
        <div class="loading-spinner" style="position: relative; transform: none; margin: 0 auto 15px;"></div>
        <p>Loading notifications...</p>
      </div>
    </div>
  `;
}

async function setupNotificationsListener() {
  const notificationsList = document.getElementById("notificationsList");
  
  if (notificationsUnsubscribe) notificationsUnsubscribe();
  
  notificationsList.innerHTML = `
    <div style="padding: 40px; text-align: center; color: var(--text-light);">
      <div class="loading-spinner" style="position: relative; transform: none; margin: 0 auto 15px;"></div>
      <p>Loading notifications...</p>
    </div>
  `;
  
  try {
    const notificationsRef = collection(db, "users", currentUserId, "notifications");
    const notificationsQuery = query(notificationsRef, orderBy("createdAt", "desc"));
    
    notificationsUnsubscribe = onSnapshot(notificationsQuery,
      async (snapshot) => {
        notifications = [];
        
        if (snapshot.empty) {
          showEmptyState("No notifications yet");
          updateBadges(0);
          return;
        }
        
        const notificationPromises = [];
        
        for (const docSnapshot of snapshot.docs) {
          const notification = docSnapshot.data();
          notification.id = docSnapshot.id;
          
          // Determine notification type based on content
          if (!notification.type) {
            notification.type = determineNotificationType(notification);
          }
          
          // Extract payment information from message
          const extractedInfo = extractPaymentInfoFromMessage(notification.message || '');
          if (extractedInfo.amount > 0) {
            notification.remainingAmount = extractedInfo.amount;
            notification.deadline = extractedInfo.deadline;
          }
          
          // Set notification status based on content
          if (!notification.status) {
            notification.status = determineNotificationStatus(notification);
          }
          
          // Fetch product images if productId is available
          if (notification.productId || notification.orderId) {
            notificationPromises.push(fetchProductImage(notification));
          }
          
          notifications.push(notification);
        }
        
        if (notificationPromises.length > 0) {
          await Promise.all(notificationPromises);
        }
        
        console.log(`‚úÖ Loaded ${notifications.length} notifications for user: ${currentUserId}`);
        displayNotifications(notifications);
        
        const unreadCount = notifications.filter(n => !n.read).length;
        updateBadges(unreadCount);
        
      },
      (error) => {
        console.error("‚ùå Error in notifications listener:", error);
        notificationsList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Connection Error</h3>
            <p>Please check your internet connection</p>
            <button class="filter-btn active" onclick="loadNotifications()" style="margin-top: 20px;">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
      }
    );
    
  } catch (error) {
    console.error("‚ùå Setup error:", error);
    showEmptyState("Failed to setup notifications. Please refresh.");
  }
}

function determineNotificationType(notification) {
  const title = notification.title || '';
  const message = notification.message || '';
  const orderStatus = notification.orderStatus || '';
  const paymentStatus = notification.paymentStatus || '';
  
  // Check for payment pending notifications
  if (message.includes('remaining payment') || 
      message.includes('clear the remaining payment') ||
      message.includes('within 1 hour') ||
      message.includes('remaining balance') ||
      message.includes('IMPORTANT: Please clear')) {
    return 'payment_pending';
  }
  
  // Check for other payment status
  if (paymentStatus === 'advance_paid') {
    return 'payment_advance';
  }
  
  if (paymentStatus === 'fully_paid') {
    return 'payment_full';
  }
  
  // Check for order status
  if (orderStatus === 'shipped' || 
      title.toLowerCase().includes('shipped') ||
      message.toLowerCase().includes('has been shipped')) {
    return 'shipped';
  }
  
  if (orderStatus === 'delivered' || 
      title.toLowerCase().includes('delivered')) {
    return 'delivered';
  }
  
  if (orderStatus === 'out_for_delivery' || 
      title.toLowerCase().includes('out for delivery')) {
    return 'out_for_delivery';
  }
  
  if (orderStatus === 'processing' || 
      title.toLowerCase().includes('processing')) {
    return 'processing';
  }
  
  if (orderStatus === 'cancelled' || 
      title.toLowerCase().includes('cancelled')) {
    return 'cancelled';
  }
  
  if (orderStatus === 'ready_to_ship' || 
      title.toLowerCase().includes('ready to ship')) {
    return 'ready_to_ship';
  }
  
  // Generic categories based on content
  if (title.toLowerCase().includes('order') || 
      message.toLowerCase().includes('order')) {
    return 'order';
  }
  
  if (title.toLowerCase().includes('shipping') || 
      message.toLowerCase().includes('shipping') ||
      message.toLowerCase().includes('tracking')) {
    return 'shipping';
  }
  
  return 'system';
}

function extractPaymentInfoFromMessage(message) {
  const result = {
    amount: 0,
    deadline: null
  };
  
  if (!message) return result;
  
  // Extract amount (e.g., ¬£59.50)
  const amountMatch = message.match(/¬£([\d\.]+)/);
  if (amountMatch && amountMatch[1]) {
    result.amount = parseFloat(amountMatch[1]);
  }
  
  // Extract deadline (e.g., within 1 hour)
  if (message.includes('within 1 hour')) {
    result.deadline = '1 hour';
  } else if (message.includes('within 24 hours')) {
    result.deadline = '24 hours';
  } else if (message.includes('within 48 hours')) {
    result.deadline = '48 hours';
  }
  
  return result;
}

function determineNotificationStatus(notification) {
  const type = notification.type || '';
  
  const statusMap = {
    'payment_pending': 'Payment Pending',
    'payment_advance': 'Advance Payment',
    'payment_full': 'Payment Completed',
    'processing': 'Order Processing',
    'ready_to_ship': 'Ready to Ship',
    'shipped': 'Shipped',
    'out_for_delivery': 'Out for Delivery',
    'delivered': 'Delivered',
    'cancelled': 'Cancelled',
    'order': 'Order Update',
    'shipping': 'Shipping Update',
    'system': 'System Update'
  };
  
  return statusMap[type] || 'Notification';
}

// Fetch product image from Firestore
async function fetchProductImage(notification) {
  try {
    let productId = notification.productId;
    
    if (!productId && notification.orderId) {
      try {
        // Try to get order from users collection
        const userOrderRef = doc(db, "users", currentUserId, "orders", notification.orderId);
        const orderDoc = await getDoc(userOrderRef);
        
        if (orderDoc.exists()) {
          const orderData = orderDoc.data();
          if (orderData.items && orderData.items.length > 0) {
            productId = orderData.items[0].productId || orderData.items[0].id;
            notification.productName = orderData.items[0].name;
            notification.productPrice = orderData.items[0].price || orderData.items[0].totalPrice;
          }
        }
      } catch (error) {
        console.log("Order details not found in users collection");
      }
    }
    
    if (!productId) return;
    
    // Try products collection first
    try {
      const productDoc = await getDoc(doc(db, "products", productId));
      
      if (productDoc.exists()) {
        const productData = productDoc.data();
        
        if (productData.images && Array.isArray(productData.images) && productData.images.length > 0) {
          if (typeof productData.images[0] === 'string') {
            notification.productImage = productData.images[0];
          } else if (productData.images[0].url) {
            notification.productImage = productData.images[0].url;
          } else if (productData.images[0].imageUrl) {
            notification.productImage = productData.images[0].imageUrl;
          }
        } else if (productData.imageUrl) {
          notification.productImage = productData.imageUrl;
        } else if (productData.image) {
          notification.productImage = productData.image;
        }
        
        notification.productName = notification.productName || productData.name || productData.title || "Stone Product";
        notification.productCategory = productData.category || "Stone";
        notification.productPrice = notification.productPrice || productData.price || productData.startingPrice || 0;
        
        return;
      }
    } catch (productError) {
      console.log("Products collection ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ");
    }
    
    // Try stone collection
    try {
      const stoneDoc = await getDoc(doc(db, "stone", productId));
      if (stoneDoc.exists()) {
        const stoneData = stoneDoc.data();
        notification.productImage = stoneData.imageUrl || stoneData.image || stoneData.imgUrl;
        notification.productName = notification.productName || stoneData.stoneName || stoneData.name || "Stone Product";
        notification.productCategory = stoneData.category || "Stone";
        notification.productPrice = notification.productPrice || stoneData.price || stoneData.startingPrice || 0;
        
        return;
      }
    } catch (stoneError) {
      console.log("Stone collection ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ");
    }
    
  } catch (error) {
    console.warn("‚ö†Ô∏è Product image fetch error:", error);
  }
  
  // Set default image if none found
  if (!notification.productImage) {
    notification.productImage = getDefaultImage(notification.productCategory);
  }
}

function getDefaultImage(category) {
  const categoryLower = (category || '').toLowerCase();
  
  if (categoryLower.includes('sand')) {
    return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('kota')) {
    return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('granite')) {
    return 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('marble')) {
    return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800&q=80';
  }
  
  return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800&q=80';
}

function displayNotifications(notificationsList) {
  const notificationsListDiv = document.getElementById("notificationsList");
  
  if (!notificationsList || notificationsList.length === 0) {
    showEmptyState("No notifications yet");
    return;
  }
  
  // Apply filter
  let filteredNotifications = notificationsList;
  
  switch(currentFilter) {
    case 'unread':
      filteredNotifications = notificationsList.filter(n => !n.read);
      break;
    case 'payment':
      filteredNotifications = notificationsList.filter(n => 
        n.type === 'payment_pending' || 
        n.type === 'payment_advance' ||
        n.type === 'payment_full' ||
        (n.title && n.title.toLowerCase().includes('payment')) ||
        (n.message && (n.message.toLowerCase().includes('payment') || 
                       n.message.toLowerCase().includes('¬£') ||
                       n.message.toLowerCase().includes('amount')))
      );
      break;
    case 'shipping':
      filteredNotifications = notificationsList.filter(n => 
        n.type === 'shipped' || 
        n.type === 'out_for_delivery' ||
        n.type === 'delivered' ||
        n.type === 'ready_to_ship' ||
        (n.title && (n.title.toLowerCase().includes('shipped') || 
                     n.title.toLowerCase().includes('delivered') ||
                     n.title.toLowerCase().includes('tracking') ||
                     n.title.toLowerCase().includes('shipping')))
      );
      break;
    case 'order':
      filteredNotifications = notificationsList.filter(n => 
        n.type === 'order' ||
        n.type === 'processing' ||
        n.type === 'cancelled' ||
        (n.title && n.title.toLowerCase().includes('order')) ||
        (n.message && n.message.toLowerCase().includes('order'))
      );
      break;
    case 'all':
    default:
      filteredNotifications = notificationsList;
  }
  
  if (filteredNotifications.length === 0) {
    notificationsListDiv.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-bell-slash"></i>
        <h3>No ${currentFilter === 'all' ? '' : currentFilter} notifications</h3>
        <p>${getEmptyMessageForFilter(currentFilter)}</p>
      </div>
    `;
    return;
  }
  
  let notificationsHTML = '';
  
  filteredNotifications.forEach((notification) => {
    const timeAgo = getTimeAgo(notification.createdAt);
    const isUnread = !notification.read;
    const notificationType = notification.type || 'system';
    const typeClass = `notification-type ${notificationType.replace(/_/g, '-')}`;
    const typeText = getTypeText(notificationType);
    
    // Extract order info
    const orderInfo = extractOrderInfo(notification);
    
    // Check if it's a payment pending notification
    const isPaymentPending = notificationType === 'payment_pending' || 
                            (notification.message && 
                             (notification.message.includes('remaining payment') ||
                              notification.message.includes('clear the remaining payment')));
    
    // Determine action button
    let actionButtonHTML = '';
    if (isPaymentPending && notification.remainingAmount) {
      actionButtonHTML = `
        <div class="notification-highlight">
          <div class="highlight-title">
            <i class="fas fa-exclamation-circle"></i> Payment Required
          </div>
          <div class="highlight-amount">¬£${notification.remainingAmount.toFixed(2)}</div>
          ${notification.deadline ? `
          <div class="highlight-deadline">
            <i class="far fa-clock"></i> Due ${notification.deadline}
          </div>
          ` : ''}
        </div>
        <button class="pay-now-btn" onclick="event.stopPropagation(); handlePaymentAction('${notification.id}', '${orderInfo.orderId}', '${orderInfo.orderNumber}', ${notification.remainingAmount})">
          <i class="fas fa-bolt"></i> PAY NOW
        </button>
      `;
    } else if (notificationType === 'payment_advance' || notificationType === 'payment_full') {
      actionButtonHTML = `
        <button class="action-btn-small success" onclick="event.stopPropagation(); handleOrderDetailsAction('${notification.id}', '${orderInfo.orderId}', '${orderInfo.orderNumber}')">
          <i class="fas fa-eye"></i> View Order
        </button>
      `;
    } else {
      actionButtonHTML = `
        <button class="action-btn-small info" onclick="event.stopPropagation(); handleTrackOrderAction('${notification.id}', '${orderInfo.orderId}', '${orderInfo.orderNumber}')">
          <i class="fas fa-truck"></i> Track Order
        </button>
      `;
    }
    
    notificationsHTML += `
      <div class="notification-item ${isUnread ? 'unread' : ''}" 
           data-id="${notification.id}"
           data-type="${notificationType}"
           data-order-id="${orderInfo.orderId}"
           data-order-number="${orderInfo.orderNumber}"
           onclick="handleNotificationClick('${notification.id}', '${notificationType}', '${orderInfo.orderId}', '${orderInfo.orderNumber}')">
        <div class="notification-header">
          <div class="notification-title">
            ${notification.title || 'Notification'}
            <span class="${typeClass}">${typeText}</span>
          </div>
          <div class="notification-time">
            <i class="far fa-clock"></i> ${timeAgo}
          </div>
        </div>
        
        <div class="notification-message">
          ${notification.message || ''}
          ${notification.orderNumber ? `<br><small><strong>Order:</strong> ${notification.orderNumber}</small>` : ''}
        </div>
        
        ${actionButtonHTML}
        
        ${notification.productImage ? `
        <div class="notification-product">
          <div class="product-image">
            <img src="${notification.productImage}" 
                 alt="${notification.productName || 'Product'}" 
                 loading="lazy"
                 onerror="this.src='${getDefaultImage()}'">
          </div>
          <div class="product-details">
            <div class="product-name">${notification.productName || 'Product'}</div>
            <div class="product-meta">${notification.productCategory || 'Stone Product'}</div>
            ${notification.productPrice ? `
            <div class="product-price">¬£${notification.productPrice.toFixed(2)}</div>
            ` : ''}
          </div>
        </div>
        ` : ''}
        
        <div class="notification-actions">
          ${isUnread ? `
          <button class="action-btn-small success" onclick="event.stopPropagation(); markAsRead('${notification.id}')">
            <i class="fas fa-check"></i> Mark as read
          </button>
          ` : ''}
          
          <button class="action-btn-small" onclick="event.stopPropagation(); deleteNotification('${notification.id}')">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </div>
    `;
  });
  
  notificationsListDiv.innerHTML = notificationsHTML;
}

function extractOrderInfo(notification) {
  const title = notification.title || '';
  const message = notification.message || '';
  const orderId = notification.orderId || '';
  const orderNumber = notification.orderNumber || '';
  
  // Extract order number from message if not provided
  let extractedOrderNumber = orderNumber;
  if (!extractedOrderNumber) {
    const extracted = extractOrderInfoFromMessage(message);
    if (extracted && extracted.orderNumber) {
      extractedOrderNumber = extracted.orderNumber;
    }
  }
  
  return {
    orderId: orderId,
    orderNumber: extractedOrderNumber
  };
}

function extractOrderInfoFromMessage(message) {
  if (!message) return null;
  
  const pattern1 = message.match(/IRYA[-\s]\d+[-\s]\d+/g);
  if (pattern1 && pattern1[0]) {
    return { orderNumber: pattern1[0] };
  }
  
  const pattern2 = message.match(/IRYA[-\s]\d+/g);
  if (pattern2 && pattern2[0]) {
    return { orderNumber: pattern2[0] };
  }
  
  const pattern3 = message.match(/Order[#\s]+\d+/gi);
  if (pattern3 && pattern3[0]) {
    const orderNum = pattern3[0].replace(/Order[#\s]+/i, '').trim();
    return { orderNumber: `IRYA-${orderNum}` };
  }
  
  const pattern4 = message.match(/\b\d{10,}\b/g);
  if (pattern4 && pattern4[0]) {
    return { orderNumber: `IRYA-${pattern4[0]}` };
  }
  
  return null;
}

function getTypeText(type) {
  const typeMap = {
    'payment_pending': 'Payment Pending',
    'payment_advance': 'Advance Paid',
    'payment_full': 'Payment Completed',
    'processing': 'Processing',
    'ready_to_ship': 'Ready to Ship',
    'shipped': 'Shipped',
    'out_for_delivery': 'Out for Delivery',
    'delivered': 'Delivered',
    'cancelled': 'Cancelled',
    'order': 'Order Update',
    'shipping': 'Shipping Update',
    'system': 'System'
  };
  
  return typeMap[type] || type.replace(/_/g, ' ').toUpperCase();
}

function getEmptyMessageForFilter(filter) {
  const messages = {
    'all': 'You will see notifications here when you have new updates.',
    'unread': 'You have no unread notifications.',
    'payment': 'No payment notifications.',
    'shipping': 'No shipping notifications.',
    'order': 'No order notifications.'
  };
  
  return messages[filter] || messages['all'];
}

// ============================================
// NOTIFICATION ACTIONS HANDLERS
// ============================================

async function handleNotificationClick(notificationId, type, orderId, orderNumber) {
  try {
    if (!isUserLoggedIn) {
      showMessage("Please sign in to view notifications");
      return;
    }
    
    // First mark as read
    await markAsRead(notificationId);
    
    // Check if it's a payment pending notification
    const isPaymentPending = type === 'payment_pending' || 
                            (type && type.includes('payment_pending'));
    
    if (isPaymentPending) {
      // Payment pending notifications go to checkout
      handlePaymentAction(notificationId, orderId, orderNumber);
    } else if (type === 'payment_advance' || type === 'payment_full') {
      // Payment completed notifications go to order details
      handleOrderDetailsAction(notificationId, orderId, orderNumber);
    } else {
      // ALL other notifications go to orders.html with tracking
      handleTrackOrderAction(notificationId, orderId, orderNumber);
    }
    
  } catch (error) {
    console.error("‚ùå Error handling notification click:", error);
    showMessage("Failed to process notification");
  }
}

async function handlePaymentAction(notificationId, orderId, orderNumber, amount = 0) {
  try {
    if (!isUserLoggedIn) {
      showMessage("Please sign in to make payments");
      return;
    }
    
    // Mark as read
    await markAsRead(notificationId);
    
    // Redirect to checkout
    redirectToNotificationCheckout(orderId, orderNumber, amount);
    
  } catch (error) {
    console.error("‚ùå Error in payment action:", error);
  }
}

async function handleTrackOrderAction(notificationId, orderId, orderNumber) {
  try {
    if (!isUserLoggedIn) {
      showMessage("Please sign in to track orders");
      return;
    }
    
    // Mark as read
    await markAsRead(notificationId);
    
    // Redirect to orders page with tracking
    redirectToOrdersPage(orderId, orderNumber, true);
    
  } catch (error) {
    console.error("‚ùå Error in track order action:", error);
  }
}

async function handleOrderDetailsAction(notificationId, orderId, orderNumber) {
  try {
    if (!isUserLoggedIn) {
      showMessage("Please sign in to view order details");
      return;
    }
    
    // Mark as read
    await markAsRead(notificationId);
    
    // Redirect to orders page
    redirectToOrdersPage(orderId, orderNumber, false);
    
  } catch (error) {
    console.error("‚ùå Error in order details action:", error);
  }
}

// ============================================
// REDIRECT FUNCTIONS
// ============================================

function redirectToNotificationCheckout(orderId, orderNumber, amount = 0) {
  console.log("üí∞ Redirecting to notification checkout:", { orderId, orderNumber, amount });
  
  // First, try to get the actual order from Firestore to get exact remaining amount
  try {
    // Try to get order from Firestore
    const orderRef = doc(db, "users", currentUserId, "orders", orderId);
    getDoc(orderRef).then(orderDoc => {
      if (orderDoc.exists()) {
        const orderData = orderDoc.data();
        const paidAmount = orderData.submittedAmount || orderData.advancePayment || 0;
        const totalAmount = orderData.total || 0;
        const actualRemaining = orderData.remainingPayment || (totalAmount - paidAmount);
        
        // Use actual amount from order if available, otherwise use extracted amount
        const finalAmount = actualRemaining > 0 ? actualRemaining : amount;
        
        const redirectData = {
          orderId: orderId,
          orderNumber: orderNumber,
          amount: finalAmount,
          totalAmount: totalAmount,
          paidAmount: paidAmount,
          notificationType: 'payment_pending',
          source: 'notifications_page',
          timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('irya_pending_payment_order', JSON.stringify(redirectData));
        
        let checkoutUrl = `notification-checkout.html?order_id=${orderId}&type=remaining_payment&amount=${finalAmount}`;
        
        console.log("üîó Redirecting to:", checkoutUrl);
        showMessage("Redirecting to payment page...");
        
        setTimeout(() => {
          window.location.href = checkoutUrl;
        }, 500);
      }
    }).catch(error => {
      // Fallback to extracted amount if order not found
      console.log("Order not found, using extracted amount");
      proceedWithExtractedAmount();
    });
  } catch (error) {
    console.log("Error fetching order, using extracted amount");
    proceedWithExtractedAmount();
  }
  
  function proceedWithExtractedAmount() {
    const redirectData = {
      orderId: orderId,
      orderNumber: orderNumber,
      amount: amount,
      notificationType: 'payment_pending',
      source: 'notifications_page',
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('irya_pending_payment_order', JSON.stringify(redirectData));
    
    let checkoutUrl = 'notification-checkout.html';
    
    if (orderId) {
      checkoutUrl += `?order_id=${orderId}&type=remaining_payment`;
    } else if (orderNumber) {
      checkoutUrl += `?order_number=${encodeURIComponent(orderNumber)}&type=remaining_payment`;
    } else {
      checkoutUrl += '?type=remaining_payment';
    }
    
    if (amount > 0) {
      checkoutUrl += `&amount=${amount}`;
    }
    
    console.log("üîó Redirecting to:", checkoutUrl);
    showMessage("Redirecting to payment page...");
    
    setTimeout(() => {
      window.location.href = checkoutUrl;
    }, 500);
  }
}

function redirectToOrdersPage(orderId, orderNumber, trackOrder = false) {
  console.log("üì¶ Redirecting to orders page:", { orderId, orderNumber, trackOrder });
  
  const redirectData = {
    orderId: orderId,
    orderNumber: orderNumber,
    notificationType: trackOrder ? 'order_tracking' : 'order_notification',
    trackOrder: trackOrder,
    timestamp: new Date().toISOString()
  };
  
  localStorage.setItem('irya_notification_redirect', JSON.stringify(redirectData));
  
  let ordersUrl = 'orders.html';
  
  if (orderId) {
    ordersUrl += `?order_id=${orderId}`;
    if (trackOrder) {
      ordersUrl += `&track=true`;
    }
  } else if (orderNumber) {
    ordersUrl += `?search=${encodeURIComponent(orderNumber)}`;
    if (trackOrder) {
      ordersUrl += `&track=true`;
    }
  }
  
  console.log("üîó Redirecting to:", ordersUrl);
  showMessage(trackOrder ? "Redirecting to track order..." : "Redirecting to order details...");
  
  setTimeout(() => {
    window.location.href = ordersUrl;
  }, 500);
}

// ============================================
// NOTIFICATION MANAGEMENT FUNCTIONS
// ============================================

async function markAsRead(notificationId) {
  try {
    if (!db || !isUserLoggedIn || !currentUserId) return;
    
    const notificationRef = doc(db, "users", currentUserId, "notifications", notificationId);
    await updateDoc(notificationRef, {
      read: true,
      readAt: new Date().toISOString()
    });
    
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
      notification.read = true;
    }
    
    const notificationElement = document.querySelector(`[data-id="${notificationId}"]`);
    if (notificationElement) {
      notificationElement.classList.remove('unread');
      
      const markAsReadBtn = notificationElement.querySelector('.action-btn-small.success');
      if (markAsReadBtn) {
        markAsReadBtn.remove();
      }
    }
    
    const unreadCount = notifications.filter(n => !n.read).length;
    updateBadges(unreadCount);
    
  } catch (error) {
    console.error("‚ùå Error marking as read:", error);
    showMessage("Failed to mark as read");
  }
}

async function markAllAsRead() {
  try {
    if (!db || !isUserLoggedIn || !currentUserId) return;
    
    const unreadNotifications = notifications.filter(n => !n.read);
    
    for (const notification of unreadNotifications) {
      const notificationRef = doc(db, "users", currentUserId, "notifications", notification.id);
      await updateDoc(notificationRef, {
        read: true,
        readAt: new Date().toISOString()
      });
      
      notification.read = true;
    }
    
    document.querySelectorAll('.notification-item.unread').forEach(item => {
      item.classList.remove('unread');
      
      const markAsReadBtn = item.querySelector('.action-btn-small.success');
      if (markAsReadBtn) {
        markAsReadBtn.remove();
      }
    });
    
    updateBadges(0);
    showMessage("All notifications marked as read");
    
  } catch (error) {
    console.error("‚ùå Error marking all as read:", error);
    showMessage("Failed to mark all as read");
  }
}

async function deleteNotification(notificationId) {
  if (!isUserLoggedIn) {
    showMessage("Please sign in to delete notifications");
    return;
  }
  
  if (!confirm('Are you sure you want to delete this notification?')) return;
  
  try {
    if (!db || !currentUserId) return;
    
    const notificationRef = doc(db, "users", currentUserId, "notifications", notificationId);
    await deleteDoc(notificationRef);
    
    notifications = notifications.filter(n => n.id !== notificationId);
    
    const unreadCount = notifications.filter(n => !n.read).length;
    updateBadges(unreadCount);
    
    displayNotifications(notifications);
    
    showMessage("Notification deleted");
    
  } catch (error) {
    console.error("‚ùå Error deleting notification:", error);
    showMessage("Failed to delete notification");
  }
}

async function clearAllNotifications() {
  if (!isUserLoggedIn) {
    showMessage("Please sign in to clear notifications");
    return;
  }
  
  if (!confirm('Are you sure you want to clear all notifications? This cannot be undone.')) return;
  
  try {
    if (!db || !currentUserId) return;
    
    const notificationsRef = collection(db, "users", currentUserId, "notifications");
    const snapshot = await getDocs(notificationsRef);
    
    const deletePromises = [];
    snapshot.forEach((doc) => {
      deletePromises.push(deleteDoc(doc.ref));
    });
    
    await Promise.all(deletePromises);
    
    notifications = [];
    updateBadges(0);
    showEmptyState("All notifications cleared");
    
    showMessage("All notifications cleared");
    
  } catch (error) {
    console.error("‚ùå Error clearing all notifications:", error);
    showMessage("Failed to clear notifications");
  }
}

// ============================================
// FILTER FUNCTIONS
// ============================================

function filterNotifications(filter) {
  if (!isUserLoggedIn) {
    showMessage("Please sign in to filter notifications");
    return;
  }
  
  currentFilter = filter;
  
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  event?.target.classList.add('active');
  
  displayNotifications(notifications);
}

// ============================================
// BADGE MANAGEMENT
// ============================================

function updateBadges(unreadCount) {
  const bottomNavBadge = document.getElementById('bottomNavBadge');
  
  if (bottomNavBadge) {
    if (unreadCount > 0) {
      bottomNavBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      bottomNavBadge.style.display = 'flex';
    } else {
      bottomNavBadge.style.display = 'none';
    }
  }
  
  localStorage.setItem('irya_unread_notifications', unreadCount.toString());
}

function updateCartBadge() {
  try {
    const userId = localStorage.getItem('irya_guest_id') || 'guest';
    const cartKey = 'irya_local_cart_' + userId;
    const cartData = localStorage.getItem(cartKey);
    const cartItems = cartData ? JSON.parse(cartData) : [];
    const count = cartItems.reduce((total, item) => total + (item.quantity || 0), 0);
    
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
      cartBadge.textContent = count;
      cartBadge.style.display = count > 0 ? 'flex' : 'none';
    }
  } catch (error) {
    console.error('‚ùå Error updating cart badge:', error);
  }
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function showEmptyState(message) {
  const notificationsList = document.getElementById("notificationsList");
  if (!notificationsList) return;
  
  notificationsList.innerHTML = `
    <div class="empty-state">
      <i class="fas fa-bell-slash"></i>
      <h3>${message}</h3>
      <p>You will see notifications here when you have new updates.</p>
      <button class="filter-btn active" onclick="loadNotifications()" style="margin-top: 20px;">
        <i class="fas fa-redo"></i> Refresh
      </button>
    </div>
  `;
}

function getTimeAgo(dateString) {
  if (!dateString) return 'Just now';
  
  try {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short'
    });
  } catch (error) {
    return dateString;
  }
}

function showMessage(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
  
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 5000);
}

window.addEventListener('beforeunload', () => {
  if (notificationsUnsubscribe) notificationsUnsubscribe();
});

// Make functions available globally
window.filterNotifications = filterNotifications;
window.markAsRead = markAsRead;
window.markAllAsRead = markAllAsRead;
window.deleteNotification = deleteNotification;
window.clearAllNotifications = clearAllNotifications;
window.handleNotificationClick = handleNotificationClick;
window.handlePaymentAction = handlePaymentAction;
window.handleTrackOrderAction = handleTrackOrderAction;
window.handleOrderDetailsAction = handleOrderDetailsAction;
window.redirectToNotificationCheckout = redirectToNotificationCheckout;
window.redirectToOrdersPage = redirectToOrdersPage;
</script>

</body>
</html>

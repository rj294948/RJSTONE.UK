<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin – IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f4f6f8; padding:15px; }
.order { background:#fff; padding:15px; margin-bottom:15px; border-radius:8px; }
button { padding:6px 10px; margin-top:6px; }
input, select { width:100%; padding:6px; margin-top:5px; }
.badge { padding:4px 8px; border-radius:4px; font-size:12px; }
.advance { background:#ffc107; }
.full { background:#28a745; color:#fff; }
</style>
</head>

<body>

<h2>Admin Orders Panel</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore,
  collectionGroup,
  getDocs,
  doc,
  updateDoc,
  addDoc,
  collection
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ordersDiv = document.getElementById("orders");

/* ================= LOAD ORDERS ================= */
async function loadOrders() {
  ordersDiv.innerHTML = "";
  const snap = await getDocs(collectionGroup(db, "orders"));

  snap.forEach(d => {
    const o = d.data();
    if (!o.userId) return;

    const isFull = o.submittedAmount >= o.total;

    ordersDiv.innerHTML += `
      <div class="order">
        <b>${o.orderNumber}</b>
        <span class="badge ${isFull ? "full":"advance"}">
          ${isFull ? "FULL PAID" : "ADVANCE PAID"}
        </span>

        <p>User: ${o.userName}</p>
        <p>Paid: £${o.submittedAmount} | Remaining: £${o.remainingPayment}</p>

        <select id="pay-${d.id}">
          <option value="">-- Payment Status --</option>
          <option value="advance_confirmed">Advance Confirmed</option>
          <option value="fully_paid">Fully Paid</option>
        </select>

        <button onclick="updatePayment('${o.userId}','${d.id}','${o.orderNumber}')">
          Update Payment
        </button>

        <input id="track-${d.id}" placeholder="Tracking Number">

        <button onclick="updateShipping('${o.userId}','${d.id}','${o.orderNumber}')">
          Update Shipping
        </button>
      </div>
    `;
  });
}

/* ================= PAYMENT UPDATE ================= */
window.updatePayment = async (userId, orderId, orderNumber) => {
  const status = document.getElementById(`pay-${orderId}`).value;
  if (!status) return alert("Select payment status");

  await updateDoc(doc(db,"users",userId,"orders",orderId), {
    paymentStatus: status,
    updatedAt: new Date().toISOString()
  });

  await addDoc(collection(db,"users",userId,"notifications"), {
    type:"payment",
    orderId,
    orderNumber,
    title:"Payment Update",
    message: status === "fully_paid"
      ? "Your full payment has been confirmed."
      : "Your advance payment has been confirmed.",
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Payment updated");
};

/* ================= SHIPPING UPDATE ================= */
window.updateShipping = async (userId, orderId, orderNumber) => {
  const track = document.getElementById(`track-${orderId}`).value;
  if (!track) return alert("Enter tracking number");

  await updateDoc(doc(db,"users",userId,"orders",orderId), {
    shippingStatus:"shipped",
    trackingNumber:track,
    shippedAt:new Date().toISOString()
  });

  await addDoc(collection(db,"users",userId,"notifications"), {
    type:"shipping",
    orderId,
    orderNumber,
    title:"Order Shipped",
    message:`Your order has been shipped. Tracking No: ${track}`,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Shipping updated");
};

loadOrders();
</script>
</body>
</html>

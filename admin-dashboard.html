<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin – IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f4f6f8; padding:15px; }
.order { background:#fff; padding:15px; margin-bottom:15px; border-radius:8px; }
.badge { padding:4px 8px; border-radius:4px; font-size:12px; font-weight:bold; }
.advance { background:#ffc107; }
.full { background:#28a745; color:#fff; }
button { padding:6px 10px; margin-top:6px; }
input, select { width:100%; padding:6px; margin-top:5px; }
.disabled { opacity:.5; pointer-events:none; }
</style>
</head>

<body>

<h2>Admin Orders Panel</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore,
  collectionGroup,
  getDocs,
  updateDoc,
  addDoc,
  collection
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ordersDiv = document.getElementById("orders");

/* ================= LOAD ORDERS ================= */
async function loadOrders() {
  ordersDiv.innerHTML = "";
  const snap = await getDocs(collectionGroup(db, "orders"));

  snap.forEach(d => {
    const o = d.data();
    if (!o.userId) return;

    const isFull = o.paymentStatus === "fully_paid";

    ordersDiv.innerHTML += `
      <div class="order">
        <b>${o.orderNumber}</b>
        <span class="badge ${isFull ? "full":"advance"}">
          ${isFull ? "FULL PAID" : "ADVANCE PAID"}
        </span>

        <p><b>User:</b> ${o.userName} (${o.userEmail})</p>
        <p><b>Total:</b> £${o.total}</p>
        <p><b>Remaining:</b> £${o.remainingPayment || 0}</p>

        <select id="pay-${d.id}">
          <option value="">-- Payment Action --</option>
          <option value="advance_confirmed">Confirm Advance</option>
          <option value="fully_paid">Confirm Full Payment</option>
          <option value="payment_reminder">Send Reminder</option>
        </select>

        <button onclick='updatePayment(${JSON.stringify(d.ref.path)}, "${o.userId}", "${o.orderNumber}")'>
          Update Payment
        </button>

        <div class="${isFull ? "" : "disabled"}">
          <input id="track-${d.id}" placeholder="Tracking Number">
          <button onclick='updateShipping(${JSON.stringify(d.ref.path)}, "${o.userId}", "${o.orderNumber}", "${d.id}")'>
            Update Shipping
          </button>
        </div>
      </div>
    `;
  });
}

/* ================= PAYMENT UPDATE ================= */
window.updatePayment = async (orderPath, userId, orderNumber) => {
  const orderRef = orderPath;
  const select = document.querySelector(`[id^="pay-"]:focus`) || document.activeElement.previousElementSibling;
  const status = select.value;

  if (!status) return alert("Select action");

  await updateDoc(db._delegate._databaseId
    ? eval(`doc(db, "${orderPath}")`)
    : null, {
    paymentStatus: status === "fully_paid" ? "fully_paid" : undefined,
    updatedAt: new Date().toISOString()
  });

  await addDoc(collection(db,"users",userId,"notifications"), {
    type:"payment",
    orderNumber,
    message:
      status === "fully_paid"
        ? "Your full payment has been confirmed."
        : status === "advance_confirmed"
          ? "Your advance payment has been confirmed."
          : "Please complete remaining payment.",
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Payment updated");
  loadOrders();
};

/* ================= SHIPPING UPDATE ================= */
window.updateShipping = async (orderPath, userId, orderNumber, id) => {
  const track = document.getElementById(`track-${id}`).value;
  if (!track) return alert("Enter tracking number");

  await updateDoc(eval(`doc(db, "${orderPath}")`), {
    shippingStatus:"shipped",
    trackingNumber:track,
    shippedAt:new Date().toISOString()
  });

  await addDoc(collection(db,"users",userId,"notifications"), {
    type:"shipping",
    orderNumber,
    message:`Order shipped. Tracking No: ${track}`,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Shipping updated");
  loadOrders();
};

loadOrders();
</script>
</body>
</html>

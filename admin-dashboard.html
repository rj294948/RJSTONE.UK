<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin – IRYA STONE Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* --- PROFESSIONAL STYLING --- */
body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background:#eef1f4; /* Light background */
    padding:20px; 
    color: #333;
}
.header {
    margin-bottom: 25px;
    color: #1f2937;
    border-bottom: 3px solid #007bff; /* Accent color */
    padding-bottom: 10px;
}
.order { 
    background:#ffffff; 
    padding:20px; 
    margin-bottom:20px; 
    border-radius:12px; /* Smoother corners */
    border:1px solid #e0e0e0; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.05); /* Soft shadow */
    transition: all 0.3s ease;
}
.order:hover {
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}
h2, h3, h4 { margin-top: 0; }
hr { border: 0; border-top: 1px solid #eee; margin: 15px 0; }

/* Action Buttons and Inputs */
button { 
    padding: 10px 18px; /* Larger, more clickable area */
    margin-top: 10px;
    cursor: pointer; 
    border: none;
    border-radius: 6px;
    background: #007bff; /* Primary Blue */
    color: white;
    font-weight: 600;
    transition: background 0.3s;
    margin-right: 10px;
}
button:hover { background: #0056b3; }

input, select { 
    width: 100%; 
    padding: 10px;
    margin-top: 8px; 
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box; /* Crucial for layout */
    font-size: 14px;
    background-color: #f9f9f9;
}
select { 
    appearance: none; 
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
}

/* Badges */
.badge { 
    padding: 5px 12px; 
    border-radius: 6px; 
    font-size: 13px; 
    margin-left: 8px;
    font-weight: bold;
    display: inline-block;
}
.advance { background:#ffc107; color:#333; }
.full { background:#28a745; color:#fff; }
.shipped { background:#17a2b8; color:#fff; }
.pending { background:#6c757d; color:#fff; }

/* Product Display */
.product-img { 
    width: 70px; 
    height: 70px; 
    object-fit: cover; 
    margin-right: 15px; 
    border-radius: 6px; 
    border: 1px solid #eee;
}
.flex { 
    display: flex; 
    align-items: flex-start; /* Align items to the top */
    margin-top: 15px; 
    padding-bottom: 10px;
    border-bottom: 1px dashed #eee;
}
.flex:last-child {
    border-bottom: none;
    padding-bottom: 0;
}
.product-details { font-size: 14px; }
.product-details b { color: #555; }

/* Action Sections */
.action-group {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}
.action-group h4 {
    color: #495057;
    margin-bottom: 10px;
}
</style>
</head>
<body>

<h2 class="header">Admin Orders Panel</h2>
<div id="orders">
    <p>Loading orders...</p>
</div>

<script type="module">
// --- ORIGINAL JAVASCRIPT LOGIC (FOR RELIABILITY) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collectionGroup, getDocs, doc, updateDoc, addDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ordersDiv = document.getElementById("orders");

// Expose functions to the window scope
window.updatePayment = updatePayment;
window.updateShipping = updateShipping;

// Load orders
async function loadOrders() {
  ordersDiv.innerHTML = "<p>Loading orders...</p>"; // Updated loading state
  
    try {
        const snap = await getDocs(collectionGroup(db, "orders"));
        let orderList = [];
        
        // Use a Map to filter duplicates by orderNumber while processing the collectionGroup snapshot
        const uniqueOrders = new Map();

        snap.forEach(d => {
            let o = d.data();
            o.docId = d.id;
            
            // Check if this orderNumber is already mapped. If not, add it.
            // This handles the duplicate issue by prioritizing the first instance found.
            if (!uniqueOrders.has(o.orderNumber)) {
                uniqueOrders.set(o.orderNumber, o);
            }
        });

        orderList = Array.from(uniqueOrders.values());

        // Sort by latest
        orderList.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
        
        ordersDiv.innerHTML = ""; // Clear loading message

        if (orderList.length === 0) {
            ordersDiv.innerHTML = "<p>No orders found.</p>";
            return;
        }

        for(const o of orderList){
            // Avoid incomplete orders
            if(!o.items || o.items.length===0) continue;

            const totalPaid = o.advancePayment || 0;
            const remaining = (o.total || 0) - totalPaid;
            const isFull = remaining <= 0.01; // Adjusted for floating point safety
            const statusBadge = isFull ? "full" : "advance";
            const shippingStatus = o.shippingStatus || "pending";
            const shippedBadge = shippingStatus==="shipped" ? "shipped" : "pending";
            
            // Format numbers for clean display
            const totalFmt = (o.total || 0).toFixed(2);
            const paidFmt = totalPaid.toFixed(2);
            const remainingFmt = remaining.toFixed(2);
            
            // Products HTML
            let productsHTML = "";
            for(const item of o.items){
                // Fetch product info by id (Awaits inside loop, might be slow for many orders)
                let productSnap = await getDoc(doc(db,"products",item.id));
                let product = productSnap.exists() ? productSnap.data() : {};
                let img = product.images?.[0] || 'https://via.placeholder.com/70?text=No+Image';
                let name = product.title || product.name || item.name || "Unknown Product";
                let itemRemaining = item.remainingPayment || 0;

                productsHTML += `
                    <div class="flex">
                        <img src="${img}" class="product-img" alt="${name}"/>
                        <div class="product-details">
                            <b>${name}</b><br/>
                            Qty: ${item.quantity} | Price: £${(item.price || 0).toFixed(2)} | Item Remaining: £${itemRemaining.toFixed(2)}
                        </div>
                    </div>
                `;
            }
            
            // Get delivery time value for pre-fill
            const deliveryTimeValue = o.deliveryDateTime ? o.deliveryDateTime.substring(0, 16) : '';

            ordersDiv.innerHTML += `
                <div class="order">
                    <h3>Order #: ${o.orderNumber}
                        <span class="badge ${statusBadge}">${isFull ? "FULLY PAID" : "ADVANCE PAID"}</span>
                        <span class="badge ${shippedBadge}">${shippingStatus.toUpperCase()}</span>
                    </h3>
                    
                    <p>
                        User: <b>${o.userName || 'N/A'}</b> | Email: ${o.userEmail || 'N/A'}
                    </p>
                    <p>
                        Phone: ${o.shippingAddress?.phone || o.billingAddress?.phone || 'N/A'}
                    </p>
                    <p>
                        **FINANCIALS:** Total: £${totalFmt} | Paid: £${paidFmt} | Remaining: £${remainingFmt}
                    </p>

                    <h4>Products Included:</h4>
                    ${productsHTML}

                    <div class="action-group">
                        <h4>Update Payment Status</h4>
                        <select id="pay-${o.docId}">
                            <option value="">-- Select Status --</option>
                            <option value="advance_confirmed" ${o.paymentStatus === 'advance_confirmed' ? 'selected' : ''}>Advance Confirmed</option>
                            <option value="fully_paid" ${o.paymentStatus === 'fully_paid' ? 'selected' : ''}>Fully Paid</option>
                        </select>
                        <button onclick="updatePayment('${o.userId}','${o.docId}','${o.orderNumber}', ${o.total || 0})">Update Payment</button>
                    </div>

                    <div class="action-group">
                        <h4>Shipping & Tracking</h4>
                        <input id="track-${o.docId}" placeholder="Tracking Number" value="${o.trackingNumber || ''}">
                        <input type="datetime-local" id="delivery-${o.docId}" placeholder="Delivery Date & Time" value="${deliveryTimeValue}">
                        <button onclick="updateShipping('${o.userId}','${o.docId}','${o.orderNumber}')">Update Shipping</button>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error("Error loading orders:", error);
        ordersDiv.innerHTML = `<p style="color: red;">Error loading orders: ${error.message}</p>`;
    }
}

// Update Payment (Your original logic maintained)
async function updatePayment(userId, orderId, orderNumber, total) {
  const status = document.getElementById(`pay-${orderId}`).value;
  if(!status) return alert("Select payment status");

  const paidAmount = status==="fully_paid" ? total : total*0.3;
  const remainingAmount = total - paidAmount;

  await updateDoc(doc(db,"users",userId,"orders",orderId),{
    paymentStatus: status,
    advancePayment: paidAmount,
    remainingPayment: remainingAmount,
    updatedAt: new Date().toISOString()
  });
  
  const paidFmt = paidAmount.toFixed(2);
  const remainingFmt = remainingAmount.toFixed(2);

  await addDoc(collection(db,"users",userId,"notifications"),{
    type:"payment",
    orderId,
    orderNumber,
    title:"Payment Update",
    message: status==="fully_paid"
      ? `Your full payment of £${total.toFixed(2)} has been confirmed.`
      : `Advance payment of £${paidFmt} received. Remaining £${remainingFmt}. Please complete payment within 24 hours or order will auto-cancel. Advance is non-refundable.`,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Payment updated");
  loadOrders();
}

// Update Shipping (Your original logic maintained)
async function updateShipping(userId, orderId, orderNumber) {
  const track = document.getElementById(`track-${orderId}`).value.trim();
  const delivery = document.getElementById(`delivery-${orderId}`).value;
  
  if(!track) return alert("Enter tracking number");
  if(!delivery) return alert("Set delivery date & time");

  await updateDoc(doc(db,"users",userId,"orders",orderId),{
    shippingStatus:"shipped",
    trackingNumber: track,
    shippedAt: new Date().toISOString(),
    deliveryDateTime: delivery,
    updatedAt: new Date().toISOString() // Added update time
  });
  
  // Format delivery date for user friendly notification
  const deliveryDateDisplay = new Date(delivery).toLocaleString();

  await addDoc(collection(db,"users",userId,"notifications"),{
    type:"shipping",
    orderId,
    orderNumber,
    title:"Order Shipped",
    message: `Your order has been shipped. Tracking No: ${track}. Expected Delivery: ${deliveryDateDisplay}`,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Shipping updated");
  loadOrders();
}

loadOrders();
</script>
</body>
</html>

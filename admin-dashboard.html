<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IRYA STONE ‚Äì Admin Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ========== CLASSIC THEME ========== */
:root {
    --primary: #2c3e50;
    --secondary: #34495e;
    --accent: #3498db;
    --success: #27ae60;
    --warning: #f39c12;
    --danger: #e74c3c;
    --info: #17a2b8;
    --light: #ecf0f1;
    --dark: #2c3e50;
    --border: #bdc3c7;
    --shadow: 0 3px 10px rgba(0,0,0,0.1);
    --radius: 8px;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    margin: 0;
    padding: 20px;
    color: #333;
    min-height: 100vh;
}

/* ========== HEADER ========== */
.dashboard-header {
    background: var(--primary);
    color: white;
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left h1 {
    margin: 0 0 5px 0;
    font-size: 24px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.header-left p {
    margin: 0;
    opacity: 0.8;
    font-size: 14px;
}

.header-right {
    display: flex;
    gap: 15px;
    align-items: center;
}

.stat-badge {
    background: rgba(255,255,255,0.2);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ========== STATS CARDS ========== */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border-left: 4px solid var(--accent);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-3px);
}

.stat-card h3 {
    margin: 0 0 5px 0;
    font-size: 28px;
    color: var(--primary);
}

.stat-card p {
    margin: 0;
    color: #666;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ========== ORDER CARD ========== */
.order-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: all 0.3s ease;
}

.order-card:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--light);
}

.order-title {
    flex: 1;
}

.order-title h3 {
    margin: 0 0 5px 0;
    color: var(--primary);
    font-size: 18px;
}

.order-meta {
    color: #666;
    font-size: 14px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.order-status {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* ========== BADGES ========== */
.badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.processing { background: #e3f2fd; color: #1565c0; border-left: 4px solid #1565c0; }
.ready_to_ship { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #2e7d32; }
.shipped { background: #e1f5fe; color: #0277bd; border-left: 4px solid #0277bd; }
.out_for_delivery { background: #fff3e0; color: #f57c00; border-left: 4px solid #f57c00; }
.delivered { background: #f1f8e9; color: #689f38; border-left: 4px solid #689f38; }
.cancelled { background: #ffebee; color: #c62828; border-left: 4px solid #c62828; }
.paid { background: #27ae60; color: white; }
.advance { background: #f39c12; color: white; }
.pending_payment { background: #e74c3c; color: white; }

.payment-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    margin-right: 5px;
}

/* ========== ORDER DETAILS ========== */
.order-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.detail-section {
    background: #f9f9f9;
    padding: 15px;
    border-radius: var(--radius);
    border: 1px solid #eee;
}

.detail-section h4 {
    margin: 0 0 10px 0;
    color: var(--primary);
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.detail-section p {
    margin: 8px 0;
    font-size: 14px;
}

.detail-section strong {
    color: var(--dark);
    min-width: 120px;
    display: inline-block;
}

/* ========== PRODUCTS ========== */
.products-section {
    margin: 20px 0;
    padding: 15px;
    background: #f9f9f9;
    border-radius: var(--radius);
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 10px;
}

.product-item {
    display: flex;
    gap: 15px;
    padding: 12px;
    background: white;
    border-radius: var(--radius);
    border: 1px solid #eee;
    align-items: center;
}

.product-img {
    width: 60px;
    height: 60px;
    border-radius: 6px;
    object-fit: cover;
    border: 1px solid #ddd;
}

.product-info h5 {
    margin: 0 0 5px 0;
    font-size: 14px;
}

.product-info p {
    margin: 0;
    font-size: 13px;
    color: #666;
}

/* ========== UPDATE FORMS ========== */
.update-forms {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid var(--light);
}

.form-section {
    background: #f5f7fa;
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 15px;
    border: 1px solid #e1e8ed;
}

.form-section h4 {
    margin: 0 0 15px 0;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    margin-bottom: 10px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--dark);
    font-size: 14px;
}

.form-group select,
.form-group input,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
    transition: border 0.3s ease;
}

.form-group select:focus,
.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.form-group textarea {
    min-height: 80px;
    resize: vertical;
}

/* ========== BUTTONS ========== */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: var(--accent);
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-success:hover {
    background: #219653;
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-warning {
    background: var(--warning);
    color: white;
}

.btn-warning:hover {
    background: #e67e22;
}

.btn-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
}

/* ========== TIMELINE ========== */
.timeline-section {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: var(--radius);
    border: 1px solid #e9ecef;
}

.timeline {
    position: relative;
    padding-left: 20px;
    margin-top: 10px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 7px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--accent);
}

.timeline-item {
    position: relative;
    margin-bottom: 15px;
    padding-left: 15px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -6px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid white;
}

.timeline-date {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.timeline-content {
    font-size: 14px;
    color: #333;
    background: white;
    padding: 10px;
    border-radius: 6px;
    border-left: 3px solid var(--accent);
}

/* ========== NOTIFICATION BADGE ========== */
.notification-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
}

/* ========== LOADING ========== */
.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.loading i {
    font-size: 30px;
    margin-bottom: 15px;
    color: var(--accent);
}

/* ========== MODAL ========== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: var(--radius);
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal-header {
    background: var(--primary);
    color: white;
    padding: 20px;
    border-radius: var(--radius) var(--radius) 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-modal {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* ========== PAYMENT CALCULATION ========== */
.calculation-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: var(--radius);
    padding: 15px;
    margin: 15px 0;
}

.calc-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px dashed #dee2e6;
}

.calc-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
    font-weight: bold;
    color: var(--primary);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
    .dashboard-header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .order-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .order-status {
        align-self: flex-start;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        width: 100%;
    }
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="dashboard-header">
    <div class="header-left">
        <h1><i class="fas fa-gem"></i> IRYA STONE ‚Äì Admin Orders</h1>
        <p><i class="fas fa-sync-alt"></i> Real-time Order Management System</p>
    </div>
    <div class="header-right">
        <div class="stat-badge">
            <i class="fas fa-shopping-cart"></i>
            <span id="totalOrders">0</span> Orders
        </div>
        <div class="stat-badge">
            <i class="fas fa-pound-sign"></i>
            ¬£<span id="totalRevenue">0</span>
        </div>
        <button class="btn btn-primary" onclick="loadOrders()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- STATS -->
<div class="stats-container">
    <div class="stat-card">
        <h3 id="statsTotal">0</h3>
        <p><i class="fas fa-box-open"></i> Total Orders</p>
    </div>
    <div class="stat-card">
        <h3 id="statsProcessing">0</h3>
        <p><i class="fas fa-cog"></i> Processing</p>
    </div>
    <div class="stat-card">
        <h3 id="statsReady">0</h3>
        <p><i class="fas fa-box"></i> Ready to Ship</p>
    </div>
    <div class="stat-card">
        <h3 id="statsShipped">0</h3>
        <p><i class="fas fa-shipping-fast"></i> Shipped</p>
    </div>
    <div class="stat-card">
        <h3 id="statsDelivered">0</h3>
        <p><i class="fas fa-check-circle"></i> Delivered</p>
    </div>
    <div class="stat-card">
        <h3 id="statsCancelled">0</h3>
        <p><i class="fas fa-times-circle"></i> Cancelled</p>
    </div>
</div>

<!-- ORDERS CONTAINER -->
<div id="orders"></div>

<!-- LOADING -->
<div id="loading" class="loading" style="display: none;">
    <i class="fas fa-spinner fa-spin"></i>
    <p>Loading orders...</p>
</div>

<!-- PAYMENT MODAL -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-credit-card"></i> Update Payment Details</h3>
            <button class="close-modal" onclick="closePaymentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="calculation-box">
                <div class="calc-row">
                    <span>Order Total:</span>
                    <span id="modalOrderTotal">¬£0.00</span>
                </div>
                <div class="calc-row">
                    <span>Current Paid:</span>
                    <span id="modalCurrentPaid">¬£0.00</span>
                </div>
                <div class="calc-row">
                    <span>Remaining Balance:</span>
                    <span id="modalRemaining">¬£0.00</span>
                </div>
            </div>
            
            <div class="form-section">
                <h4><i class="fas fa-money-check-alt"></i> Payment Information</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Payment Type</label>
                        <select id="paymentType" onchange="calculatePayment()">
                            <option value="advance">Advance Payment</option>
                            <option value="full">Full Payment</option>
                            <option value="partial">Partial Payment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount Paid (¬£)</label>
                        <input type="number" id="paidAmount" step="0.01" min="0" oninput="calculatePayment()" placeholder="Enter amount">
                    </div>
                    <div class="form-group">
                        <label>Transaction Reference</label>
                        <input type="text" id="transactionRef" placeholder="Enter transaction ID">
                    </div>
                    <div class="form-group">
                        <label>Payment Date</label>
                        <input type="datetime-local" id="paymentDate">
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Notes</label>
                    <textarea id="paymentNotes" placeholder="Add any notes about this payment"></textarea>
                </div>
                
                <!-- CALCULATION RESULTS -->
                <div class="calculation-box" id="calcResults" style="display: none;">
                    <div class="calc-row">
                        <span>New Paid Amount:</span>
                        <span id="newPaidAmount">¬£0.00</span>
                    </div>
                    <div class="calc-row">
                        <span>New Remaining:</span>
                        <span id="newRemaining">¬£0.00</span>
                    </div>
                    <div class="calc-row">
                        <span>Payment Status:</span>
                        <span id="newPaymentStatus">Pending</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closePaymentModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn btn-success" onclick="savePayment()" id="savePaymentBtn">
                <i class="fas fa-save"></i> Save Payment
            </button>
        </div>
    </div>
</div>

<!-- STATUS MODAL -->
<div id="statusModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exchange-alt"></i> Update Order Status</h3>
            <button class="close-modal" onclick="closeStatusModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-section">
                <h4><i class="fas fa-info-circle"></i> Order Information</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: var(--radius); margin-bottom: 20px;">
                    <div style="font-weight: bold; margin-bottom: 5px;" id="modalOrderNumber">Order #</div>
                    <div style="font-size: 14px; color: #666;" id="modalCustomerInfo">Customer</div>
                </div>
                
                <h4><i class="fas fa-flag"></i> Select New Status</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <button class="btn" onclick="selectStatus('processing')" id="statusProcessing">
                        <i class="fas fa-cog"></i> Processing
                    </button>
                    <button class="btn" onclick="selectStatus('ready_to_ship')" id="statusReady">
                        <i class="fas fa-box"></i> Ready to Ship
                    </button>
                    <button class="btn" onclick="selectStatus('shipped')" id="statusShipped">
                        <i class="fas fa-shipping-fast"></i> Shipped
                    </button>
                    <button class="btn" onclick="selectStatus('out_for_delivery')" id="statusOut">
                        <i class="fas fa-truck"></i> Out for Delivery
                    </button>
                    <button class="btn" onclick="selectStatus('delivered')" id="statusDelivered">
                        <i class="fas fa-check-circle"></i> Delivered
                    </button>
                    <button class="btn btn-danger" onclick="selectStatus('cancelled')" id="statusCancelled">
                        <i class="fas fa-times-circle"></i> Cancelled
                    </button>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-shipping-fast"></i> Tracking Number</label>
                        <input type="text" id="statusTracking" placeholder="Enter tracking number">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar-alt"></i> Status Date & Time</label>
                        <input type="datetime-local" id="statusDateTime">
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-sticky-note"></i> Status Notes</label>
                    <textarea id="statusNotes" placeholder="Add notes about this status update"></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeStatusModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn btn-success" onclick="saveStatus()">
                <i class="fas fa-save"></i> Update Status
            </button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
    getFirestore, 
    collection, 
    getDocs, 
    doc, 
    getDoc, 
    updateDoc, 
    addDoc,
    query,
    where,
    orderBy,
    limit,
    deleteDoc,
    collectionGroup,
    serverTimestamp 
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Your Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDNWQ8h3N_lITIGCNnZGeH6_-iKJWU5pM0",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "544507744745",
    appId: "1:544507744745:web:08be89f93b19a9a6b0bf9c"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Global variables
let allOrders = [];
let currentOrder = null;
let selectedStatus = null;

// DOM elements
const ordersContainer = document.getElementById("orders");
const loading = document.getElementById("loading");
const paymentModal = document.getElementById("paymentModal");
const statusModal = document.getElementById("statusModal");

/* ========== NOTIFICATION SYSTEM ========== */

/**
 * Manage notifications (keep max 10 per user)
 */
async function manageUserNotifications(userId) {
    try {
        const notificationsRef = collection(db, "users", userId, "notifications");
        const q = query(notificationsRef, orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        const notifications = [];
        snapshot.forEach(doc => {
            notifications.push({ id: doc.id, ...doc.data() });
        });
        
        // Delete old notifications if more than 10
        if (notifications.length > 10) {
            const toDelete = notifications.slice(10);
            for (const notif of toDelete) {
                await deleteDoc(doc(db, "users", userId, "notifications", notif.id));
            }
        }
        
        return notifications.slice(0, 10);
    } catch (error) {
        console.error("Error managing notifications:", error);
        return [];
    }
}

/**
 * Send notification to user
 */
async function sendOrderNotification(userId, orderId, orderNumber, title, message, type = "order_update") {
    try {
        // First manage notifications (keep only 10)
        await manageUserNotifications(userId);
        
        const notificationRef = collection(db, "users", userId, "notifications");
        
        const notificationData = {
            title: title,
            message: message,
            orderId: orderId,
            orderNumber: orderNumber,
            type: type,
            createdAt: new Date().toISOString(),
            read: false,
            readAt: null
        };
        
        await addDoc(notificationRef, notificationData);
        console.log(`${type} notification sent: ${title} for order ${orderNumber}`);
        return true;
    } catch (error) {
        console.error("Error sending notification:", error);
        return false;
    }
}

/**
 * Send payment warning notification
 */
async function sendPaymentWarningNotification(order) {
    const title = "‚ö†Ô∏è Payment Required - Order Ready to Ship";
    let message = `Your order ${order.orderNumber} is ready to ship. `;
    message += `Please clear the remaining payment of ¬£${(order.remainingPayment || 0).toFixed(2)} `;
    message += `within 1 hour to avoid automatic cancellation.`;
    
    return sendOrderNotification(
        order.userId,
        order._id,
        order.orderNumber,
        title,
        message,
        "payment_warning"
    );
}

/**
 * Send status update notification
 */
async function sendStatusNotification(order, statusInfo) {
    const { newStatus, trackingNumber, statusNotes } = statusInfo;
    
    const statusText = newStatus.replace(/_/g, ' ');
    const title = `üì¶ Order ${statusText}`;
    let message = `Your order ${order.orderNumber} is now ${statusText}.`;
    let notificationType = "status_update";
    
    if (trackingNumber) {
        message += ` Tracking Number: ${trackingNumber}`;
    }
    
    if (statusNotes) {
        message += ` Notes: ${statusNotes}`;
    }
    
    // Payment warning for ready_to_ship
    if (newStatus === "ready_to_ship" && order.remainingPayment > 0) {
        message += `\n\n‚ö†Ô∏è IMPORTANT: Please clear remaining payment of ¬£${(order.remainingPayment || 0).toFixed(2)} within 1 hour.`;
        notificationType = "payment_warning";
    }
    
    // Thank you for delivered
    if (newStatus === "delivered") {
        title = "üéâ Order Delivered!";
        message = `Your order ${order.orderNumber} has been delivered successfully!`;
        notificationType = "thanks";
    }
    
    // Cancellation notice
    if (newStatus === "cancelled") {
        title = "‚ùå Order Cancelled";
        message = `Your order ${order.orderNumber} has been cancelled.`;
        notificationType = "cancellation";
    }
    
    return sendOrderNotification(
        order.userId,
        order._id,
        order.orderNumber,
        title,
        message,
        notificationType
    );
}

/**
 * Send payment notification
 */
async function sendPaymentNotification(order, paymentInfo) {
    const { newPaid, remaining, referenceNumber, paymentType, notes } = paymentInfo;
    
    let title = "";
    let message = "";
    let notificationType = "payment_update";
    
    if (paymentType === 'full') {
        title = "‚úÖ Payment Completed";
        message = `Full payment ¬£${newPaid.toFixed(2)} confirmed for order ${order.orderNumber}.`;
        notificationType = "thanks";
    } else if (paymentType === 'advance') {
        title = "üí∞ Advance Payment Received";
        message = `Advance payment ¬£${newPaid.toFixed(2)} received for order ${order.orderNumber}. Remaining: ¬£${remaining.toFixed(2)}.`;
    } else {
        title = "üìù Payment Updated";
        message = `Payment updated to ¬£${newPaid.toFixed(2)} for order ${order.orderNumber}. Remaining: ¬£${remaining.toFixed(2)}.`;
    }
    
    if (referenceNumber) {
        message += ` Reference: ${referenceNumber}`;
    }
    
    if (notes) {
        message += ` Notes: ${notes}`;
    }
    
    return sendOrderNotification(
        order.userId,
        order._id,
        order.orderNumber,
        title,
        message,
        notificationType
    );
}

/* ========== UTILITY FUNCTIONS ========== */

function nowISO() {
    return new Date().toISOString();
}

function hoursBetween(a, b) {
    return (new Date(b) - new Date(a)) / 36e5;
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatCurrency(amount) {
    return `¬£${(amount || 0).toFixed(2)}`;
}

function getStatusClass(status) {
    return status || "processing";
}

function getPaymentBadgeClass(paymentStatus, submittedAmount) {
    if (paymentStatus === "fully_paid") return "paid";
    if (submittedAmount > 0) return "advance";
    return "pending_payment";
}

/* ========== LOAD ORDERS ========== */
async function loadOrders() {
    loading.style.display = 'block';
    ordersContainer.innerHTML = '';
    
    // Reset stats
    let stats = {
        total: 0,
        processing: 0,
        ready_to_ship: 0,
        shipped: 0,
        delivered: 0,
        cancelled: 0,
        totalRevenue: 0
    };

    try {
        // Load orders
        const ordersQuery = query(collectionGroup(db, "orders"), orderBy("createdAt", "desc"));
        const snap = await getDocs(ordersQuery);
        
        allOrders = [];
        const orders = [];
        
        snap.forEach(doc => {
            const order = doc.data();
            order._id = doc.id;
            
            // Extract userId from path: users/{userId}/orders/{orderId}
            const pathParts = doc.ref.path.split('/');
            if (pathParts.length >= 2 && pathParts[0] === 'users') {
                order.userId = pathParts[1];
            }
            
            // Set defaults for missing fields
            order.orderNumber = order.orderNumber || `ORDER-${order._id.substring(0, 8)}`;
            order.status = order.status || 'processing';
            order.paymentStatus = order.paymentStatus || 'pending';
            order.total = order.total || 0;
            order.submittedAmount = order.submittedAmount || 0;
            order.remainingPayment = order.remainingPayment || Math.max(0, order.total - order.submittedAmount);
            order.items = order.items || [];
            
            // Auto-cancel logic
            if (order.status === "ready_to_ship" && order.remainingPayment > 0) {
                const readyTime = order.readyToShipAt || order.updatedAt || order.createdAt;
                if (readyTime && hoursBetween(readyTime, nowISO()) >= 1) {
                    // Auto-cancel order
                    setTimeout(async () => {
                        try {
                            const orderRef = doc(db, "users", order.userId, "orders", order._id);
                            await updateDoc(orderRef, {
                                status: "cancelled",
                                cancelledAt: nowISO(),
                                cancelledReason: "Payment not cleared within 1 hour",
                                updatedAt: nowISO()
                            });
                            
                            // Send cancellation notification
                            await sendOrderNotification(
                                order.userId,
                                order._id,
                                order.orderNumber,
                                "‚ùå Order Cancelled",
                                `Your order ${order.orderNumber} was cancelled because payment was not cleared within 1 hour.`,
                                "cancellation"
                            );
                            
                            // Reload orders to reflect changes
                            loadOrders();
                        } catch (error) {
                            console.error("Error auto-cancelling order:", error);
                        }
                    }, 0);
                    return; // Skip this order for display
                }
            }
            
            orders.push(order);
            allOrders.push(order);
            
            // Update stats
            stats.total++;
            stats.totalRevenue += order.total || 0;
            
            if (order.status === 'processing') stats.processing++;
            if (order.status === 'ready_to_ship') stats.ready_to_ship++;
            if (order.status === 'shipped') stats.shipped++;
            if (order.status === 'delivered') stats.delivered++;
            if (order.status === 'cancelled') stats.cancelled++;
        });
        
        // Update stats display
        document.getElementById('statsTotal').textContent = stats.total;
        document.getElementById('statsProcessing').textContent = stats.processing;
        document.getElementById('statsReady').textContent = stats.ready_to_ship;
        document.getElementById('statsShipped').textContent = stats.shipped;
        document.getElementById('statsDelivered').textContent = stats.delivered;
        document.getElementById('statsCancelled').textContent = stats.cancelled;
        document.getElementById('totalOrders').textContent = stats.total;
        document.getElementById('totalRevenue').textContent = stats.totalRevenue.toFixed(2);
        
        // Display orders
        for (const order of orders) {
            await displayOrder(order);
        }
        
        loading.style.display = 'none';
        
        if (orders.length === 0) {
            ordersContainer.innerHTML = `
                <div class="order-card" style="text-align: center; padding: 40px;">
                    <i class="fas fa-inbox" style="font-size: 48px; color: #ccc; margin-bottom: 20px;"></i>
                    <h3 style="color: #666;">No Orders Found</h3>
                    <p style="color: #888;">No orders have been placed yet.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error("Error loading orders:", error);
        loading.style.display = 'none';
        ordersContainer.innerHTML = `
            <div class="order-card" style="text-align: center; padding: 40px; background: #ffebee; border-color: #ef5350;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #c62828; margin-bottom: 20px;"></i>
                <h3 style="color: #c62828;">Error Loading Orders</h3>
                <p style="color: #666;">${error.message}</p>
                <button class="btn btn-primary" onclick="loadOrders()" style="margin-top: 20px;">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </div>
        `;
    }
}

/* ========== DISPLAY ORDER ========== */
async function displayOrder(order) {
    try {
        // Get status badge
        const statusClass = getStatusClass(order.status);
        const statusText = order.status ? order.status.replace(/_/g, ' ') : "Processing";
        
        // Get payment badge
        const paymentBadge = getPaymentBadgeClass(order.paymentStatus, order.submittedAmount);
        const paymentText = paymentBadge === "paid" ? "Fully Paid" : 
                          paymentBadge === "advance" ? "Advance Paid" : "Payment Pending";
        
        // Load products
        let productsHTML = '';
        let productCount = 0;
        let productTotal = 0;
        
        for (const item of order.items) {
            try {
                const productDoc = await getDoc(doc(db, "products", item.id || item.productId));
                const product = productDoc.exists() ? productDoc.data() : {};
                
                const img = product.images?.[0] || product.image || product.imageUrl || 
                           "https://via.placeholder.com/70/CCCCCC/666666?text=Product";
                const title = item.name || product.title || "Unknown Product";
                const price = item.totalPrice || item.price || 0;
                const qty = item.quantity || 1;
                
                productCount++;
                productTotal += price;
                
                productsHTML += `
                <div class="product-item">
                    <img src="${img}" class="product-img" alt="${title}" onerror="this.src='https://via.placeholder.com/70/CCCCCC/666666?text=Product'">
                    <div class="product-info">
                        <h5>${title}</h5>
                        <p><i class="fas fa-hashtag"></i> Qty: ${qty}</p>
                        <p><i class="fas fa-pound-sign"></i> ${formatCurrency(price)}</p>
                    </div>
                </div>`;
            } catch (error) {
                console.error("Error loading product:", error);
                // Still show item even if product data fails
                const title = item.name || "Unknown Product";
                const price = item.totalPrice || item.price || 0;
                const qty = item.quantity || 1;
                
                productCount++;
                productTotal += price;
                
                productsHTML += `
                <div class="product-item">
                    <img src="https://via.placeholder.com/70/CCCCCC/666666?text=Product" class="product-img" alt="${title}">
                    <div class="product-info">
                        <h5>${title}</h5>
                        <p><i class="fas fa-hashtag"></i> Qty: ${qty}</p>
                        <p><i class="fas fa-pound-sign"></i> ${formatCurrency(price)}</p>
                    </div>
                </div>`;
            }
        }
        
        // Format dates
        const orderDate = formatDate(order.createdAt);
        const updatedDate = formatDate(order.updatedAt);
        const deliveredDate = formatDate(order.deliveredAt);
        const cancelledDate = formatDate(order.cancelledAt);
        
        // Generate timeline
        let timelineHTML = '';
        if (order.statusHistory && order.statusHistory.length > 0) {
            timelineHTML = order.statusHistory.slice(-10).map(history => {
                const date = formatDate(history.at);
                const status = history.status ? history.status.replace(/_/g, ' ') : 'Unknown';
                const notes = history.notes ? `<br><small>${history.notes}</small>` : '';
                return `
                <div class="timeline-item">
                    <div class="timeline-date">
                        <i class="far fa-clock"></i> ${date}
                    </div>
                    <div class="timeline-content">
                        <i class="fas fa-arrow-right"></i> Status changed to <strong>${status}</strong>
                        ${notes}
                    </div>
                </div>`;
            }).join('');
        } else {
            timelineHTML = '<div class="timeline-item"><div class="timeline-content">No status history available</div></div>';
        }
        
        // Create order card
        const orderCard = document.createElement('div');
        orderCard.className = 'order-card';
        orderCard.innerHTML = `
            <!-- ORDER HEADER -->
            <div class="order-header">
                <div class="order-title">
                    <h3><i class="fas fa-receipt"></i> Order: ${order.orderNumber || 'N/A'}</h3>
                    <div class="order-meta">
                        <span><i class="far fa-calendar"></i> ${orderDate}</span>
                        <span><i class="fas fa-user"></i> ${order.userName || 'Unknown'}</span>
                        <span><i class="fas fa-envelope"></i> ${order.userEmail || 'No email'}</span>
                        <span><i class="fas fa-id-card"></i> ${order.userId?.substring(0, 8) || 'No ID'}</span>
                    </div>
                </div>
                <div class="order-status">
                    <span class="badge ${statusClass}">${statusText}</span>
                    <span class="badge ${paymentBadge}">${paymentText}</span>
                </div>
            </div>

            <!-- ORDER DETAILS -->
            <div class="order-details">
                <div class="detail-section">
                    <h4><i class="fas fa-money-bill-wave"></i> Payment Details</h4>
                    <p><strong>Total Amount:</strong> ${formatCurrency(order.total)}</p>
                    <p><strong>Amount Paid:</strong> ${formatCurrency(order.submittedAmount)}</p>
                    <p><strong>Remaining:</strong> ${formatCurrency(order.remainingPayment)}</p>
                    ${order.transactionReference ? `<p><strong>Transaction Ref:</strong> ${order.transactionReference}</p>` : ''}
                </div>
                
                <div class="detail-section">
                    <h4><i class="fas fa-shipping-fast"></i> Shipping Info</h4>
                    ${order.trackingNumber ? `<p><strong>Tracking:</strong> ${order.trackingNumber}</p>` : ''}
                    ${order.shippingAddress ? `<p><strong>Address:</strong> ${order.shippingAddress}</p>` : ''}
                    ${order.deliveredAt ? `<p><strong>Delivered:</strong> ${deliveredDate}</p>` : ''}
                    ${order.cancelledAt ? `<p><strong>Cancelled:</strong> ${cancelledDate}</p>` : ''}
                </div>
                
                <div class="detail-section">
                    <h4><i class="fas fa-info-circle"></i> Order Info</h4>
                    <p><strong>Order ID:</strong> ${order._id}</p>
                    <p><strong>Last Updated:</strong> ${updatedDate}</p>
                    <p><strong>Items:</strong> ${productCount} products</p>
                    <p><strong>Products Total:</strong> ${formatCurrency(productTotal)}</p>
                </div>
            </div>

            <!-- PRODUCTS -->
            <div class="products-section">
                <h4><i class="fas fa-box-open"></i> Products (${productCount})</h4>
                <div class="products-grid">
                    ${productsHTML}
                </div>
            </div>

            <!-- UPDATE FORMS -->
            <div class="update-forms">
                <!-- ACTIONS -->
                <div class="form-section">
                    <h4><i class="fas fa-cogs"></i> Order Actions</h4>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="openPaymentModal('${order.userId}','${order._id}','${order.orderNumber}',${order.total},${order.submittedAmount},${order.remainingPayment})">
                            <i class="fas fa-credit-card"></i> Update Payment
                        </button>
                        <button class="btn btn-primary" onclick="openStatusModal('${order.userId}','${order._id}','${order.orderNumber}','${order.status}','${order.trackingNumber || ''}',${order.remainingPayment})">
                            <i class="fas fa-exchange-alt"></i> Update Status
                        </button>
                        <button class="btn btn-danger" onclick="cancelOrder('${order.userId}','${order._id}','${order.orderNumber}')">
                            <i class="fas fa-times-circle"></i> Cancel Order
                        </button>
                    </div>
                </div>
            </div>

            <!-- TIMELINE -->
            <div class="timeline-section">
                <h4><i class="fas fa-history"></i> Status History</h4>
                <div class="timeline">
                    ${timelineHTML}
                </div>
            </div>
        `;

        ordersContainer.appendChild(orderCard);
    } catch (error) {
        console.error("Error displaying order:", error);
    }
}

/* ========== MODAL FUNCTIONS ========== */

// Payment Modal
window.openPaymentModal = function(userId, orderId, orderNumber, total, paid, remaining) {
    currentOrder = {
        userId: userId,
        orderId: orderId,
        orderNumber: orderNumber,
        total: total,
        paid: paid,
        remaining: remaining
    };
    
    // Set modal values
    document.getElementById('modalOrderTotal').textContent = formatCurrency(total);
    document.getElementById('modalCurrentPaid').textContent = formatCurrency(paid);
    document.getElementById('modalRemaining').textContent = formatCurrency(remaining);
    
    // Set default values
    document.getElementById('paidAmount').value = paid;
    document.getElementById('transactionRef').value = '';
    document.getElementById('paymentNotes').value = '';
    
    // Set default date to now
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('paymentDate').value = localDateTime;
    
    // Hide calculation results
    document.getElementById('calcResults').style.display = 'none';
    
    // Show modal
    paymentModal.style.display = 'flex';
};

window.closePaymentModal = function() {
    paymentModal.style.display = 'none';
    currentOrder = null;
    document.getElementById('calcResults').style.display = 'none';
};

window.calculatePayment = function() {
    if (!currentOrder) return;
    
    const paymentType = document.getElementById('paymentType').value;
    const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
    const total = currentOrder.total;
    
    let newPaid = paidAmount;
    let newRemaining = Math.max(total - newPaid, 0);
    let paymentStatus = 'pending';
    
    if (paymentType === 'full') {
        newPaid = total;
        newRemaining = 0;
        paymentStatus = 'fully_paid';
        document.getElementById('paidAmount').value = total;
    } else if (paymentType === 'advance' && paidAmount > 0) {
        paymentStatus = 'advance_paid';
    } else if (paidAmount > 0 && paidAmount < total) {
        paymentStatus = 'advance_paid';
    }
    
    // Update display
    document.getElementById('newPaidAmount').textContent = formatCurrency(newPaid);
    document.getElementById('newRemaining').textContent = formatCurrency(newRemaining);
    document.getElementById('newPaymentStatus').textContent = paymentStatus.replace(/_/g, ' ');
    
    // Show results
    document.getElementById('calcResults').style.display = 'block';
    
    // Update button text
    const btn = document.getElementById('savePaymentBtn');
    if (paymentType === 'full') {
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Full Payment';
    } else if (paymentType === 'advance') {
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Advance Payment';
    } else {
        btn.innerHTML = '<i class="fas fa-save"></i> Save Payment';
    }
};

window.savePayment = async function() {
    if (!currentOrder) {
        alert("No order selected!");
        return;
    }
    
    const paidAmount = parseFloat(document.getElementById('paidAmount').value);
    const paymentType = document.getElementById('paymentType').value;
    const transactionRef = document.getElementById('transactionRef').value.trim();
    const paymentDate = document.getElementById('paymentDate').value;
    const paymentNotes = document.getElementById('paymentNotes').value.trim();
    
    if (!paidAmount || paidAmount < 0) {
        alert("Please enter a valid payment amount");
        return;
    }
    
    if (!paymentDate) {
        alert("Please select payment date and time");
        return;
    }
    
    if (!transactionRef) {
        alert("Please enter transaction reference");
        return;
    }
    
    try {
        const orderRef = doc(db, "users", currentOrder.userId, "orders", currentOrder.orderId);
        
        // Get current order data
        const orderSnap = await getDoc(orderRef);
        if (!orderSnap.exists()) {
            alert("Order not found!");
            return;
        }
        
        const orderData = orderSnap.data();
        
        // Calculate new values
        const newPaid = paidAmount;
        const total = orderData.total || currentOrder.total || 0;
        const remaining = Math.max(total - newPaid, 0);
        
        // Determine payment status
        let paymentStatus = 'pending';
        if (remaining <= 0) {
            paymentStatus = 'fully_paid';
        } else if (newPaid > 0 && newPaid < total) {
            paymentStatus = 'advance_paid';
        }
        
        // Prepare update data
        const updateData = {
            paymentStatus: paymentStatus,
            submittedAmount: newPaid,
            remainingPayment: remaining,
            transactionReference: transactionRef,
            paymentSubmittedAt: paymentDate || nowISO(),
            updatedAt: nowISO()
        };
        
        // Add to payment history
        const paymentHistory = orderData.paymentHistory || [];
        paymentHistory.push({
            type: paymentType,
            amount: newPaid,
            previousAmount: orderData.submittedAmount || 0,
            reference: transactionRef,
            date: paymentDate || nowISO(),
            notes: paymentNotes,
            status: "confirmed",
            updatedBy: "admin"
        });
        
        updateData.paymentHistory = paymentHistory;
        
        // Update order
        await updateDoc(orderRef, updateData);
        
        // Send notification
        await sendPaymentNotification(orderData, {
            newPaid: newPaid,
            remaining: remaining,
            referenceNumber: transactionRef,
            paymentType: paymentType,
            notes: paymentNotes
        });
        
        alert(`‚úÖ Payment updated successfully!\n\nOrder: ${currentOrder.orderNumber}\nAmount: ${formatCurrency(newPaid)}\nRemaining: ${formatCurrency(remaining)}\nStatus: ${paymentStatus}`);
        
        // Close modal and reload
        closePaymentModal();
        loadOrders();
        
    } catch (error) {
        console.error("Error saving payment:", error);
        alert("‚ùå Error saving payment: " + error.message);
    }
};

// Status Modal
window.openStatusModal = function(userId, orderId, orderNumber, currentStatus, trackingNumber, remainingPayment) {
    currentOrder = {
        userId: userId,
        orderId: orderId,
        orderNumber: orderNumber,
        currentStatus: currentStatus,
        trackingNumber: trackingNumber,
        remainingPayment: remainingPayment
    };
    
    // Set modal values
    document.getElementById('modalOrderNumber').textContent = `Order: ${orderNumber}`;
    document.getElementById('modalCustomerInfo').textContent = `Remaining Payment: ${formatCurrency(remainingPayment)}`;
    
    // Set current values
    document.getElementById('statusTracking').value = trackingNumber || '';
    document.getElementById('statusNotes').value = '';
    
    // Set default date to now
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('statusDateTime').value = localDateTime;
    
    // Reset all status buttons
    document.querySelectorAll('#statusModal .btn').forEach(btn => {
        btn.className = btn.className.replace(' btn-success', '');
        if (btn.id === `status${currentStatus.charAt(0).toUpperCase() + currentStatus.slice(1)}`) {
            btn.className += ' btn-success';
        }
    });
    
    selectedStatus = currentStatus;
    
    // Show modal
    statusModal.style.display = 'flex';
};

window.closeStatusModal = function() {
    statusModal.style.display = 'none';
    currentOrder = null;
    selectedStatus = null;
};

window.selectStatus = function(status) {
    selectedStatus = status;
    
    // Update button styles
    document.querySelectorAll('#statusModal .btn').forEach(btn => {
        btn.className = btn.className.replace(' btn-success', '');
        if (btn.textContent.includes(status.replace(/_/g, ' '))) {
            btn.className += ' btn-success';
        }
    });
};

window.saveStatus = async function() {
    if (!currentOrder || !selectedStatus) {
        alert("Please select a status");
        return;
    }
    
    const trackingNumber = document.getElementById('statusTracking').value.trim();
    const statusDateTime = document.getElementById('statusDateTime').value;
    const statusNotes = document.getElementById('statusNotes').value.trim();
    
    if (!statusDateTime) {
        alert("Please select status date and time");
        return;
    }
    
    try {
        const orderRef = doc(db, "users", currentOrder.userId, "orders", currentOrder.orderId);
        
        // Get current order data
        const orderSnap = await getDoc(orderRef);
        if (!orderSnap.exists()) {
            alert("Order not found!");
            return;
        }
        
        const orderData = orderSnap.data();
        
        // Prepare update data
        const updateData = {
            status: selectedStatus,
            updatedAt: nowISO()
        };
        
        // Add tracking number if provided
        if (trackingNumber) {
            updateData.trackingNumber = trackingNumber;
        }
        
        // Prepare status history entry
        const statusHistoryEntry = {
            status: selectedStatus,
            at: statusDateTime || nowISO(),
            notes: statusNotes,
            tracking: trackingNumber || null,
            updatedBy: "admin"
        };
        
        // Update status history
        const statusHistory = orderData.statusHistory || [];
        statusHistory.push(statusHistoryEntry);
        updateData.statusHistory = statusHistory;
        
        // Handle specific status updates
        if (selectedStatus === "ready_to_ship") {
            updateData.readyToShipAt = statusDateTime || nowISO();
        }
        
        if (selectedStatus === "shipped") {
            updateData.shippedAt = statusDateTime || nowISO();
        }
        
        if (selectedStatus === "out_for_delivery") {
            updateData.outForDeliveryAt = statusDateTime || nowISO();
        }
        
        if (selectedStatus === "delivered") {
            updateData.deliveredAt = statusDateTime || nowISO();
            // Mark as fully paid if delivered
            updateData.remainingPayment = 0;
            updateData.paymentStatus = 'fully_paid';
        }
        
        if (selectedStatus === "cancelled") {
            updateData.cancelledAt = statusDateTime || nowISO();
            updateData.cancelledReason = statusNotes || "Cancelled by admin";
        }
        
        // Update order
        await updateDoc(orderRef, updateData);
        
        // Send notification
        await sendStatusNotification(orderData, {
            newStatus: selectedStatus,
            trackingNumber: trackingNumber,
            statusNotes: statusNotes
        });
        
        // Special handling for ready_to_ship status with remaining payment
        if (selectedStatus === "ready_to_ship" && currentOrder.remainingPayment > 0) {
            await sendPaymentWarningNotification({
                ...orderData,
                remainingPayment: currentOrder.remainingPayment
            });
        }
        
        alert(`‚úÖ Status updated to ${selectedStatus.replace(/_/g, ' ')} for order ${currentOrder.orderNumber}`);
        
        // Close modal and reload
        closeStatusModal();
        loadOrders();
        
    } catch (error) {
        console.error("Error updating status:", error);
        alert("‚ùå Error updating status: " + error.message);
    }
};

/* ========== CANCEL ORDER ========== */
window.cancelOrder = async function(userId, orderId, orderNumber) {
    if (!confirm(`Are you sure you want to cancel order ${orderNumber}?`)) return;
    
    try {
        const orderRef = doc(db, "users", userId, "orders", orderId);
        
        // Get current order data
        const orderSnap = await getDoc(orderRef);
        if (!orderSnap.exists()) {
            alert("Order not found!");
            return;
        }
        
        const orderData = orderSnap.data();
        
        // Prepare update data
        const updateData = {
            status: "cancelled",
            cancelledAt: nowISO(),
            cancelledReason: "Cancelled by admin",
            updatedAt: nowISO()
        };
        
        // Update status history
        const statusHistory = orderData.statusHistory || [];
        statusHistory.push({
            status: "cancelled",
            at: nowISO(),
            notes: "Order cancelled by admin",
            updatedBy: "admin"
        });
        updateData.statusHistory = statusHistory;
        
        // Update order
        await updateDoc(orderRef, updateData);
        
        // Send notification
        await sendOrderNotification(
            userId,
            orderId,
            orderNumber,
            "‚ùå Order Cancelled",
            `Your order ${orderNumber} has been cancelled by admin.`,
            "cancellation"
        );
        
        alert(`‚úÖ Order ${orderNumber} has been cancelled.`);
        
        // Reload orders
        loadOrders();
        
    } catch (error) {
        console.error("Error cancelling order:", error);
        alert("‚ùå Error cancelling order: " + error.message);
    }
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
    console.log("Admin dashboard initialized!");
});
</script>
</body>
</html>

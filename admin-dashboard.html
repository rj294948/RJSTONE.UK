<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin – IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f4f6f8; padding:15px; }
.order { background:#fff; padding:15px; margin-bottom:15px; border-radius:8px; }
.badge { padding:4px 8px; border-radius:4px; font-size:12px; font-weight:bold; }
.advance { background:#ffc107; }
.full { background:#28a745; color:#fff; }
.pending { background:#dc3545; color:#fff; }
img { width:80px; border-radius:6px; margin-right:10px; }
.row { display:flex; gap:10px; align-items:center; }
button { padding:6px 10px; margin-top:6px; }
input, select { width:100%; padding:6px; margin-top:5px; }
.disabled { opacity:.5; pointer-events:none; }
</style>
</head>

<body>

<h2>Admin Orders Panel</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore,
  collectionGroup,
  getDocs,
  updateDoc,
  addDoc,
  collection,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
});

const db = getFirestore(app);
const ordersDiv = document.getElementById("orders");

/* ================= LOAD ORDERS ================= */
async function loadOrders() {
  ordersDiv.innerHTML = "";
  const snap = await getDocs(collectionGroup(db, "orders"));

  for (const d of snap.docs) {
    const o = d.data();
    const orderRef = d.ref;

    const pending = Math.max(0, (o.total || 0) - (o.advancePayment || 0));
    const isFull = pending === 0;

    // product image
    let image = "";
    if (o.items?.[0]?.id) {
      const p = await getDoc(doc(db,"products",o.items[0].id));
      image = p.exists() ? p.data().imageUrl : "";
    }

    ordersDiv.innerHTML += `
      <div class="order">
        <div class="row">
          ${image ? `<img src="${image}">` : ""}
          <div>
            <b>${o.orderNumber}</b><br>
            <span class="badge ${isFull ? "full":"advance"}">
              ${isFull ? "FULL PAID" : "ADVANCE PAID"}
            </span>
          </div>
        </div>

        <p><b>${o.userName}</b> | ${o.userEmail}</p>
        <p>${o.shippingAddress?.address1}, ${o.shippingAddress?.city}</p>

        <p>Total: £${o.total}</p>
        <p>Advance Paid: £${o.advancePayment || 0}</p>
        <p><b>Pending: £${pending}</b></p>

        <select id="pay-${d.id}">
          <option value="">-- Payment Action --</option>
          <option value="advance">Confirm Advance</option>
          <option value="full">Confirm Full Payment</option>
          <option value="reminder">Send Pending Warning</option>
        </select>

        <button onclick="updatePayment('${d.id}')">Update Payment</button>

        <div class="${isFull ? "" : "disabled"}">
          <input id="track-${d.id}" placeholder="Tracking Number">
          <input id="date-${d.id}" type="date">
          <button onclick="updateShipping('${d.id}')">Ship Order</button>
        </div>
      </div>
    `;

    window[`orderRef_${d.id}`] = orderRef;
    window[`orderData_${d.id}`] = o;
  }
}

/* ================= PAYMENT ================= */
window.updatePayment = async (id) => {
  const ref = window[`orderRef_${id}`];
  const o = window[`orderData_${id}`];
  const action = document.getElementById(`pay-${id}`).value;

  if (!action) return alert("Select option");

  let msg = "";

  if (action === "advance") {
    msg = `Advance received. Remaining £${o.total - o.advancePayment}. 
    Pay within 24 hours or order will be cancelled. Advance non-refundable.`;
  }

  if (action === "full") {
    await updateDoc(ref,{ paymentStatus:"fully_paid" });
    msg = "Full payment confirmed. Preparing shipment.";
  }

  if (action === "reminder") {
    msg = `£${o.total - o.advancePayment} pending. 
    Pay within 24 hours. Order may cancel.`;
  }

  await addDoc(collection(db,"users",o.userId,"notifications"),{
    type:"payment",
    orderNumber:o.orderNumber,
    message:msg,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Payment action done");
  loadOrders();
};

/* ================= SHIPPING ================= */
window.updateShipping = async (id) => {
  const ref = window[`orderRef_${id}`];
  const o = window[`orderData_${id}`];
  const track = document.getElementById(`track-${id}`).value;
  const date = document.getElementById(`date-${id}`).value;

  if (!track) return alert("Tracking required");

  await updateDoc(ref,{
    shippingStatus:"shipped",
    trackingNumber:track,
    deliveryDate:date
  });

  await addDoc(collection(db,"users",o.userId,"notifications"),{
    type:"shipping",
    orderNumber:o.orderNumber,
    message:`Shipped. Tracking: ${track}`,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Shipped");
  loadOrders();
};

loadOrders();
</script>
</body>
</html>

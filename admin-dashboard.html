<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IRYA STONE Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; background: #f4f6f8; padding: 20px; }
h2 { text-align: center; margin-bottom: 20px; }
.order-card { background: #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.order-header { display: flex; justify-content: space-between; align-items: center; }
.badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
.badge.advance { background: #ffc107; color: #000; }
.badge.full { background: #28a745; color: #fff; }
.order-body { margin-top: 10px; }
.order-body p { margin: 4px 0; }
.order-body img { max-width: 80px; margin-right: 10px; vertical-align: middle; border-radius: 4px; }
.order-actions { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
input, select { padding: 6px; width: 150px; }
button { padding: 6px 10px; cursor: pointer; }
.timeline { margin-top: 10px; font-size: 13px; color: #555; }
.timeline div { margin-bottom: 4px; }
</style>
</head>
<body>

<h2>Admin Orders Panel</h2>
<div id="ordersContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collectionGroup, getDocs, doc, updateDoc, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5",
  measurementId: "G-6YM1FLYN48"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ordersContainer = document.getElementById("ordersContainer");

// ================= LOAD ORDERS =================
async function loadOrders() {
  ordersContainer.innerHTML = "";
  const ordersQuery = query(collectionGroup(db, "orders"), orderBy("createdAt", "desc"));
  const snapshot = await getDocs(ordersQuery);

  snapshot.forEach(docSnap => {
    const o = docSnap.data();
    const orderId = docSnap.id;

    // Determine payment badge
    let badgeClass = "advance";
    let badgeText = "ADVANCE PAID";
    if (o.paymentStatus === "fully_paid") {
      badgeClass = "full";
      badgeText = "FULL PAID";
    }

    // Remaining Payment Handling
    const remaining = o.total - (o.advancePayment || 0);

    // Render Product Images & Title
    let itemsHtml = "";
    if (o.items && o.items.length) {
      o.items.forEach(item => {
        itemsHtml += `<div><img src="${item.imageURL || 'https://via.placeholder.com/80'}" alt="${item.name}"><strong>${item.name}</strong> | Qty: ${item.quantity} | Unit: ${item.priceUnit}</div>`;
      });
    }

    // Timeline
    let timelineHtml = `<div class="timeline">
      <div><b>Order Placed:</b> ${new Date(o.createdAt).toLocaleString()}</div>`;
    if (o.paymentStatus === "advance_paid") {
      timelineHtml += `<div><b>Advance Payment Confirmed:</b> ${new Date(o.updatedAt).toLocaleString()}</div>`;
    } else if (o.paymentStatus === "fully_paid") {
      timelineHtml += `<div><b>Payment Confirmed:</b> ${new Date(o.updatedAt).toLocaleString()}</div>`;
    }
    if (o.shippingStatus) {
      timelineHtml += `<div><b>Shipped:</b> ${new Date(o.shippedAt).toLocaleString()} | Tracking: ${o.trackingNumber || '-'}</div>`;
    }
    if (o.deliveryStatus) {
      timelineHtml += `<div><b>Delivered:</b> ${new Date(o.deliveryDate).toLocaleString()}</div>`;
    }
    if (o.autoCancel) {
      timelineHtml += `<div><b>Auto Cancel Date:</b> ${new Date(o.autoCancelDate).toLocaleString()}</div>`;
    }
    timelineHtml += `</div>`;

    ordersContainer.innerHTML += `
      <div class="order-card">
        <div class="order-header">
          <span><b>${o.orderNumber}</b></span>
          <span class="badge ${badgeClass}">${badgeText}</span>
        </div>
        <div class="order-body">
          <p>User: ${o.userName} | Email: ${o.userEmail}</p>
          <p>Phone: ${o.shippingAddress?.phone || o.billingAddress?.phone}</p>
          <p>Total: £${o.total} | Paid: £${o.advancePayment || 0} | Remaining: £${remaining}</p>
          ${itemsHtml}
          ${timelineHtml}
        </div>
        <div class="order-actions">
          <select id="payment-${orderId}">
            <option value="">-- Update Payment --</option>
            <option value="advance_paid">Advance Paid</option>
            <option value="fully_paid">Full Paid</option>
          </select>
          <button onclick="updatePayment('${o.userId}','${orderId}')">Update Payment</button>

          <input type="text" id="tracking-${orderId}" placeholder="Tracking Number">
          <button onclick="updateShipping('${o.userId}','${orderId}')">Update Shipping</button>

          <input type="datetime-local" id="delivery-${orderId}">
          <button onclick="updateDelivery('${o.userId}','${orderId}')">Confirm Delivery</button>
        </div>
      </div>
    `;
  });
}

// ================= UPDATE PAYMENT =================
window.updatePayment = async (userId, orderId) => {
  const select = document.getElementById(`payment-${orderId}`);
  const val = select.value;
  if (!val) return alert("Select payment status");

  const orderRef = doc(db,"users",userId,"orders",orderId);
  const updatedAt = new Date().toISOString();

  let advancePayment = 0, paymentStatus = "advance_paid";
  if (val === "advance_paid") {
    advancePayment = 0.3 * 100; // Example 30% placeholder, adjust based on real order
    paymentStatus = "advance_paid";
  } else if (val === "fully_paid") {
    advancePayment = 100; // Example full amount
    paymentStatus = "fully_paid";
  }

  await updateDoc(orderRef, {
    paymentStatus,
    advancePayment,
    updatedAt,
    autoCancel: val === "advance_paid",
    autoCancelDate: val === "advance_paid" ? new Date(Date.now() + 24*60*60*1000).toISOString() : null
  });

  // Add notification
  await addDoc(collection(db,"users",userId,"notifications"),{
    type:"payment",
    title:"Payment Update",
    message: val === "fully_paid" ? "Your full payment has been confirmed." : "Your advance payment is confirmed. Remaining payment pending. Order will auto-cancel after 24 hours if not completed.",
    orderId,
    createdAt: updatedAt,
    read:false
  });

  alert("Payment updated successfully");
  loadOrders();
};

// ================= UPDATE SHIPPING =================
window.updateShipping = async (userId, orderId) => {
  const track = document.getElementById(`tracking-${orderId}`).value;
  if (!track) return alert("Enter tracking number");

  const orderRef = doc(db,"users",userId,"orders",orderId);
  const shippedAt = new Date().toISOString();

  await updateDoc(orderRef, {
    shippingStatus: "shipped",
    trackingNumber: track,
    shippedAt
  });

  // Notification
  await addDoc(collection(db,"users",userId,"notifications"),{
    type:"shipping",
    title:"Order Shipped",
    message:`Your order has been shipped. Tracking Number: ${track}`,
    orderId,
    createdAt: shippedAt,
    read:false
  });

  alert("Shipping updated successfully");
  loadOrders();
};

// ================= CONFIRM DELIVERY =================
window.updateDelivery = async (userId, orderId) => {
  const deliveryInput = document.getElementById(`delivery-${orderId}`);
  if (!deliveryInput.value) return alert("Select delivery date/time");

  const deliveryDate = new Date(deliveryInput.value).toISOString();
  const orderRef = doc(db,"users",userId,"orders",orderId);

  await updateDoc(orderRef, {
    deliveryStatus: "delivered",
    deliveryDate
  });

  await addDoc(collection(db,"users",userId,"notifications"),{
    type:"delivery",
    title:"Order Delivered",
    message:`Your order has been delivered on ${new Date(deliveryDate).toLocaleString()}`,
    orderId,
    createdAt: new Date().toISOString(),
    read:false
  });

  alert("Delivery confirmed");
  loadOrders();
};

loadOrders();
</script>
</body>
</html>

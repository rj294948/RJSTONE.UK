<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IRYA STONE â€“ Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:Inter,sans-serif;
  background:#f4f7fa;
  margin:0;
  padding:20px;
}
h2{margin-bottom:20px}
.section{margin-bottom:30px}

.order{
  background:#fff;
  border-radius:14px;
  padding:16px;
  margin-bottom:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.07);
  border-left:5px solid #ccc;
}

.top{
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}

.badge{
  padding:5px 12px;
  border-radius:20px;
  font-size:12px;
  font-weight:700;
}
.paid{background:#28a745;color:#fff}
.advance{background:#ffc107}
.processing{background:#6f42c1;color:#fff}
.ready{background:#0dcaf0}
.shipped{background:#17a2b8;color:#fff}
.delivered{background:#007bff;color:#fff}
.cancelled{background:#dc3545;color:#fff}

.addr{
  background:#f8f9fa;
  padding:10px;
  border-radius:10px;
  font-size:13px;
  margin:12px 0;
}

.products{background:#f7fafc;padding:10px;border-radius:10px}
.product{
  display:flex;gap:10px;margin-bottom:8px
}
.product img{width:55px;height:55px;border-radius:8px;object-fit:cover}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}

input,select,button{
  padding:9px;
  border-radius:8px;
  border:1px solid #ccc;
  width:100%;
}

button{
  background:#000;
  color:#fff;
  border:none;
  cursor:pointer;
  font-weight:600;
}

.timeline{
  font-size:12px;
  color:#666;
  margin-top:10px;
}
</style>
</head>

<body>

<h2>ðŸ’Ž IRYA STONE â€“ Admin Orders</h2>

<div class="section">
<h3>âœ… Fully Paid Orders</h3>
<div id="paidOrders"></div>
</div>

<div class="section">
<h3>âš  Pending / Advance Orders</h3>
<div id="pendingOrders"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collectionGroup, getDocs,
  doc, getDoc, updateDoc, addDoc, collection,
  query, orderBy, limit, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyDNW...",
  authDomain:"iryastone-uk.firebaseapp.com",
  projectId:"iryastone-uk"
});
const db = getFirestore(app);

const paidBox=document.getElementById("paidOrders");
const pendingBox=document.getElementById("pendingOrders");

const now=()=>new Date().toISOString();
const hours=(a,b)=>(new Date(b)-new Date(a))/36e5;
const money=a=>`Â£${(+a||0).toFixed(2)}`;

async function notify(uid,title,msg){
  const ref=collection(db,"users",uid,"notifications");
  await addDoc(ref,{title,message:msg,createdAt:now(),read:false});
  const q=query(ref,orderBy("createdAt","desc"),limit(11));
  const s=await getDocs(q);
  if(s.size>10) s.docs.slice(10).forEach(d=>deleteDoc(d.ref));
}

async function loadOrders(){
  paidBox.innerHTML="";
  pendingBox.innerHTML="";
  const snap=await getDocs(collectionGroup(db,"orders"));

  for(const d of snap.docs){
    const o=d.data(); o.id=d.id;

    if(o.status==="ready_to_ship" && o.remainingPayment>0){
      if(hours(o.readyToShipAt||o.updatedAt,now())>=1){
        await updateDoc(doc(db,"users",o.userId,"orders",o.id),{
          status:"cancelled",cancelledAt:now()
        });
        await notify(o.userId,"Order Cancelled",
          `Order ${o.orderNumber} cancelled due to pending payment.`);
        continue;
      }
    }

    render(o);
  }
}

async function render(o){
  const box=o.paymentStatus==="fully_paid"?paidBox:pendingBox;

  const status=o.status||"processing";
  const pay=o.paymentStatus==="fully_paid"?"paid":"advance";

  let prods="";
  for(const it of o.items||[]){
    const ps=await getDoc(doc(db,"products",it.id));
    const p=ps.exists()?ps.data():{};
    prods+=`
    <div class="product">
      <img src="${p.images?.[0]||'https://via.placeholder.com/55'}">
      <div>
        <b>${p.title||it.name}</b><br>
        Qty ${it.quantity} â€¢ ${money(it.totalPrice)}
      </div>
    </div>`;
  }

  box.innerHTML+=`
  <div class="order" style="border-color:${pay==='paid'?'#28a745':'#ffc107'}">
    <div class="top">
      <div>
        <b>#${o.orderNumber}</b><br>
        <span class="badge ${status}">${status.replaceAll("_"," ")}</span>
        <span class="badge ${pay}">${pay==='paid'?'Paid':'Advance'}</span>
      </div>
      <div>
        <b>${money(o.total)}</b><br>
        Paid ${money(o.submittedAmount)}<br>
        Due ${money(o.remainingPayment)}
      </div>
    </div>

    <div class="addr">
      <b>${o.shippingAddress?.fullName}</b><br>
      ${o.shippingAddress?.address1}, ${o.shippingAddress?.city}<br>
      ${o.shippingAddress?.state} - ${o.shippingAddress?.postalCode}
    </div>

    <div class="products">${prods}</div>

    <div class="grid">
      <select id="pay-${o.id}">
        <option value="">Payment</option>
        <option value="advance">Advance</option>
        <option value="full">Full</option>
      </select>
      <input id="amt-${o.id}" placeholder="Amount">
      <input id="ref-${o.id}" placeholder="Reference No">
      <button onclick="pay('${o.userId}','${o.id}','${o.orderNumber}',${o.total})">Confirm Payment</button>
    </div>

    <div class="grid">
      <select id="st-${o.id}">
        <option value="">Status</option>
        <option value="processing">Processing</option>
        <option value="ready_to_ship">Ready to Ship</option>
        <option value="shipped">Shipped</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>
      <input id="trk-${o.id}" placeholder="Tracking No">
      <button onclick="status('${o.userId}','${o.id}','${o.orderNumber}')">Update Status</button>
    </div>

    <div class="timeline">
      ${(o.statusHistory||[]).map(h=>`â€¢ ${h.status} â€“ ${new Date(h.at).toLocaleString()}`).join("<br>")}
    </div>
  </div>`;
}

window.pay=async(uid,id,ord,total)=>{
  const type=document.getElementById(`pay-${id}`).value;
  const amt=+document.getElementById(`amt-${id}`).value;
  const ref=document.getElementById(`ref-${id}`).value;
  if(!type||!amt) return alert("Enter payment");

  const r=doc(db,"users",uid,"orders",id);
  const s=await getDoc(r);
  const o=s.data();

  const paid=(o.submittedAmount||0)+amt;
  const rem=Math.max(total-paid,0);

  await updateDoc(r,{
    submittedAmount:paid,
    remainingPayment:rem,
    paymentStatus:paid>=total?"fully_paid":"advance_paid",
    transactionReference:ref,
    updatedAt:now()
  });

  await notify(uid,"Payment Update",
    paid>=total?`Full payment confirmed for ${ord}`:
    `Payment received. Remaining ${money(rem)}`);

  loadOrders();
};

window.status=async(uid,id,ord)=>{
  const st=document.getElementById(`st-${id}`).value;
  const tr=document.getElementById(`trk-${id}`).value;
  if(!st) return;

  const r=doc(db,"users",uid,"orders",id);
  const s=await getDoc(r);
  const o=s.data();

  const h=[...(o.statusHistory||[]),{status:st,at:now()}];

  const u={status:st,trackingNumber:tr,updatedAt:now(),statusHistory:h};

  if(st==="ready_to_ship" && o.remainingPayment>0){
    u.readyToShipAt=now();
    await notify(uid,"Urgent Payment",
      `Clear remaining payment within 1 hour or order will cancel.`);
  }

  if(st==="delivered"){u.remainingPayment=0;u.deliveredAt=now();}

  await updateDoc(r,u);
  await notify(uid,"Order Update",`Order ${ord} is now ${st.replaceAll("_"," ")}`);
  loadOrders();
};

loadOrders();
</script>
</body>
</html>

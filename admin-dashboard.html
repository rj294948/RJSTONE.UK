<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IRYA STONE – Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Segoe UI;background:#f4f6f8;margin:0;padding:15px}
h2,h3{margin:10px 0}
.section{margin-bottom:30px}
.order{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 6px 16px rgba(0,0,0,.08)}
.flex{display:flex;gap:12px;align-items:center}
.product-img{width:70px;height:70px;border-radius:8px;object-fit:cover}
.badge{padding:4px 10px;border-radius:8px;font-size:12px;margin-left:6px}
.paid{background:#28a745;color:#fff}
.advance{background:#ffc107}
.processing{background:#6f42c1;color:#fff}
.ready{background:#0dcaf0;color:#000}
.shipped{background:#17a2b8;color:#fff}
.delivered{background:#007bff;color:#fff}
.cancelled{background:#dc3545;color:#fff}
input,select,button{padding:7px;margin-top:6px;width:100%}
button{background:#000;color:#fff;border:none;border-radius:8px;cursor:pointer}
hr{border:none;border-top:1px solid #ddd;margin:10px 0}
.timeline{font-size:12px;color:#555;margin-top:8px}
.addr{font-size:13px;background:#f8f9fa;padding:8px;border-radius:8px}
</style>
</head>

<body>

<h2>Admin Orders Dashboard</h2>

<div class="section">
<h3>✅ Fully Paid Orders</h3>
<div id="paidOrders"></div>
</div>

<div class="section">
<h3>⚠ Pending / Advance Orders</h3>
<div id="pendingOrders"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collectionGroup, getDocs,
  doc, getDoc, updateDoc, addDoc, collection,
  query, orderBy, limit, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDNW...",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk"
});
const db = getFirestore(app);

const paidBox=document.getElementById("paidOrders");
const pendingBox=document.getElementById("pendingOrders");

const now=()=>new Date().toISOString();
const hoursDiff=(a,b)=> (new Date(b)-new Date(a))/36e5;

/* ---------------- NOTIFICATION (MAX 10) ---------------- */
async function notify(userId,title,msg){
  const ref=collection(db,"users",userId,"notifications");
  await addDoc(ref,{title,message:msg,createdAt:now(),read:false});

  const q=query(ref,orderBy("createdAt","desc"));
  const snap=await getDocs(q);
  if(snap.size>10){
    snap.docs.slice(10).forEach(d=>deleteDoc(d.ref));
  }
}

/* ---------------- LOAD ORDERS ---------------- */
async function loadOrders(){
  paidBox.innerHTML="";
  pendingBox.innerHTML="";

  const snap=await getDocs(collectionGroup(db,"orders"));
  for(const d of snap.docs){
    const o=d.data();
    const oid=d.id;

    /* AUTO CANCEL AFTER READY TO SHIP 1 HOUR */
    if(o.status==="ready_to_ship" && o.remainingPayment>0){
      if(hoursDiff(o.readyToShipAt||o.updatedAt,now())>=1){
        await updateDoc(doc(db,"users",o.userId,"orders",oid),{
          status:"cancelled",
          cancelledAt:now()
        });
        await notify(o.userId,"Order Cancelled",
          `Order ${o.orderNumber} cancelled. Remaining payment not cleared. Advance non-refundable.`);
        continue;
      }
    }

    const box=o.paymentStatus==="fully_paid"?paidBox:pendingBox;

    let badge=o.status==="cancelled"?"cancelled":
      o.status==="delivered"?"delivered":
      o.status==="shipped"?"shipped":
      o.status==="ready_to_ship"?"ready":
      o.status==="processing"?"processing":
      o.paymentStatus==="fully_paid"?"paid":"advance";

    let products="";
    for(const it of o.items||[]){
      const ps=await getDoc(doc(db,"products",it.id));
      const p=ps.exists()?ps.data():{};
      products+=`
      <div class="flex">
        <img src="${p.images?.[0]||'https://via.placeholder.com/70'}" class="product-img">
        <div>
          <b>${p.title||it.name}</b><br>
          Qty ${it.quantity} | £${it.totalPrice}
        </div>
      </div>`;
    }

    box.innerHTML+=`
    <div class="order">
      <b>${o.orderNumber}</b>
      <span class="badge ${badge}">${o.status}</span>

      <p><b>${o.userName}</b> – ${o.userEmail}</p>
      <p>Total £${o.total} | Paid £${o.submittedAmount||0} | Remaining £${o.remainingPayment||0}</p>

      <div class="addr">
        <b>Shipping Address</b><br>
        ${o.shippingAddress?.fullName}<br>
        ${o.shippingAddress?.address1}, ${o.shippingAddress?.city}<br>
        ${o.shippingAddress?.state} - ${o.shippingAddress?.postalCode}
      </div>

      ${products}

      <hr>
      <b>Payment Confirmation</b>
      <select id="pay-${oid}">
        <option value="">Select</option>
        <option value="advance">Advance</option>
        <option value="full">Full Payment</option>
      </select>
      <input id="amt-${oid}" type="number" placeholder="Paid Amount">
      <input id="ref-${oid}" placeholder="Transaction / Reference No">
      <button onclick="confirmPayment('${o.userId}','${oid}','${o.orderNumber}',${o.total})">
        Confirm Payment
      </button>

      <hr>
      <b>Order Status</b>
      <select id="st-${oid}">
        <option value="">Select</option>
        <option value="processing">Processing</option>
        <option value="ready_to_ship">Ready to Ship</option>
        <option value="shipped">Shipped</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>
      <input id="trk-${oid}" placeholder="Tracking Number">
      <button onclick="updateStatus('${o.userId}','${oid}','${o.orderNumber}')">
        Update Status
      </button>

      <div class="timeline">
        ${(o.statusHistory||[]).map(h=>`• ${h.status} – ${h.at}`).join("<br>")}
      </div>
    </div>`;
  }
}

/* ---------------- PAYMENT ---------------- */
window.confirmPayment=async(userId,id,ord,total)=>{
  const type=document.getElementById(`pay-${id}`).value;
  const amt=Number(document.getElementById(`amt-${id}`).value);
  const ref=document.getElementById(`ref-${id}`).value;
  if(!type||!amt) return alert("Payment info missing");

  const remaining=Math.max(total-amt,0);

  await updateDoc(doc(db,"users",userId,"orders",id),{
    paymentStatus:type==="full"?"fully_paid":"advance_paid",
    submittedAmount:amt,
    remainingPayment:remaining,
    transactionReference:ref,
    paymentSubmittedAt:now(),
    updatedAt:now()
  });

  await notify(userId,"Payment Confirmed",
    type==="full"
    ? `Full payment £${amt} confirmed for ${ord}.`
    : `Advance £${amt} received. Remaining £${remaining}.`);

  loadOrders();
};

/* ---------------- STATUS ---------------- */
window.updateStatus=async(userId,id,ord)=>{
  const st=document.getElementById(`st-${id}`).value;
  const trk=document.getElementById(`trk-${id}`).value;

  const ref=doc(db,"users",userId,"orders",id);
  const snap=await getDoc(ref);
  const o=snap.data();

  const hist=[...(o.statusHistory||[]),{status:st,at:now()}];

  const upd={
    status:st,
    trackingNumber:trk||o.trackingNumber||"",
    updatedAt:now(),
    statusHistory:hist
  };

  if(st==="ready_to_ship"){
    upd.readyToShipAt=now();
    if(o.remainingPayment>0){
      await notify(userId,"Payment Pending",
        `Remaining payment clear within 1 hour or order will be cancelled. Advance non-refundable.`);
    }
  }

  if(st==="delivered"){
    upd.deliveredAt=now();
    upd.remainingPayment=0;
  }

  await updateDoc(ref,upd);
  await notify(userId,"Order Update",`Order ${ord} is now ${st.replaceAll("_"," ")}`);
  loadOrders();
};

loadOrders();
</script>
</body>
</html>

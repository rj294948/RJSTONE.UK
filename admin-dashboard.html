<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IRYA STONE â€“ Admin Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Segoe UI;background:#f4f6f8;margin:0;padding:15px}
.order{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 6px 16px rgba(0,0,0,.08)}
.flex{display:flex;gap:12px;align-items:center}
.product-img{width:70px;height:70px;border-radius:8px;object-fit:cover}
.badge{padding:4px 10px;border-radius:8px;font-size:12px;margin-right:6px}
.paid{background:#28a745;color:#fff}
.advance{background:#ffc107}
.processing{background:#6f42c1;color:#fff}
.shipped{background:#17a2b8;color:#fff}
.out{background:#fd7e14;color:#fff}
.delivered{background:#007bff;color:#fff}
.cancelled{background:#dc3545;color:#fff}
select,input,button{padding:7px;margin-top:6px;width:100%}
button{cursor:pointer;background:#000;color:#fff;border:none;border-radius:8px}
hr{border:none;border-top:1px solid #ddd;margin:10px 0}
.timeline{font-size:12px;color:#555;margin-top:8px}
.addr{background:#f8f9fa;border-radius:8px;padding:10px;font-size:13px}
</style>
</head>

<body>

<h2>Admin Orders Panel</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collectionGroup, getDocs,
  doc, getDoc, updateDoc, addDoc,
  collection, query, orderBy, limit, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDNW...",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk"
});
const db = getFirestore(app);
const box = document.getElementById("orders");

const nowISO = ()=> new Date().toISOString();
const hoursBetween = (a,b)=> (new Date(b)-new Date(a))/36e5;

/* ---------- NOTIFICATION (MAX 10) ---------- */
async function notify(userId,title,msg){
  const col = collection(db,"users",userId,"notifications");
  await addDoc(col,{ title, message:msg, createdAt:nowISO(), read:false });

  const q = query(col, orderBy("createdAt","desc"));
  const snap = await getDocs(q);
  let i=0;
  for(const d of snap.docs){
    i++;
    if(i>10) await deleteDoc(d.ref);
  }
}

/* ---------- LOAD ORDERS ---------- */
async function loadOrders(){
  box.innerHTML="";
  const snap = await getDocs(collectionGroup(db,"orders"));
  let orders=[];
  snap.forEach(d=>{ let o=d.data(); o._id=d.id; orders.push(o); });
  orders.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

  for(const o of orders){
    if(!o.items?.length) continue;

    if(o.paymentStatus!=="fully_paid" && o.createdAt){
      if(hoursBetween(o.createdAt,nowISO())>=24 && o.status!=="cancelled"){
        await updateDoc(doc(db,"users",o.userId,"orders",o._id),{
          status:"cancelled", cancelledAt:nowISO()
        });
        await notify(o.userId,"Order Cancelled",
          `Order ${o.orderNumber} cancelled due to pending payment.`);
        continue;
      }
    }

    let badge =
      o.status==="cancelled"?"cancelled":
      o.status==="delivered"?"delivered":
      o.status==="out_for_delivery"?"out":
      o.status==="shipped"?"shipped":
      o.status==="processing"?"processing":
      o.paymentStatus==="fully_paid"?"paid":"advance";

    let products="";
    for(const it of o.items){
      products+=`
      <div class="flex">
        <div>
          <b>${it.name}</b><br>
          Qty ${it.quantity} | Â£${it.totalPrice}
        </div>
      </div>`;
    }

    const bill=o.billingAddress||{};
    const ship=o.shippingAddress||{};

    box.innerHTML+=`
    <div class="order">
      <b>${o.orderNumber}</b>
      <span class="badge ${badge}">${o.status}</span>

      <p>${o.userName} â€“ ${o.userEmail}</p>
      <p>Total Â£${o.total} | Paid Â£${o.submittedAmount||0} | Remaining Â£${o.remainingPayment||0}</p>

      ${products}

      <hr>
      <b>Billing Address</b>
      <div class="addr">
        ${bill.fullName||""}<br>
        ${bill.address1||""} ${bill.address2||""}<br>
        ${bill.city||""}, ${bill.state||""} ${bill.postalCode||""}<br>
        ${bill.country||""}<br>
        ðŸ“ž ${bill.phone||""}
      </div>

      <hr>
      <b>Shipping Address</b>
      <div class="addr">
        ${ship.fullName||""}<br>
        ${ship.address1||""} ${ship.address2||""}<br>
        ${ship.city||""}, ${ship.state||""} ${ship.postalCode||""}<br>
        ${ship.country||""}<br>
        ðŸ“ž ${ship.phone||""}
      </div>

      <hr>
      <b>Order Status</b>
      <select id="status-${o._id}">
        <option value="">Select Status</option>
        <option value="processing">Processing</option>
        <option value="ready_to_ship">Ready to Ship</option>
        <option value="shipped">Shipped</option>
        <option value="out_for_delivery">Out for Delivery</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>

      <input id="track-${o._id}" placeholder="Tracking Number">
      <button onclick="updateStatus('${o.userId}','${o._id}','${o.orderNumber}')">
        Update Order
      </button>

      <div class="timeline">
        ${(o.statusHistory||[]).map(h=>`â€¢ ${h.status} â€“ ${h.at}`).join("<br>")}
      </div>
    </div>`;
  }
}

/* ---------- STATUS ---------- */
window.updateStatus = async (userId,id,ord)=>{
  const st=document.getElementById(`status-${id}`).value;
  const track=document.getElementById(`track-${id}`).value||"";
  if(!st) return alert("Select status");

  const ref=doc(db,"users",userId,"orders",id);
  const snap=await getDoc(ref);
  const data=snap.data();

  await updateDoc(ref,{
    status:st,
    trackingNumber:track,
    updatedAt:nowISO(),
    statusHistory:[...(data.statusHistory||[]),{status:st,at:nowISO()}]
  });

  await notify(userId,"Order Update",`Order ${ord} is now ${st.replaceAll("_"," ")}`);
  loadOrders();
};

loadOrders();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Orders â€“ IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f4f6f8; padding:15px; }
.order { background:#fff; padding:15px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd; }
.badge { padding:4px 8px; border-radius:4px; font-size:12px; margin-left:5px; }
.processing { background:#ffc107; }
.shipped { background:#17a2b8; color:#fff; }
.delivered { background:#28a745; color:#fff; }
.cancelled { background:#dc3545; color:#fff; }
.product { display:flex; gap:10px; margin-top:8px; }
.product img { width:60px; height:60px; object-fit:cover; border-radius:4px; }
hr { margin:10px 0; }
select, button, input { padding:6px; margin-top:6px; width:100%; }
.timeline { font-size:12px; background:#f1f1f1; padding:8px; border-radius:5px; margin-top:8px; }
</style>
</head>

<body>
<h2>Admin Orders Panel</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collectionGroup, getDocs,
  doc, updateDoc, arrayUnion
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* ðŸ” FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ordersDiv = document.getElementById("orders");

/* âœ… NORMALIZE ORDER (IGNORE DUPLICATES) */
function normalizeOrder(o) {
  const paid = o.submittedAmount ?? o.advancePayment ?? 0;
  const remaining = Math.max((o.total || 0) - paid, 0);

  let paymentStatus = o.paymentStatus;
  if (!paymentStatus) {
    paymentStatus = paid === 0 ? "unpaid" : remaining > 0 ? "advance_paid" : "fully_paid";
  }

  return {
    ...o,
    submittedAmount: paid,
    remainingAmount: remaining,
    paymentStatus
  };
}

/* âœ… MERGE SAME PRODUCTS */
function mergeProducts(items = []) {
  const map = {};
  items.forEach(i => {
    const key = i.name + JSON.stringify(i.calculationData || {});
    if (!map[key]) {
      map[key] = { ...i };
    } else {
      map[key].quantity += i.quantity;
      map[key].totalPrice += i.totalPrice;
    }
  });
  return Object.values(map);
}

/* ðŸ”„ LOAD ORDERS */
async function loadOrders() {
  ordersDiv.innerHTML = "";
  const snap = await getDocs(collectionGroup(db, "orders"));
  let orders = [];

  snap.forEach(d => orders.push({ id: d.id, ...normalizeOrder(d.data()) }));

  orders.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

  for (const o of orders) {
    const items = mergeProducts(o.items);
    const badge = o.status || "processing";

    let productsHTML = "";
    items.forEach(p => {
      productsHTML += `
        <div class="product">
          <img src="https://via.placeholder.com/60">
          <div>
            <b>${p.name}</b><br>
            Qty: ${p.quantity} | Â£${p.totalPrice}
          </div>
        </div>`;
    });

    let timeline = "";
    (o.statusHistory || []).forEach(s => {
      timeline += `âœ” ${s.status} â€“ ${new Date(s.at).toLocaleString()}<br>`;
    });

    ordersDiv.innerHTML += `
      <div class="order">
        <b>Order #${o.orderNumber}</b>
        <span class="badge ${badge}">${badge.toUpperCase()}</span>

        <p>User: ${o.userName} | ${o.userEmail}</p>
        <p>Total: Â£${o.total} | Paid: Â£${o.submittedAmount} | Remaining: Â£${o.remainingAmount}</p>

        ${productsHTML}

        <hr>

        <select id="status-${o.id}">
          <option value="">-- Update Status --</option>
          <option value="processing">Processing</option>
          <option value="shipped">Shipped</option>
          <option value="delivered">Delivered</option>
          <option value="cancelled">Cancelled</option>
        </select>

        <button onclick="updateStatus('${o.userId}','${o.id}')">Update Status</button>

        <div class="timeline">${timeline || "No history yet"}</div>
      </div>
    `;
  }
}

/* ðŸ›  UPDATE STATUS */
window.updateStatus = async (userId, orderId) => {
  const status = document.getElementById(`status-${orderId}`).value;
  if (!status) return alert("Select status");

  await updateDoc(doc(db,"users",userId,"orders",orderId),{
    status,
    updatedAt: new Date().toISOString(),
    statusHistory: arrayUnion({
      status,
      at: new Date().toISOString()
    }),
    ...(status==="shipped" && { shippedAt: new Date().toISOString() }),
    ...(status==="delivered" && { deliveredAt: new Date().toISOString() })
  });

  alert("Order updated");
  loadOrders();
};

loadOrders();
</script>
</body>
</html>

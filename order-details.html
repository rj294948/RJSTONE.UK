<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Details | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* Copy all CSS from orders.html */
/* Add specific styles for order details */
.order-details-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.back-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    color: var(--text-dark);
    text-decoration: none;
    font-weight: 500;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.back-btn:hover {
    background: var(--primary-gold);
    color: white;
    border-color: var(--primary-gold);
}

.detail-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.detail-section h2 {
    color: var(--stone-dark);
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.detail-label {
    font-size: 13px;
    color: var(--text-light);
    font-weight: 500;
}

.detail-value {
    font-size: 15px;
    color: var(--text-dark);
    font-weight: 600;
}

.detail-value.gold {
    color: var(--primary-gold);
}

/* Status indicators */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-processing { background: #cce5ff; color: #004085; }
.status-shipped { background: #d4edda; color: #155724; }
.status-delivered { background: #d1ecf1; color: #0c5460; }
.status-cancelled { background: #f8d7da; color: #721c24; }
.status-awaiting-payment { background: #fff3cd; color: #856404; }
.status-payment-verified { background: #d4edda; color: #155724; }

/* Real-time indicator */
.real-time-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    font-size: 13px;
}

.real-time-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #28a745;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Notification panel */
.notification-panel {
    position: fixed;
    top: 70px;
    right: 20px;
    z-index: 1000;
    width: 300px;
    max-height: 400px;
    overflow-y: auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    display: none;
}

.notification-header {
    padding: 15px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-item {
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s;
}

.notification-item:hover {
    background: #f8f9fa;
}

.notification-item.unread {
    background: #f0f7ff;
}

.notification-time {
    font-size: 11px;
    color: #6c757d;
    margin-top: 5px;
}

.items-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.items-table th {
    background: #f8f9fa;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    color: var(--stone-dark);
    border-bottom: 2px solid #e0e0e0;
}

.items-table td {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.item-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Update animation */
.updating {
    animation: highlightUpdate 2s ease;
}

@keyframes highlightUpdate {
    0% { background-color: rgba(255, 193, 7, 0.1); }
    100% { background-color: transparent; }
}
</style>
</head>
<body>

<!-- Real-time indicator -->
<div class="real-time-indicator" id="realTimeIndicator">
    <div class="real-time-dot"></div>
    <span>Live Updates Active</span>
</div>

<!-- Notification panel -->
<div class="notification-panel" id="notificationPanel">
    <div class="notification-header">
        <h4 style="margin: 0;">Order Updates</h4>
        <button onclick="clearNotifications()" style="background: none; border: none; color: #6c757d; cursor: pointer;">
            Clear All
        </button>
    </div>
    <div id="notificationsList"></div>
</div>

<div class="order-details-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <a href="orders.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Back to Orders
        </a>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button onclick="toggleNotifications()" class="back-btn">
                <i class="fas fa-bell"></i>
                <span id="notificationCount">0</span>
            </button>
            <button onclick="refreshOrder()" class="back-btn">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
    </div>
    
    <div id="orderDetailsContent">
        <!-- Order details will be loaded here -->
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// Global variables
let orderId = null;
let lastOrderData = null;
let notificationCount = 0;
let db = null;
let orderUnsubscribe = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Get order ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    orderId = urlParams.get('id');
    
    if (!orderId) {
        window.location.href = 'orders.html';
        return;
    }
    
    // Initialize Firebase
    initializeFirebase();
    
    // Load order details with real-time updates
    loadOrderDetails();
    
    // Initialize notification system
    initializeNotificationSystem();
});

// Firebase configuration
function initializeFirebase() {
    const firebaseConfig = {
        apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
        authDomain: "iryastone-uk.firebaseapp.com",
        projectId: "iryastone-uk",
        storageBucket: "iryastone-uk.firebasestorage.app",
        messagingSenderId: "110940910896",
        appId: "1:110940910896:web:b25e92127118665e5c84f5",
        measurementId: "G-6YM1FLYN48"
    };
    
    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    // Get Firestore instance
    db = firebase.firestore();
}

// Main function to load order details with real-time updates
async function loadOrderDetails() {
    try {
        // Get current user
        const auth = firebase.auth();
        const user = auth.currentUser;
        const userId = user ? user.uid : localStorage.getItem('irya_guest_id');
        
        if (!userId) {
            showOrderNotFound();
            return;
        }
        
        // Set up real-time listener
        setupRealtimeListener(userId);
        
    } catch (error) {
        console.error('Error loading order details:', error);
        showError(error);
    }
}

// Set up real-time Firestore listener
function setupRealtimeListener(userId) {
    // First try user's personal orders collection
    let orderRef = db.collection('users').doc(userId).collection('orders').doc(orderId);
    
    // Set up the real-time listener
    orderUnsubscribe = orderRef.onSnapshot(async (orderDoc) => {
        try {
            if (orderDoc.exists) {
                const orderData = orderDoc.data();
                orderData.id = orderDoc.id;
                
                // Display order details
                await displayOrderDetails(orderData);
                
                // Check for changes and notify
                checkForChangesAndNotify(orderData);
                
                // Update last order data
                lastOrderData = orderData;
                
            } else {
                // If not found in user collection, try main orders collection
                tryMainOrdersCollection();
            }
        } catch (error) {
            console.error('Error processing order snapshot:', error);
        }
    }, (error) => {
        console.error('Error in order listener:', error);
        // Fallback to one-time load
        loadOrderOnce(userId);
    });
}

// Try main orders collection
function tryMainOrdersCollection() {
    const mainOrderRef = db.collection('orders').doc(orderId);
    
    orderUnsubscribe = mainOrderRef.onSnapshot((orderDoc) => {
        if (orderDoc.exists) {
            const orderData = orderDoc.data();
            orderData.id = orderDoc.id;
            displayOrderDetails(orderData);
            checkForChangesAndNotify(orderData);
            lastOrderData = orderData;
        } else {
            showOrderNotFound();
        }
    });
}

// Fallback one-time load
async function loadOrderOnce(userId) {
    try {
        let orderData = null;
        
        // Try user collection
        const userOrderDoc = await db.collection('users').doc(userId)
            .collection('orders').doc(orderId).get();
        
        if (userOrderDoc.exists) {
            orderData = userOrderDoc.data();
            orderData.id = userOrderDoc.id;
        } else {
            // Try main collection
            const mainOrderDoc = await db.collection('orders').doc(orderId).get();
            if (mainOrderDoc.exists) {
                orderData = mainOrderDoc.data();
                orderData.id = mainOrderDoc.id;
            }
        }
        
        if (orderData) {
            displayOrderDetails(orderData);
            lastOrderData = orderData;
        } else {
            showOrderNotFound();
        }
    } catch (error) {
        console.error('Error in fallback load:', error);
        showOrderNotFound();
    }
}

// Check for changes and show notifications
function checkForChangesAndNotify(newOrderData) {
    if (!lastOrderData) return;
    
    const changes = [];
    
    // Check status changes
    if (lastOrderData.status !== newOrderData.status) {
        changes.push({
            type: 'status',
            old: lastOrderData.status,
            new: newOrderData.status,
            message: `Order status changed from "${getStatusText(lastOrderData.status)}" to "${getStatusText(newOrderData.status)}"`
        });
    }
    
    // Check payment status changes
    if (lastOrderData.paymentStatus !== newOrderData.paymentStatus) {
        changes.push({
            type: 'payment',
            old: lastOrderData.paymentStatus,
            new: newOrderData.paymentStatus,
            message: `Payment status changed to "${getPaymentStatusText(newOrderData.paymentStatus)}"`
        });
    }
    
    // Check shipping/tracking updates
    if (!lastOrderData.tracking && newOrderData.tracking) {
        changes.push({
            type: 'tracking',
            message: 'Tracking information has been added to your order'
        });
    }
    
    if (lastOrderData.tracking && newOrderData.tracking && 
        lastOrderData.tracking.number !== newOrderData.tracking.number) {
        changes.push({
            type: 'tracking',
            message: 'Tracking information has been updated'
        });
    }
    
    // Show notifications for changes
    changes.forEach(change => {
        showChangeNotification(change);
    });
}

// Display order details with real-time updates
function displayOrderDetails(order) {
    const content = document.getElementById('orderDetailsContent');
    
    // Add updating animation to changed sections
    if (lastOrderData) {
        setTimeout(() => {
            document.querySelectorAll('.detail-section').forEach(section => {
                section.classList.add('updating');
                setTimeout(() => {
                    section.classList.remove('updating');
                }, 2000);
            });
        }, 100);
    }
    
    content.innerHTML = `
        <!-- Order Summary -->
        <div class="detail-section">
            <h2><i class="fas fa-receipt"></i> Order Summary</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Order Number</div>
                    <div class="detail-value">${order.orderNumber || order.id}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Order Date</div>
                    <div class="detail-value">${formatDate(order.createdAt)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Order Status</div>
                    <div class="detail-value">
                        <span class="status-badge status-${getStatusClass(order.status)}">
                            <i class="fas ${getStatusIcon(order.status)}"></i>
                            ${getStatusText(order.status)}
                        </span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Payment Status</div>
                    <div class="detail-value">
                        <span class="status-badge status-${getPaymentStatusClass(order.paymentStatus)}">
                            <i class="fas ${getPaymentStatusIcon(order.paymentStatus)}"></i>
                            ${getPaymentStatusText(order.paymentStatus)}
                        </span>
                    </div>
                </div>
                ${order.updatedAt ? `
                <div class="detail-item">
                    <div class="detail-label">Last Updated</div>
                    <div class="detail-value" id="lastUpdatedTime">${formatDate(order.updatedAt)}</div>
                </div>
                ` : ''}
            </div>
        </div>
        
        <!-- Customer Information -->
        <div class="detail-section">
            <h2><i class="fas fa-user"></i> Customer Information</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Name</div>
                    <div class="detail-value">${order.userName || 'Customer'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${order.userEmail || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">User ID</div>
                    <div class="detail-value">${order.userId ? order.userId.substring(0, 10) + '...' : 'N/A'}</div>
                </div>
            </div>
        </div>
        
        <!-- Order Items -->
        <div class="detail-section">
            <h2><i class="fas fa-box"></i> Order Items (${order.items?.length || 0})</h2>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Details</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${(order.items || []).map(item => `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="item-image">
                                        <img src="${item.image || 'https://via.placeholder.com/60'}" 
                                             alt="${item.name}">
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">${item.name}</div>
                                        <div style="font-size: 13px; color: var(--text-light);">${item.category || 'General'}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div style="font-size: 13px;">
                                    ${item.calculationData ? getCalculationInfo(item) : `Standard item`}
                                    ${item.customRequirements ? `<div style="color: var(--primary-gold); margin-top: 5px;"><i class="fas fa-edit"></i> Custom requirements</div>` : ''}
                                </div>
                            </td>
                            <td>${item.quantity || 1}</td>
                            <td>£${item.price?.toFixed(2) || '0.00'}</td>
                            <td class="detail-value gold">£${item.calculatedPrice?.toFixed(2) || '0.00'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <!-- Payment Details -->
        <div class="detail-section">
            <h2><i class="fas fa-credit-card"></i> Payment Details</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Payment Method</div>
                    <div class="detail-value">${order.paymentMethod || 'Bank Transfer'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Payment Type</div>
                    <div class="detail-value">${order.paymentType === 'advance' ? '30% Advance' : 'Full Payment'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Subtotal</div>
                    <div class="detail-value">£${order.subtotal?.toFixed(2) || '0.00'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Shipping</div>
                    <div class="detail-value">${order.shipping === 0 ? 'FREE' : `£${order.shipping?.toFixed(2) || '0.00'}`}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tax</div>
                    <div class="detail-value">£${order.tax?.toFixed(2) || '0.00'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Total Amount</div>
                    <div class="detail-value gold">£${order.total?.toFixed(2) || '0.00'}</div>
                </div>
                ${order.paymentVerifiedAt ? `
                <div class="detail-item">
                    <div class="detail-label">Payment Verified</div>
                    <div class="detail-value">${formatDate(order.paymentVerifiedAt)}</div>
                </div>
                ` : ''}
            </div>
        </div>
        
        <!-- Shipping & Tracking -->
        <div class="detail-section">
            <h2><i class="fas fa-shipping-fast"></i> Shipping & Tracking</h2>
            <div class="detail-grid">
                ${order.shippingAddress ? `
                    <div class="detail-item" style="grid-column: span 2;">
                        <div class="detail-label">Shipping Address</div>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-top: 5px;">
                            ${order.shippingAddress.fullName}<br>
                            ${order.shippingAddress.address1}<br>
                            ${order.shippingAddress.address2 ? order.shippingAddress.address2 + '<br>' : ''}
                            ${order.shippingAddress.city}, ${order.shippingAddress.state} ${order.shippingAddress.postalCode}<br>
                            ${order.shippingAddress.country}<br>
                            <strong>Phone:</strong> ${order.shippingAddress.phone || 'N/A'}
                        </div>
                    </div>
                ` : ''}
                
                ${order.tracking ? `
                    <div class="detail-item">
                        <div class="detail-label">Tracking Number</div>
                        <div class="detail-value gold">${order.tracking.number || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Carrier</div>
                        <div class="detail-value">${order.tracking.carrier || 'Standard Shipping'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Shipping Date</div>
                        <div class="detail-value">${order.shippedAt ? formatDate(order.shippedAt) : 'Not shipped yet'}</div>
                    </div>
                ` : ''}
                
                ${order.estimatedDelivery ? `
                    <div class="detail-item">
                        <div class="detail-label">Estimated Delivery</div>
                        <div class="detail-value">${formatDate(order.estimatedDelivery)}</div>
                    </div>
                ` : ''}
                
                ${order.deliveredAt ? `
                    <div class="detail-item">
                        <div class="detail-label">Delivered On</div>
                        <div class="detail-value gold">${formatDate(order.deliveredAt)}</div>
                    </div>
                ` : ''}
            </div>
            
            ${order.tracking?.url ? `
                <div style="margin-top: 20px;">
                    <a href="${order.tracking.url}" target="_blank" 
                       style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 20px; 
                              background: var(--primary-gold); color: white; text-decoration: none; 
                              border-radius: 8px; font-weight: 600;">
                        <i class="fas fa-external-link-alt"></i>
                        Track Package
                    </a>
                </div>
            ` : ''}
        </div>
        
        <!-- Bank Transfer Details -->
        ${order.paymentMethod === 'bank' && order.bankTransferDetails ? `
            <div class="detail-section">
                <h2><i class="fas fa-university"></i> Bank Transfer Details</h2>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Account Name</div>
                        <div class="detail-value">${order.bankTransferDetails.accountName}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Account Number</div>
                        <div class="detail-value">${order.bankTransferDetails.accountNumber}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Sort Code</div>
                        <div class="detail-value">${order.bankTransferDetails.sortCode}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Reference</div>
                        <div class="detail-value gold">${order.bankTransferDetails.reference}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Amount to Pay</div>
                        <div class="detail-value gold">£${order.bankTransferDetails.amount?.toFixed(2) || '0.00'}</div>
                    </div>
                </div>
            </div>
        ` : ''}
        
        <!-- Order Timeline -->
        <div class="detail-section">
            <h2><i class="fas fa-history"></i> Order Timeline</h2>
            <div style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 20px; position: relative; padding-left: 30px;">
                    <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--primary-gold);"></div>
                    
                    <div style="position: relative;">
                        <div style="position: absolute; left: -36px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-gold);"></div>
                        <div>
                            <div style="font-weight: 600; color: var(--stone-dark);">Order Placed</div>
                            <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.createdAt)}</div>
                        </div>
                    </div>
                    
                    ${order.paymentVerifiedAt ? `
                        <div style="position: relative;">
                            <div style="position: absolute; left: -36px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-gold);"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--stone-dark);">Payment Verified</div>
                                <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.paymentVerifiedAt)}</div>
                                ${order.paymentVerifiedBy ? `<div style="font-size: 12px; color: var(--text-light);">Verified by: ${order.paymentVerifiedBy}</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${order.processingStartedAt ? `
                        <div style="position: relative;">
                            <div style="position: absolute; left: -36px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-gold);"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--stone-dark);">Processing Started</div>
                                <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.processingStartedAt)}</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${order.shippedAt ? `
                        <div style="position: relative;">
                            <div style="position: absolute; left: -36px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-gold);"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--stone-dark);">Order Shipped</div>
                                <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.shippedAt)}</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${order.deliveredAt ? `
                        <div style="position: relative;">
                            <div style="position: absolute; left: -36px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-gold);"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--stone-dark);">Order Delivered</div>
                                <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.deliveredAt)}</div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
            <button onclick="downloadInvoice()" 
                    style="padding: 15px 25px; background: var(--primary-gold); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-file-pdf"></i>
                Download Invoice
            </button>
            
            ${order.tracking?.url ? `
                <button onclick="window.open('${order.tracking.url}', '_blank')" 
                        style="padding: 15px 25px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-shipping-fast"></i>
                    Track Order
                </button>
            ` : ''}
            
            <button onclick="contactSupport()" 
                    style="padding: 15px 25px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-headset"></i>
                Contact Support
            </button>
            
            <button onclick="window.print()" 
                    style="padding: 15px 25px; background: #343a40; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-print"></i>
                Print Details
            </button>
        </div>
    `;
}

// Notification System
function initializeNotificationSystem() {
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // Load saved notifications
    loadSavedNotifications();
}

function showChangeNotification(change) {
    // Create notification object
    const notification = {
        id: Date.now(),
        type: change.type,
        message: change.message,
        time: new Date().toISOString(),
        read: false,
        orderId: orderId
    };
    
    // Save to localStorage
    saveNotification(notification);
    
    // Update notification count
    updateNotificationCount();
    
    // Show browser notification if permitted
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('IRYA STONE - Order Update', {
            body: change.message,
            icon: '/favicon.ico',
            tag: 'order-update'
        });
    }
    
    // Show in-page notification
    showInPageNotification(notification);
}

function saveNotification(notification) {
    let notifications = JSON.parse(localStorage.getItem('irya_order_notifications') || '[]');
    
    // Keep only last 50 notifications
    notifications.unshift(notification);
    if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
    }
    
    localStorage.setItem('irya_order_notifications', JSON.stringify(notifications));
}

function loadSavedNotifications() {
    const notifications = JSON.parse(localStorage.getItem('irya_order_notifications') || '[]');
    
    // Filter for this order
    const orderNotifications = notifications.filter(n => n.orderId === orderId);
    
    // Update count
    notificationCount = orderNotifications.filter(n => !n.read).length;
    updateNotificationCount();
    
    // Display in panel
    displayNotificationsInPanel(orderNotifications);
}

function displayNotificationsInPanel(notifications) {
    const container = document.getElementById('notificationsList');
    if (!container) return;
    
    if (notifications.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">No notifications yet</div>';
        return;
    }
    
    container.innerHTML = notifications.map(notif => `
        <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="markNotificationRead(${notif.id})">
            <div><strong>${getNotificationTitle(notif.type)}</strong></div>
            <div style="font-size: 13px;">${notif.message}</div>
            <div class="notification-time">${formatDate(notif.time)}</div>
        </div>
    `).join('');
}

function getNotificationTitle(type) {
    const titles = {
        'status': 'Status Update',
        'payment': 'Payment Update',
        'tracking': 'Shipping Update'
    };
    return titles[type] || 'Order Update';
}

function updateNotificationCount() {
    const countElement = document.getElementById('notificationCount');
    if (countElement) {
        countElement.textContent = notificationCount;
        if (notificationCount > 0) {
            countElement.style.color = '#dc3545';
            countElement.style.fontWeight = 'bold';
        }
    }
}

function markNotificationRead(notificationId) {
    let notifications = JSON.parse(localStorage.getItem('irya_order_notifications') || '[]');
    
    notifications = notifications.map(notif => {
        if (notif.id === notificationId) {
            notif.read = true;
        }
        return notif;
    });
    
    localStorage.setItem('irya_order_notifications', JSON.stringify(notifications));
    
    // Reload notifications
    loadSavedNotifications();
}

function clearNotifications() {
    let notifications = JSON.parse(localStorage.getItem('irya_order_notifications') || '[]');
    
    // Remove only notifications for this order
    notifications = notifications.filter(n => n.orderId !== orderId);
    
    localStorage.setItem('irya_order_notifications', JSON.stringify(notifications));
    
    // Reload
    loadSavedNotifications();
    
    // Hide panel
    document.getElementById('notificationPanel').style.display = 'none';
}

function toggleNotifications() {
    const panel = document.getElementById('notificationPanel');
    if (panel.style.display === 'block') {
        panel.style.display = 'none';
    } else {
        panel.style.display = 'block';
        // Mark all as read when opening
        let notifications = JSON.parse(localStorage.getItem('irya_order_notifications') || '[]');
        notifications = notifications.map(notif => {
            if (notif.orderId === orderId && !notif.read) {
                notif.read = true;
            }
            return notif;
        });
        localStorage.setItem('irya_order_notifications', JSON.stringify(notifications));
        loadSavedNotifications();
    }
}

function showInPageNotification(notification) {
    // Create temporary notification toast
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 9999;
        max-width: 300px;
        border-left: 4px solid var(--primary-gold);
        animation: slideIn 0.3s ease;
    `;
    
    toast.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 5px;">${getNotificationTitle(notification.type)}</div>
        <div style="font-size: 14px;">${notification.message}</div>
        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Just now</div>
    `;
    
    document.body.appendChild(toast);
    
    // Remove after 5 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 5000);
}

// Helper Functions
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return dateString;
    }
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'Pending',
        'pending_bank_transfer': 'Awaiting Payment',
        'payment_submitted': 'Payment Submitted',
        'payment_verified': 'Payment Verified',
        'processing': 'Processing',
        'shipped': 'Shipped',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || status;
}

function getStatusClass(status) {
    const classMap = {
        'pending': 'pending',
        'pending_bank_transfer': 'awaiting-payment',
        'payment_submitted': 'processing',
        'payment_verified': 'payment-verified',
        'processing': 'processing',
        'shipped': 'shipped',
        'delivered': 'delivered',
        'cancelled': 'cancelled'
    };
    return classMap[status] || 'pending';
}

function getStatusIcon(status) {
    const iconMap = {
        'pending': 'fa-clock',
        'pending_bank_transfer': 'fa-money-bill-wave',
        'payment_submitted': 'fa-paper-plane',
        'payment_verified': 'fa-check-circle',
        'processing': 'fa-cog',
        'shipped': 'fa-shipping-fast',
        'delivered': 'fa-check-double',
        'cancelled': 'fa-times-circle'
    };
    return iconMap[status] || 'fa-clock';
}

function getPaymentStatusText(status) {
    const statusMap = {
        'pending_bank_transfer': 'Awaiting Payment',
        'payment_submitted': 'Payment Submitted',
        'payment_verified': 'Payment Verified',
        'paid': 'Paid',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || 'Pending';
}

function getPaymentStatusClass(status) {
    const classMap = {
        'pending_bank_transfer': 'awaiting-payment',
        'payment_submitted': 'processing',
        'payment_verified': 'payment-verified',
        'paid': 'delivered',
        'cancelled': 'cancelled'
    };
    return classMap[status] || 'pending';
}

function getPaymentStatusIcon(status) {
    const iconMap = {
        'pending_bank_transfer': 'fa-clock',
        'payment_submitted': 'fa-paper-plane',
        'payment_verified': 'fa-check-circle',
        'paid': 'fa-check-double',
        'cancelled': 'fa-times-circle'
    };
    return iconMap[status] || 'fa-clock';
}

function getCalculationInfo(item) {
    if (!item.calculationData) return `Quantity: ${item.quantity || 1} pieces`;
    
    const unit = item.calculationData.unit || 'piece';
    
    if (unit === 'sqft') {
        return `Area: ${item.calculationData.length || 1}ft × ${item.calculationData.width || 1}ft`;
    } else if (unit === 'sqm') {
        return `Area: ${item.calculationData.length || 1}m × ${item.calculationData.width || 1}m`;
    } else if (unit === 'weight') {
        return `Weight: ${item.calculationData.weight || 1}kg`;
    } else {
        return `Quantity: ${item.quantity || 1} pieces`;
    }
}

// Action Functions
function refreshOrder() {
    if (orderUnsubscribe) {
        orderUnsubscribe();
    }
    loadOrderDetails();
    
    // Show refresh animation
    const refreshBtn = document.querySelector('button[onclick="refreshOrder()"]');
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing';
    setTimeout(() => {
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
    }, 1000);
}

function downloadInvoice() {
    // Implementation for invoice download
    alert('Invoice download feature would be implemented here');
}

function contactSupport() {
    window.location.href = 'mailto:support@iryastone.com?subject=Order Inquiry: ' + orderId;
}

function showOrderNotFound() {
    document.getElementById('orderDetailsContent').innerHTML = `
        <div style="text-align: center; padding: 50px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ffc107; margin-bottom: 20px;"></i>
            <h2>Order Not Found</h2>
            <p>This order does not exist or you don't have permission to view it.</p>
            <a href="orders.html" class="back-btn" style="margin-top: 20px;">
                <i class="fas fa-arrow-left"></i>
                Back to Orders
            </a>
        </div>
    `;
}

function showError(error) {
    document.getElementById('orderDetailsContent').innerHTML = `
        <div style="text-align: center; padding: 50px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc3545; margin-bottom: 20px;"></i>
            <h2>Error Loading Order</h2>
            <p>${error.message}</p>
            <a href="orders.html" class="back-btn" style="margin-top: 20px;">
                <i class="fas fa-arrow-left"></i>
                Back to Orders
            </a>
        </div>
    `;
}

// Clean up when leaving page
window.addEventListener('beforeunload', function() {
    if (orderUnsubscribe) {
        orderUnsubscribe();
    }
});

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
</body>
</html>

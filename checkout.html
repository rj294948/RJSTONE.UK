<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | IRYA STONE</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        /* ============================================
           SAME THEME AS CART.HTML
           ============================================ */
        :root {
            --primary-gold: #c9a227;
            --gold-light: #f0d77c;
            --gold-dark: #9c7c1f;
            --stone-dark: #1a1a1a;
            --stone-light: #f4f6f4;
            --bg-light: #f7f9fc;
            --text-dark: #222222;
            --text-light: #666666;
            --white: #ffffff;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --error-red: #ef4444;
            --info-blue: #3b82f6;
            --pending-yellow: #fbbf24;
            --refunded-purple: #8b5cf6;
            --cancelled-red: #dc2626;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 20px rgba(0,0,0,0.12);
            --transition: all 0.3s ease;
            --border-radius: 12px;
            --border-radius-lg: 20px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: var(--bg-light);
            color: var(--text-dark);
            padding-bottom: 80px;
            font-size: 14px;
            scroll-behavior: smooth;
        }
        
        /* ============================================
           HEADER - MATCHING CART.HTML STYLE
           ============================================ */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            gap: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            height: 60px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            min-width: 120px;
        }
        
        .logo i {
            color: var(--primary-gold);
            font-size: 18px;
        }
        
        .logo span {
            font-size: 16px;
            font-weight: 700;
            color: var(--white);
            font-family: 'Roboto Slab', serif;
        }
        
        /* Back Button */
        .back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
            color: var(--white);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: var(--transition);
            white-space: nowrap;
            min-width: 70px;
            text-decoration: none;
        }
        
        /* ============================================
           MAIN CONTENT - MATCHING CART.HTML STYLE
           ============================================ */
        .main-content {
            padding: 80px 15px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .page-header {
            margin-bottom: 25px;
            text-align: center;
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.6));
            padding: 20px 15px;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            position: relative;
        }
        
        .page-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--white);
            font-family: 'Roboto Slab', serif;
        }
        
        .test-mode-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--warning-orange);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            display: none;
        }
        
        /* ============================================
           CHECKOUT CONTAINER
           ============================================ */
        .checkout-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr 350px;
                gap: 20px;
            }
        }
        
        /* ============================================
           CHECKOUT STEPS
           ============================================ */
        .checkout-steps {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            border: 1px solid #f0f0f0;
            padding: 20px;
        }
        
        .steps-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .steps-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .step-circle.active {
            background: var(--primary-gold);
            color: white;
        }
        
        .step-line {
            width: 40px;
            height: 2px;
            background: #f0f0f0;
        }
        
        .step-line.active {
            background: var(--primary-gold);
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        /* ============================================
           FORM STYLES
           ============================================ */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--stone-dark);
            font-size: 13px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            transition: var(--transition);
            background: var(--bg-light);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        @media (min-width: 480px) {
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* ============================================
           PAYMENT METHODS
           ============================================ */
        .payment-methods {
            display: grid;
            gap: 10px;
        }
        
        .payment-method {
            padding: 15px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--bg-light);
        }
        
        .payment-method.selected {
            border-color: var(--primary-gold);
            background: rgba(201, 162, 39, 0.05);
        }
        
        /* ============================================
           ORDER SUMMARY
           ============================================ */
        .order-summary {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 20px;
            border: 1px solid #f0f0f0;
            height: fit-content;
        }
        
        @media (min-width: 768px) {
            .order-summary {
                position: sticky;
                top: 80px;
            }
        }
        
        .order-items {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .order-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .summary-total {
            font-size: 16px;
            font-weight: 700;
            color: var(--stone-dark);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }
        
        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ============================================
           LOADING & ERROR STATES
           ============================================ */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 3px solid rgba(201, 162, 39, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-gold);
            animation: spin 1s ease-in-out infinite;
            z-index: 9999;
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--primary-gold);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: var(--shadow-md);
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 250px;
            display: none;
            font-size: 13px;
        }
        
        .notification.show {
            transform: translateX(0);
            display: block;
        }
        
        .error-message {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: var(--shadow-md);
            z-index: 9999;
            display: none;
            max-width: 250px;
            text-align: center;
            font-size: 13px;
        }
        
        /* ============================================
           MODALS
           ============================================ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-lg);
        }
        
        /* Responsive Design */
        @media (max-width: 480px) {
            .main-content {
                padding: 65px 12px 15px;
            }
            
            .page-header {
                padding: 15px 12px;
            }
            
            .checkout-steps {
                padding: 15px;
            }
        }
    </style>
</head>
<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<!-- Error Message -->
<div class="error-message" id="errorMessage"></div>

<!-- Header -->
<header>
    <a href="cart.html" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
    </a>
    
    <div class="logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="page-header">
        <h1><i class="fas fa-shopping-bag"></i> Secure Checkout</h1>
        <p>Complete your purchase with our secure checkout process</p>
        <div class="test-mode-badge" id="testModeBadge">TEST MODE</div>
    </div>
    
    <div class="checkout-container">
        <!-- Checkout Steps -->
        <div class="checkout-steps">
            <div class="steps-header">
                <div class="steps-progress">
                    <div class="step-circle active" id="step1">1</div>
                    <div class="step-line" id="line1"></div>
                    <div class="step-circle" id="step2">2</div>
                    <div class="step-line" id="line2"></div>
                    <div class="step-circle" id="step3">3</div>
                </div>
            </div>
            
            <!-- Step 1: Shipping -->
            <div class="step-content active" id="stepContent1">
                <h2 class="step-title">Shipping Details</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="shippingName" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="shippingEmail" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" id="shippingPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Country *</label>
                        <select id="shippingCountry" required>
                            <option value="GB" selected>United Kingdom</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Address Line 1 *</label>
                    <input type="text" id="shippingAddress1" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>City *</label>
                        <input type="text" id="shippingCity" required>
                    </div>
                    <div class="form-group">
                        <label>Postal Code *</label>
                        <input type="text" id="shippingPostalCode" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Special Requirements</label>
                    <textarea id="orderNotes" rows="3" placeholder="Any special instructions..."></textarea>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="goToStep(2)">
                        Continue to Payment <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Payment -->
            <div class="step-content" id="stepContent2">
                <h2 class="step-title">Payment Method</h2>
                
                <div class="payment-methods">
                    <div class="payment-method selected" onclick="selectPaymentMethod('stripe')" id="stripeMethod">
                        <div class="method-header">
                            <div class="method-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div>
                                <div class="method-title">Credit/Debit Card</div>
                                <div class="method-description">Secure payment via Stripe</div>
                            </div>
                        </div>
                        <div class="method-tags">
                            <span class="method-tag instant">INSTANT</span>
                        </div>
                    </div>
                    
                    <div class="payment-method" onclick="selectPaymentMethod('bank')" id="bankMethod">
                        <div class="method-header">
                            <div class="method-icon">
                                <i class="fas fa-university"></i>
                            </div>
                            <div>
                                <div class="method-title">Bank Transfer</div>
                                <div class="method-description">Transfer directly to our account</div>
                            </div>
                        </div>
                        <div class="method-tags">
                            <span class="method-tag delayed">24 HOURS</span>
                        </div>
                    </div>
                </div>
                
                <!-- Bank Transfer Details -->
                <div id="bankDetails" style="margin-top: 20px; display: none; padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                    <h4 style="margin-bottom: 10px; color: var(--warning-orange); font-size: 14px;">
                        <i class="fas fa-info-circle"></i> Bank Transfer Details
                    </h4>
                    <div style="font-size: 12px; line-height: 1.6;">
                        <p><strong>Bank:</strong> HSBC UK</p>
                        <p><strong>Account:</strong> IRYA STONE LTD</p>
                        <p><strong>Account No:</strong> 12345678</p>
                        <p><strong>Sort Code:</strong> 40-04-15</p>
                        <p><strong>Reference:</strong> <span id="bankReference">Loading...</span></p>
                    </div>
                </div>
                
                <!-- Payment Timing Info -->
                <div id="timingInfo" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;">
                    <!-- Dynamic content will be inserted -->
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 10px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" style="flex: 2;" onclick="goToStep(3)">
                        Review Order <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Review -->
            <div class="step-content" id="stepContent3">
                <h2 class="step-title">Review & Confirm</h2>
                
                <div id="reviewContent">
                    <!-- Dynamic content -->
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="placeOrder()" id="placeOrderBtn">
                        <i class="fas fa-lock"></i> Place Order & Pay Advance
                    </button>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" style="width: 100%;" onclick="goToStep(2)">
                        <i class="fas fa-arrow-left"></i> Back to Payment
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="order-summary">
            <h2>Order Summary</h2>
            
            <div class="order-items" id="orderItems">
                <!-- Dynamic content -->
            </div>
            
            <div class="summary-row">
                <span class="summary-label">Subtotal</span>
                <span class="summary-value" id="subtotalAmount">£0.00</span>
            </div>
            
            <div class="summary-row">
                <span class="summary-label">Shipping</span>
                <span class="summary-value" id="shippingAmount">FREE</span>
            </div>
            
            <div class="summary-row">
                <span class="summary-label">Tax (20%)</span>
                <span class="summary-value" id="taxAmount">£0.00</span>
            </div>
            
            <div class="summary-total">
                <span class="summary-label">Total</span>
                <span class="summary-value" id="totalAmount">£0.00</span>
            </div>
            
            <div class="advance-payment">
                <div class="advance-label">Advance Payment (30%)</div>
                <div class="advance-amount" id="advanceAmount">£0.00</div>
            </div>
        </div>
    </div>
</main>

<!-- Success Modal -->
<div class="modal" id="successModal">
    <div class="modal-content">
        <div class="modal-icon">
            <i class="fas fa-check"></i>
        </div>
        <h3 class="modal-title" id="successTitle">Order Successful!</h3>
        <p class="modal-message" id="successMessage"></p>
        <div id="successDetails" style="text-align: left; margin-bottom: 25px; padding: 15px; background: var(--bg-light); border-radius: 8px; font-size: 12px;">
            <!-- Success details -->
        </div>
        <button class="btn btn-primary" onclick="goToHome()">
            <i class="fas fa-home"></i> Return to Home
        </button>
    </div>
</div>

<!-- Bank Transfer Modal -->
<div class="modal" id="bankModal">
    <div class="modal-content">
        <div class="modal-icon" style="background: var(--warning-orange);">
            <i class="fas fa-clock"></i>
        </div>
        <h3 class="modal-title">Payment Pending</h3>
        <p class="modal-message">Please complete the bank transfer within 24 hours</p>
        
        <div id="bankModalDetails" style="text-align: left; margin-bottom: 25px; padding: 15px; background: var(--bg-light); border-radius: 8px; font-size: 12px;">
            <!-- Bank details -->
        </div>
        
        <button class="btn btn-primary" onclick="closeBankModal()">
            <i class="fas fa-check"></i> I Understand
        </button>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// ============================================
// CONFIGURATION
// ============================================
const STRIPE_TEST_PK = "pk_test_51QeEW5DvQKgVX0tNBCj2Rr6opag8nMikxrmsV6zUzEgsxHZes3Kz6Ldcp1OG7ofyB2x2FOfcLJ9f1R8wHFa2Bp4u003rK6LPiD";
const TEST_EMAIL = "ravijain236129@gmail.com";

const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5"
};

// ============================================
// GLOBAL VARIABLES
// ============================================
let currentStep = 1;
let selectedPaymentMethod = 'stripe';
let stripe = null;
let firebaseApp, firebaseDB;
let orderData = {
    items: [],
    subtotal: 0,
    total: 0,
    advance: 0,
    userId: null,
    userEmail: null
};

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', async function() {
    showLoading(true);
    
    try {
        // Initialize Stripe
        stripe = Stripe(STRIPE_TEST_PK);
        
        // Initialize Firebase
        firebaseApp = firebase.initializeApp(firebaseConfig);
        firebaseDB = firebase.firestore();
        
        // Load cart data
        await loadCartData();
        
        // Check test mode
        checkTestMode();
        
        // Setup UI
        updateStepUI(1);
        renderOrderItems();
        updateOrderSummary();
        
    } catch (error) {
        showError('Failed to initialize: ' + error.message);
    } finally {
        showLoading(false);
    }
});

// ============================================
// DATA LOADING
// ============================================
async function loadCartData() {
    try {
        const cartData = localStorage.getItem('irya_cart') || '[]';
        orderData.items = JSON.parse(cartData);
        
        if (orderData.items.length === 0) {
            throw new Error('Cart is empty');
        }
        
        // Calculate totals
        calculateTotals();
        
        // Get user data
        const userData = localStorage.getItem('irya_user');
        if (userData) {
            const user = JSON.parse(userData);
            orderData.userId = user.uid || 'guest_' + Date.now();
            orderData.userEmail = user.email || '';
            
            // Pre-fill email if available
            if (user.email) {
                document.getElementById('shippingEmail').value = user.email;
            }
        } else {
            orderData.userId = 'guest_' + Date.now();
        }
        
    } catch (error) {
        showError('Failed to load cart: ' + error.message);
    }
}

function calculateTotals() {
    orderData.subtotal = orderData.items.reduce((sum, item) => {
        return sum + (item.price * item.quantity);
    }, 0);
    
    orderData.tax = orderData.subtotal * 0.2;
    orderData.total = orderData.subtotal + orderData.tax;
    orderData.advance = orderData.total * 0.3;
}

// ============================================
// TEST MODE HANDLING
// ============================================
function checkTestMode() {
    const userEmail = orderData.userEmail || document.getElementById('shippingEmail').value;
    const isTestEmail = userEmail === TEST_EMAIL;
    
    if (isTestEmail) {
        document.getElementById('testModeBadge').style.display = 'block';
        showNotification('Test Mode Active - Only test payments allowed');
    }
}

function validateTestMode() {
    const userEmail = document.getElementById('shippingEmail').value;
    if (userEmail !== TEST_EMAIL) {
        showError('Only test payments allowed for email: ' + TEST_EMAIL);
        return false;
    }
    return true;
}

// ============================================
// STEP NAVIGATION
// ============================================
function goToStep(step) {
    if (step < currentStep || validateCurrentStep()) {
        currentStep = step;
        updateStepUI(step);
        
        if (step === 2) {
            updatePaymentTimingInfo();
        } else if (step === 3) {
            updateReviewContent();
        }
    }
}

function updateStepUI(step) {
    // Update step circles
    for (let i = 1; i <= 3; i++) {
        const circle = document.getElementById('step' + i);
        const line = document.getElementById('line' + (i - 1));
        const content = document.getElementById('stepContent' + i);
        
        if (i <= step) {
            circle.classList.add('active');
            if (line) line.classList.add('active');
        } else {
            circle.classList.remove('active');
            if (line) line.classList.remove('active');
        }
        
        if (content) {
            content.classList.toggle('active', i === step);
        }
    }
}

function validateCurrentStep() {
    if (currentStep === 1) {
        const required = ['shippingName', 'shippingEmail', 'shippingPhone', 'shippingAddress1', 'shippingCity', 'shippingPostalCode'];
        for (const field of required) {
            const el = document.getElementById(field);
            if (!el.value.trim()) {
                showError('Please fill in all required fields');
                el.focus();
                return false;
            }
        }
        
        const email = document.getElementById('shippingEmail').value;
        if (!isValidEmail(email)) {
            showError('Please enter a valid email');
            return false;
        }
    }
    return true;
}

// ============================================
// PAYMENT METHODS
// ============================================
function selectPaymentMethod(method) {
    selectedPaymentMethod = method;
    
    // Update UI
    document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('selected');
    });
    document.getElementById(method + 'Method').classList.add('selected');
    
    // Show/hide details
    document.getElementById('bankDetails').style.display = method === 'bank' ? 'block' : 'none';
    
    // Update timing info
    updatePaymentTimingInfo();
    
    // Generate bank reference
    if (method === 'bank') {
        const ref = 'IRYA-' + Date.now().toString().slice(-6) + '-' + Math.floor(Math.random() * 1000);
        document.getElementById('bankReference').textContent = ref;
    }
}

function updatePaymentTimingInfo() {
    const timingDiv = document.getElementById('timingInfo');
    
    if (selectedPaymentMethod === 'stripe') {
        timingDiv.innerHTML = `
            <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px;">
                <h4 style="margin-bottom: 8px; color: var(--success-green); font-size: 14px;">
                    <i class="fas fa-bolt"></i> Instant Confirmation
                </h4>
                <p style="font-size: 12px; color: var(--text-dark);">
                    • Order confirmed immediately<br>
                    • No waiting period<br>
                    • Platform fee: 2.5% + £0.30 + Stripe charges (1.4% + £0.20)
                </p>
            </div>
        `;
    } else {
        const deadline = new Date(Date.now() + 24 * 60 * 60 * 1000);
        timingDiv.innerHTML = `
            <div style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px;">
                <h4 style="margin-bottom: 8px; color: var(--warning-orange); font-size: 14px;">
                    <i class="fas fa-clock"></i> Confirm within 24 Hours
                </h4>
                <p style="font-size: 12px; color: var(--text-dark);">
                    • Deadline: ${deadline.toLocaleString()}<br>
                    • Auto-cancel if payment not confirmed<br>
                    • Platform fee: 2.5% + £0.30 + Bank charges (£0.50)<br>
                    • Refund = Advance - Fees if cancelled
                </p>
            </div>
        `;
    }
    timingDiv.style.display = 'block';
}

// ============================================
// ORDER PROCESSING
// ============================================
async function placeOrder() {
    showLoading(true);
    
    try {
        // Validate test mode
        if (!validateTestMode()) {
            showLoading(false);
            return;
        }
        
        // Create order object
        const orderId = 'order_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const orderNumber = 'IRYA-' + Date.now().toString().slice(-8);
        const now = new Date();
        const deadline = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        
        const order = {
            orderId: orderId,
            orderNumber: orderNumber,
            userId: orderData.userId,
            userEmail: document.getElementById('shippingEmail').value,
            items: orderData.items,
            subtotal: orderData.subtotal,
            tax: orderData.tax,
            total: orderData.total,
            advance: orderData.advance,
            shippingDetails: {
                name: document.getElementById('shippingName').value,
                email: document.getElementById('shippingEmail').value,
                phone: document.getElementById('shippingPhone').value,
                address: document.getElementById('shippingAddress1').value,
                city: document.getElementById('shippingCity').value,
                postalCode: document.getElementById('shippingPostalCode').value,
                country: document.getElementById('shippingCountry').value
            },
            paymentMethod: selectedPaymentMethod,
            paymentStatus: selectedPaymentMethod === 'bank' ? 'pending' : 'paid',
            orderStatus: selectedPaymentMethod === 'bank' ? 'payment_pending' : 'confirmed',
            notes: document.getElementById('orderNotes').value,
            createdAt: now.toISOString(),
            updatedAt: now.toISOString(),
            paymentConfirmDeadline: deadline.toISOString(),
            autoCancelTime: deadline.toISOString(),
            refundPolicy: 'Refund = Advance - Platform Fee (2.5% + £0.30) - Payment Gateway Charges'
        };
        
        // Calculate fees
        const platformFee = (orderData.advance * 0.025) + 0.30;
        const gatewayFee = selectedPaymentMethod === 'stripe' ? 
            (orderData.advance * 0.014) + 0.20 : 0.50;
        const refundAmount = orderData.advance - platformFee - gatewayFee;
        
        order.platformFee = platformFee;
        order.gatewayFee = gatewayFee;
        order.refundAmount = refundAmount;
        
        // Save to Firebase FIRST
        const firebaseResult = await saveOrderToFirebase(order);
        
        if (selectedPaymentMethod === 'stripe') {
            // Process Stripe payment
            await processStripePayment(order, firebaseResult);
        } else {
            // Bank transfer - show instructions
            showBankTransferModal(order, firebaseResult);
        }
        
    } catch (error) {
        showError('Order failed: ' + error.message);
        showLoading(false);
    }
}

// ============================================
// FIREBASE SAVE - FIXED
// ============================================
async function saveOrderToFirebase(order) {
    try {
        // Save to user's orders collection
        const userOrderRef = firebaseDB.collection('users')
            .doc(order.userId)
            .collection('orders')
            .doc(order.orderId);
        
        await userOrderRef.set(order);
        console.log('✅ Saved to user orders');
        
        // Save to global orders collection
        const globalOrderRef = firebaseDB.collection('orders')
            .doc(order.orderId);
        
        await globalOrderRef.set(order);
        console.log('✅ Saved to global orders');
        
        // Also save to backup collection
        const backupRef = firebaseDB.collection('orders_backup')
            .doc(order.orderId);
        
        await backupRef.set({
            ...order,
            backupSavedAt: new Date().toISOString()
        });
        console.log('✅ Saved to backup');
        
        return { success: true, orderId: order.orderId };
        
    } catch (error) {
        console.error('Firebase save error:', error);
        throw new Error('Failed to save order: ' + error.message);
    }
}

// ============================================
// STRIPE PAYMENT
// ============================================
async function processStripePayment(order, firebaseResult) {
    try {
        // Create Stripe payment intent on your backend
        // For demo, we'll simulate this
        const paymentResult = await simulateStripePayment(order);
        
        if (paymentResult.success) {
            // Update order status
            await updateOrderStatus(order.orderId, 'paid', 'confirmed');
            
            // Clear cart
            localStorage.removeItem('irya_cart');
            
            // Show success
            showSuccessModal(order, 'Card payment successful! Order confirmed instantly.');
        } else {
            throw new Error('Payment failed');
        }
        
    } catch (error) {
        // Update order status to failed
        await updateOrderStatus(order.orderId, 'failed', 'cancelled');
        throw error;
    } finally {
        showLoading(false);
    }
}

async function simulateStripePayment(order) {
    // Simulate API call
    return new Promise(resolve => {
        setTimeout(() => {
            resolve({
                success: true,
                paymentId: 'pi_' + Date.now(),
                amount: Math.round(order.advance * 100)
            });
        }, 1500);
    });
}

// ============================================
// BANK TRANSFER
// ============================================
function showBankTransferModal(order, firebaseResult) {
    const deadline = new Date(order.paymentConfirmDeadline);
    const refundAmount = order.refundAmount;
    
    document.getElementById('bankModalDetails').innerHTML = `
        <p><strong>Order Number:</strong> ${order.orderNumber}</p>
        <p><strong>Advance Amount:</strong> £${order.advance.toFixed(2)}</p>
        <p><strong>Bank:</strong> HSBC UK</p>
        <p><strong>Account:</strong> IRYA STONE LTD</p>
        <p><strong>Account No:</strong> 12345678</p>
        <p><strong>Sort Code:</strong> 40-04-15</p>
        <p><strong>Reference:</strong> ${order.orderNumber}</p>
        <div style="margin-top: 15px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
            <p style="color: var(--warning-orange); font-size: 11px;">
                <i class="fas fa-exclamation-triangle"></i> IMPORTANT
            </p>
            <p style="font-size: 10px; color: var(--text-dark);">
                • Confirm payment by: ${deadline.toLocaleString()}<br>
                • Auto-cancel after deadline<br>
                • Platform fee: £${order.platformFee.toFixed(2)}<br>
                • Bank charges: £${order.gatewayFee.toFixed(2)}<br>
                • Refund if cancelled: £${refundAmount.toFixed(2)}
            </p>
        </div>
    `;
    
    document.getElementById('bankModal').style.display = 'flex';
    showLoading(false);
}

function closeBankModal() {
    document.getElementById('bankModal').style.display = 'none';
    
    // Clear cart
    localStorage.removeItem('irya_cart');
    
    // Show success modal
    const order = JSON.parse(localStorage.getItem('irya_last_order'));
    showSuccessModal(order, 'Order created! Complete bank transfer within 24 hours.');
}

// ============================================
// ORDER STATUS UPDATE
// ============================================
async function updateOrderStatus(orderId, paymentStatus, orderStatus) {
    try {
        const updateData = {
            paymentStatus: paymentStatus,
            orderStatus: orderStatus,
            updatedAt: new Date().toISOString()
        };
        
        // Update in user collection
        await firebaseDB.collection('users')
            .doc(orderData.userId)
            .collection('orders')
            .doc(orderId)
            .update(updateData);
        
        // Update in global collection
        await firebaseDB.collection('orders')
            .doc(orderId)
            .update(updateData);
            
    } catch (error) {
        console.error('Status update failed:', error);
    }
}

// ============================================
// UI UPDATES
// ============================================
function renderOrderItems() {
    const container = document.getElementById('orderItems');
    
    if (orderData.items.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">No items</p>';
        return;
    }
    
    let html = '';
    orderData.items.forEach(item => {
        html += `
            <div class="order-item">
                <div style="flex: 1;">
                    <div style="font-size: 13px; font-weight: 600;">${item.name}</div>
                    <div style="font-size: 11px; color: var(--text-light);">Qty: ${item.quantity}</div>
                </div>
                <div style="font-weight: 600; color: var(--primary-gold);">
                    £${(item.price * item.quantity).toFixed(2)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateOrderSummary() {
    document.getElementById('subtotalAmount').textContent = '£' + orderData.subtotal.toFixed(2);
    document.getElementById('taxAmount').textContent = '£' + orderData.tax.toFixed(2);
    document.getElementById('totalAmount').textContent = '£' + orderData.total.toFixed(2);
    document.getElementById('advanceAmount').textContent = '£' + orderData.advance.toFixed(2);
}

function updateReviewContent() {
    const content = document.getElementById('reviewContent');
    const shipping = {
        name: document.getElementById('shippingName').value,
        email: document.getElementById('shippingEmail').value,
        address: document.getElementById('shippingAddress1').value,
        city: document.getElementById('shippingCity').value,
        postalCode: document.getElementById('shippingPostalCode').value
    };
    
    const platformFee = (orderData.advance * 0.025) + 0.30;
    const gatewayFee = selectedPaymentMethod === 'stripe' ? 
        (orderData.advance * 0.014) + 0.20 : 0.50;
    const refundAmount = orderData.advance - platformFee - gatewayFee;
    
    content.innerHTML = `
        <div style="display: grid; gap: 15px;">
            <div style="padding: 15px; background: var(--bg-light); border-radius: 8px;">
                <h4 style="margin-bottom: 10px; font-size: 14px;">Shipping Details</h4>
                <p style="font-size: 12px;">${shipping.name}<br>
                ${shipping.address}<br>
                ${shipping.city} ${shipping.postalCode}<br>
                ${shipping.email}</p>
            </div>
            
            <div style="padding: 15px; background: var(--bg-light); border-radius: 8px;">
                <h4 style="margin-bottom: 10px; font-size: 14px;">Payment Method</h4>
                <p style="font-size: 12px;">
                    ${selectedPaymentMethod === 'stripe' ? 'Credit/Debit Card' : 'Bank Transfer'}<br>
                    ${selectedPaymentMethod === 'stripe' ? 'Instant confirmation' : '24-hour confirmation'}
                </p>
            </div>
            
            <div style="padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                <h4 style="margin-bottom: 10px; font-size: 14px; color: var(--warning-orange);">Refund Policy</h4>
                <div style="font-size: 12px;">
                    <p><strong>Advance:</strong> £${orderData.advance.toFixed(2)}</p>
                    <p><strong>Platform Fee:</strong> £${platformFee.toFixed(2)} (2.5% + £0.30)</p>
                    <p><strong>Payment Charges:</strong> £${gatewayFee.toFixed(2)}</p>
                    <p><strong>Refund Amount:</strong> £${refundAmount.toFixed(2)}</p>
                    <p style="color: var(--error-red); margin-top: 8px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        If payment not confirmed within 24 hours
                    </p>
                </div>
            </div>
        </div>
    `;
}

function showSuccessModal(order, message) {
    document.getElementById('successTitle').textContent = 
        selectedPaymentMethod === 'bank' ? 'Order Created!' : 'Payment Successful!';
    document.getElementById('successMessage').textContent = message;
    
    document.getElementById('successDetails').innerHTML = `
        <p><strong>Order Number:</strong> ${order.orderNumber}</p>
        <p><strong>Total Amount:</strong> £${order.total.toFixed(2)}</p>
        <p><strong>Advance Paid:</strong> £${order.advance.toFixed(2)}</p>
        <p><strong>Payment Method:</strong> ${selectedPaymentMethod === 'stripe' ? 'Card' : 'Bank Transfer'}</p>
        <p><strong>Status:</strong> ${selectedPaymentMethod === 'stripe' ? 'Confirmed' : 'Pending Payment'}</p>
        ${selectedPaymentMethod === 'bank' ? 
            `<p style="color: var(--warning-orange); margin-top: 8px;">
                <i class="fas fa-clock"></i> Complete payment within 24 hours
            </p>` : ''
        }
    `;
    
    document.getElementById('successModal').style.display = 'flex';
}

// ============================================
// UTILITY FUNCTIONS
// ============================================
function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
}

function showNotification(message) {
    const el = document.getElementById('notification');
    el.textContent = message;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
}

function showError(message) {
    const el = document.getElementById('errorMessage');
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 5000);
}

function goToHome() {
    window.location.href = 'index.html';
}

// ============================================
// MAKE FUNCTIONS GLOBALLY AVAILABLE
// ============================================
window.selectPaymentMethod = selectPaymentMethod;
window.goToStep = goToStep;
window.placeOrder = placeOrder;
window.closeBankModal = closeBankModal;
window.goToHome = goToHome;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | IRYA STONE</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f5f5;
            color: #333;
            padding-bottom: 80px;
        }
        
        /* Header */
        .header {
            background: white;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 18px;
            color: #c9a227;
        }
        
        /* Container */
        .container {
            max-width: 800px;
            margin: 80px auto 20px;
            padding: 0 15px;
        }
        
        /* Card */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #c9a227;
            padding-bottom: 10px;
        }
        
        /* Order Type Badge */
        .order-type-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .badge-new {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-remaining {
            background: #fff8e1;
            color: #f57c00;
        }
        
        /* Payment Info Card */
        .payment-info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .payment-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .payment-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .payment-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .payment-value {
            font-weight: bold;
            font-size: 18px;
        }
        
        .urgent-badge {
            background: #ff4757;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Order Summary */
        .order-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .item-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .item-specs {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .item-price {
            color: #c9a227;
            font-weight: bold;
        }
        
        /* Price Details */
        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
        }
        
        .price-row.total {
            font-size: 18px;
            font-weight: bold;
            border-top: 2px solid #eee;
            padding-top: 15px;
            margin-top: 10px;
        }
        
        .price-paid {
            color: #4caf50;
        }
        
        .price-remaining {
            color: #ff6b6b;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #c9a227;
            box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* Payment Methods */
        .payment-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .payment-option.selected {
            border-color: #c9a227;
            background: rgba(201, 162, 39, 0.05);
        }
        
        .payment-icon {
            width: 40px;
            height: 40px;
            background: #f5f5f5;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #c9a227;
            font-size: 20px;
        }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #c9a227;
            color: white;
        }
        
        .btn-primary:hover {
            background: #b08f20;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 162, 39, 0.2);
        }
        
        .btn-danger {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);
        }
        
        .btn-secondary {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #f5f5f5;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #c9a227;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error */
        .error-box {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #c62828;
        }
        
        /* Success */
        .success-box {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .success-icon {
            width: 60px;
            height: 60px;
            background: #4caf50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto 15px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-row, .payment-details {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 70px auto 10px;
            }
        }
        
        @media (max-width: 480px) {
            .card {
                padding: 15px;
            }
            
            .btn {
                padding: 12px;
                font-size: 14px;
            }
        }
        
        /* Calculation Display */
        .calculation-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .calc-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .calc-row.total {
            font-weight: bold;
            color: #c9a227;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>

<!-- Header -->
<header class="header">
    <div class="logo">
        <i class="fas fa-gem"></i>
        <span>IRYA STONE</span>
    </div>
</header>

<!-- Main Container -->
<main class="container">
    <!-- Loading State -->
    <div class="loading" id="loadingState">
        <div class="spinner"></div>
        <p id="loadingText">Loading...</p>
    </div>
    
    <!-- Error State -->
    <div class="error-box" id="errorState" style="display: none;">
        <p id="errorMessage">Error loading checkout</p>
        <button class="btn-secondary" onclick="retryLoad()" style="margin-top: 10px;">
            <i class="fas fa-redo"></i> Try Again
        </button>
    </div>
    
    <!-- Checkout Content -->
    <div id="checkoutContent" style="display: none;">
        <!-- Payment Info Card (for remaining payments) -->
        <div class="payment-info-card" id="remainingPaymentCard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div class="urgent-badge" id="urgentBadge" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i> URGENT PAYMENT
                    </div>
                    <h3 style="margin: 10px 0; color: white;">Complete Remaining Payment</h3>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 5px; font-size: 12px;">
                    Remaining Payment
                </div>
            </div>
            
            <div class="payment-details">
                <div class="payment-item">
                    <div class="payment-label">Order Number</div>
                    <div class="payment-value" id="remOrderNumber">-</div>
                </div>
                <div class="payment-item">
                    <div class="payment-label">Remaining Amount</div>
                    <div class="payment-value" id="remAmount">£0.00</div>
                </div>
                <div class="payment-item">
                    <div class="payment-label">Already Paid</div>
                    <div class="payment-value" id="remPaid">£0.00</div>
                </div>
                <div class="payment-item">
                    <div class="payment-label">Total Order</div>
                    <div class="payment-value" id="remTotal">£0.00</div>
                </div>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="card">
            <h2><i class="fas fa-box"></i> Order Summary</h2>
            
            <!-- Order Type Badge -->
            <div id="orderTypeBadge"></div>
            
            <div id="orderItems"></div>
            
            <div class="calculation-details" id="calculationDetails">
                <!-- Price calculation details -->
            </div>
            
            <div style="margin-top: 20px;">
                <div class="price-row">
                    <span>Subtotal:</span>
                    <span id="subtotalAmount">£0.00</span>
                </div>
                <div class="price-row">
                    <span>Shipping:</span>
                    <span id="shippingAmount">£0.00</span>
                </div>
                <div class="price-row">
                    <span>Tax (20%):</span>
                    <span id="taxAmount">£0.00</span>
                </div>
                
                <!-- For remaining payments -->
                <div class="price-row price-paid" id="alreadyPaidRow" style="display: none;">
                    <span>Already Paid:</span>
                    <span id="alreadyPaidAmount">£0.00</span>
                </div>
                
                <!-- For remaining payments -->
                <div class="price-row price-remaining" id="remainingPaymentRow" style="display: none;">
                    <span>Remaining Payment:</span>
                    <span id="remainingPaymentAmount">£0.00</span>
                </div>
                
                <!-- For new orders -->
                <div class="price-row" id="advancePaymentRow" style="display: none;">
                    <span>Advance Payment (30%):</span>
                    <span id="advanceAmount">£0.00</span>
                </div>
                
                <div class="price-row total">
                    <span id="totalLabel">Total Amount:</span>
                    <span id="totalAmount">£0.00</span>
                </div>
            </div>
        </div>
        
        <!-- Customer Details (for new orders only) -->
        <div class="card" id="customerDetailsCard">
            <h2><i class="fas fa-user"></i> Customer Details</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="customerEmail" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="customerPhone" required>
                </div>
                <div class="form-group">
                    <label>Country</label>
                    <select id="customerCountry">
                        <option value="GB">United Kingdom</option>
                        <option value="US">United States</option>
                        <option value="IN">India</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Address *</label>
                <input type="text" id="customerAddress" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>City *</label>
                    <input type="text" id="customerCity" required>
                </div>
                <div class="form-group">
                    <label>Postal Code *</label>
                    <input type="text" id="customerPostalCode" required>
                </div>
            </div>
        </div>
        
        <!-- Payment Method -->
        <div class="card">
            <h2><i class="fas fa-credit-card"></i> Payment Method</h2>
            
            <div class="payment-option" onclick="selectPayment('bank')" id="bankOption">
                <div class="payment-icon">
                    <i class="fas fa-university"></i>
                </div>
                <div>
                    <div style="font-weight: bold;">Bank Transfer</div>
                    <div style="font-size: 12px; color: #666;">Transfer to our bank account</div>
                </div>
                <div style="margin-left: auto; color: #c9a227; display: none;" id="bankCheck">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            
            <div id="bankDetails" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 10px;">Bank Account Details:</div>
                <div style="font-size: 14px; line-height: 1.6;">
                    <div><strong>Bank:</strong> HSBC UK</div>
                    <div><strong>Account:</strong> IRYA STONE LTD</div>
                    <div><strong>Account No:</strong> 12345678</div>
                    <div><strong>Sort Code:</strong> 40-04-15</div>
                    <div><strong>Reference:</strong> <span id="bankReference"></span></div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    <i class="fas fa-info-circle"></i> Please use this reference when making payment
                </div>
            </div>
            
            <div class="payment-option" onclick="selectPayment('card')" id="cardOption">
                <div class="payment-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div>
                    <div style="font-weight: bold;">Credit/Debit Card</div>
                    <div style="font-size: 12px; color: #666;">Pay with card (Coming Soon)</div>
                </div>
                <div style="margin-left: auto; color: #c9a227; display: none;" id="cardCheck">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
        </div>
        
        <!-- Order Notes -->
        <div class="card" id="orderNotesCard">
            <h2><i class="fas fa-edit"></i> Order Notes (Optional)</h2>
            <textarea id="orderNotes" rows="3" placeholder="Any special requirements or notes..."></textarea>
        </div>
        
        <!-- Place Order Button -->
        <div class="card">
            <button class="btn btn-primary" onclick="placeOrder()" id="placeOrderBtn">
                <i class="fas fa-lock"></i> <span id="payButtonText">Place Order</span>
            </button>
            <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #666;">
                <i class="fas fa-shield-alt"></i> Secure checkout • SSL encrypted
            </div>
        </div>
    </div>
    
    <!-- Success Box -->
    <div class="success-box" id="successBox" style="display: none;">
        <div class="success-icon">
            <i class="fas fa-check"></i>
        </div>
        <h3 style="margin-bottom: 10px; color: #2e7d32;" id="successTitle">Order Successful!</h3>
        <div id="orderDetails" style="margin-bottom: 15px; text-align: left; background: white; padding: 15px; border-radius: 5px;">
            <!-- Order details will appear here -->
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="viewOrder()">
                <i class="fas fa-eye"></i> View Order
            </button>
            <button class="btn btn-secondary" onclick="goHome()">
                <i class="fas fa-home"></i> Back to Home
            </button>
        </div>
    </div>
</main>

<script>
// Global Variables
let currentOrder = {
    items: [],
    subtotal: 0,
    shipping: 0,
    tax: 0,
    total: 0,
    advance: 0,
    remaining: 0
};

let selectedPayment = 'bank';
let checkoutType = 'new'; // 'new' or 'remaining'
let existingOrderData = null;
let currentOrderId = null;

// Initialize Page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Checkout page loading...');
    loadOrderData();
});

// Load Order Data
function loadOrderData() {
    showLoading(true);
    
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const isBuyNow = urlParams.get('buynow') === 'true';
    const productId = urlParams.get('product');
    const orderId = urlParams.get('order');
    const paymentType = urlParams.get('type');
    const source = urlParams.get('source');
    
    console.log('URL Params:', { isBuyNow, productId, orderId, paymentType, source });
    
    // Check if this is a remaining payment
    if (paymentType === 'remaining_payment' && orderId) {
        checkoutType = 'remaining';
        loadRemainingPayment(orderId);
    } else if (isBuyNow && productId) {
        checkoutType = 'new';
        loadBuyNowOrder(productId);
    } else {
        checkoutType = 'new';
        loadCartOrder();
    }
}

// Load Remaining Payment Order
function loadRemainingPayment(orderId) {
    try {
        document.getElementById('loadingText').textContent = 'Loading payment details...';
        
        // Check localStorage for pending payment data
        const storedPayment = localStorage.getItem('irya_pending_payment_order');
        if (storedPayment) {
            existingOrderData = JSON.parse(storedPayment);
            console.log('Loaded from localStorage:', existingOrderData);
        } else {
            // Try to get from URL or session
            const amount = new URLSearchParams(window.location.search).get('amount');
            existingOrderData = {
                orderId: orderId,
                remainingAmount: parseFloat(amount) || 0,
                source: 'notification'
            };
        }
        
        // Set order type
        updateCheckoutType();
        
        // For demo, we'll create dummy data
        // In real app, you would fetch from Firebase
        setupRemainingPaymentDemo();
        
    } catch (error) {
        console.error('Error loading remaining payment:', error);
        showError('Failed to load payment details. Please try again.');
    }
}

// Setup demo data for remaining payment
function setupRemainingPaymentDemo() {
    // Create demo order data
    existingOrderData.orderNumber = 'IRYA-' + Date.now();
    existingOrderData.total = 1500;
    existingOrderData.paid = 450; // 30%
    existingOrderData.remaining = 1050; // 70%
    
    // Update currentOrder for display
    currentOrder.total = existingOrderData.remaining;
    currentOrder.items = [{
        name: 'Existing Order Payment',
        stoneName: 'Remaining Payment for Order ' + existingOrderData.orderNumber,
        price: existingOrderData.remaining,
        quantity: 1,
        calculatedPrice: existingOrderData.remaining
    }];
    
    // Update UI
    updateRemainingPaymentDisplay();
    showCheckout();
}

// Load Buy Now Order
function loadBuyNowOrder(productId) {
    try {
        document.getElementById('loadingText').textContent = 'Loading order details...';
        
        // Get product from localStorage
        const buyNowData = localStorage.getItem('irya_buynow_cart_' + getUserId());
        if (buyNowData) {
            const items = JSON.parse(buyNowData);
            currentOrder.items = items;
            calculateOrder();
            updateCheckoutType();
            showCheckout();
        } else {
            // Try session storage
            const sessionData = sessionStorage.getItem('irya_current_buynow');
            if (sessionData) {
                const item = JSON.parse(sessionData);
                currentOrder.items = [item];
                calculateOrder();
                updateCheckoutType();
                showCheckout();
            } else {
                showError('No buy now items found. Please try again.');
            }
        }
    } catch (error) {
        console.error('Error loading buy now:', error);
        showError('Failed to load order. Please try again.');
    }
}

// Load Cart Order
function loadCartOrder() {
    try {
        document.getElementById('loadingText').textContent = 'Loading cart items...';
        
        const cartData = localStorage.getItem('irya_local_cart_' + getUserId());
        if (cartData) {
            const items = JSON.parse(cartData);
            // Filter out buy now items
            currentOrder.items = items.filter(item => !item.isBuyNow);
            
            if (currentOrder.items.length === 0) {
                showError('Your cart is empty. Please add items first.');
                return;
            }
            
            calculateOrder();
            updateCheckoutType();
            showCheckout();
        } else {
            showError('Your cart is empty. Please add items first.');
        }
    } catch (error) {
        console.error('Error loading cart:', error);
        showError('Failed to load cart. Please try again.');
    }
}

// Update Checkout Type Display
function updateCheckoutType() {
    const orderTypeBadge = document.getElementById('orderTypeBadge');
    const remainingPaymentCard = document.getElementById('remainingPaymentCard');
    const customerDetailsCard = document.getElementById('customerDetailsCard');
    const orderNotesCard = document.getElementById('orderNotesCard');
    const placeOrderBtn = document.getElementById('placeOrderBtn');
    const payButtonText = document.getElementById('payButtonText');
    const totalLabel = document.getElementById('totalLabel');
    const advancePaymentRow = document.getElementById('advancePaymentRow');
    const alreadyPaidRow = document.getElementById('alreadyPaidRow');
    const remainingPaymentRow = document.getElementById('remainingPaymentRow');
    
    if (checkoutType === 'remaining') {
        // Remaining Payment
        orderTypeBadge.innerHTML = '<div class="order-type-badge badge-remaining"><i class="fas fa-money-bill-wave"></i> Remaining Payment</div>';
        remainingPaymentCard.style.display = 'block';
        customerDetailsCard.style.display = 'none';
        orderNotesCard.style.display = 'none';
        payButtonText.textContent = 'Pay Remaining Amount';
        totalLabel.textContent = 'Payment Due:';
        advancePaymentRow.style.display = 'none';
        alreadyPaidRow.style.display = 'flex';
        remainingPaymentRow.style.display = 'flex';
        
        // Show urgent badge if from notification
        if (existingOrderData.source === 'notification') {
            document.getElementById('urgentBadge').style.display = 'inline-flex';
        }
        
    } else {
        // New Order
        orderTypeBadge.innerHTML = '<div class="order-type-badge badge-new"><i class="fas fa-shopping-cart"></i> New Order</div>';
        remainingPaymentCard.style.display = 'none';
        customerDetailsCard.style.display = 'block';
        orderNotesCard.style.display = 'block';
        payButtonText.textContent = 'Place Order & Pay Advance';
        totalLabel.textContent = 'Total Amount:';
        advancePaymentRow.style.display = 'flex';
        alreadyPaidRow.style.display = 'none';
        remainingPaymentRow.style.display = 'none';
    }
}

// Update Remaining Payment Display
function updateRemainingPaymentDisplay() {
    document.getElementById('remOrderNumber').textContent = existingOrderData.orderNumber || '-';
    document.getElementById('remAmount').textContent = '£' + existingOrderData.remaining.toFixed(2);
    document.getElementById('remPaid').textContent = '£' + existingOrderData.paid.toFixed(2);
    document.getElementById('remTotal').textContent = '£' + existingOrderData.total.toFixed(2);
    
    document.getElementById('alreadyPaidAmount').textContent = '£' + existingOrderData.paid.toFixed(2);
    document.getElementById('remainingPaymentAmount').textContent = '£' + existingOrderData.remaining.toFixed(2);
    document.getElementById('totalAmount').textContent = '£' + existingOrderData.remaining.toFixed(2);
}

// Calculate Order Totals (for new orders)
function calculateOrder() {
    let subtotal = 0;
    
    currentOrder.items.forEach(item => {
        // Calculate item total
        let itemTotal = 0;
        
        if (item.calculationData) {
            // Calculate based on calculation data
            const calc = item.calculationData;
            const unit = calc.unit || 'piece';
            const quantity = calc.quantity || 1;
            const price = item.price || 0;
            
            if (unit === 'sqft' || unit === 'sqm') {
                const length = calc.length || 1;
                const width = calc.width || 1;
                const area = length * width;
                itemTotal = price * area * quantity;
            } else if (unit === 'weight') {
                const weight = calc.weight || 1;
                itemTotal = price * weight * quantity;
            } else {
                itemTotal = price * quantity;
            }
        } else {
            // Simple calculation
            const quantity = item.quantity || 1;
            const price = item.price || 0;
            itemTotal = price * quantity;
        }
        
        item.calculatedPrice = itemTotal;
        subtotal += itemTotal;
    });
    
    // Set order values
    currentOrder.subtotal = subtotal;
    currentOrder.shipping = subtotal > 500 ? 0 : 25; // Free shipping over £500
    currentOrder.tax = subtotal * 0.2; // 20% VAT
    currentOrder.total = subtotal + currentOrder.shipping + currentOrder.tax;
    currentOrder.advance = currentOrder.total * 0.3; // 30% advance
    currentOrder.remaining = currentOrder.total * 0.7; // 70% remaining
    
    // Update UI
    updateOrderDisplay();
}

// Update Order Display
function updateOrderDisplay() {
    // Update order items
    const orderItemsDiv = document.getElementById('orderItems');
    let itemsHTML = '';
    
    currentOrder.items.forEach((item, index) => {
        const itemName = item.stoneName || item.name || 'Stone Product';
        const quantity = item.quantity || 1;
        const price = item.calculatedPrice || (item.price * quantity);
        const image = item.image || getDefaultImage();
        
        let specsHTML = '';
        if (item.calculationData) {
            const calc = item.calculationData;
            if (calc.unit === 'sqft') {
                specsHTML = `<div class="item-specs">${calc.length || 0}ft × ${calc.width || 0}ft (${calc.unit}) × ${calc.quantity || 1}</div>`;
            } else if (calc.unit === 'sqm') {
                specsHTML = `<div class="item-specs">${calc.length || 0}m × ${calc.width || 0}m (${calc.unit}) × ${calc.quantity || 1}</div>`;
            } else if (calc.unit === 'weight') {
                specsHTML = `<div class="item-specs">${calc.weight || 0}kg (weight) × ${calc.quantity || 1}</div>`;
            } else {
                specsHTML = `<div class="item-specs">${quantity} pieces</div>`;
            }
        } else {
            specsHTML = `<div class="item-specs">${quantity} pieces</div>`;
        }
        
        itemsHTML += `
            <div class="order-item">
                <div class="item-image">
                    <img src="${image}" alt="${itemName}" onerror="this.src='${getDefaultImage()}'">
                </div>
                <div class="item-details">
                    <div class="item-name">${itemName}</div>
                    ${specsHTML}
                    <div class="item-price">£${price.toFixed(2)}</div>
                </div>
            </div>
        `;
    });
    
    orderItemsDiv.innerHTML = itemsHTML;
    
    // Update calculation details
    const calcDetailsDiv = document.getElementById('calculationDetails');
    let calcHTML = '<div style="font-weight: bold; margin-bottom: 10px;">Price Calculation:</div>';
    
    currentOrder.items.forEach((item, index) => {
        const itemName = item.stoneName || item.name || 'Product';
        const price = item.price || 0;
        const quantity = item.quantity || 1;
        
        if (item.calculationData) {
            const calc = item.calculationData;
            const unit = calc.unit || 'piece';
            
            if (unit === 'sqft') {
                const length = calc.length || 1;
                const width = calc.width || 1;
                const area = length * width;
                const qty = calc.quantity || 1;
                const total = price * area * qty;
                
                calcHTML += `
                    <div class="calc-row">
                        <span>${itemName}:</span>
                        <span>£${price.toFixed(2)}/sqft × (${length}ft × ${width}ft) × ${qty} = £${total.toFixed(2)}</span>
                    </div>
                `;
            } else if (unit === 'sqm') {
                const length = calc.length || 1;
                const width = calc.width || 1;
                const area = length * width;
                const qty = calc.quantity || 1;
                const total = price * area * qty;
                
                calcHTML += `
                    <div class="calc-row">
                        <span>${itemName}:</span>
                        <span>£${price.toFixed(2)}/sqm × (${length}m × ${width}m) × ${qty} = £${total.toFixed(2)}</span>
                    </div>
                `;
            } else if (unit === 'weight') {
                const weight = calc.weight || 1;
                const qty = calc.quantity || 1;
                const total = price * weight * qty;
                
                calcHTML += `
                    <div class="calc-row">
                        <span>${itemName}:</span>
                        <span>£${price.toFixed(2)}/kg × ${weight}kg × ${qty} = £${total.toFixed(2)}</span>
                    </div>
                `;
            } else {
                const total = price * quantity;
                calcHTML += `
                    <div class="calc-row">
                        <span>${itemName}:</span>
                        <span>£${price.toFixed(2)} × ${quantity} = £${total.toFixed(2)}</span>
                    </div>
                `;
            }
        } else {
            const total = price * quantity;
            calcHTML += `
                <div class="calc-row">
                    <span>${itemName}:</span>
                    <span>£${price.toFixed(2)} × ${quantity} = £${total.toFixed(2)}</span>
                </div>
            `;
        }
    });
    
    calcDetailsDiv.innerHTML = calcHTML;
    
    // Update amounts
    document.getElementById('subtotalAmount').textContent = '£' + currentOrder.subtotal.toFixed(2);
    document.getElementById('shippingAmount').textContent = '£' + currentOrder.shipping.toFixed(2);
    document.getElementById('taxAmount').textContent = '£' + currentOrder.tax.toFixed(2);
    document.getElementById('totalAmount').textContent = '£' + currentOrder.total.toFixed(2);
    document.getElementById('advanceAmount').textContent = '£' + currentOrder.advance.toFixed(2);
    document.getElementById('remainingAmount').textContent = '£' + currentOrder.remaining.toFixed(2);
    
    // Generate bank reference
    const ref = 'IRYA-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    document.getElementById('bankReference').textContent = ref;
    
    // Auto-fill customer details if available
    const savedName = localStorage.getItem('irya_user_name');
    const savedEmail = localStorage.getItem('irya_user_email');
    if (savedName) document.getElementById('customerName').value = savedName;
    if (savedEmail) document.getElementById('customerEmail').value = savedEmail;
}

// Select Payment Method
function selectPayment(method) {
    selectedPayment = method;
    
    // Update UI
    document.getElementById('bankCheck').style.display = 'none';
    document.getElementById('cardCheck').style.display = 'none';
    document.getElementById('bankDetails').style.display = 'none';
    
    if (method === 'bank') {
        document.getElementById('bankCheck').style.display = 'block';
        document.getElementById('bankDetails').style.display = 'block';
    } else if (method === 'card') {
        document.getElementById('cardCheck').style.display = 'block';
    }
}

// Place Order
function placeOrder() {
    if (checkoutType === 'remaining') {
        processRemainingPayment();
    } else {
        processNewOrder();
    }
}

// Process New Order
function processNewOrder() {
    // Validate form
    if (!validateForm()) {
        return;
    }
    
    // Disable button
    const btn = document.getElementById('placeOrderBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    // Prepare order data
    const orderData = prepareNewOrderData();
    
    // Save order
    setTimeout(() => {
        saveNewOrder(orderData);
    }, 1500);
}

// Process Remaining Payment
function processRemainingPayment() {
    // Disable button
    const btn = document.getElementById('placeOrderBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Payment...';
    
    // Prepare payment data
    const paymentData = prepareRemainingPaymentData();
    
    // Process payment
    setTimeout(() => {
        saveRemainingPayment(paymentData);
    }, 1500);
}

// Validate Form (for new orders)
function validateForm() {
    const name = document.getElementById('customerName').value.trim();
    const email = document.getElementById('customerEmail').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const address = document.getElementById('customerAddress').value.trim();
    const city = document.getElementById('customerCity').value.trim();
    const postalCode = document.getElementById('customerPostalCode').value.trim();
    
    if (!name) {
        alert('Please enter your name');
        document.getElementById('customerName').focus();
        return false;
    }
    
    if (!email || !isValidEmail(email)) {
        alert('Please enter a valid email address');
        document.getElementById('customerEmail').focus();
        return false;
    }
    
    if (!phone) {
        alert('Please enter your phone number');
        document.getElementById('customerPhone').focus();
        return false;
    }
    
    if (!address) {
        alert('Please enter your address');
        document.getElementById('customerAddress').focus();
        return false;
    }
    
    if (!city) {
        alert('Please enter your city');
        document.getElementById('customerCity').focus();
        return false;
    }
    
    if (!postalCode) {
        alert('Please enter your postal code');
        document.getElementById('customerPostalCode').focus();
        return false;
    }
    
    return true;
}

// Prepare New Order Data
function prepareNewOrderData() {
    const orderNumber = 'IRYA-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    
    // Save customer details
    const customerName = document.getElementById('customerName').value;
    const customerEmail = document.getElementById('customerEmail').value;
    
    localStorage.setItem('irya_user_name', customerName);
    localStorage.setItem('irya_user_email', customerEmail);
    
    const orderData = {
        orderNumber: orderNumber,
        userId: getUserId(),
        userName: customerName,
        userEmail: customerEmail,
        userPhone: document.getElementById('customerPhone').value,
        shippingAddress: {
            address: document.getElementById('customerAddress').value,
            city: document.getElementById('customerCity').value,
            postalCode: document.getElementById('customerPostalCode').value,
            country: document.getElementById('customerCountry').value
        },
        items: currentOrder.items,
        subtotal: currentOrder.subtotal,
        shipping: currentOrder.shipping,
        tax: currentOrder.tax,
        total: currentOrder.total,
        advancePayment: currentOrder.advance,
        remainingPayment: currentOrder.remaining,
        submittedAmount: currentOrder.advance, // For first payment
        paymentMethod: selectedPayment,
        paymentReference: selectedPayment === 'bank' ? document.getElementById('bankReference').textContent : null,
        status: 'advance_paid',
        paymentStatus: 'advance_paid',
        notes: document.getElementById('orderNotes').value,
        createdAt: new Date().toISOString(),
        source: 'checkout'
    };
    
    return orderData;
}

// Prepare Remaining Payment Data
function prepareRemainingPaymentData() {
    const paymentData = {
        orderId: existingOrderData.orderId,
        orderNumber: existingOrderData.orderNumber,
        amount: existingOrderData.remaining,
        paymentMethod: selectedPayment,
        paymentReference: selectedPayment === 'bank' ? document.getElementById('bankReference').textContent : null,
        paymentType: 'remaining_payment',
        timestamp: new Date().toISOString(),
        userId: getUserId()
    };
    
    return paymentData;
}

// Save New Order
function saveNewOrder(orderData) {
    try {
        // Save to localStorage
        const orderId = 'order_' + Date.now();
        currentOrderId = orderId;
        
        // Save to user's orders
        const userOrdersKey = 'irya_user_orders_' + getUserId();
        const existingOrders = JSON.parse(localStorage.getItem(userOrdersKey) || '[]');
        existingOrders.push({
            id: orderId,
            ...orderData
        });
        localStorage.setItem(userOrdersKey, JSON.stringify(existingOrders));
        
        // Also save to main orders for easy access
        localStorage.setItem('irya_last_order', JSON.stringify(orderData));
        
        // Clear cart/buy now data
        clearSourceData();
        
        // Show success
        showSuccess(orderData, 'new');
        
    } catch (error) {
        console.error('Error saving order:', error);
        alert('Failed to save order. Please try again.');
        document.getElementById('placeOrderBtn').disabled = false;
        document.getElementById('placeOrderBtn').innerHTML = '<i class="fas fa-lock"></i> <span id="payButtonText">Place Order</span>';
    }
}

// Save Remaining Payment
function saveRemainingPayment(paymentData) {
    try {
        // Update existing order in localStorage
        const userOrdersKey = 'irya_user_orders_' + getUserId();
        const existingOrders = JSON.parse(localStorage.getItem(userOrdersKey) || '[]');
        
        // Find the order
        const orderIndex = existingOrders.findIndex(order => 
            order.orderNumber === paymentData.orderNumber || 
            order.id === paymentData.orderId
        );
        
        if (orderIndex >= 0) {
            // Update order
            existingOrders[orderIndex].submittedAmount = paymentData.amount;
            existingOrders[orderIndex].remainingPayment = 0;
            existingOrders[orderIndex].status = 'fully_paid';
            existingOrders[orderIndex].paymentStatus = 'fully_paid';
            existingOrders[orderIndex].paymentHistory = existingOrders[orderIndex].paymentHistory || [];
            existingOrders[orderIndex].paymentHistory.push({
                type: 'remaining_payment',
                amount: paymentData.amount,
                method: paymentData.paymentMethod,
                reference: paymentData.paymentReference,
                timestamp: paymentData.timestamp
            });
            
            // Save back
            localStorage.setItem(userOrdersKey, JSON.stringify(existingOrders));
            currentOrderId = existingOrders[orderIndex].id;
            
            // Clear pending payment data
            localStorage.removeItem('irya_pending_payment_order');
            
            // Show success
            showSuccess(paymentData, 'remaining');
            
        } else {
            throw new Error('Order not found');
        }
        
    } catch (error) {
        console.error('Error saving payment:', error);
        alert('Failed to process payment. Please try again.');
        document.getElementById('placeOrderBtn').disabled = false;
        document.getElementById('placeOrderBtn').innerHTML = '<i class="fas fa-lock"></i> <span id="payButtonText">Pay Remaining Amount</span>';
    }
}

// Clear Source Data (for new orders)
function clearSourceData() {
    const userId = getUserId();
    
    // Clear buy now data
    localStorage.removeItem('irya_buynow_cart_' + userId);
    sessionStorage.removeItem('irya_current_buynow');
    
    // Clear cart items that were just ordered
    const cartKey = 'irya_local_cart_' + userId;
    const cartData = localStorage.getItem(cartKey);
    
    if (cartData) {
        const cartItems = JSON.parse(cartData);
        const orderedItemIds = currentOrder.items.map(item => item.uniqueId || item.id);
        const updatedCart = cartItems.filter(item => !orderedItemIds.includes(item.uniqueId || item.id));
        localStorage.setItem(cartKey, JSON.stringify(updatedCart));
    }
}

// Show Success
function showSuccess(data, type) {
    // Hide checkout content
    document.getElementById('checkoutContent').style.display = 'none';
    
    // Show success box
    const successBox = document.getElementById('successBox');
    successBox.style.display = 'block';
    
    if (type === 'new') {
        document.getElementById('successTitle').textContent = 'Order Placed Successfully!';
        
        const orderDetails = document.getElementById('orderDetails');
        orderDetails.innerHTML = `
            <div style="margin-bottom: 10px;">
                <strong>Order Number:</strong> ${data.orderNumber}
            </div>
            <div style="margin-bottom: 10px;">
                <strong>Total Amount:</strong> £${data.total.toFixed(2)}
            </div>
            <div style="margin-bottom: 10px;">
                <strong>Advance Paid (30%):</strong> £${data.advancePayment.toFixed(2)}
            </div>
            <div style="margin-bottom: 10px;">
                <strong>Remaining (70%):</strong> £${data.remainingPayment.toFixed(2)}
            </div>
            ${data.paymentMethod === 'bank' ? `
                <div style="margin-bottom: 10px;">
                    <strong>Payment Reference:</strong> ${data.paymentReference}
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 10px;">
                    <i class="fas fa-info-circle"></i> Please use the reference above when making bank transfer
                </div>
            ` : ''}
        `;
        
    } else {
        document.getElementById('successTitle').textContent = 'Payment Successful!';
        
        const orderDetails = document.getElementById('orderDetails');
        orderDetails.innerHTML = `
            <div style="margin-bottom: 10px;">
                <strong>Order Number:</strong> ${data.orderNumber}
            </div>
            <div style="margin-bottom: 10px;">
                <strong>Payment Amount:</strong> £${data.amount.toFixed(2)}
            </div>
            <div style="margin-bottom: 10px;">
                <strong>Payment Type:</strong> Remaining Payment
            </div>
            ${data.paymentMethod === 'bank' ? `
                <div style="margin-bottom: 10px;">
                    <strong>Payment Reference:</strong> ${data.paymentReference}
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 10px;">
                    <i class="fas fa-info-circle"></i> Thank you for completing your payment
                </div>
            ` : ''}
        `;
    }
}

// Utility Functions
function getUserId() {
    const savedUser = localStorage.getItem('irya_stone_auth_user');
    if (savedUser) {
        const user = JSON.parse(savedUser);
        return user.uid;
    }
    
    let guestId = localStorage.getItem('irya_guest_id');
    if (!guestId) {
        guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('irya_guest_id', guestId);
    }
    return guestId;
}

function getDefaultImage() {
    return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800';
}

function isValidEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function showCheckout() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('checkoutContent').style.display = 'block';
    
    // Select bank payment by default
    selectPayment('bank');
}

function showError(message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorState').style.display = 'block';
}

function showLoading(show) {
    document.getElementById('loadingState').style.display = show ? 'block' : 'none';
}

function retryLoad() {
    showLoading(true);
    document.getElementById('errorState').style.display = 'none';
    setTimeout(() => {
        loadOrderData();
    }, 1000);
}

function viewOrder() {
    if (currentOrderId) {
        window.location.href = `orders.html?order_id=${currentOrderId}`;
    } else {
        window.location.href = 'orders.html';
    }
}

function goHome() {
    window.location.href = 'index.html';
}

// Make functions available globally
window.selectPayment = selectPayment;
window.placeOrder = placeOrder;
window.viewOrder = viewOrder;
window.goHome = goHome;
window.retryLoad = retryLoad;
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | IRYA STONE</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        /* ============================================
           SAME THEME AS CART.HTML
           ============================================ */
        :root {
            --primary-gold: #c9a227;
            --gold-light: #f0d77c;
            --gold-dark: #9c7c1f;
            --stone-dark: #1a1a1a;
            --stone-light: #f4f6f4;
            --bg-light: #f7f9fc;
            --text-dark: #222222;
            --text-light: #666666;
            --white: #ffffff;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --error-red: #ef4444;
            --info-blue: #3b82f6;
            --pending-yellow: #fbbf24;
            --refunded-purple: #8b5cf6;
            --cancelled-red: #dc2626;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 20px rgba(0,0,0,0.12);
            --transition: all 0.3s ease;
            --border-radius: 12px;
            --border-radius-lg: 20px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: var(--bg-light);
            color: var(--text-dark);
            padding-bottom: 80px;
            font-size: 14px;
            scroll-behavior: smooth;
        }
        
        /* ============================================
           HEADER - MATCHING CART.HTML STYLE
           ============================================ */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            gap: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            height: 60px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            min-width: 120px;
        }
        
        .logo i {
            color: var(--primary-gold);
            font-size: 18px;
        }
        
        .logo span {
            font-size: 16px;
            font-weight: 700;
            color: var(--white);
            font-family: 'Roboto Slab', serif;
        }
        
        /* Back Button */
        .back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
            color: var(--white);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: var(--transition);
            white-space: nowrap;
            min-width: 70px;
            text-decoration: none;
        }
        
        /* ============================================
           MAIN CONTENT - MATCHING CART.HTML STYLE
           ============================================ */
        .main-content {
            padding: 80px 15px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .page-header {
            margin-bottom: 25px;
            text-align: center;
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.6));
            padding: 20px 15px;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            position: relative;
        }
        
        .page-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--white);
            font-family: 'Roboto Slab', serif;
        }
        
        .test-mode-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--warning-orange);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            display: none;
        }
        
        /* ============================================
           CHECKOUT CONTAINER
           ============================================ */
        .checkout-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr 350px;
                gap: 20px;
            }
        }
        
        /* ============================================
           CHECKOUT STEPS
           ============================================ */
        .checkout-steps {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            border: 1px solid #f0f0f0;
            padding: 20px;
        }
        
        .steps-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .steps-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .step-circle.active {
            background: var(--primary-gold);
            color: white;
        }
        
        .step-line {
            width: 40px;
            height: 2px;
            background: #f0f0f0;
        }
        
        .step-line.active {
            background: var(--primary-gold);
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        /* ============================================
           FORM STYLES
           ============================================ */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--stone-dark);
            font-size: 13px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            transition: var(--transition);
            background: var(--bg-light);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        @media (min-width: 480px) {
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* ============================================
           PAYMENT METHODS
           ============================================ */
        .payment-methods {
            display: grid;
            gap: 10px;
        }
        
        .payment-method {
            padding: 15px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--bg-light);
        }
        
        .payment-method.selected {
            border-color: var(--primary-gold);
            background: rgba(201, 162, 39, 0.05);
        }
        
        /* ============================================
           ORDER SUMMARY
           ============================================ */
        .order-summary {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 20px;
            border: 1px solid #f0f0f0;
            height: fit-content;
        }
        
        @media (min-width: 768px) {
            .order-summary {
                position: sticky;
                top: 80px;
            }
        }
        
        .order-items {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .order-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .summary-total {
            font-size: 16px;
            font-weight: 700;
            color: var(--stone-dark);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }
        
        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ============================================
           LOADING & ERROR STATES
           ============================================ */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 3px solid rgba(201, 162, 39, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-gold);
            animation: spin 1s ease-in-out infinite;
            z-index: 9999;
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--primary-gold);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: var(--shadow-md);
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 250px;
            display: none;
            font-size: 13px;
        }
        
        .notification.show {
            transform: translateX(0);
            display: block;
        }
        
        .error-message {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: var(--shadow-md);
            z-index: 9999;
            display: none;
            max-width: 250px;
            text-align: center;
            font-size: 13px;
        }
        
        /* ============================================
           MODALS
           ============================================ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-lg);
        }
        
        /* Responsive Design */
        @media (max-width: 480px) {
            .main-content {
                padding: 65px 12px 15px;
            }
            
            .page-header {
                padding: 15px 12px;
            }
            
            .checkout-steps {
                padding: 15px;
            }
        }
    </style>
</head>
<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<!-- Error Message -->
<div class="error-message" id="errorMessage"></div>

<!-- Header -->
<header>
    <a href="cart.html" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
    </a>
    
    <div class="logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="page-header">
        <h1><i class="fas fa-shopping-bag"></i> Secure Checkout</h1>
        <p>Complete your purchase with our secure checkout process</p>
        <div class="test-mode-badge" id="testModeBadge">TEST MODE</div>
    </div>
    
    <div class="checkout-container">
        <!-- Checkout Steps -->
        <div class="checkout-steps">
            <div class="steps-header">
                <div class="steps-progress">
                    <div class="step-circle active" id="step1">1</div>
                    <div class="step-line" id="line1"></div>
                    <div class="step-circle" id="step2">2</div>
                    <div class="step-line" id="line2"></div>
                    <div class="step-circle" id="step3">3</div>
                </div>
            </div>
            
            <!-- Step 1: Shipping -->
            <div class="step-content active" id="stepContent1">
                <h2 class="step-title">Shipping Details</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="shippingName" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="shippingEmail" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" id="shippingPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Country *</label>
                        <select id="shippingCountry" required>
                            <option value="GB" selected>United Kingdom</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Address Line 1 *</label>
                    <input type="text" id="shippingAddress1" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>City *</label>
                        <input type="text" id="shippingCity" required>
                    </div>
                    <div class="form-group">
                        <label>Postal Code *</label>
                        <input type="text" id="shippingPostalCode" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Special Requirements</label>
                    <textarea id="orderNotes" rows="3" placeholder="Any special instructions..."></textarea>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="goToStep(2)">
                        Continue to Payment <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Payment -->
            <div class="step-content" id="stepContent2">
                <h2 class="step-title">Payment Method</h2>
                
                <div class="payment-methods">
                    <div class="payment-method selected" onclick="selectPaymentMethod('stripe')" id="stripeMethod">
                        <div class="method-header">
                            <div class="method-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div>
                                <div class="method-title">Credit/Debit Card</div>
                                <div class="method-description">Secure payment via Stripe</div>
                            </div>
                        </div>
                        <div class="method-tags">
                            <span class="method-tag instant">INSTANT</span>
                        </div>
                    </div>
                    
                    <div class="payment-method" onclick="selectPaymentMethod('bank')" id="bankMethod">
                        <div class="method-header">
                            <div class="method-icon">
                                <i class="fas fa-university"></i>
                            </div>
                            <div>
                                <div class="method-title">Bank Transfer</div>
                                <div class="method-description">Transfer directly to our account</div>
                            </div>
                        </div>
                        <div class="method-tags">
                            <span class="method-tag delayed">24 HOURS</span>
                        </div>
                    </div>
                </div>
                
                <!-- Bank Transfer Details -->
                <div id="bankDetails" style="margin-top: 20px; display: none; padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                    <h4 style="margin-bottom: 10px; color: var(--warning-orange); font-size: 14px;">
                        <i class="fas fa-info-circle"></i> Bank Transfer Details
                    </h4>
                    <div style="font-size: 12px; line-height: 1.6;">
                        <p><strong>Bank:</strong> HSBC UK</p>
                        <p><strong>Account:</strong> IRYA STONE LTD</p>
                        <p><strong>Account No:</strong> 12345678</p>
                        <p><strong>Sort Code:</strong> 40-04-15</p>
                        <p><strong>Reference:</strong> <span id="bankReference">Loading...</span></p>
                    </div>
                </div>
                
                <!-- Payment Timing Info -->
                <div id="timingInfo" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;">
                    <!-- Dynamic content will be inserted -->
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 10px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" style="flex: 2;" onclick="goToStep(3)">
                        Review Order <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Review -->
            <div class="step-content" id="stepContent3">
                <h2 class="step-title">Review & Confirm</h2>
                
                <div id="reviewContent">
                    <!-- Dynamic content -->
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="placeOrder()" id="placeOrderBtn">
                        <i class="fas fa-lock"></i> Place Order & Pay Advance
                    </button>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" style="width: 100%;" onclick="goToStep(2)">
                        <i class="fas fa-arrow-left"></i> Back to Payment
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="order-summary">
            <h2>Order Summary</h2>
            
            <div class="order-items" id="orderItems">
                <!-- Dynamic content -->
            </div>
            
            <div class="summary-row">
                <span class="summary-label">Subtotal</span>
                <span class="summary-value" id="subtotalAmount">Â£0.00</span>
            </div>
            
            <div class="summary-row">
                <span class="summary-label">Shipping</span>
                <span class="summary-value" id="shippingAmount">FREE</span>
            </div>
            
            <div class="summary-row">
                <span class="summary-label">Tax (20%)</span>
                <span class="summary-value" id="taxAmount">Â£0.00</span>
            </div>
            
            <div class="summary-total">
                <span class="summary-label">Total</span>
                <span class="summary-value" id="totalAmount">Â£0.00</span>
            </div>
            
            <div class="advance-payment">
                <div class="advance-label">Advance Payment (30%)</div>
                <div class="advance-amount" id="advanceAmount">Â£0.00</div>
            </div>
        </div>
    </div>
</main>

<!-- Success Modal -->
<div class="modal" id="successModal">
    <div class="modal-content">
        <div class="modal-icon">
            <i class="fas fa-check"></i>
        </div>
        <h3 class="modal-title" id="successTitle">Order Successful!</h3>
        <p class="modal-message" id="successMessage"></p>
        <div id="successDetails" style="text-align: left; margin-bottom: 25px; padding: 15px; background: var(--bg-light); border-radius: 8px; font-size: 12px;">
            <!-- Success details -->
        </div>
        <button class="btn btn-primary" onclick="goToHome()">
            <i class="fas fa-home"></i> Return to Home
        </button>
    </div>
</div>

<!-- Bank Transfer Modal -->
<div class="modal" id="bankModal">
    <div class="modal-content">
        <div class="modal-icon" style="background: var(--warning-orange);">
            <i class="fas fa-clock"></i>
        </div>
        <h3 class="modal-title">Payment Pending</h3>
        <p class="modal-message">Please complete the bank transfer within 24 hours</p>
        
        <div id="bankModalDetails" style="text-align: left; margin-bottom: 25px; padding: 15px; background: var(--bg-light); border-radius: 8px; font-size: 12px;">
            <!-- Bank details -->
        </div>
        
        <button class="btn btn-primary" onclick="closeBankModal()">
            <i class="fas fa-check"></i> I Understand
        </button>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// ============================================
// CONFIGURATION
// ============================================
const STRIPE_TEST_PK = "pk_test_51QeEW5DvQKgVX0tNBCj2Rr6opag8nMikxrmsV6zUzEgsxHZes3Kz6Ldcp1OG7ofyB2x2FOfcLJ9f1R8wHFa2Bp4u003rK6LPiD";
const TEST_EMAIL = "ravijain236129@gmail.com";

const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5"
};

// ============================================
// GLOBAL VARIABLES
// ============================================
let currentStep = 1;
let selectedPaymentMethod = 'stripe';
let stripe = null;
let firebaseApp, firebaseDB, firebaseAuth;
let orderData = {
    items: [],
    subtotal: 0,
    total: 0,
    advance: 0,
    userId: null,
    userEmail: null,
    userName: null
};

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', async function() {
    console.log('ðŸš€ Checkout page initializing...');
    showLoading(true);
    
    try {
        // Initialize Stripe
        stripe = Stripe(STRIPE_TEST_PK);
        console.log('âœ… Stripe initialized');
        
        // Initialize Firebase
        await initializeFirebase();
        console.log('âœ… Firebase initialized');
        
        // Load user data
        await loadUserData();
        console.log('âœ… User data loaded:', orderData.userId, orderData.userEmail);
        
        // Load cart data from MULTIPLE SOURCES
        await loadCartData();
        console.log('âœ… Cart data loaded:', orderData.items.length, 'items');
        
        if (orderData.items.length === 0) {
            showError('Your cart is empty. Please add items first.');
            document.getElementById('placeOrderBtn').disabled = true;
        }
        
        // Check test mode
        checkTestMode();
        
        // Setup UI
        updateStepUI(1);
        renderOrderItems();
        updateOrderSummary();
        
        console.log('âœ… Checkout page initialized successfully');
        
    } catch (error) {
        console.error('âŒ Initialization error:', error);
        showError('Failed to initialize: ' + error.message);
    } finally {
        showLoading(false);
    }
});

// ============================================
// FIREBASE INITIALIZATION - FIXED
// ============================================
async function initializeFirebase() {
    try {
        // Check if Firebase is already initialized
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            console.log('âœ… Firebase app initialized');
        } else {
            firebaseApp = firebase.app();
            console.log('âœ… Using existing Firebase app');
        }
        
        // Initialize services
        firebaseDB = firebase.firestore();
        firebaseAuth = firebase.auth();
        
        // Enable persistence for offline support
        try {
            await firebaseDB.enablePersistence();
            console.log('âœ… Firestore persistence enabled');
        } catch (err) {
            console.log('â„¹ï¸ Firestore persistence not enabled:', err.message);
        }
        
        return true;
        
    } catch (error) {
        console.error('âŒ Firebase initialization error:', error);
        return false;
    }
}

// ============================================
// USER DATA LOADING - FIXED
// ============================================
async function loadUserData() {
    try {
        // Try multiple sources for user data
        let userData = null;
        
        // Source 1: localStorage with multiple keys
        const localStorageKeys = [
            'irya_stone_user',
            'irya_user',
            'user_data',
            'current_user'
        ];
        
        for (const key of localStorageKeys) {
            const data = localStorage.getItem(key);
            if (data) {
                try {
                    userData = JSON.parse(data);
                    console.log(`âœ… Found user data in ${key}`);
                    break;
                } catch (e) {
                    console.log(`âŒ Error parsing ${key}:`, e);
                }
            }
        }
        
        // Source 2: Session storage
        if (!userData) {
            const sessionData = sessionStorage.getItem('irya_current_user');
            if (sessionData) {
                try {
                    userData = JSON.parse(sessionData);
                    console.log('âœ… Found user data in sessionStorage');
                } catch (e) {
                    console.log('âŒ Error parsing sessionStorage:', e);
                }
            }
        }
        
        // Source 3: URL parameters (for Buy Now flow)
        if (!userData) {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');
            const userEmail = urlParams.get('user_email');
            
            if (userId) {
                userData = {
                    uid: userId,
                    email: userEmail || '',
                    displayName: urlParams.get('user_name') || 'Guest'
                };
                console.log('âœ… Found user data in URL parameters');
            }
        }
        
        // Set orderData from user data
        if (userData) {
            orderData.userId = userData.uid || userData.id || 'guest_' + Date.now();
            orderData.userEmail = userData.email || '';
            orderData.userName = userData.displayName || userData.name || 'Guest User';
            
            // Pre-fill email in form if available
            if (orderData.userEmail) {
                document.getElementById('shippingEmail').value = orderData.userEmail;
            }
            
            // Pre-fill name if available
            if (orderData.userName && orderData.userName !== 'Guest User') {
                document.getElementById('shippingName').value = orderData.userName;
            }
        } else {
            // Create guest user
            orderData.userId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            orderData.userEmail = '';
            orderData.userName = 'Guest User';
        }
        
        console.log('ðŸ“‹ User Info Set:', {
            userId: orderData.userId,
            userEmail: orderData.userEmail,
            userName: orderData.userName
        });
        
    } catch (error) {
        console.error('âŒ Error loading user data:', error);
        // Fallback to guest user
        orderData.userId = 'guest_error_' + Date.now();
        orderData.userEmail = '';
        orderData.userName = 'Guest User';
    }
}

// ============================================
// CART DATA LOADING - FIXED FOR MULTIPLE SOURCES
// ============================================
async function loadCartData() {
    try {
        console.log('ðŸ›’ Loading cart data from multiple sources...');
        
        let cartItems = [];
        let dataSource = 'unknown';
        
        // âœ… SOURCE 1: Checkout data from cart page (most reliable)
        const checkoutData = sessionStorage.getItem('irya_checkout_data');
        if (checkoutData) {
            try {
                const parsedData = JSON.parse(checkoutData);
                cartItems = parsedData.items || parsedData.cartItems || [];
                dataSource = 'checkout_data';
                console.log(`âœ… Loaded ${cartItems.length} items from checkout_data`);
            } catch (e) {
                console.error('âŒ Error parsing checkout data:', e);
            }
        }
        
        // âœ… SOURCE 2: Universal cart key
        if (cartItems.length === 0) {
            const universalCart = localStorage.getItem('irya_cart');
            if (universalCart) {
                try {
                    cartItems = JSON.parse(universalCart);
                    dataSource = 'universal_cart';
                    console.log(`âœ… Loaded ${cartItems.length} items from universal_cart`);
                } catch (e) {
                    console.error('âŒ Error parsing universal cart:', e);
                }
            }
        }
        
        // âœ… SOURCE 3: User-specific cart key
        if (cartItems.length === 0 && orderData.userId) {
            const userCartKey = 'irya_cart_' + orderData.userId;
            const userCartData = localStorage.getItem(userCartKey);
            if (userCartData) {
                try {
                    cartItems = JSON.parse(userCartData);
                    dataSource = 'user_cart';
                    console.log(`âœ… Loaded ${cartItems.length} items from user_cart`);
                } catch (e) {
                    console.error('âŒ Error parsing user cart:', e);
                }
            }
        }
        
        // âœ… SOURCE 4: Legacy cart keys
        if (cartItems.length === 0) {
            const legacyKeys = [
                'cart_items',
                'shopping_cart',
                'irya_local_cart',
                'irya_cart_items'
            ];
            
            for (const key of legacyKeys) {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        cartItems = JSON.parse(data);
                        dataSource = 'legacy_' + key;
                        console.log(`âœ… Loaded ${cartItems.length} items from ${key}`);
                        break;
                    } catch (e) {
                        console.error(`âŒ Error parsing ${key}:`, e);
                    }
                }
            }
        }
        
        // âœ… SOURCE 5: Buy Now data (check URL parameter)
        if (cartItems.length === 0) {
            const urlParams = new URLSearchParams(window.location.search);
            const buyNowParam = urlParams.get('buynow');
            const productParam = urlParams.get('product');
            
            if (buyNowParam === 'true' || productParam) {
                // Load Buy Now product
                await loadBuyNowProduct();
                return; // Exit early as Buy Now has different flow
            }
        }
        
        // Validate cart items
        if (cartItems.length === 0) {
            console.log('ðŸ›’ Cart is empty from all sources');
            orderData.items = [];
            return;
        }
        
        // Process cart items into standard format
        orderData.items = cartItems.map(item => {
            // Handle different item structures
            return {
                id: item.id || item.productId || 'item_' + Date.now(),
                name: item.stone_name || item.name || item.productName || 'Stone Product',
                price: parseFloat(item.price) || parseFloat(item.productPrice) || 0,
                quantity: item.quantity || item.qty || 1,
                image: item.image || item.productImage || getDefaultImage(item.category),
                category: item.category || item.productCategory || '',
                calculationData: item.calculationData || null,
                customRequirements: item.customRequirements || '',
                totalPrice: (parseFloat(item.price) || 0) * (item.quantity || 1)
            };
        }).filter(item => item.price > 0); // Filter out invalid items
        
        console.log(`âœ… Processed ${orderData.items.length} items from ${dataSource}`);
        
        // Calculate totals
        calculateTotals();
        
    } catch (error) {
        console.error('âŒ Error loading cart data:', error);
        orderData.items = [];
        throw error;
    }
}

// ============================================
// BUY NOW PRODUCT LOADING
// ============================================
async function loadBuyNowProduct() {
    try {
        console.log('âš¡ Loading Buy Now product...');
        
        let buyNowProduct = null;
        
        // Check multiple sources for Buy Now data
        const sources = [
            { key: 'irya_buynow_product', storage: sessionStorage },
            { key: 'irya_current_buynow', storage: sessionStorage },
            { key: 'irya_buynow_cart_' + orderData.userId, storage: localStorage },
            { key: 'irya_current_buynow', storage: localStorage }
        ];
        
        for (const source of sources) {
            const data = source.storage.getItem(source.key);
            if (data) {
                try {
                    buyNowProduct = JSON.parse(data);
                    console.log(`âœ… Buy Now product loaded from ${source.key}`);
                    break;
                } catch (e) {
                    console.error(`âŒ Error parsing ${source.key}:`, e);
                }
            }
        }
        
        // Check URL parameters
        if (!buyNowProduct) {
            const urlParams = new URLSearchParams(window.location.search);
            const productParam = urlParams.get('product');
            if (productParam) {
                try {
                    buyNowProduct = JSON.parse(decodeURIComponent(productParam));
                    console.log('âœ… Buy Now product loaded from URL');
                } catch (e) {
                    console.error('âŒ Error parsing URL product:', e);
                }
            }
        }
        
        if (!buyNowProduct) {
            throw new Error('Buy Now product not found');
        }
        
        // Convert to standard item format
        orderData.items = [{
            id: buyNowProduct.id || 'buynow_' + Date.now(),
            name: buyNowProduct.stone_name || buyNowProduct.name || 'Buy Now Product',
            price: parseFloat(buyNowProduct.price) || 0,
            quantity: buyNowProduct.quantity || 1,
            image: buyNowProduct.image || getDefaultImage(buyNowProduct.category),
            category: buyNowProduct.category || '',
            calculationData: buyNowProduct.calculationData || null,
            customRequirements: buyNowProduct.customRequirements || '',
            isBuyNow: true,
            totalPrice: (parseFloat(buyNowProduct.price) || 0) * (buyNowProduct.quantity || 1)
        }];
        
        console.log('âœ… Buy Now product processed:', orderData.items[0]);
        
        // Calculate totals
        calculateTotals();
        
    } catch (error) {
        console.error('âŒ Error loading Buy Now product:', error);
        throw error;
    }
}

function calculateTotals() {
    if (orderData.items.length === 0) {
        orderData.subtotal = 0;
        orderData.tax = 0;
        orderData.total = 0;
        orderData.advance = 0;
        return;
    }
    
    orderData.subtotal = orderData.items.reduce((sum, item) => {
        return sum + (item.price * item.quantity);
    }, 0);
    
    orderData.tax = orderData.subtotal * 0.2;
    orderData.total = orderData.subtotal + orderData.tax;
    orderData.advance = orderData.total * 0.3;
    
    console.log('ðŸ’° Totals calculated:', {
        subtotal: orderData.subtotal,
        tax: orderData.tax,
        total: orderData.total,
        advance: orderData.advance
    });
}

// ============================================
// TEST MODE HANDLING
// ============================================
function checkTestMode() {
    const userEmail = orderData.userEmail || document.getElementById('shippingEmail').value;
    const isTestEmail = userEmail === TEST_EMAIL;
    
    if (isTestEmail) {
        document.getElementById('testModeBadge').style.display = 'block';
        showNotification('Test Mode Active - Payments allowed for ' + TEST_EMAIL);
    }
}

function validateTestMode() {
    const userEmail = document.getElementById('shippingEmail').value;
    if (userEmail !== TEST_EMAIL) {
        showError('Only test payments allowed for email: ' + TEST_EMAIL);
        return false;
    }
    return true;
}

// ============================================
// STEP NAVIGATION
// ============================================
function goToStep(step) {
    if (step < currentStep || validateCurrentStep()) {
        currentStep = step;
        updateStepUI(step);
        
        if (step === 2) {
            updatePaymentTimingInfo();
        } else if (step === 3) {
            updateReviewContent();
        }
    }
}

function updateStepUI(step) {
    // Update step circles
    for (let i = 1; i <= 3; i++) {
        const circle = document.getElementById('step' + i);
        const line = document.getElementById('line' + (i - 1));
        const content = document.getElementById('stepContent' + i);
        
        if (i <= step) {
            circle.classList.add('active');
            if (line) line.classList.add('active');
        } else {
            circle.classList.remove('active');
            if (line) line.classList.remove('active');
        }
        
        if (content) {
            content.classList.toggle('active', i === step);
        }
    }
}

function validateCurrentStep() {
    if (currentStep === 1) {
        const required = ['shippingName', 'shippingEmail', 'shippingPhone', 'shippingAddress1', 'shippingCity', 'shippingPostalCode'];
        for (const field of required) {
            const el = document.getElementById(field);
            if (!el.value.trim()) {
                showError('Please fill in all required fields');
                el.focus();
                return false;
            }
        }
        
        const email = document.getElementById('shippingEmail').value;
        if (!isValidEmail(email)) {
            showError('Please enter a valid email');
            return false;
        }
    }
    return true;
}

// ============================================
// PAYMENT METHODS
// ============================================
function selectPaymentMethod(method) {
    selectedPaymentMethod = method;
    
    // Update UI
    document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('selected');
    });
    document.getElementById(method + 'Method').classList.add('selected');
    
    // Show/hide details
    document.getElementById('bankDetails').style.display = method === 'bank' ? 'block' : 'none';
    
    // Update timing info
    updatePaymentTimingInfo();
    
    // Generate bank reference
    if (method === 'bank') {
        const ref = 'IRYA-' + Date.now().toString().slice(-6) + '-' + Math.floor(Math.random() * 1000);
        document.getElementById('bankReference').textContent = ref;
    }
}

function updatePaymentTimingInfo() {
    const timingDiv = document.getElementById('timingInfo');
    
    if (selectedPaymentMethod === 'stripe') {
        timingDiv.innerHTML = `
            <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px;">
                <h4 style="margin-bottom: 8px; color: var(--success-green); font-size: 14px;">
                    <i class="fas fa-bolt"></i> Instant Confirmation
                </h4>
                <p style="font-size: 12px; color: var(--text-dark);">
                    â€¢ Order confirmed immediately<br>
                    â€¢ Platform fee: 2.5% + Â£0.30<br>
                    â€¢ Stripe charges: 1.4% + Â£0.20<br>
                    â€¢ Total fees: ${calculateFees().totalFees.toFixed(2)}
                </p>
            </div>
        `;
    } else {
        const deadline = new Date(Date.now() + 24 * 60 * 60 * 1000);
        const fees = calculateFees();
        timingDiv.innerHTML = `
            <div style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px;">
                <h4 style="margin-bottom: 8px; color: var(--warning-orange); font-size: 14px;">
                    <i class="fas fa-clock"></i> Confirm within 24 Hours
                </h4>
                <p style="font-size: 12px; color: var(--text-dark);">
                    â€¢ Deadline: ${deadline.toLocaleString()}<br>
                    â€¢ Auto-cancel if payment not confirmed<br>
                    â€¢ Platform fee: 2.5% + Â£0.30<br>
                    â€¢ Bank charges: Â£0.50<br>
                    â€¢ Refund if cancelled: Â£${fees.refundAmount.toFixed(2)}
                </p>
            </div>
        `;
    }
    timingDiv.style.display = 'block';
}

function calculateFees() {
    const advance = orderData.advance;
    const platformFee = (advance * 0.025) + 0.30;
    let gatewayFee = 0;
    
    if (selectedPaymentMethod === 'stripe') {
        gatewayFee = (advance * 0.014) + 0.20;
    } else {
        gatewayFee = 0.50;
    }
    
    const totalFees = platformFee + gatewayFee;
    const refundAmount = advance - totalFees;
    
    return {
        advance: advance,
        platformFee: platformFee,
        gatewayFee: gatewayFee,
        totalFees: totalFees,
        refundAmount: refundAmount
    };
}

// ============================================
// ORDER PROCESSING - FIXED FIREBASE SAVE
// ============================================
async function placeOrder() {
    showLoading(true);
    const placeOrderBtn = document.getElementById('placeOrderBtn');
    placeOrderBtn.disabled = true;
    placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    try {
        // Validate test mode
        if (!validateTestMode()) {
            showLoading(false);
            placeOrderBtn.disabled = false;
            placeOrderBtn.innerHTML = '<i class="fas fa-lock"></i> Place Order & Pay Advance';
            return;
        }
        
        // Validate items
        if (orderData.items.length === 0) {
            throw new Error('Cart is empty');
        }
        
        // Create order object
        const orderId = 'order_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const orderNumber = 'IRYA-' + Date.now().toString().slice(-8);
        const now = new Date();
        const deadline = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        
        const fees = calculateFees();
        
        const order = {
            // Order Identification
            orderId: orderId,
            orderNumber: orderNumber,
            
            // User Information
            userId: orderData.userId,
            userEmail: document.getElementById('shippingEmail').value,
            userName: document.getElementById('shippingName').value,
            
            // Order Items
            items: orderData.items.map(item => ({
                id: item.id,
                name: item.name,
                price: item.price,
                quantity: item.quantity,
                image: item.image,
                category: item.category,
                calculationData: item.calculationData || null,
                customRequirements: item.customRequirements || '',
                isBuyNow: item.isBuyNow || false,
                totalPrice: item.price * item.quantity
            })),
            
            // Pricing
            subtotal: orderData.subtotal,
            tax: orderData.tax,
            total: orderData.total,
            advance: orderData.advance,
            remaining: orderData.total - orderData.advance,
            
            // Fees
            platformFee: fees.platformFee,
            gatewayFee: fees.gatewayFee,
            totalFees: fees.totalFees,
            refundAmount: fees.refundAmount,
            
            // Shipping Details
            shippingDetails: {
                name: document.getElementById('shippingName').value,
                email: document.getElementById('shippingEmail').value,
                phone: document.getElementById('shippingPhone').value,
                address: document.getElementById('shippingAddress1').value,
                city: document.getElementById('shippingCity').value,
                postalCode: document.getElementById('shippingPostalCode').value,
                country: document.getElementById('shippingCountry').value,
                notes: document.getElementById('orderNotes').value || ''
            },
            
            // Payment Information
            paymentMethod: selectedPaymentMethod,
            paymentStatus: selectedPaymentMethod === 'bank' ? 'pending' : 'paid',
            paymentReference: selectedPaymentMethod === 'bank' ? 
                'IRYA-' + Date.now().toString().slice(-6) + '-' + Math.floor(Math.random() * 1000) : 
                'stripe_' + Date.now(),
            
            // Order Status
            orderStatus: selectedPaymentMethod === 'bank' ? 'payment_pending' : 'confirmed',
            
            // Timing Information
            createdAt: now.toISOString(),
            updatedAt: now.toISOString(),
            paymentConfirmDeadline: deadline.toISOString(),
            autoCancelTime: deadline.toISOString(),
            
            // Metadata
            isBuyNow: orderData.items.some(item => item.isBuyNow),
            source: window.location.href,
            userAgent: navigator.userAgent,
            
            // Refund Policy
            refundPolicy: 'Refund = Advance - Platform Fee (2.5% + Â£0.30) - Payment Gateway Charges',
            termsAccepted: true
        };
        
        console.log('ðŸ“ Order object created:', order);
        
        // âœ… SAVE TO FIREBASE FIRST (BEFORE PAYMENT)
        console.log('ðŸ’¾ Saving order to Firebase...');
        const firebaseResult = await saveOrderToFirebase(order);
        console.log('âœ… Firebase save result:', firebaseResult);
        
        // Save to localStorage as backup
        localStorage.setItem('irya_last_order', JSON.stringify(order));
        localStorage.setItem('irya_last_order_id', orderId);
        console.log('âœ… Saved to localStorage as backup');
        
        if (selectedPaymentMethod === 'stripe') {
            // Process Stripe payment
            await processStripePayment(order, firebaseResult);
        } else {
            // Bank transfer - show instructions
            showBankTransferModal(order, firebaseResult);
        }
        
    } catch (error) {
        console.error('âŒ Order processing error:', error);
        showError('Order failed: ' + error.message);
        
        // Re-enable button
        placeOrderBtn.disabled = false;
        placeOrderBtn.innerHTML = '<i class="fas fa-lock"></i> Place Order & Pay Advance';
        showLoading(false);
    }
}

// ============================================
// FIREBASE SAVE - COMPLETELY FIXED
// ============================================
async function saveOrderToFirebase(order) {
    try {
        console.log('ðŸ”¥ Starting Firebase save process...');
        
        // Check if Firebase is initialized
        if (!firebaseDB) {
            console.error('âŒ Firebase DB not initialized');
            throw new Error('Database not available');
        }
        
        // âœ… 1. Save to user's orders collection
        console.log('ðŸ“ Saving to user collection:', order.userId);
        const userOrderRef = firebaseDB.collection('users')
            .doc(order.userId)
            .collection('orders')
            .doc(order.orderId);
        
        await userOrderRef.set(order);
        console.log('âœ… Saved to user orders collection');
        
        // âœ… 2. Save to global orders collection
        console.log('ðŸ“ Saving to global orders collection');
        const globalOrderRef = firebaseDB.collection('orders')
            .doc(order.orderId);
        
        await globalOrderRef.set(order);
        console.log('âœ… Saved to global orders collection');
        
        // âœ… 3. Save to orders_backup collection
        console.log('ðŸ“ Saving to backup collection');
        const backupRef = firebaseDB.collection('orders_backup')
            .doc(order.orderId);
        
        await backupRef.set({
            ...order,
            backupSavedAt: new Date().toISOString(),
            backupNote: 'Main backup copy'
        });
        console.log('âœ… Saved to backup collection');
        
        // âœ… 4. Update user document with order count
        try {
            const userRef = firebaseDB.collection('users').doc(order.userId);
            const userDoc = await userRef.get();
            
            if (userDoc.exists) {
                await userRef.update({
                    lastOrderId: order.orderId,
                    lastOrderDate: order.createdAt,
                    totalOrders: firebase.firestore.FieldValue.increment(1),
                    totalSpent: firebase.firestore.FieldValue.increment(order.total),
                    updatedAt: new Date().toISOString()
                });
                console.log('âœ… User document updated');
            } else {
                // Create user document if it doesn't exist
                await userRef.set({
                    userId: order.userId,
                    userName: order.userName,
                    userEmail: order.userEmail,
                    createdAt: order.createdAt,
                    updatedAt: order.createdAt,
                    totalOrders: 1,
                    totalSpent: order.total,
                    lastOrderId: order.orderId,
                    lastOrderDate: order.createdAt
                });
                console.log('âœ… Created new user document');
            }
        } catch (userError) {
            console.log('âš ï¸ Could not update user document:', userError);
            // Continue even if user update fails
        }
        
        // âœ… 5. Save shipping address separately
        try {
            const addressRef = firebaseDB.collection('users')
                .doc(order.userId)
                .collection('addresses')
                .doc('shipping_' + Date.now());
            
            await addressRef.set({
                ...order.shippingDetails,
                orderId: order.orderId,
                createdAt: order.createdAt,
                isDefault: false
            });
            console.log('âœ… Shipping address saved');
        } catch (addressError) {
            console.log('âš ï¸ Could not save address:', addressError);
        }
        
        console.log('ðŸŽ‰ Firebase save COMPLETED SUCCESSFULLY');
        return {
            success: true,
            orderId: order.orderId,
            userId: order.userId,
            message: 'Order saved to Firebase successfully'
        };
        
    } catch (error) {
        console.error('âŒ Firebase save ERROR:', error);
        console.error('Error details:', {
            message: error.message,
            code: error.code,
            stack: error.stack
        });
        
        // Try alternative save method
        try {
            console.log('ðŸ”„ Trying alternative save method...');
            
            // Create simplified order for backup
            const backupOrder = {
                orderId: order.orderId,
                orderNumber: order.orderNumber,
                userId: order.userId,
                userEmail: order.userEmail,
                total: order.total,
                status: 'save_failed_but_backed_up',
                createdAt: new Date().toISOString(),
                backupNote: 'Saved after initial failure'
            };
            
            // Save to backup_failed_orders collection
            const failedRef = firebaseDB.collection('backup_failed_orders')
                .doc(order.orderId);
            
            await failedRef.set(backupOrder);
            console.log('âœ… Saved to backup_failed_orders collection');
            
            return {
                success: false,
                orderId: order.orderId,
                message: 'Order partially saved to backup collection',
                error: error.message
            };
            
        } catch (backupError) {
            console.error('âŒ Backup save also failed:', backupError);
            throw new Error('Complete Firebase save failure: ' + error.message);
        }
    }
}

// ============================================
// STRIPE PAYMENT
// ============================================
async function processStripePayment(order, firebaseResult) {
    try {
        console.log('ðŸ’³ Processing Stripe payment...');
        
        // Simulate Stripe payment (replace with actual Stripe integration)
        const paymentResult = await simulateStripePayment(order);
        
        if (paymentResult.success) {
            // Update order status in Firebase
            await updateOrderStatus(order.orderId, 'paid', 'confirmed');
            
            // Clear cart
            clearCartData();
            
            // Show success
            showSuccessModal(order, 'Card payment successful! Order confirmed instantly.');
        } else {
            throw new Error('Payment failed');
        }
        
    } catch (error) {
        // Update order status to failed
        await updateOrderStatus(order.orderId, 'failed', 'cancelled');
        throw error;
    } finally {
        showLoading(false);
        document.getElementById('placeOrderBtn').disabled = false;
        document.getElementById('placeOrderBtn').innerHTML = '<i class="fas fa-lock"></i> Place Order & Pay Advance';
    }
}

async function simulateStripePayment(order) {
    // Simulate API call
    return new Promise(resolve => {
        setTimeout(() => {
            resolve({
                success: true,
                paymentId: 'pi_' + Date.now(),
                amount: Math.round(order.advance * 100),
                currency: 'gbp'
            });
        }, 1500);
    });
}

// ============================================
// BANK TRANSFER
// ============================================
function showBankTransferModal(order, firebaseResult) {
    const deadline = new Date(order.paymentConfirmDeadline);
    const refundAmount = order.refundAmount;
    
    document.getElementById('bankModalDetails').innerHTML = `
        <p><strong>Order Number:</strong> ${order.orderNumber}</p>
        <p><strong>Advance Amount:</strong> Â£${order.advance.toFixed(2)}</p>
        <p><strong>Bank:</strong> HSBC UK</p>
        <p><strong>Account:</strong> IRYA STONE LTD</p>
        <p><strong>Account No:</strong> 12345678</p>
        <p><strong>Sort Code:</strong> 40-04-15</p>
        <p><strong>Reference:</strong> ${order.orderNumber}</p>
        <div style="margin-top: 15px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
            <p style="color: var(--warning-orange); font-size: 11px;">
                <i class="fas fa-exclamation-triangle"></i> IMPORTANT
            </p>
            <p style="font-size: 10px; color: var(--text-dark);">
                â€¢ Confirm payment by: ${deadline.toLocaleString()}<br>
                â€¢ Auto-cancel after deadline<br>
                â€¢ Platform fee: Â£${order.platformFee.toFixed(2)}<br>
                â€¢ Bank charges: Â£${order.gatewayFee.toFixed(2)}<br>
                â€¢ Refund if cancelled: Â£${refundAmount.toFixed(2)}
            </p>
        </div>
        <div style="margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
            <p style="color: var(--success-green); font-size: 11px;">
                <i class="fas fa-check-circle"></i> Order Saved to Database
            </p>
            <p style="font-size: 10px; color: var(--text-dark);">
                Order ID: ${order.orderId}<br>
                Saved at: ${new Date().toLocaleString()}
            </p>
        </div>
    `;
    
    document.getElementById('bankModal').style.display = 'flex';
    showLoading(false);
    
    // Clear cart
    clearCartData();
    
    // Re-enable button
    document.getElementById('placeOrderBtn').disabled = false;
    document.getElementById('placeOrderBtn').innerHTML = '<i class="fas fa-lock"></i> Place Order & Pay Advance';
}

function closeBankModal() {
    document.getElementById('bankModal').style.display = 'none';
    
    // Show success modal
    const order = JSON.parse(localStorage.getItem('irya_last_order') || '{}');
    showSuccessModal(order, 'Order created! Complete bank transfer within 24 hours.');
}

function clearCartData() {
    // Clear cart from all possible storage locations
    const keysToClear = [
        'irya_cart',
        'irya_checkout_data',
        'cart_items',
        'shopping_cart',
        'irya_local_cart',
        'irya_cart_items'
    ];
    
    if (orderData.userId) {
        keysToClear.push('irya_cart_' + orderData.userId);
    }
    
    keysToClear.forEach(key => {
        localStorage.removeItem(key);
        sessionStorage.removeItem(key);
    });
    
    console.log('ðŸ§¹ Cart data cleared');
}

// ============================================
// ORDER STATUS UPDATE
// ============================================
async function updateOrderStatus(orderId, paymentStatus, orderStatus) {
    try {
        const updateData = {
            paymentStatus: paymentStatus,
            orderStatus: orderStatus,
            updatedAt: new Date().toISOString()
        };
        
        // Update in user collection
        await firebaseDB.collection('users')
            .doc(orderData.userId)
            .collection('orders')
            .doc(orderId)
            .update(updateData);
        
        // Update in global collection
        await firebaseDB.collection('orders')
            .doc(orderId)
            .update(updateData);
            
        console.log('âœ… Order status updated:', { paymentStatus, orderStatus });
        
    } catch (error) {
        console.error('âŒ Status update failed:', error);
    }
}

// ============================================
// UI UPDATES
// ============================================
function renderOrderItems() {
    const container = document.getElementById('orderItems');
    
    if (orderData.items.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; color: var(--text-light); opacity: 0.5; margin-bottom: 15px;">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h3 style="color: var(--stone-dark); margin-bottom: 10px;">Your Cart is Empty</h3>
                <p style="color: var(--text-light); margin-bottom: 20px;">Please add items to your cart first.</p>
                <a href="products.html" style="
                    display: inline-block;
                    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
                    color: white;
                    padding: 10px 20px;
                    border-radius: 20px;
                    text-decoration: none;
                    font-weight: 500;
                ">
                    <i class="fas fa-gem"></i> Browse Products
                </a>
            </div>
        `;
        return;
    }
    
    let html = '';
    orderData.items.forEach(item => {
        html += `
            <div class="order-item">
                <div style="flex: 1;">
                    <div style="font-size: 13px; font-weight: 600;">${item.name}</div>
                    <div style="font-size: 11px; color: var(--text-light);">Qty: ${item.quantity}</div>
                    ${item.isBuyNow ? `<div style="font-size: 10px; color: var(--primary-gold);"><i class="fas fa-bolt"></i> Buy Now</div>` : ''}
                </div>
                <div style="font-weight: 600; color: var(--primary-gold);">
                    Â£${(item.price * item.quantity).toFixed(2)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateOrderSummary() {
    document.getElementById('subtotalAmount').textContent = 'Â£' + orderData.subtotal.toFixed(2);
    document.getElementById('taxAmount').textContent = 'Â£' + orderData.tax.toFixed(2);
    document.getElementById('totalAmount').textContent = 'Â£' + orderData.total.toFixed(2);
    document.getElementById('advanceAmount').textContent = 'Â£' + orderData.advance.toFixed(2);
}

function updateReviewContent() {
    const content = document.getElementById('reviewContent');
    const shipping = {
        name: document.getElementById('shippingName').value,
        email: document.getElementById('shippingEmail').value,
        address: document.getElementById('shippingAddress1').value,
        city: document.getElementById('shippingCity').value,
        postalCode: document.getElementById('shippingPostalCode').value
    };
    
    const fees = calculateFees();
    
    content.innerHTML = `
        <div style="display: grid; gap: 15px;">
            <div style="padding: 15px; background: var(--bg-light); border-radius: 8px;">
                <h4 style="margin-bottom: 10px; font-size: 14px;">Shipping Details</h4>
                <p style="font-size: 12px;">${shipping.name}<br>
                ${shipping.address}<br>
                ${shipping.city} ${shipping.postalCode}<br>
                ${shipping.email}</p>
            </div>
            
            <div style="padding: 15px; background: var(--bg-light); border-radius: 8px;">
                <h4 style="margin-bottom: 10px; font-size: 14px;">Payment Method</h4>
                <p style="font-size: 12px;">
                    ${selectedPaymentMethod === 'stripe' ? 'Credit/Debit Card' : 'Bank Transfer'}<br>
                    ${selectedPaymentMethod === 'stripe' ? 'Instant confirmation' : '24-hour confirmation'}
                </p>
            </div>
            
            <div style="padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                <h4 style="margin-bottom: 10px; font-size: 14px; color: var(--warning-orange);">Payment & Refund Details</h4>
                <div style="font-size: 12px;">
                    <p><strong>Advance Payment:</strong> Â£${orderData.advance.toFixed(2)}</p>
                    <p><strong>Platform Fee (2.5% + Â£0.30):</strong> Â£${fees.platformFee.toFixed(2)}</p>
                    <p><strong>${selectedPaymentMethod === 'stripe' ? 'Stripe Charges (1.4% + Â£0.20)' : 'Bank Charges'}:</strong> Â£${fees.gatewayFee.toFixed(2)}</p>
                    <p><strong>Total Fees:</strong> Â£${fees.totalFees.toFixed(2)}</p>
                    <p><strong>Net Received:</strong> Â£${(orderData.advance - fees.totalFees).toFixed(2)}</p>
                    <p><strong>Refund if Cancelled:</strong> Â£${fees.refundAmount.toFixed(2)}</p>
                    <p style="color: var(--error-red); margin-top: 8px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Order auto-cancels after 24 hours if payment not confirmed
                    </p>
                </div>
            </div>
        </div>
    `;
}

function showSuccessModal(order, message) {
    document.getElementById('successTitle').textContent = 
        selectedPaymentMethod === 'bank' ? 'Order Created!' : 'Payment Successful!';
    document.getElementById('successMessage').textContent = message;
    
    const timingInfo = selectedPaymentMethod === 'bank' ? 
        `<p style="color: var(--warning-orange);">
            <i class="fas fa-clock"></i> Complete payment within 24 hours
        </p>` :
        `<p style="color: var(--success-green);">
            <i class="fas fa-bolt"></i> Order confirmed instantly
        </p>`;
    
    document.getElementById('successDetails').innerHTML = `
        <p><strong>Order Number:</strong> ${order.orderNumber}</p>
        <p><strong>Total Amount:</strong> Â£${order.total.toFixed(2)}</p>
        <p><strong>Advance Paid:</strong> Â£${order.advance.toFixed(2)}</p>
        <p><strong>Payment Method:</strong> ${selectedPaymentMethod === 'stripe' ? 'Card' : 'Bank Transfer'}</p>
        <p><strong>Status:</strong> ${selectedPaymentMethod === 'stripe' ? 'Confirmed' : 'Pending Payment'}</p>
        ${timingInfo}
        <div style="margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
            <p style="color: var(--success-green); font-size: 11px;">
                <i class="fas fa-database"></i> Order saved to database
            </p>
            <p style="font-size: 10px; color: var(--text-dark);">
                Order ID: ${order.orderId}<br>
                User ID: ${order.userId}
            </p>
        </div>
    `;
    
    document.getElementById('successModal').style.display = 'flex';
}

// ============================================
// UTILITY FUNCTIONS
// ============================================
function getDefaultImage(category) {
    const categoryLower = (category || '').toLowerCase();
    
    if (categoryLower.includes('sand')) {
        return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=400&h=300';
    } else if (categoryLower.includes('kota')) {
        return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=400&h=300';
    }
    
    return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=400&h=300';
}

function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
}

function showNotification(message) {
    const el = document.getElementById('notification');
    el.textContent = message;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
}

function showError(message) {
    const el = document.getElementById('errorMessage');
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 5000);
}

function goToHome() {
    window.location.href = 'index.html';
}

// ============================================
// MAKE FUNCTIONS GLOBALLY AVAILABLE
// ============================================
window.selectPaymentMethod = selectPaymentMethod;
window.goToStep = goToStep;
window.placeOrder = placeOrder;
window.closeBankModal = closeBankModal;
window.goToHome = goToHome;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stone Products - StoneCraft UK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== HOME PAGE JAISE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #ffffff;
            color: #333;
            line-height: 1.6;
            padding-top: 120px;
            transition: padding-top 0.3s ease;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* ===== FILTER SECTION STYLES - NEW ADDED ===== */
        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .filter-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .clear-filters {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e0e0e0;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .clear-filters:hover {
            background: #b8860b;
            color: white;
            border-color: #b8860b;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 13px;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #b8860b;
            background: white;
        }
        
        /* Filter chips - Active filters display */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .filter-chip {
            background: #b8860b;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .filter-chip .remove {
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Header Styles - Home Page jaise */
        header {
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            transition: transform 0.4s ease;
        }
        
        header.hidden { transform: translateY(-100%); }
        header.visible { transform: translateY(0); }
        
        .main-header { padding: 8px 0; }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo h1 {
            font-size: 24px;
            color: #333;
            font-weight: 700;
        }
        .logo span { color: #b8860b; }
        
        .trust-info {
            flex: 1;
            text-align: center;
            padding: 0 10px;
            padding-top: 5px;
        }
        .trust-info-content {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 13px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .trust-item {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
        }
        .trust-item i { color: #b8860b; font-size: 14px; }

        /* User Profile Styles */
        .user-profile { position: relative; }
        .profile-toggle {
            display: flex; align-items: center; gap: 6px;
            background: none; border: none; cursor: pointer;
            padding: 6px 10px; border-radius: 6px;
            transition: background-color 0.3s;
        }
        .profile-toggle:hover { background: #f8f9fa; }
        .profile-avatar {
            width: 28px; height: 28px; border-radius: 50%;
            background: #b8860b; color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 12px;
        }
        .profile-name { font-size: 12px; font-weight: 500; color: #333; }
        .profile-dropdown {
            position: absolute; top: 100%; right: 0;
            background: white; border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            min-width: 180px; z-index: 1000; display: none;
            border: 1px solid #e0e0e0;
        }
        .profile-dropdown.active { display: block; }
        .dropdown-header {
            padding: 12px; border-bottom: 1px solid #eee;
            background: #f8f9fa; border-radius: 8px 8px 0 0;
        }
        .dropdown-header .user-email {
            font-size: 11px; color: #666; margin-top: 4px;
        }
        .dropdown-menu { list-style: none; padding: 6px 0; }
        .dropdown-item {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 12px; color: #333; text-decoration: none;
            font-size: 13px; transition: all 0.3s;
        }
        .dropdown-item:hover { background: #f8f9fa; color: #b8860b; }
        .dropdown-item i { width: 14px; text-align: center; color: #666; font-size: 13px; }
        .dropdown-divider { height: 1px; background: #eee; margin: 6px 0; }

        /* Search Styles */
        .search-container {
            position: relative; flex: 1; max-width: 450px; margin: 0 15px;
        }
        .search-input {
            width: 100%; padding: 10px 40px 10px 15px;
            border: 2px solid #e1e5e9; border-radius: 20px;
            font-size: 13px; background-color: #f8f9fa;
        }
        .search-input:focus {
            outline: none; border-color: #b8860b; background-color: white;
        }
        .search-button {
            position: absolute; right: 6px;
            background: #b8860b; color: white; border: none;
            width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; font-size: 12px;
        }
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            max-height: 350px; overflow-y: auto; z-index: 1001;
            display: none; margin-top: 5px;
        }
        .search-results.active { display: block; }
        .search-result-item {
            display: flex; align-items: center;
            padding: 10px 12px; border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .search-result-item:hover { background: #f8f9fa; }
        .search-result-image {
            width: 45px; height: 45px; border-radius: 6px;
            background-size: cover; background-position: center;
            margin-right: 12px; flex-shrink: 0;
        }
        .search-result-name {
            font-weight: 600; color: #333; margin-bottom: 3px; font-size: 13px;
        }
        .search-result-category {
            font-size: 11px; color: #b8860b; background: #fff9e6;
            padding: 2px 6px; border-radius: 10px; display: inline-block;
        }

        /* Banner Text */
        .banner-text {
            background: linear-gradient(135deg, #b8860b, #a3780a);
            color: white; padding: 2px 0; text-align: center;
            font-size: 12px; font-weight: 500; margin: 0; line-height: 1.2;
        }

        /* Uses Top Bar */
        .uses-top-bar {
            position: sticky; top: 0; background: #333;
            padding: 0; z-index: 999; transition: top 0.3s ease;
        }
        .uses-container { display: flex; justify-content: space-between; flex-wrap: wrap; }
        .use-item { flex: 1; min-width: 110px; position: relative; }
        .use-link {
            display: block; color: white; text-decoration: none;
            padding: 12px 8px; font-size: 13px; font-weight: 500;
            text-align: center; cursor: pointer; transition: background-color 0.3s;
        }
        .use-link:hover { background: #b8860b; }
        .mega-menu {
            position: absolute; top: 100%; left: 0; width: 100%;
            background: white; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: none; padding: 25px 0;
        }
        .use-item:hover .mega-menu { display: block; }
        .patterns-grid {
            display: grid; grid-template-columns: repeat(6, 1fr);
            gap: 15px; padding: 0 15px;
        }
        .pattern-item { text-align: center; cursor: pointer; text-decoration: none; color: #333; }
        .pattern-image {
            width: 100%; height: 160px; background-size: cover;
            background-position: center; border-radius: 6px; margin-bottom: 8px;
            transition: transform 0.3s ease;
        }
        .pattern-item:hover .pattern-image { transform: scale(1.05); }
        .pattern-name { font-size: 13px; color: #333; font-weight: 500; }

        /* Main Content */
        .main-content { margin-top: 5px; padding: 15px 0; }
        .page-header {
            text-align: center; margin-bottom: 5px; padding: 10px 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
        }
        .page-header h1 { font-size: 32px; color: #333; margin-bottom: 5px; }
        .page-header .breadcrumb { color: #666; font-size: 14px; }
        .page-header .breadcrumb a { color: #b8860b; text-decoration: none; font-weight: 500; }

        /* Main Layout */
        .main-layout { display: flex; gap: 20px; }
        .sidebar { flex: 0 0 280px; }
        .products-section {
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); flex: 1;
        }
        
        .products-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
        }
        .products-count { font-size: 16px; color: #666; font-weight: 500; }

        /* Product Cards */
        #products-list {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 15px; padding: 8px;
        }
        .product-card {
            padding: 4px; text-align: left; display: flex;
            flex-direction: column; height: 100%;
        }
        .product-img-box {
            width: 100%; aspect-ratio: 1 / 1; overflow: hidden;
            border-radius: 8px; background: #f8f9fa; position: relative;
        }
        .product-img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.3s ease;
        }
        .product-img:hover { transform: scale(1.05); }
        .product-description {
            margin-top: 8px; font-size: 13px; color: #333;
            line-height: 1.4; flex-grow: 1;
            display: -webkit-box; -webkit-line-clamp: 2;
            -webkit-box-orient: vertical; overflow: hidden;
        }
        .product-rate {
            margin-top: 5px; font-size: 15px; font-weight: bold; color: #b8860b;
        }
        .details-btn {
            display: inline-block; margin-top: 6px; padding: 6px 12px;
            font-size: 13px; background: #b8860b; color: white;
            border-radius: 5px; text-decoration: none;
            transition: background 0.3s ease; text-align: center; width: 100%;
        }
        .details-btn:hover { background: #a3780a; }

        .no-products {
            text-align: center; padding: 40px 15px; grid-column: 1 / -1;
        }
        .no-products i { font-size: 40px; color: #ddd; margin-bottom: 15px; }
        .no-products h3 { font-size: 20px; color: #666; margin-bottom: 10px; }
        .no-products p { color: #888; margin-bottom: 15px; font-size: 14px; }

        /* Features */
        .features {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 25px; margin: 40px 0; padding: 40px 0; background-color: #f9f9f9;
        }
        .feature {
            text-align: center; padding: 25px 15px;
            background: white; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .feature i { font-size: 35px; color: #b8860b; margin-bottom: 15px; }
        .feature h3 { margin-bottom: 12px; font-size: 18px; color: #333; }
        .feature p { font-size: 14px; color: #666; line-height: 1.5; }

        /* Footer */
        footer { background-color: #222; color: #ddd; padding: 40px 0 15px; }
        .footer-content {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 25px; margin-bottom: 25px;
        }
        .footer-column h3 {
            color: white; margin-bottom: 15px; font-size: 16px;
            padding-bottom: 6px; border-bottom: 2px solid #b8860b;
            display: inline-block;
        }
        .footer-links { list-style: none; }
        .footer-links li { margin-bottom: 8px; }
        .footer-links a {
            color: #ddd; text-decoration: none; font-size: 13px;
            transition: color 0.3s;
        }
        .footer-links a:hover { color: #b8860b; }
        .copyright {
            text-align: center; padding-top: 20px;
            border-top: 1px solid #444; font-size: 12px; color: #999;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            #products-list { grid-template-columns: repeat(3, 1fr); }
            .features { grid-template-columns: repeat(3, 1fr); }
            .footer-content { grid-template-columns: repeat(2, 1fr); }
            .patterns-grid { grid-template-columns: repeat(3, 1fr); }
            .main-layout { flex-direction: column; }
            .filters-section { order: 2; }
        }
        
        @media (max-width: 768px) {
            body { padding-top: 100px; }
            .main-content { margin-top: 5px; }
            .header-content { flex-wrap: wrap; }
            .trust-info { order: 3; flex-basis: 100%; margin-top: 8px; padding: 0; }
            .search-container { order: 4; flex-basis: 100%; margin: 8px 0 0; max-width: 100%; }
            .features { grid-template-columns: 1fr; padding: 30px 0; margin: 30px 0; }
            .products-header { flex-direction: column; align-items: flex-start; }
            #products-list { grid-template-columns: repeat(2, 1fr); }
            .page-header h1 { font-size: 28px; }
        }
        
        @media (max-width: 480px) {
            body { padding-top: 190px; }
            #products-list { grid-template-columns: repeat(2, 1fr); }
            .footer-content { grid-template-columns: 1fr; }
            .patterns-grid { grid-template-columns: 1fr; }
            .page-header { padding: 8px 0; margin-bottom: 3px; }
            .page-header h1 { font-size: 24px; }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header id="mainHeader">
        <div class="trust-info">
            <div class="trust-info-content">
                <div class="trust-item"><i class="fas fa-truck"></i><span>Free UK Delivery</span></div>
                <div class="trust-item"><i class="fas fa-star"></i><span>Rated 4.8/5</span></div>
                <div class="trust-item"><i class="fas fa-award"></i><span>BSF Member</span></div>
            </div>
        </div>
        <div class="main-header">
            <div class="container header-content">
                <div class="logo">
                    <a href="index.html" style="text-decoration: none; color: inherit;">
                        <h1>Stone<span>Craft</span></h1>
                    </a>
                </div>
                
                <!-- Search -->
                <div class="search-container">
                    <div class="search-input-container">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search for stones, products, categories...">
                        <button class="search-button" id="searchButton"><i class="fas fa-search"></i></button>
                    </div>
                    <div class="search-results" id="searchResults"></div>
                </div>
                
                <div class="user-actions">
                    <div class="user-profile" id="userProfile" style="display: none;">
                        <button class="profile-toggle" id="profileToggle">
                            <div class="profile-avatar" id="profileAvatar">U</div>
                            <span class="profile-name" id="profileName">User</span>
                            <i class="fas fa-chevron-down" style="font-size: 11px;"></i>
                        </button>
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="dropdown-header">
                                <div class="profile-name" id="dropdownUserName">User Name</div>
                                <div class="user-email" id="dropdownUserEmail">user@example.com</div>
                            </div>
                            <ul class="dropdown-menu">
                                <li><a href="dashboard.html" class="dropdown-item"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                                <li><a href="add.html" class="dropdown-item"><i class="fas fa-plus-circle"></i> Add Product</a></li>
                                <li><a href="edit-profile.html" class="dropdown-item"><i class="fas fa-user-edit"></i> Edit Profile</a></li>
                                <li><a href="wishlist.html" class="dropdown-item"><i class="fas fa-heart"></i> My Wishlist</a></li>
                                <li><a href="billing.html" class="dropdown-item"><i class="fas fa-address-card"></i> Billing/Shipping</a></li>
                                <li><a href="orders.html" class="dropdown-item"><i class="fas fa-history"></i> Order History</a></li>
                                <li class="dropdown-divider"></li>
                                <li><a href="#" class="dropdown-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                    <a href="add.html" class="user-action" id="addProductButton" style="display: none;">
                        <i class="fas fa-plus-circle"></i><span>Add Product</span>
                    </a>
                    <a href="login.html" class="user-action" id="loginButton">
                        <i class="fas fa-user"></i><span>Sign In</span>
                    </a>
                    <a href="#" class="user-action">
                        <i class="fas fa-shopping-cart"></i><span>Cart (0)</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="banner-text">
            <div class="container">
                Premium Natural Stone Collections - Sandstone, Marble & Limestone for UK Homes & Commercial Projects
            </div>
        </div>
    </header>

    <!-- Uses Top Bar -->
    <div class="uses-top-bar">
        <div class="container uses-container" id="dynamicUsesContainer">
            <div class="loading-categories">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading navigation...</p>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 id="pageTitle">Stone Products</h1>
                <div class="breadcrumb" id="breadcrumb">
                    <a href="index.html">Home</a> <span>&gt;</span> <span>Products</span>
                </div>
            </div>
            
            <!-- Main Layout -->
            <div class="main-layout">
                <!-- NEW FILTERS SECTION -->
                <div class="filters-section">
                    <div class="filters-header">
                        <div class="filter-title">Filters</div>
                        <button class="clear-filters" id="clearFilters">Clear All</button>
                    </div>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>Stone Type</label>
                            <select id="stoneTypeFilter">
                                <option value="">All Types</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Usage</label>
                            <select id="usageFilter">
                                <option value="">All Uses</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Price Range</label>
                            <input type="range" id="priceFilter" min="0" max="1000" value="1000">
                            <span id="priceValue">Â£0 - Â£1000</span>
                        </div>
                        <div class="filter-group">
                            <label>Thickness</label>
                            <select id="thicknessFilter">
                                <option value="">All Thickness</option>
                            </select>
                        </div>
                    </div>
                    <div class="active-filters" id="activeFilters"></div>
                </div>

                <!-- Products Section -->
                <div class="products-section">
                    <div class="products-header">
                        <div class="products-count" id="productsCount">Loading products...</div>
                    </div>
                    <div id="products-list"></div>
                </div>
            </div>

            <!-- Features -->
            <section class="features">
                <div class="container">
                    <div class="feature">
                        <i class="fas fa-shipping-fast"></i>
                        <h3>Free UK Delivery</h3>
                        <p>Free delivery on all orders across the United Kingdom with no minimum spend required.</p>
                    </div>
                    <div class="feature">
                        <i class="fas fa-award"></i>
                        <h3>Quality Guaranteed</h3>
                        <p>All our stones are sourced from trusted quarries with quality certification.</p>
                    </div>
                    <div class="feature">
                        <i class="fas fa-headset"></i>
                        <h3>Expert Support</h3>
                        <p>Get expert advice from our stone specialists for your project requirements.</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>StoneCraft</h3>
                    <ul class="footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="add.html">Add Product</a></li>
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Our Story</a></li>
                        <li><a href="#">Sustainability</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Products</h3>
                    <ul class="footer-links">
                        <li><a href="category-products.html?usage=flooring">Flooring Stones</a></li>
                        <li><a href="category-products.html?usage=wall">Wall Stones</a></li>
                        <li><a href="category-products.html?usage=bathroom">Bathroom Stones</a></li>
                        <li><a href="category-products.html?usage=outdoor">Outdoor Stones</a></li>
                        <li><a href="category-products.html?usage=kitchen">Kitchen Stones</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Support</h3>
                    <ul class="footer-links">
                        <li><a href="#">Contact Us</a></li>
                        <li><a href="#">Delivery Info</a></li>
                        <li><a href="#">Returns Policy</a></li>
                        <li><a href="#">Installation Guide</a></li>
                        <li><a href="#">FAQ</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Legal</h3>
                    <ul class="footer-links">
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Cookie Policy</a></li>
                        <li><a href="#">Disclaimer</a></li>
                        <li><a href="#">Sitemap</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 StoneCraft UK. All rights reserved. | Registered in England No: 12345678</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script>
        // Header Scroll Behavior
        document.addEventListener('DOMContentLoaded', function() {
            const header = document.getElementById('mainHeader');
            let lastScrollY = window.scrollY;
            let ticking = false;
            
            function updateHeader() {
                const currentScrollY = window.scrollY;
                if (currentScrollY > 50) {
                    header.classList.add('hidden');
                    header.classList.remove('visible');
                } else {
                    header.classList.remove('hidden');
                    header.classList.add('visible');
                }
                lastScrollY = currentScrollY;
                ticking = false;
            }
            
            function onScroll() {
                if (!ticking) {
                    requestAnimationFrame(updateHeader);
                    ticking = true;
                }
            }
            
            window.addEventListener('scroll', onScroll, { passive: true });
            header.classList.add('visible');
        });
    </script>

    <!-- Firebase + Filters Script -->
    <script type="module">
        import { 
            db, auth, collection, getDocs, onSnapshot,
            onAuthStateChanged, signOut 
        } from './firebase-config.js';

        const appState = {
            products: [],
            filteredProducts: [],
            currentUsage: null,
            currentStoneName: null,
            user: null,
            activeFilters: {}
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Initializing Category Products Page with Filters...');
            
            const urlParams = new URLSearchParams(window.location.search);
            appState.currentUsage = urlParams.get('usage');
            appState.currentStoneName = urlParams.get('stone') || urlParams.get('stone_name');
            
            initializePage();
            initializeAuth();
            initializeUI();
            initializeFilters();
        });

        // Filter Functions
        function initializeFilters() {
            const filters = ['stoneTypeFilter', 'usageFilter', 'thicknessFilter'];
            filters.forEach(filterId => {
                const filter = document.getElementById(filterId);
                if (filter) {
                    filter.addEventListener('change', applyFilters);
                }
            });
            
            document.getElementById('priceFilter').addEventListener('input', function() {
                document.getElementById('priceValue').textContent = `Â£0 - Â£${this.value}`;
                applyFilters();
            });
            
            document.getElementById('clearFilters').addEventListener('click', clearAllFilters);
        }

        function populateFilters() {
            const stoneTypes = [...new Set(appState.products.map(p => p.category || 'Unknown'))].sort();
            const usages = [...new Set(appState.products.map(p => p.uses).filter(u => u))].sort();
            const thicknesses = [...new Set(appState.products.map(p => p.thickness).filter(t => t))].sort();

            // Populate stone type filter
            const stoneFilter = document.getElementById('stoneTypeFilter');
            stoneFilter.innerHTML = '<option value="">All Types</option>';
            stoneTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.toLowerCase().replace(/ /g, '-');
                option.textContent = type;
                stoneFilter.appendChild(option);
            });

            // Populate usage filter
            const usageFilter = document.getElementById('usageFilter');
            usageFilter.innerHTML = '<option value="">All Uses</option>';
            usages.forEach(usage => {
                const option = document.createElement('option');
                option.value = usage.toLowerCase().replace(/ /g, '-');
                option.textContent = usage;
                usageFilter.appendChild(option);
            });

            // Populate thickness filter
            const thicknessFilter = document.getElementById('thicknessFilter');
            thicknessFilter.innerHTML = '<option value="">All Thickness</option>';
            thicknesses.forEach(thickness => {
                const option = document.createElement('option');
                option.value = thickness;
                option.textContent = thickness;
                thicknessFilter.appendChild(option);
            });
        }

        function applyFilters() {
            let filtered = [...appState.products];

            // Apply active filters
            if (appState.activeFilters.stoneType) {
                filtered = filtered.filter(p => 
                    (p.category || '').toLowerCase().replace(/ /g, '-') === appState.activeFilters.stoneType
                );
            }
            
            if (appState.activeFilters.usage) {
                filtered = filtered.filter(p => 
                    p.uses.toLowerCase().replace(/ /g, '-') === appState.activeFilters.usage
                );
            }
            
            if (appState.activeFilters.thickness) {
                filtered = filtered.filter(p => 
                    (p.thickness || '') === appState.activeFilters.thickness
                );
            }
            
            if (appState.activeFilters.maxPrice) {
                filtered = filtered.filter(p => {
                    const price = parseFloat(p.price) || 0;
                    return price <= parseFloat(appState.activeFilters.maxPrice);
                });
            }

            // Apply URL filters
            if (appState.currentUsage) {
                filtered = filtered.filter(p => 
                    p.uses.toLowerCase().replace(/ /g, '-') === appState.currentUsage.toLowerCase()
                );
            }
            if (appState.currentStoneName) {
                filtered = filtered.filter(p => 
                    p.stonename.toLowerCase().replace(/ /g, '-') === appState.currentStoneName.toLowerCase()
                );
            }

            appState.filteredProducts = filtered;
            displayProducts();
            updateProductsCount();
            updateActiveFiltersDisplay();
        }

        function updateActiveFiltersDisplay() {
            const container = document.getElementById('activeFilters');
            container.innerHTML = '';
            
            Object.entries(appState.activeFilters).forEach(([key, value]) => {
                if (value) {
                    const chip = document.createElement('div');
                    chip.className = 'filter-chip';
                    chip.innerHTML = `
                        ${getFilterLabel(key)}: ${value}
                        <button class="remove" data-filter="${key}">&times;</button>
                    `;
                    chip.querySelector('.remove').addEventListener('click', () => {
                        clearFilter(key);
                    });
                    container.appendChild(chip);
                }
            });
        }

        function getFilterLabel(key) {
            const labels = {
                stoneType: 'Stone Type',
                usage: 'Usage',
                thickness: 'Thickness',
                maxPrice: 'Price'
            };
            return labels[key] || key;
        }

        function clearFilter(filterKey) {
            appState.activeFilters[filterKey] = '';
            document.getElementById(filterKey === 'maxPrice' ? 'priceFilter' : `${filterKey}Filter`).value = '';
            if (filterKey === 'maxPrice') {
                document.getElementById('priceValue').textContent = 'Â£0 - Â£1000';
            }
            applyFilters();
        }

        function clearAllFilters() {
            appState.activeFilters = {};
            document.querySelectorAll('.filter-group select, .filter-group input[type="range"]').forEach(el => {
                el.value = '';
            });
            document.getElementById('priceValue').textContent = 'Â£0 - Â£1000';
            applyFilters();
        }

        // UI Functions (Search, Profile, Mega Menu - SAME AS BEFORE)
        function initializeUI() {
            initializeSearch();
            initializeUserProfile();
            initializeMegaMenu();
        }

        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchResults = document.getElementById('searchResults');
            
            if (!searchInput || !searchButton || !searchResults) return;
            
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') performSearch();
            });
            
            searchInput.addEventListener('input', function() {
                if (searchInput.value.length > 2) {
                    performSearch();
                } else {
                    searchResults.classList.remove('active');
                }
            });
            
            function performSearch() {
                const query = searchInput.value.trim().toLowerCase();
                if (query.length < 2) {
                    searchResults.classList.remove('active');
                    return;
                }
                
                searchResults.classList.remove('active');
                searchResults.innerHTML = '<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
                searchResults.classList.add('active');
                
                setTimeout(() => {
                    const results = appState.products.filter(product =>
                        product.stonename.toLowerCase().includes(query) ||
                        product.uses.toLowerCase().includes(query) ||
                        product.type.toLowerCase().includes(query) ||
                        product.category.toLowerCase().includes(query)
                    );
                    displaySearchResults(results, query);
                }, 300);
            }
            
            function displaySearchResults(results, query) {
                searchResults.innerHTML = '';
                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="no-results">No products found for "' + query + '"</div>';
                    return;
                }
                
                results.forEach(product => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <div class="search-result-image" style="background-image: url('${product.images?.[0] || getDefaultImage(product.category)}')"></div>
                        <div class="search-result-content">
                            <div class="search-result-name">${product.stonename} Stone Product</div>
                            <div class="search-result-category">${product.uses} | ${product.category} | Natural Stone</div>
                            <div class="search-result-price">${product.price ? 'Â£' + product.price : 'Price on request'}</div>
                        </div>
                    `;
                    resultItem.addEventListener('click', function() {
                        window.location.href = `product-details.html?id=${product.id}`;
                    });
                    searchResults.appendChild(resultItem);
                });
            }
        }

        // Page Functions (loadProducts, displayProducts - UPDATED)
        async function initializePage() {
            try {
                await loadProductsFromFirestore();
                updatePageTitle();
                populateFilters();
                applyFilters();
                generateUsesNavigation();
            } catch (error) {
                console.error('Error initializing page', error);
                appState.products = getSampleProducts();
                populateFilters();
                applyFilters();
                generateUsesNavigation();
            }
        }

        async function loadProductsFromFirestore() {
            const querySnapshot = await getDocs(collection(db, 'products'));
            appState.products = [];
            
            querySnapshot.forEach(doc => {
                const data = doc.data();
                let processedData = { ...data };
                
                if (data.additionalfields && Array.isArray(data.additionalfields)) {
                    data.additionalfields.forEach(field => {
                        if (typeof field === 'object') {
                            processedData = { ...processedData, ...field };
                        }
                    });
                }
                
                appState.products.push({ id: doc.id, ...processedData });
            });
            
            // Real-time updates
            onSnapshot(collection(db, 'products'), (snapshot) => {
                const updatedProducts = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let processedData = { ...data };
                    if (data.additionalfields && Array.isArray(data.additionalfields)) {
                        data.additionalfields.forEach(field => {
                            if (typeof field === 'object') {
                                processedData = { ...processedData, ...field };
                            }
                        });
                    }
                    updatedProducts.push({ id: doc.id, ...processedData });
                });
                appState.products = updatedProducts;
                populateFilters();
                applyFilters();
                generateUsesNavigation();
            });
        }

        function displayProducts() {
            const productsContainer = document.getElementById('products-list');
            productsContainer.innerHTML = '';
            
            if (!appState.filteredProducts.length) {
                productsContainer.innerHTML = `
                    <div class="no-products">
                        <i class="fas fa-box-open"></i>
                        <h3>No Products Found</h3>
                        <p>We couldn't find any products matching your criteria.</p>
                        <a href="index.html" class="details-btn">Back to Home</a>
                    </div>
                `;
                return;
            }
            
            appState.filteredProducts.forEach(product => {
                const imageUrl = product.images?.[0] || getDefaultImage(product.category);
                const description = product.description || 'No description';
                const rate = product.price || 'N/A';
                const detailsLink = product.pageUrl || `product-details.html?id=${product.id}`;
                
                const cardHTML = `
                    <div class="product-card">
                        <a href="${detailsLink}">
                            <div class="product-img-box">
                                <img src="${imageUrl}" alt="${product.stonename}" class="product-img">
                            </div>
                        </a>
                        <p class="product-description">${description}</p>
                        <p class="product-rate">${rate}</p>
                        <a href="${detailsLink}" class="details-btn">View Details</a>
                    </div>
                `;
                productsContainer.innerHTML += cardHTML;
            });
        }

        function getDefaultImage(category) {
            const defaultImages = {
                'marble': 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80',
                'granite': 'https://images.unsplash.com/photo-1595428774223-ef52624120d2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80',
                'limestone': 'https://images.unsplash.com/photo-1611273426858-450d8e3c9fce?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80',
                'sandstone': 'https://images.unsplash.com/photo-1541140532154-b024d705b90a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80'
            };
            const cat = category ? category.toLowerCase() : 'marble';
            return defaultImages[cat] || defaultImages.marble;
        }

        // Other functions remain same (updatePageTitle, generateUsesNavigation, etc.)
        function updatePageTitle() {
            const pageTitle = document.getElementById('pageTitle');
            const breadcrumb = document.getElementById('breadcrumb');
            
            if (appState.currentUsage && appState.currentStoneName) {
                pageTitle.textContent = `${appState.currentStoneName} Stones`;
                breadcrumb.innerHTML = `<a href="index.html">Home</a> <span>&gt;</span> <a href="category-products.html?usage=${appState.currentUsage}">${appState.currentUsage}</a> <span>&gt;</span> <span>${appState.currentStoneName}</span>`;
            } else if (appState.currentUsage) {
                pageTitle.textContent = `${appState.currentUsage} Stones`;
                breadcrumb.innerHTML = `<a href="index.html">Home</a> <span>&gt;</span> <span>${appState.currentUsage}</span>`;
            } else {
                pageTitle.textContent = 'All Stone Products';
                breadcrumb.innerHTML = `<a href="index.html">Home</a> <span>&gt;</span> <span>All Products</span>`;
            }
        }

        function getSampleProducts() {
            return [{
                id: 1,
                stonename: 'RED SAND STONE',
                category: 'Red Sand Stone',
                type: 'Natural',
                uses: 'Flooring',
                price: 100,
                thickness: '20-30 mm',
                images: ['https://i.ibb.co/HLpBc94/R51b7aaab131a.jpg']
            }];
        }

        // Auth functions (same as before)
        function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    appState.user = {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0]
                    };
                    updateUserInterface();
                } else {
                    appState.user = null;
                    updateUserInterface();
                }
            });
        }

        function updateUserInterface() {
            if (appState.user) {
                document.getElementById('userProfile').style.display = 'block';
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('addProductButton').style.display = 'flex';
                
                document.getElementById('profileName').textContent = appState.user.name;
                document.getElementById('profileAvatar').textContent = appState.user.name.charAt(0).toUpperCase();
                document.getElementById('dropdownUserName').textContent = appState.user.name;
                document.getElementById('dropdownUserEmail').textContent = appState.user.email;
            } else {
                document.getElementById('userProfile').style.display = 'none';
                document.getElementById('loginButton').style.display = 'flex';
                document.getElementById('addProductButton').style.display = 'none';
            }
        }

        // Rest of the functions (initializeUserProfile, initializeMegaMenu, etc.) remain the same...
        function initializeUserProfile() {
            const profileToggle = document.getElementById('profileToggle');
            const profileDropdown = document.getElementById('profileDropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (!profileToggle || !profileDropdown) return;
            
            profileToggle.addEventListener('click', function(event) {
                event.stopPropagation();
                profileDropdown.classList.toggle('active');
            });
            
            document.addEventListener('click', function() {
                profileDropdown.classList.remove('active');
            });
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    signOut(auth).then(() => {
                        console.log('User signed out');
                    }).catch(error => {
                        console.error('Sign out error', error);
                    });
                });
            }
        }

        function initializeMegaMenu() {
            // Mega menu functionality remains the same
            const useItems = document.querySelectorAll('.use-item');
            const container = document.querySelector('.uses-top-bar .container');
            
            if (!container) return;
            
            useItems.forEach((item, index) => {
                const megaMenu = item.querySelector('.mega-menu');
                if (megaMenu) {
                    const containerRect = container.getBoundingClientRect();
                    megaMenu.style.width = `${containerRect.width}px`;
                    megaMenu.style.left = '0px';
                }
            });
        }

        function generateUsesNavigation() {
            const usesContainer = document.getElementById('dynamicUsesContainer');
            if (!usesContainer) return;
            
            usesContainer.innerHTML = '';
            const uniqueUses = [...new Set(appState.products
                .filter(product => product.uses && product.uses.trim())
                .map(product => product.uses.trim())
            )].sort();
            
            if (uniqueUses.length === 0) {
                usesContainer.innerHTML = '<div class="loading-categories"><i class="fas fa-info-circle"></i><p>No uses found</p></div>';
                return;
            }
            
            uniqueUses.forEach(usage => {
                const usageKey = usage.toLowerCase().replace(/ /g, '-');
                const useItem = document.createElement('div');
                useItem.className = 'use-item';
                
                const usageProducts = appState.products.filter(product => 
                    product.uses.toLowerCase() === usage.toLowerCase()
                );
                const uniqueStoneNames = [...new Set(usageProducts
                    .filter(product => product.stonename)
                    .map(product => product.stonename)
                )];
                
                if (uniqueStoneNames.length > 0) {
                    // Mega menu with stone names
                    useItem.innerHTML = `
                        <div class="use-link">${usage} (${usageProducts.length})</div>
                        <div class="mega-menu">
                            <div class="patterns-grid">
                                ${uniqueStoneNames.map(stoneName => {
                                    const stoneSlug = stoneName.toLowerCase().replace(/ /g, '-');
                                    const stoneProduct = appState.products.find(p => 
                                        p.uses.toLowerCase() === usage.toLowerCase() && 
                                        p.stonename === stoneName
                                    );
                                    const imageUrl = stoneProduct?.images?.[0] || getDefaultImage(stoneProduct?.category);
                                    return `
                                        <a href="category-products.html?usage=${usageKey}&stone=${stoneSlug}" 
                                           class="pattern-item" data-usage="${usage}" data-stone="${stoneName}">
                                            <div class="pattern-image" style="background-image: url('${imageUrl}')"></div>
                                            <div class="pattern-name">${stoneName}</div>
                                        </a>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    // Simple link
                    useItem.innerHTML = `<a href="category-products.html?usage=${usageKey}" class="use-link">${usage} (${usageProducts.length})</a>`;
                }
                
                usesContainer.appendChild(useItem);
            });
            
            setTimeout(initializeMegaMenu, 100);
        }

        function updateProductsCount() {
            const productsCount = document.getElementById('productsCount');
            if (!productsCount) return;
            
            const filteredCount = appState.filteredProducts.length;
            let countText = `Showing ${filteredCount} product${filteredCount !== 1 ? 's' : ''}`;
            
            if (appState.currentUsage && appState.currentStoneName) {
                countText += ` for ${appState.currentStoneName} ${appState.currentUsage} all categories`;
            }
            
            productsCount.textContent = countText;
        }

        console.log('âœ… All functions loaded with NEW FILTERS!');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management - IRYA STONE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #c9a227, #e6c04c);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #2c3e50;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: white;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #34495e;
        }
        
        .tab.active {
            background: #34495e;
            border-bottom: 3px solid #c9a227;
        }
        
        .tab-content {
            padding: 30px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #c9a227;
            box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding: 15px;
            border: 2px dashed #e0e0e0;
            border-radius: 6px;
            min-height: 100px;
        }
        
        .img-thumb {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .img-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .img-thumb span {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4757;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #c9a227, #e6c04c);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #b89420, #d4b140);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(201, 162, 39, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #ff4757;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff3742;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border: 1px solid #e0e0e0;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-name {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .product-category {
            color: #c9a227;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .product-price {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .product-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-container input {
            flex: 1;
        }
        
        .no-products {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-new {
            background: #ffc107;
            color: #000;
        }
        
        .status-trending {
            background: #dc3545;
            color: white;
        }
        
        .status-featured {
            background: #17a2b8;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #c9a227;
        }
        
        .image-url-guide {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid #c9a227;
        }
        
        .image-url-guide h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .image-url-guide ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        .image-url-guide li {
            margin-bottom: 5px;
            color: #555;
        }
        
        .example-url {
            background: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .test-image-btn {
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-gem"></i> IRYA STONE PRODUCT MANAGEMENT</h1>
            <p>Add, Edit, View and Delete Products</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="add">Add/Edit Product</div>
            <div class="tab" data-tab="view">View Products</div>
            <div class="tab" data-tab="guide">Image Guide</div>
        </div>
        
        <!-- Message Display -->
        <div id="message" class="message"></div>
        
        <!-- Add/Edit Product Tab -->
        <div id="add-tab" class="tab-content active">
            <form id="productForm">
                <div class="form-grid">
                    <!-- Stone Name -->
                    <div class="form-group">
                        <label>Stone Name *</label>
                        <input type="text" id="stone_name" placeholder="e.g., Premium Sandstone" required>
                    </div>
                    
                    <!-- Category -->
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="category" required>
                            <option value="">Select Category</option>
                            <option value="Sand Stone">Sand Stone</option>
                            <option value="Kota Stone">Kota Stone</option>
                            <option value="Granite">Granite</option>
                            <option value="Marble">Marble</option>
                            <option value="Limestone">Limestone</option>
                            <option value="Quartzite">Quartzite</option>
                            <option value="Slate">Slate</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <!-- Price -->
                    <div class="form-group">
                        <label>Price (¬£) *</label>
                        <input type="number" id="price" step="0.01" placeholder="89.99" required>
                    </div>
                    
                    <!-- Price Unit -->
                    <div class="form-group">
                        <label>Price Unit *</label>
                        <select id="price_unit" required>
                            <option value="sqm">Per SQM</option>
                            <option value="piece">Per Piece</option>
                            <option value="box">Per Box</option>
                            <option value="pallet">Per Pallet</option>
                        </select>
                    </div>
                    
                    <!-- Color -->
                    <div class="form-group">
                        <label>Color</label>
                        <input type="text" id="color" placeholder="e.g., Autumn Brown">
                    </div>
                    
                    <!-- Finish -->
                    <div class="form-group">
                        <label>Finish</label>
                        <select id="finish">
                            <option value="">Select Finish</option>
                            <option value="Natural">Natural</option>
                            <option value="Polished">Polished</option>
                            <option value="Honed">Honed</option>
                            <option value="Brushed">Brushed</option>
                            <option value="Flamed">Flamed</option>
                            <option value="Tumbled">Tumbled</option>
                        </select>
                    </div>
                    
                    <!-- Size -->
                    <div class="form-group">
                        <label>Size (L x W)</label>
                        <input type="text" id="size" placeholder="e.g., 30x30cm">
                    </div>
                    
                    <!-- Thickness -->
                    <div class="form-group">
                        <label>Thickness</label>
                        <input type="text" id="thickness" placeholder="e.g., 20mm">
                    </div>
                    
                    <!-- Type -->
                    <div class="form-group">
                        <label>Type</label>
                        <input type="text" id="type" placeholder="e.g., Natural Stone">
                    </div>
                    
                    <!-- Sub Category -->
                    <div class="form-group">
                        <label>Sub Category</label>
                        <input type="text" id="sub_category" placeholder="e.g., Brown Sandstone">
                    </div>
                    
                    <!-- Latest Status -->
                    <div class="form-group">
                        <label>Latest Status</label>
                        <select id="latest">
                            <option value="">Not Latest</option>
                            <option value="new">New Arrival</option>
                            <option value="trending">Trending</option>
                            <option value="featured">Featured</option>
                        </select>
                    </div>
                </div>
                
                <!-- Description -->
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" placeholder="Product description..."></textarea>
                </div>
                
                <!-- Usage -->
                <div class="form-group">
                    <label>Usage/Application</label>
                    <textarea id="usage" rows="2" placeholder="e.g., Wall Cladding, Flooring, Outdoor Paving"></textarea>
                </div>
                
                <!-- Image Management -->
                <div class="form-group">
                    <label>Product Images (Direct Image URLs) *</label>
                    <div class="image-preview" id="imagePreview"></div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="text" id="imageUrlInput" placeholder="Paste direct image URL" style="flex: 1;">
                        <button type="button" class="btn btn-primary" id="addImageBtn">
                            <i class="fas fa-plus"></i> Add Image
                        </button>
                    </div>
                    
                    <button type="button" class="btn btn-secondary test-image-btn" id="testImageBtn">
                        <i class="fas fa-check"></i> Test Image URL
                    </button>
                    
                    <div class="image-url-guide">
                        <h4><i class="fas fa-info-circle"></i> How to get working image URL:</h4>
                        <p>Use these free image hosting services:</p>
                        <div class="example-url">https://images.unsplash.com/photo-... (Unsplash)</div>
                        <div class="example-url">https://i.imgur.com/... (Imgur)</div>
                        <div class="example-url">https://example.com/image.jpg (Direct link)</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" id="clearBtn">
                        <i class="fas fa-times"></i> Clear Form
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save"></i> Save Product
                    </button>
                </div>
            </form>
        </div>
        
        <!-- View Products Tab -->
        <div id="view-tab" class="tab-content">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search products...">
                <button class="btn btn-primary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <div id="loading" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading products...</p>
            </div>
            
            <div id="productsContainer">
                <!-- Products will load here -->
            </div>
        </div>
        
        <!-- Image Guide Tab -->
        <div id="guide-tab" class="tab-content">
            <div class="image-url-guide">
                <h2><i class="fas fa-images"></i> Image URL Guide</h2>
                
                <h3>Problem: Google Drive URLs don't work directly</h3>
                <p>Google Drive sharing links are for viewing files, not for direct image embedding.</p>
                
                <h3>Solution 1: Use Free Image Hosting</h3>
                <p>Upload images to these free services:</p>
                
                <h4>1. Imgur (Recommended)</h4>
                <ol>
                    <li>Go to <a href="https://imgur.com/upload" target="_blank">imgur.com/upload</a></li>
                    <li>Upload your image</li>
                    <li>Right-click on image ‚Üí "Copy image address"</li>
                    <li>URL format: <code>https://i.imgur.com/IMAGE_ID.jpg</code></li>
                </ol>
                
                <h4>2. PostImage</h4>
                <ol>
                    <li>Go to <a href="https://postimages.org/" target="_blank">postimages.org</a></li>
                    <li>Upload image</li>
                    <li>Copy "Direct Link"</li>
                    <li>URL format: <code>https://i.postimg.cc/.../filename.jpg</code></li>
                </ol>
                
                <h4>3. FreeImage.Host</h4>
                <ol>
                    <li>Go to <a href="https://freeimage.host/" target="_blank">freeimage.host</a></li>
                    <li>Upload image</li>
                    <li>Copy "Direct Link"</li>
                </ol>
                
                <h3>Solution 2: Fix Google Drive URLs</h3>
                <p>Convert Google Drive URL to direct link:</p>
                
                <h4>Step 1: Get File ID</h4>
                <p>Original Google Drive URL:</p>
                <div class="example-url">https://drive.google.com/file/d/1AbCdEfGhIjKlMnOpQrStUvWxYz/view?usp=sharing</div>
                
                <p>File ID is between <code>/d/</code> and <code>/view</code>:</p>
                <div class="example-url">File ID: 1AbCdEfGhIjKlMnOpQrStUvWxYz</div>
                
                <h4>Step 2: Create Direct Link</h4>
                <p>Convert to this format:</p>
                <div class="example-url">https://drive.google.com/uc?export=view&id=1AbCdEfGhIjKlMnOpQrStUvWxYz</div>
                
                <h4>Step 3: Use in HTML</h4>
                <div class="example-url">&lt;img src="https://drive.google.com/uc?export=view&id=1AbCdEfGhIjKlMnOpQrStUvWxYz"&gt;</div>
                
                <h3>Solution 3: Use Image URLs Generator</h3>
                <p>Add this URL to automatically convert:</p>
                <div class="example-url">https://lh3.googleusercontent.com/d/</div>
                <p>Format: <code>https://lh3.googleusercontent.com/d/FILE_ID</code></p>
                
                <h3>Test Your Image URL</h3>
                <div style="margin-top: 20px;">
                    <input type="text" id="testUrlInput" placeholder="Paste image URL to test" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                    <button class="btn btn-primary" id="testUrlBtn">
                        <i class="fas fa-eye"></i> Test URL
                    </button>
                    <div id="testResult" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    const firebaseConfig = {
        apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
        authDomain: "iryastone-uk.firebaseapp.com",
        projectId: "iryastone-uk",
        storageBucket: "iryastone-uk.firebasestorage.app",
        messagingSenderId: "110940910896",
        appId: "1:110940910896:web:b25e92127118665e5c84f5",
        measurementId: "G-6YM1FLYN48"
    };

    // Firebase variables
    let firebaseApp, firebaseDB;
    let productImages = [];
    let editingProductId = null;
    let allProducts = [];

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Product Management Initializing...');
        
        initializeFirebase();
        setupEventListeners();
        loadProducts();
    });

    function initializeFirebase() {
        try {
            if (typeof firebase === 'undefined') {
                showError('Firebase not loaded. Please check your internet connection.');
                return false;
            }
            
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            
            firebaseDB = firebase.firestore();
            
            console.log('‚úÖ Firebase initialized successfully');
            return true;
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showError('Firebase initialization failed: ' + error.message);
            return false;
        }
    }

    function setupEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId + '-tab').classList.add('active');
                
                // Load products when viewing products tab
                if (tabId === 'view') {
                    loadProducts();
                }
            });
        });

        // Product form
        document.getElementById('productForm').addEventListener('submit', handleAddOrUpdateProduct);
        document.getElementById('clearBtn').addEventListener('click', clearProductForm);
        
        // Image management
        document.getElementById('addImageBtn').addEventListener('click', addImageFromInput);
        document.getElementById('imageUrlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addImageFromInput();
            }
        });
        
        // Test buttons
        document.getElementById('testImageBtn').addEventListener('click', testCurrentImageUrl);
        document.getElementById('testUrlBtn').addEventListener('click', testAnyImageUrl);
        
        // View products
        document.getElementById('searchInput').addEventListener('input', filterProducts);
        document.getElementById('refreshBtn').addEventListener('click', loadProducts);
    }

    // ============================================
    // GOOGLE DRIVE URL FIX FUNCTIONS
    // ============================================
    
    function convertGoogleDriveUrl(url) {
        // If already converted or not Google Drive, return as is
        if (!url.includes('drive.google.com')) {
            return url;
        }
        
        // Try to extract file ID from various Google Drive URL formats
        let fileId = '';
        
        // Format 1: https://drive.google.com/file/d/FILE_ID/view
        const match1 = url.match(/\/d\/([^\/]+)/);
        if (match1) {
            fileId = match1[1];
        }
        
        // Format 2: https://drive.google.com/open?id=FILE_ID
        const match2 = url.match(/id=([^&]+)/);
        if (match2 && !fileId) {
            fileId = match2[1];
        }
        
        if (fileId) {
            // Convert to direct download link
            return `https://drive.google.com/uc?export=view&id=${fileId}`;
        }
        
        // If we can't extract file ID, return original URL
        return url;
    }
    
    function testCurrentImageUrl() {
        const urlInput = document.getElementById('imageUrlInput');
        const url = urlInput.value.trim();
        
        if (!url) {
            showError('Please enter an image URL first');
            return;
        }
        
        testImageUrl(url, function(success, convertedUrl) {
            if (success) {
                showSuccess('‚úÖ Image URL works! Click "Add Image" to add it.');
                // Auto-fill with converted URL if needed
                if (convertedUrl && convertedUrl !== url) {
                    urlInput.value = convertedUrl;
                }
            } else {
                showError('‚ùå Image URL does not work. Please use a direct image link.');
            }
        });
    }
    
    function testAnyImageUrl() {
        const urlInput = document.getElementById('testUrlInput');
        const url = urlInput.value.trim();
        const testResult = document.getElementById('testResult');
        
        if (!url) {
            testResult.innerHTML = '<div style="color: #dc3545;">Please enter a URL to test</div>';
            return;
        }
        
        testResult.innerHTML = '<div style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Testing URL...</div>';
        
        testImageUrl(url, function(success, convertedUrl, message) {
            if (success) {
                testResult.innerHTML = `
                    <div style="color: #28a745;">
                        <i class="fas fa-check-circle"></i> <strong>URL Works!</strong>
                        <p>${message}</p>
                        <p><strong>Use this URL:</strong></p>
                        <div class="example-url">${convertedUrl}</div>
                        <button class="btn btn-sm btn-primary" onclick="copyToClipboard('${convertedUrl}')" style="margin-top: 10px;">
                            <i class="fas fa-copy"></i> Copy URL
                        </button>
                    </div>
                `;
            } else {
                testResult.innerHTML = `
                    <div style="color: #dc3545;">
                        <i class="fas fa-times-circle"></i> <strong>URL Failed</strong>
                        <p>${message}</p>
                        <p>Try using Imgur or PostImage instead.</p>
                    </div>
                `;
            }
        });
    }
    
    function testImageUrl(url, callback) {
        // First convert Google Drive URL if needed
        const convertedUrl = convertGoogleDriveUrl(url);
        
        // Create test image element
        const testImg = new Image();
        let timer;
        
        testImg.onload = function() {
            clearTimeout(timer);
            callback(true, convertedUrl, 'Image loaded successfully!');
        };
        
        testImg.onerror = function() {
            clearTimeout(timer);
            
            // Try with Googleusercontent format
            if (convertedUrl.includes('drive.google.com')) {
                const fileIdMatch = convertedUrl.match(/id=([^&]+)/);
                if (fileIdMatch) {
                    const fileId = fileIdMatch[1];
                    const googleusercontentUrl = `https://lh3.googleusercontent.com/d/${fileId}`;
                    
                    // Test Googleusercontent URL
                    const testImg2 = new Image();
                    testImg2.onload = function() {
                        callback(true, googleusercontentUrl, 'Google Drive image works with alternative URL');
                    };
                    testImg2.onerror = function() {
                        callback(false, url, 'Image failed to load. Please use Imgur or direct image hosting.');
                    };
                    testImg2.src = googleusercontentUrl;
                    return;
                }
            }
            
            callback(false, url, 'Image failed to load. Please use Imgur or direct image hosting.');
        };
        
        // Set timeout
        timer = setTimeout(function() {
            testImg.onerror();
        }, 5000);
        
        // Start loading
        testImg.src = convertedUrl;
    }
    
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            showSuccess('URL copied to clipboard!');
        }, function(err) {
            console.error('Could not copy text: ', err);
        });
    }

    // ============================================
    // FORM HANDLING (ADD/UPDATE)
    // ============================================
    async function handleAddOrUpdateProduct(e) {
        e.preventDefault();
        
        try {
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            // Get form values
            const productData = {
                stone_name: document.getElementById('stone_name').value.trim(),
                category: document.getElementById('category').value,
                description: document.getElementById('description').value.trim(),
                price: parseFloat(document.getElementById('price').value) || 0,
                price_unit: document.getElementById('price_unit').value,
                color: document.getElementById('color').value.trim(),
                finish: document.getElementById('finish').value,
                size: document.getElementById('size').value.trim(),
                thickness: document.getElementById('thickness').value.trim(),
                type: document.getElementById('type').value.trim(),
                sub_category: document.getElementById('sub_category').value.trim(),
                usage: document.getElementById('usage').value.trim(),
                latest: document.getElementById('latest').value,
                is_active: true,
                images: productImages,
                updated_at: new Date().toISOString()
            };
            
            // Validation
            if (!productData.stone_name) {
                throw new Error('Stone name is required');
            }
            
            if (!productData.category) {
                throw new Error('Category is required');
            }
            
            if (productImages.length === 0) {
                throw new Error('At least one image is required');
            }
            
            // ============================================
            // UPDATE MODE
            // ============================================
            if (editingProductId) {
                await firebaseDB
                    .collection('products')
                    .doc(editingProductId)
                    .update(productData);
                
                showSuccess('‚úÖ Product updated successfully!');
                editingProductId = null;
            }
            
            // ============================================
            // ADD MODE
            // ============================================
            else {
                productData.created_at = new Date().toISOString();
                
                await firebaseDB
                    .collection('products')
                    .add(productData);
                
                showSuccess('‚úÖ New product added successfully!');
            }
            
            // Reset form
            clearProductForm();
            
            // Reload products
            loadProducts();
            
            // Switch to view tab
            switchToViewTab();
            
        } catch (error) {
            console.error('Error saving product:', error);
            showError('‚ùå ' + error.message);
        } finally {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Product';
        }
    }

    function clearProductForm() {
        document.getElementById('productForm').reset();
        productImages = [];
        editingProductId = null;
        updateImagePreview();
        
        // Reset submit button text
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Save Product';
        
        showSuccess('Form cleared');
    }

    // ============================================
    // IMAGE MANAGEMENT
    // ============================================
    function addImageFromInput() {
        const imageUrlInput = document.getElementById('imageUrlInput');
        let url = imageUrlInput.value.trim();
        
        if (!url) {
            showError('Please enter an image URL');
            return;
        }
        
        // Convert Google Drive URL if needed
        url = convertGoogleDriveUrl(url);
        
        // Test the URL first
        testImageUrl(url, function(success, finalUrl) {
            if (success) {
                productImages.push(finalUrl);
                updateImagePreview();
                imageUrlInput.value = '';
                showSuccess('Image added successfully!');
            } else {
                showError('Image URL failed to load. Please use a working image URL.');
            }
        });
    }

    function updateImagePreview() {
        const container = document.getElementById('imagePreview');
        container.innerHTML = '';
        
        if (productImages.length === 0) {
            container.innerHTML = '<div style="color: #999; text-align: center; width: 100%; padding: 20px;">No images added yet</div>';
            return;
        }
        
        productImages.forEach((url, index) => {
            const imgDiv = document.createElement('div');
            imgDiv.className = 'img-thumb';
            imgDiv.innerHTML = `
                <img src="${url}" alt="Image ${index + 1}" 
                     onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\" viewBox=\"0 0 100 100\"><rect width=\"100\" height=\"100\" fill=\"%23f0f0f0\"/><text x=\"50\" y=\"50\" text-anchor=\"middle\" dy=\".3em\" fill=\"%23999\" font-size=\"12\">Image ${index + 1}</text></svg>';">
                <span onclick="removeImage(${index})">‚úï</span>
            `;
            container.appendChild(imgDiv);
        });
    }

    function removeImage(index) {
        productImages.splice(index, 1);
        updateImagePreview();
    }

    // ============================================
    // VIEW PRODUCTS FUNCTIONS
    // ============================================
    async function loadProducts() {
        try {
            showLoading(true);
            
            const querySnapshot = await firebaseDB.collection('products').get();
            allProducts = [];
            
            querySnapshot.forEach((doc) => {
                const product = doc.data();
                product.id = doc.id;
                
                // Fix: Ensure price is a number
                if (product.price) {
                    product.price = parseFloat(product.price);
                } else {
                    product.price = 0;
                }
                
                // Fix: Ensure images is an array
                if (!Array.isArray(product.images)) {
                    product.images = product.image ? [product.image] : [];
                }
                
                // Fix: Convert Google Drive URLs in existing products
                if (Array.isArray(product.images)) {
                    product.images = product.images.map(img => convertGoogleDriveUrl(img));
                }
                
                allProducts.push(product);
            });
            
            console.log(`Loaded ${allProducts.length} products`);
            displayProducts(allProducts);
            
        } catch (error) {
            console.error('Error loading products:', error);
            showError('Failed to load products: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    function displayProducts(products) {
        const container = document.getElementById('productsContainer');
        
        if (products.length === 0) {
            container.innerHTML = `
                <div class="no-products">
                    <i class="fas fa-box-open fa-3x" style="margin-bottom: 20px;"></i>
                    <h3>No Products Found</h3>
                    <p>Add your first product using the "Add Product" tab</p>
                </div>
            `;
            return;
        }
        
        const productsHTML = products.map(product => {
            // Get first image or use placeholder
            let imageUrl = '';
            if (product.images && product.images.length > 0) {
                imageUrl = product.images[0];
            } else if (product.image) {
                imageUrl = product.image;
            }
            
            // Convert Google Drive URL if needed
            imageUrl = convertGoogleDriveUrl(imageUrl);
            
            // Format price safely
            const price = typeof product.price === 'number' ? product.price.toFixed(2) : '0.00';
            
            // Latest badge
            let latestBadge = '';
            if (product.latest) {
                let badgeClass = '';
                switch(product.latest) {
                    case 'new': badgeClass = 'status-new'; break;
                    case 'trending': badgeClass = 'status-trending'; break;
                    case 'featured': badgeClass = 'status-featured'; break;
                    default: badgeClass = 'status-new';
                }
                latestBadge = `<span class="status-badge ${badgeClass}">${product.latest}</span>`;
            }
            
            // Description
            const description = product.description ? 
                (product.description.length > 100 ? 
                    product.description.substring(0, 100) + '...' : 
                    product.description) : 
                'No description';
            
            return `
                <div class="product-card">
                    <img src="${imageUrl}" alt="${product.stone_name}" class="product-image"
                         onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"300\" height=\"200\" viewBox=\"0 0 300 200\"><rect width=\"300\" height=\"200\" fill=\"%23f0f0f0\"/><text x=\"150\" y=\"100\" text-anchor=\"middle\" dy=\".3em\" fill=\"%23999\" font-size=\"14\">${product.stone_name}</text></svg>';">
                    <div class="product-info">
                        <div class="product-name">
                            ${product.stone_name || 'Unnamed Product'}
                            ${latestBadge}
                        </div>
                        <div class="product-category">${product.category || 'Uncategorized'}</div>
                        <div class="product-price">¬£${price}</div>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            ${description}
                        </p>
                        <div class="product-actions">
                            <button class="btn btn-sm btn-primary" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}', '${product.stone_name || 'this product'}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = `<div class="products-grid">${productsHTML}</div>`;
    }

    function filterProducts() {
        const searchTerm = this.value.toLowerCase();
        
        if (!searchTerm) {
            displayProducts(allProducts);
            return;
        }
        
        const filtered = allProducts.filter(product => {
            const stoneName = product.stone_name ? product.stone_name.toLowerCase() : '';
            const category = product.category ? product.category.toLowerCase() : '';
            const description = product.description ? product.description.toLowerCase() : '';
            const color = product.color ? product.color.toLowerCase() : '';
            
            return stoneName.includes(searchTerm) ||
                   category.includes(searchTerm) ||
                   description.includes(searchTerm) ||
                   color.includes(searchTerm);
        });
        
        displayProducts(filtered);
    }

    // ============================================
    // EDIT PRODUCT FUNCTION
    // ============================================
    async function editProduct(productId) {
        try {
            const doc = await firebaseDB
                .collection('products')
                .doc(productId)
                .get();
            
            if (!doc.exists) {
                throw new Error('Product not found');
            }
            
            const product = doc.data();
            
            // Set editing mode
            editingProductId = productId;
            
            // Fill form with product data
            document.getElementById('stone_name').value = product.stone_name || '';
            document.getElementById('category').value = product.category || '';
            document.getElementById('description').value = product.description || '';
            document.getElementById('price').value = product.price || '';
            document.getElementById('price_unit').value = product.price_unit || 'sqm';
            document.getElementById('color').value = product.color || '';
            document.getElementById('finish').value = product.finish || '';
            document.getElementById('size').value = product.size || '';
            document.getElementById('thickness').value = product.thickness || '';
            document.getElementById('type').value = product.type || '';
            document.getElementById('sub_category').value = product.sub_category || '';
            document.getElementById('usage').value = product.usage || '';
            document.getElementById('latest').value = product.latest || '';
            
            // Ensure images is an array
            productImages = Array.isArray(product.images) ? product.images : [];
            if (!productImages.length && product.image) {
                productImages = [product.image];
            }
            
            updateImagePreview();
            
            // Update submit button
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Update Product';
            
            // Switch to add tab
            switchToAddTab();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            showSuccess('Product loaded for editing');
            
        } catch (error) {
            console.error('Error loading product for edit:', error);
            showError('Failed to load product: ' + error.message);
        }
    }

    // ============================================
    // DELETE PRODUCT FUNCTION
    // ============================================
    async function deleteProduct(productId, productName) {
        if (!confirm(`Are you sure you want to delete "${productName}"?`)) {
            return;
        }
        
        try {
            await firebaseDB.collection('products').doc(productId).delete();
            showSuccess(`‚úÖ "${productName}" deleted successfully!`);
            loadProducts();
        } catch (error) {
            console.error('Error deleting product:', error);
            showError('‚ùå Failed to delete product: ' + error.message);
        }
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function showSuccess(message) {
        const messageDiv = document.getElementById('message');
        messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        messageDiv.className = 'message success';
        
        setTimeout(() => {
            messageDiv.className = 'message';
        }, 3000);
    }

    function showError(message) {
        const messageDiv = document.getElementById('message');
        messageDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        messageDiv.className = 'message error';
        
        setTimeout(() => {
            messageDiv.className = 'message';
        }, 5000);
    }

    function showLoading(show) {
        const loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = show ? 'block' : 'none';
    }

    function switchToAddTab() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector('.tab[data-tab="add"]').classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('add-tab').classList.add('active');
    }

    function switchToViewTab() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector('.tab[data-tab="view"]').classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('view-tab').classList.add('active');
    }

    // Make functions available globally
    window.removeImage = removeImage;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.copyToClipboard = copyToClipboard;
    window.convertGoogleDriveUrl = convertGoogleDriveUrl;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Orders | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ===== VARIABLES ===== */
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
    
    /* Order status colors */
    --success: #007600;
    --warning: #ffa41c;
    --pending: #ffa500;
    --processing: #007185;
    --shipped: #b12704;
    --delivered: #007600;
    --cancelled: #d50000;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
    transition: padding-top 0.3s ease;
}

/* ===== HEADER (Scroll Hide/Show) ===== */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
    gap: 10px;
    transition: transform 0.3s ease;
    transform: translateY(0);
}

.header.hide {
    transform: translateY(-100%);
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    min-width: 140px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.logo span {
    font-size: 18px;
    font-weight: 700;
    color: var(--stone-dark);
    font-family: 'Roboto Slab', serif;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-light);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dark);
    font-size: 16px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
}

/* ===== FOOTER (Scroll Hide/Show) ===== */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    border-top: 1px solid #eee;
    z-index: 999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    transform: translateY(0);
}

.bottom-nav.hide {
    transform: translateY(100%);
}

.nav-btn {
    text-align: center;
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: var(--transition);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 10px;
    min-width: 70px;
    text-decoration: none;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.nav-btn.active {
    color: var(--primary-gold);
}

.nav-btn i {
    font-size: 18px;
}

/* ===== BREADCRUMB ===== */
.breadcrumb {
    padding: 90px 16px 20px;
    background: var(--white);
    border-bottom: 1px solid #f0f0f0;
    transition: padding-top 0.3s ease;
}

.breadcrumb-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-light);
    font-size: 14px;
}

.breadcrumb-item a {
    color: var(--text-light);
    text-decoration: none;
    transition: var(--transition);
}

.breadcrumb-item a:hover {
    color: var(--primary-gold);
}

.breadcrumb-item.active {
    color: var(--primary-gold);
    font-weight: 500;
}

.breadcrumb-divider {
    color: var(--text-light);
}

/* ===== ORDER DETAILS TOP VIEW ===== */
.order-top-view {
    display: none;
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 30px;
    margin: 20px auto;
    max-width: 1200px;
    box-shadow: var(--shadow-lg);
    animation: slideDown 0.3s ease;
    position: relative;
    z-index: 99;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.order-top-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.order-top-header h2 {
    font-size: 22px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.order-top-header h2 i {
    color: var(--primary-gold);
}

.close-top-view {
    background: none;
    border: none;
    font-size: 24px;
    color: #666;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: var(--transition);
}

.close-top-view:hover {
    background: var(--bg-light);
    color: var(--stone-dark);
}

.order-top-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.order-top-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.order-top-label {
    font-size: 12px;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.order-top-value {
    font-weight: 600;
    color: var(--text-dark);
}

.order-top-value.amount {
    color: var(--primary-gold);
    font-size: 18px;
}

.order-top-value.status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

/* ===== ORDER STATUS BADGES ===== */
.status-pending { background: #fff8e1; color: var(--pending); }
.status-processing { background: #e3f2fd; color: var(--processing); }
.status-shipped { background: #f3e5f5; color: var(--shipped); }
.status-delivered { background: #e8f5e8; color: var(--delivered); }
.status-cancelled { background: #ffebee; color: var(--cancelled); }
.status-pending_bank_transfer { background: #ffeaa7; color: #856404; }

.order-status-badge {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

/* ===== MAIN CONTAINER ===== */
.container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 16px;
}

.page-header {
    margin-bottom: 20px;
}

.page-header h1 {
    font-size: 28px;
    font-weight: 600;
    color: var(--stone-dark);
    margin-bottom: 8px;
}

.page-header p {
    color: var(--text-light);
    font-size: 14px;
}

/* ===== ORDERS FILTER ===== */
.orders-filter {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 8px 16px;
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    background: var(--white);
    color: var(--text-dark);
    font-size: 14px;
    cursor: pointer;
    transition: var(--transition);
}

.filter-btn:hover {
    background: var(--bg-light);
}

.filter-btn.active {
    background: var(--primary-gold);
    color: var(--white);
    border-color: var(--primary-gold);
}

.search-box {
    flex: 1;
    min-width: 200px;
    position: relative;
}

.search-box input {
    width: 100%;
    padding: 12px 40px 12px 15px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: var(--transition);
    background: var(--white);
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.1);
}

.search-box i {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
}

/* ===== ORDERS GRID ===== */
.orders-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 20px;
}

@media (max-width: 768px) {
    .orders-grid {
        grid-template-columns: 1fr;
    }
}

/* ===== ORDER CARD ===== */
.order-card {
    background: var(--white);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
    border: 1px solid #f0f0f0;
}

.order-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.order-header {
    padding: 16px;
    background: linear-gradient(to right, #f7f7f7, var(--white));
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.order-info h3 {
    font-size: 16px;
    color: var(--stone-dark);
    margin-bottom: 4px;
    font-weight: 600;
}

.order-date {
    font-size: 12px;
    color: var(--text-light);
}

.order-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.order-body {
    padding: 16px;
}

.order-item {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #f0f0f0;
}

.item-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--bg-light);
    flex-shrink: 0;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-details {
    flex: 1;
}

.item-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
    color: var(--stone-dark);
}

.item-meta {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 4px;
}

.item-price {
    font-weight: 600;
    color: var(--text-dark);
    font-size: 14px;
}

.order-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.summary-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.summary-label {
    font-size: 12px;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summary-value {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-dark);
}

.summary-value.paid { color: var(--delivered); }
.summary-value.remaining { color: var(--pending); }
.summary-value.total { color: var(--primary-gold); }

/* ===== TRACKING PROGRESS ===== */
.tracking-progress {
    margin: 20px 0;
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    padding: 0 10px;
}

.progress-steps::before {
    content: '';
    position: absolute;
    top: 12px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: #e0e0e0;
    z-index: 1;
}

.progress-bar {
    position: absolute;
    top: 12px;
    left: 10%;
    height: 2px;
    background: var(--primary-gold);
    z-index: 2;
    transition: width 0.3s;
}

.step {
    position: relative;
    z-index: 3;
    text-align: center;
    flex: 1;
}

.step-icon {
    width: 26px;
    height: 26px;
    background: var(--white);
    border: 2px solid #e0e0e0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    font-size: 12px;
    color: var(--text-light);
    transition: var(--transition);
}

.step.active .step-icon {
    background: var(--primary-gold);
    border-color: var(--primary-gold);
    color: var(--white);
}

.step.completed .step-icon {
    background: var(--delivered);
    border-color: var(--delivered);
    color: var(--white);
}

.step-label {
    font-size: 11px;
    color: var(--text-light);
    font-weight: 500;
    text-transform: uppercase;
}

.step.active .step-label {
    color: var(--primary-gold);
    font-weight: 600;
}

.step.completed .step-label {
    color: var(--delivered);
    font-weight: 600;
}

/* ===== ORDER ACTIONS ===== */
.order-actions {
    display: flex;
    gap: 10px;
    padding: 16px;
    border-top: 1px solid #f0f0f0;
    background: var(--bg-light);
}

.btn {
    flex: 1;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: var(--transition);
}

.btn-primary {
    background: var(--primary-gold);
    color: var(--white);
}

.btn-primary:hover {
    background: var(--gold-dark);
}

.btn-secondary {
    background: var(--white);
    color: var(--text-dark);
    border: 1px solid #e0e0e0;
}

.btn-secondary:hover {
    background: var(--bg-light);
    border-color: var(--primary-gold);
}

.btn-outline {
    background: transparent;
    color: var(--primary-gold);
    border: 1px solid var(--primary-gold);
}

.btn-outline:hover {
    background: rgba(201, 162, 39, 0.1);
}

/* ===== NOTIFICATION DROPDOWN ===== */
.notification-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    width: 350px;
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    margin-top: 8px;
}

.notification-dropdown.active {
    display: block;
}

.notification-header {
    padding: 16px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-header h3 {
    font-size: 16px;
    font-weight: 600;
    color: var(--stone-dark);
}

.notification-actions button {
    background: none;
    border: none;
    color: var(--primary-gold);
    font-size: 12px;
    cursor: pointer;
    padding: 4px 8px;
    transition: var(--transition);
}

.notification-actions button:hover {
    text-decoration: underline;
}

.notification-list {
    max-height: 400px;
    overflow-y: auto;
}

.notification-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: var(--transition);
}

.notification-item:hover {
    background: var(--bg-light);
}

.notification-item.unread {
    background: rgba(201, 162, 39, 0.05);
}

.notification-title {
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--stone-dark);
}

.notification-message {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 6px;
}

.notification-time {
    font-size: 11px;
    color: var(--text-light);
}

/* ===== LOADING STATE ===== */
.loading {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-light);
    grid-column: 1 / -1;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(201, 162, 39, 0.1);
    border-top-color: var(--primary-gold);
    border-radius: 50%;
    animation: spin 1s ease-in-out infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== EMPTY STATE ===== */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: var(--white);
    border-radius: var(--border-radius);
    border: 1px solid #f0f0f0;
    grid-column: 1 / -1;
}

.empty-state i {
    font-size: 48px;
    color: #e0e0e0;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: var(--text-light);
    margin-bottom: 10px;
    font-weight: 600;
}

/* ===== CART BADGE ===== */
.cart-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: var(--white);
    font-size: 10px;
    font-weight: 600;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .breadcrumb {
        padding: 80px 16px 20px;
    }
    
    .container {
        margin: 20px auto;
    }
    
    .orders-filter {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        min-width: 100%;
    }
    
    .order-actions {
        flex-direction: column;
    }
    
    .order-summary {
        grid-template-columns: 1fr;
    }
    
    .notification-dropdown {
        width: 300px;
        right: -50px;
    }
}

@media (max-width: 480px) {
    .orders-grid {
        gap: 15px;
    }
    
    .order-card {
        border-radius: 10px;
    }
    
    .container {
        padding: 0 12px;
    }
}
</style>
</head>

<body>

<!-- Order Details Top View -->
<div class="order-top-view" id="orderTopView">
  <div class="order-top-header">
    <h2><i class="fas fa-box"></i> Order Details</h2>
    <button class="close-top-view" onclick="closeOrderTopView()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="order-top-content" id="orderTopContent">
    <!-- Order details will be loaded here -->
  </div>
  <div class="order-actions">
    <button class="btn btn-primary" onclick="downloadInvoice()">
      <i class="fas fa-file-invoice"></i> Download Invoice
    </button>
    <button class="btn btn-secondary" onclick="closeOrderTopView()">
      <i class="fas fa-times"></i> Close
    </button>
  </div>
</div>

<!-- Header -->
<header class="header" id="mainHeader">
  <div class="logo">
    <i class="fa-solid fa-gem"></i>
    <span>IRYA STONE</span>
  </div>
  
  <div class="header-actions">
    <a href="account.html" class="action-btn" title="Account">
      <i class="fas fa-user"></i>
    </a>
    <div style="position: relative;">
      <button class="action-btn notification-btn" onclick="toggleNotifications()" title="Notifications">
        <i class="fas fa-bell"></i>
        <span class="cart-badge" id="notificationBadge">0</span>
      </button>
      <div class="notification-dropdown" id="notificationDropdown">
        <div class="notification-header">
          <h3>Notifications</h3>
          <div class="notification-actions">
            <button onclick="markAllAsRead()">Mark all read</button>
          </div>
        </div>
        <div class="notification-list" id="notificationList">
          <!-- Notifications will be loaded here -->
        </div>
      </div>
    </div>
    <a href="cart.html" class="action-btn" title="Cart" style="position: relative;">
      <i class="fas fa-shopping-cart"></i>
      <span class="cart-badge" id="cartBadge">0</span>
    </a>
  </div>
</header>

<!-- Breadcrumb -->
<section class="breadcrumb">
  <div class="breadcrumb-content">
    <div class="breadcrumb-item">
      <a href="index.html"><i class="fas fa-home"></i> Home</a>
    </div>
    <div class="breadcrumb-divider">
      <i class="fas fa-chevron-right"></i>
    </div>
    <div class="breadcrumb-item active">
      My Orders
    </div>
  </div>
</section>

<!-- Main Container -->
<main class="container">
  <div class="page-header">
    <h1>My Orders</h1>
    <p>Track and manage all your orders</p>
  </div>
  
  <!-- Orders Filter -->
  <div class="orders-filter">
    <button class="filter-btn active" onclick="filterOrders('all')">All Orders</button>
    <button class="filter-btn" onclick="filterOrders('pending')">Pending</button>
    <button class="filter-btn" onclick="filterOrders('processing')">Processing</button>
    <button class="filter-btn" onclick="filterOrders('shipped')">Shipped</button>
    <button class="filter-btn" onclick="filterOrders('delivered')">Delivered</button>
    
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by order number..." onkeyup="searchOrders()">
      <i class="fas fa-search"></i>
    </div>
  </div>
  
  <!-- Orders Grid -->
  <div class="orders-grid" id="orders">
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Loading your orders...</p>
    </div>
  </div>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav" id="bottomNav">
  <a href="index.html" class="nav-btn">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </a>
  <a href="products.html" class="nav-btn">
    <i class="fas fa-th-large"></i>
    <span>Products</span>
  </a>
  <a href="orders.html" class="nav-btn active">
    <i class="fas fa-box"></i>
    <span>Orders</span>
  </a>
  <a href="account.html" class="nav-btn">
    <i class="fas fa-user"></i>
    <span>Account</span>
  </a>
</nav>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  query, 
  orderBy, 
  onSnapshot,
  getDocs,
  updateDoc,
  doc,
  where,
  limit,
  getDoc
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5",
  measurementId: "G-6YM1FLYN48"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ============================================
// SCROLL HIDE/SHOW HEADER & FOOTER
// ============================================

let lastScrollTop = 0;
const header = document.getElementById('mainHeader');
const bottomNav = document.getElementById('bottomNav');
const breadcrumb = document.querySelector('.breadcrumb');

// Scroll threshold for hiding/showing
const SCROLL_THRESHOLD = 50;

function handleScroll() {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  
  // Hide/show header
  if (scrollTop > lastScrollTop && scrollTop > SCROLL_THRESHOLD) {
    // Scrolling down
    header.classList.add('hide');
    bottomNav.classList.add('hide');
  } else {
    // Scrolling up
    header.classList.remove('hide');
    bottomNav.classList.remove('hide');
  }
  
  lastScrollTop = scrollTop;
}

// Add scroll event listener
window.addEventListener('scroll', handleScroll, { passive: true });

// ============================================
// USER ID MANAGEMENT
// ============================================

async function getUserId() {
  try {
    // Check localStorage for user
    const savedUser = localStorage.getItem('irya_stone_auth_user');
    if (savedUser) {
      const user = JSON.parse(savedUser);
      console.log("‚úÖ User ID from localStorage:", user.uid);
      return user.uid;
    }

    // Check for guest ID
    let guestId = localStorage.getItem('irya_guest_id');
    if (!guestId) {
      guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('irya_guest_id', guestId);
    }
    
    console.log("‚úÖ Guest user ID:", guestId);
    return guestId;
    
  } catch (error) {
    console.error("‚ùå Error getting user ID:", error);
    return 'guest_' + Date.now();
  }
}

// ============================================
// ORDERS MANAGEMENT - REAL-TIME
// ============================================

let userId = null;
let orders = [];
let notifications = [];
let currentFilter = 'all';
let currentOrderDetails = null;
let ordersUnsubscribe = null;
let notificationsUnsubscribe = null;

async function loadOrders() {
  try {
    const ordersDiv = document.getElementById("orders");
    
    // Get user ID
    userId = await getUserId();
    console.log("üì± Loading orders for user:", userId);
    
    // Setup real-time listener for orders
    setupOrdersListener();
    
    // Load notifications
    loadNotifications();
    
    // Update cart badge
    updateCartBadge();
    
  } catch (error) {
    console.error("‚ùå Error loading orders:", error);
    showEmptyState("Failed to load orders. Please try again.");
  }
}

async function setupOrdersListener() {
  const ordersDiv = document.getElementById("orders");
  
  // Clean up previous listener
  if (ordersUnsubscribe) ordersUnsubscribe();
  
  let ordersQuery;
  
  try {
    // First try: users/{userId}/orders collection
    const userOrdersRef = collection(db, "users", userId, "orders");
    ordersQuery = query(userOrdersRef, orderBy("createdAt", "desc"));
    console.log("‚úÖ Trying users/{userId}/orders collection");
  } catch (error) {
    console.log("‚ùå Trying main orders collection...");
    // Second try: main orders collection with user filter
    const ordersRef = collection(db, "orders");
    ordersQuery = query(
      ordersRef, 
      where("userId", "==", userId),
      orderBy("createdAt", "desc")
    );
  }
  
  ordersUnsubscribe = onSnapshot(ordersQuery, 
    async (snapshot) => {
      orders = [];
      
      if (snapshot.empty) {
        console.log("üì≠ No orders found for user:", userId);
        showEmptyState("You haven't placed any orders yet.");
        return;
      }
      
      // Process each order
      for (const docSnapshot of snapshot.docs) {
        const orderData = docSnapshot.data();
        orderData.id = docSnapshot.id;
        
        // Fetch product images for order items
        if (orderData.items && Array.isArray(orderData.items)) {
          for (const item of orderData.items) {
            if (item.imageId) {
              // Try to fetch image from products collection
              try {
                const productDoc = await getDoc(doc(db, "products", item.imageId));
                if (productDoc.exists()) {
                  const productData = productDoc.data();
                  item.image = productData.imageUrl || productData.image || 
                              getDefaultImage(item.category);
                } else {
                  // Check in stone collection
                  const stoneDoc = await getDoc(doc(db, "stone", item.imageId));
                  if (stoneDoc.exists()) {
                    const stoneData = stoneDoc.data();
                    item.image = stoneData.imageUrl || stoneData.image || 
                                getDefaultImage(item.category);
                  }
                }
              } catch (error) {
                console.warn("‚ö†Ô∏è Could not fetch image for item:", item.imageId);
                item.image = getDefaultImage(item.category);
              }
            } else {
              item.image = getDefaultImage(item.category);
            }
          }
        }
        
        orders.push(orderData);
        console.log(`üì¶ Order loaded: ${orderData.orderNumber} - ${orderData.status}`);
      }
      
      console.log(`‚úÖ Loaded ${orders.length} orders with images`);
      displayOrders(orders);
      
    }, 
    (error) => {
      console.error("‚ùå Error in orders listener:", error);
      ordersDiv.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Connection Error</h3>
          <p>Please check your internet connection</p>
          <button class="btn btn-primary" onclick="loadOrders()" style="margin-top: 20px;">
            <i class="fas fa-redo"></i> Retry
          </button>
        </div>
      `;
    }
  );
}

function getDefaultImage(category) {
  const categoryLower = (category || '').toLowerCase();
  
  if (categoryLower.includes('sand')) {
    return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('kota')) {
    return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('granite')) {
    return 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('marble')) {
    return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800&q=80';
  }
  
  return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800&q=80';
}

function displayOrders(ordersList) {
  const ordersDiv = document.getElementById("orders");
  
  if (!ordersList || ordersList.length === 0) {
    showEmptyState("You haven't placed any orders yet.");
    return;
  }
  
  // Filter orders based on current filter
  let filteredOrders = ordersList;
  if (currentFilter !== 'all') {
    filteredOrders = ordersList.filter(order => {
      const status = order.status || order.shippingStatus || 'pending';
      return status.toLowerCase().includes(currentFilter);
    });
  }
  
  if (filteredOrders.length === 0) {
    showEmptyState(`No ${currentFilter} orders found.`);
    return;
  }
  
  let ordersHTML = '';
  
  filteredOrders.forEach((order) => {
    // Format date
    const orderDate = formatDate(order.createdAt);
    
    // Payment status
    const isFullPaid = order.paymentStatus === 'fully_paid' || 
                      (order.advancePayment && order.advancePayment >= order.total) ||
                      (order.submittedAmount && order.submittedAmount >= order.total);
    
    // Shipping status
    const shippingStatus = order.shippingStatus || order.status || 'pending';
    const statusClass = getStatusClass(shippingStatus);
    const statusText = getStatusText(shippingStatus);
    
    // Calculate payments
    const paidAmount = order.submittedAmount || order.advancePayment || 0;
    const remainingAmount = isFullPaid ? 0 : (order.remainingPayment || order.total - paidAmount);
    
    // Get first item for preview
    let itemName = 'Multiple Items';
    let itemImage = getDefaultImage();
    let itemCount = order.items ? order.items.length : 1;
    
    if (order.items && order.items.length > 0) {
      const firstItem = order.items[0];
      itemName = firstItem.name || firstItem.stoneName || firstItem.productName || 'Product';
      if (firstItem.image) itemImage = firstItem.image;
    }
    
    // Progress calculation
    const progressWidth = calculateProgressWidth(order);
    
    ordersHTML += `
      <div class="order-card" data-order-id="${order.id}">
        <div class="order-header">
          <div class="order-info">
            <h3>${order.orderNumber || 'Order #' + order.id.substring(0, 8)}</h3>
            <div class="order-date">Placed on ${orderDate}</div>
          </div>
          <div class="order-status ${statusClass}">
            <i class="fas ${getStatusIcon(shippingStatus)}"></i>
            ${statusText}
          </div>
        </div>
        
        <div class="order-body">
          <div class="order-item">
            <div class="item-image">
              <img src="${itemImage}" alt="${itemName}" 
                   onerror="this.src='${getDefaultImage()}'">
            </div>
            <div class="item-details">
              <div class="item-name">${itemName}</div>
              <div class="item-meta">
                ${itemCount} item${itemCount !== 1 ? 's' : ''} 
                ‚Ä¢ ${order.paymentMethod === 'bank' ? 'Bank Transfer' : 
                    order.paymentMethod === 'stripe' ? 'Card Payment' : 
                    order.paymentMethod === 'paypal' ? 'PayPal' : 'Payment'}
              </div>
              <div class="item-price">¬£${order.total?.toFixed(2) || '0.00'}</div>
            </div>
          </div>
          
          <div class="order-summary">
            <div class="summary-item">
              <span class="summary-label">Total</span>
              <span class="summary-value total">¬£${order.total?.toFixed(2) || '0.00'}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Paid</span>
              <span class="summary-value paid">¬£${paidAmount.toFixed(2)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Remaining</span>
              <span class="summary-value remaining">¬£${remainingAmount.toFixed(2)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Payment</span>
              <span class="summary-value ${isFullPaid ? 'paid' : 'remaining'}">
                ${isFullPaid ? 'Paid' : 'Advance'}
              </span>
            </div>
          </div>
          
          <div class="tracking-progress">
            <div class="progress-steps">
              <div class="progress-bar" style="width: ${progressWidth}%"></div>
              ${createProgressSteps(order)}
            </div>
          </div>
        </div>
        
        <div class="order-actions">
          <button class="btn btn-primary" onclick="showOrderTopView('${order.id}')">
            <i class="fas fa-eye"></i> View Details
          </button>
          <button class="btn btn-secondary" onclick="downloadOrderInvoice('${order.id}')">
            <i class="fas fa-file-invoice"></i> Invoice
          </button>
          ${order.trackingNumber ? `
            <button class="btn btn-outline" onclick="trackOrder('${order.trackingNumber}')">
              <i class="fas fa-truck"></i> Track
            </button>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  ordersDiv.innerHTML = ordersHTML;
}

// ============================================
// ORDER TOP VIEW FUNCTIONS
// ============================================

async function showOrderTopView(orderId) {
  try {
    // Find order in local data
    const order = orders.find(o => o.id === orderId);
    if (!order) {
      console.error("‚ùå Order not found:", orderId);
      return;
    }
    
    currentOrderDetails = order;
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Show header and footer
    header.classList.remove('hide');
    bottomNav.classList.remove('hide');
    
    // Display order details in top view
    displayOrderTopView(order);
    
    // Show the top view
    document.getElementById('orderTopView').style.display = 'block';
    
  } catch (error) {
    console.error("‚ùå Error showing order top view:", error);
  }
}

function displayOrderTopView(order) {
  const topContent = document.getElementById('orderTopContent');
  
  const orderDate = formatDate(order.createdAt);
  const isFullPaid = order.paymentStatus === 'fully_paid';
  const statusClass = getStatusClass(order.shippingStatus || order.status);
  const statusText = getStatusText(order.shippingStatus || order.status);
  const paidAmount = order.submittedAmount || order.advancePayment || 0;
  const remainingAmount = isFullPaid ? 0 : (order.remainingPayment || order.total - paidAmount);
  
  let itemsInfo = '1 item';
  if (order.items && order.items.length > 0) {
    const firstItem = order.items[0];
    itemsInfo = `${order.items.length} items ‚Ä¢ ${firstItem.name || firstItem.stoneName || 'Product'}`;
  }
  
  topContent.innerHTML = `
    <div class="order-top-item">
      <div class="order-top-label">Order Number</div>
      <div class="order-top-value">${order.orderNumber || 'N/A'}</div>
    </div>
    
    <div class="order-top-item">
      <div class="order-top-label">Order Date</div>
      <div class="order-top-value">${orderDate}</div>
    </div>
    
    <div class="order-top-item">
      <div class="order-top-label">Status</div>
      <div class="order-top-value status ${statusClass}">${statusText}</div>
    </div>
    
    <div class="order-top-item">
      <div class="order-top-label">Items</div>
      <div class="order-top-value">${itemsInfo}</div>
    </div>
    
    <div class="order-top-item">
      <div class="order-top-label">Total Amount</div>
      <div class="order-top-value amount">¬£${order.total?.toFixed(2) || '0.00'}</div>
    </div>
    
    <div class="order-top-item">
      <div class="order-top-label">Paid Amount</div>
      <div class="order-top-value" style="color: #28a745;">¬£${paidAmount.toFixed(2)}</div>
    </div>
    
    <div class="order-top-item">
      <div class="order-top-label">Remaining</div>
      <div class="order-top-value" style="color: ${remainingAmount > 0 ? '#dc3545' : '#28a745'}">
        ¬£${remainingAmount.toFixed(2)}
      </div>
    </div>
    
    ${order.trackingNumber ? `
    <div class="order-top-item">
      <div class="order-top-label">Tracking Number</div>
      <div class="order-top-value">${order.trackingNumber}</div>
    </div>
    ` : ''}
    
    <div class="order-top-item">
      <div class="order-top-label">Payment Method</div>
      <div class="order-top-value">
        ${order.paymentMethod === 'bank' ? 'Bank Transfer' : 
          order.paymentMethod === 'stripe' ? 'Credit Card' : 
          order.paymentMethod === 'paypal' ? 'PayPal' : 'N/A'}
      </div>
    </div>
    
    ${order.bankTransferDetails ? `
    <div class="order-top-item" style="grid-column: 1 / -1; background: #f8f9fa; padding: 15px; border-radius: 6px;">
      <div class="order-top-label">Bank Transfer Details</div>
      <div style="margin-top: 8px;">
        <div><strong>Reference:</strong> ${order.bankTransferDetails.reference}</div>
        <div><strong>Amount:</strong> ¬£${order.bankTransferDetails.amount?.toFixed(2) || '0.00'}</div>
      </div>
    </div>
    ` : ''}
  `;
}

function closeOrderTopView() {
  document.getElementById('orderTopView').style.display = 'none';
  currentOrderDetails = null;
}

function downloadInvoice() {
  if (!currentOrderDetails) return;
  downloadOrderInvoice(currentOrderDetails.id);
}

// ============================================
// NOTIFICATIONS - REAL-TIME
// ============================================

async function loadNotifications() {
  try {
    if (!db || !userId) return;
    
    const notificationsRef = collection(db, "users", userId, "notifications");
    const notificationsQuery = query(notificationsRef, orderBy("createdAt", "desc"), limit(20));
    
    if (notificationsUnsubscribe) notificationsUnsubscribe();
    
    notificationsUnsubscribe = onSnapshot(notificationsQuery,
      (snapshot) => {
        notifications = [];
        const notificationList = document.getElementById("notificationList");
        notificationList.innerHTML = '';
        
        if (snapshot.empty) {
          notificationList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-light);">
              <i class="fas fa-bell-slash" style="font-size: 24px; margin-bottom: 10px;"></i>
              <p>No notifications yet</p>
            </div>
          `;
          updateNotificationBadge();
          return;
        }
        
        let unreadCount = 0;
        
        snapshot.forEach((doc) => {
          const note = doc.data();
          note.id = doc.id;
          notifications.push(note);
          
          if (!note.read) unreadCount++;
          
          // Add to UI
          const noteElement = createNotificationElement(note);
          notificationList.appendChild(noteElement);
        });
        
        updateNotificationBadge(unreadCount);
        
      },
      (error) => {
        console.error("‚ùå Error in notifications listener:", error);
      }
    );
    
  } catch (error) {
    console.error("‚ùå Error loading notifications:", error);
  }
}

function createNotificationElement(note) {
  const div = document.createElement('div');
  div.className = `notification-item ${note.read ? '' : 'unread'}`;
  div.onclick = () => viewNotification(note.id, note.orderId);
  
  const timeAgo = getTimeAgo(note.createdAt);
  
  div.innerHTML = `
    <div class="notification-title">${note.title || 'Notification'}</div>
    <div class="notification-message">${note.message || ''}</div>
    <div class="notification-time">${timeAgo}</div>
  `;
  
  return div;
}

async function viewNotification(notificationId, orderId) {
  try {
    // Mark as read
    if (db && userId) {
      const notificationRef = doc(db, "users", userId, "notifications", notificationId);
      await updateDoc(notificationRef, {
        read: true,
        readAt: new Date().toISOString()
      });
    }
    
    // If notification has orderId, show order details
    if (orderId) {
      closeNotifications();
      setTimeout(() => {
        showOrderTopView(orderId);
      }, 300);
    } else {
      closeNotifications();
    }
    
  } catch (error) {
    console.error("‚ùå Error viewing notification:", error);
    closeNotifications();
  }
}

async function markAllAsRead() {
  try {
    if (!db || !userId) return;
    
    const unreadNotifications = notifications.filter(n => !n.read);
    
    for (const note of unreadNotifications) {
      const notificationRef = doc(db, "users", userId, "notifications", note.id);
      await updateDoc(notificationRef, {
        read: true,
        readAt: new Date().toISOString()
      });
    }
    
    // Update UI
    notifications.forEach(n => n.read = true);
    updateNotificationBadge(0);
    
    document.querySelectorAll('.notification-item.unread').forEach(item => {
      item.classList.remove('unread');
    });
    
    showMessage("All notifications marked as read");
    
  } catch (error) {
    console.error("‚ùå Error marking all as read:", error);
  }
}

function updateNotificationBadge(count = null) {
  const badge = document.getElementById("notificationBadge");
  if (!badge) return;
  
  const unreadCount = count !== null ? count : notifications.filter(n => !n.read).length;
  
  if (unreadCount > 0) {
    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

// ============================================
// CART BADGE UPDATE
// ============================================

function updateCartBadge() {
  try {
    const cartKey = 'irya_local_cart_' + userId;
    const cartData = localStorage.getItem(cartKey);
    const cartItems = cartData ? JSON.parse(cartData) : [];
    const count = cartItems.reduce((total, item) => total + (item.quantity || 0), 0);
    
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
      cartBadge.textContent = count;
      cartBadge.style.display = count > 0 ? 'flex' : 'none';
    }
  } catch (error) {
    console.error('‚ùå Error updating cart badge:', error);
  }
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function filterOrders(status) {
  currentFilter = status;
  
  // Update active filter button
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
  
  // Display filtered orders
  displayOrders(orders);
}

function searchOrders() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
  
  if (!searchTerm) {
    displayOrders(orders);
    return;
  }
  
  const filteredOrders = orders.filter(order => {
    return (
      (order.orderNumber && order.orderNumber.toLowerCase().includes(searchTerm)) ||
      (order.items && order.items.some(item => 
        (item.name && item.name.toLowerCase().includes(searchTerm)) ||
        (item.stoneName && item.stoneName.toLowerCase().includes(searchTerm)) ||
        (item.productName && item.productName.toLowerCase().includes(searchTerm))
      ))
    );
  });
  
  displayOrders(filteredOrders);
}

function calculateProgressWidth(order) {
  let progress = 0;
  
  if (order.paymentStatus === 'fully_paid' || order.paymentStatus === 'payment_verified') progress = 25;
  if (order.status === 'processing') progress = 50;
  if (order.shippingStatus === 'shipped' || order.status === 'shipped') progress = 75;
  if (order.status === 'delivered') progress = 100;
  
  return progress;
}

function createProgressSteps(order) {
  const steps = [
    { key: 'payment', icon: 'fa-credit-card', label: 'Payment' },
    { key: 'processing', icon: 'fa-cog', label: 'Processing' },
    { key: 'shipped', icon: 'fa-shipping-fast', label: 'Shipped' },
    { key: 'delivered', icon: 'fa-check-circle', label: 'Delivered' }
  ];
  
  let completedSteps = 0;
  
  if (order.paymentStatus === 'fully_paid' || order.paymentStatus === 'payment_verified') completedSteps++;
  if (order.status === 'processing' || order.status === 'shipped' || order.status === 'delivered') completedSteps++;
  if (order.shippingStatus === 'shipped' || order.status === 'shipped' || order.status === 'delivered') completedSteps++;
  if (order.status === 'delivered') completedSteps++;
  
  return steps.map((step, index) => {
    let stepClass = '';
    if (index < completedSteps) stepClass = 'completed';
    else if (index === completedSteps) stepClass = 'active';
    
    return `
      <div class="step ${stepClass}">
        <div class="step-icon">
          <i class="fas ${step.icon}"></i>
        </div>
        <div class="step-label">${step.label}</div>
      </div>
    `;
  }).join('');
}

function getStatusClass(status) {
  if (!status) return 'status-pending';
  
  const statusLower = status.toLowerCase();
  if (statusLower.includes('processing') || statusLower.includes('payment_verified')) return 'status-processing';
  if (statusLower.includes('shipped')) return 'status-shipped';
  if (statusLower.includes('delivered')) return 'status-delivered';
  if (statusLower.includes('cancelled')) return 'status-cancelled';
  if (statusLower.includes('pending_bank_transfer')) return 'status-pending_bank_transfer';
  return 'status-pending';
}

function getStatusText(status) {
  if (!status) return 'Pending';
  
  const statusMap = {
    'pending': 'Pending',
    'processing': 'Processing',
    'shipped': 'Shipped',
    'delivered': 'Delivered',
    'cancelled': 'Cancelled',
    'payment_verified': 'Payment Verified',
    'pending_bank_transfer': 'Awaiting Payment',
    'payment_received': 'Payment Received'
  };
  
  return statusMap[status.toLowerCase()] || status;
}

function getStatusIcon(status) {
  if (!status) return 'fa-clock';
  
  const statusLower = status.toLowerCase();
  if (statusLower.includes('processing') || statusLower.includes('payment_verified')) return 'fa-cog';
  if (statusLower.includes('shipped')) return 'fa-shipping-fast';
  if (statusLower.includes('delivered')) return 'fa-check-circle';
  if (statusLower.includes('cancelled')) return 'fa-times-circle';
  if (statusLower.includes('pending_bank_transfer')) return 'fa-exclamation-circle';
  return 'fa-clock';
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  } catch (error) {
    return dateString;
  }
}

function getTimeAgo(dateString) {
  if (!dateString) return 'Just now';
  
  try {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short'
    });
  } catch (error) {
    return dateString;
  }
}

function showEmptyState(message) {
  const ordersDiv = document.getElementById("orders");
  ordersDiv.innerHTML = `
    <div class="empty-state">
      <i class="fas fa-box-open"></i>
      <h3>${message}</h3>
      <p>Start shopping to see your orders here</p>
      <button class="btn btn-primary" onclick="window.location.href='products.html'" style="margin-top: 20px;">
        <i class="fas fa-shopping-bag"></i> Shop Now
      </button>
    </div>
  `;
}

function showMessage(message) {
  // Create a simple toast notification
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: var(--primary-gold);
    color: var(--white);
    padding: 12px 20px;
    border-radius: var(--border-radius);
    z-index: 1000;
    animation: slideIn 0.3s ease;
    box-shadow: var(--shadow-lg);
  `;
  
  toast.innerHTML = `
    <style>
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    </style>
    <div style="display: flex; align-items: center; gap: 10px;">
      <i class="fas fa-check-circle"></i>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (toast.parentNode) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

async function downloadOrderInvoice(orderId) {
  try {
    const order = orders.find(o => o.id === orderId);
    if (!order) {
      showMessage("Order not found");
      return;
    }
    
    const win = window.open("", "_blank");
    win.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Invoice - ${order.orderNumber}</title>
        <style>
          body { 
            font-family: 'Poppins', sans-serif; 
            margin: 40px; 
            line-height: 1.6;
            background: #f7f9fc;
            color: #222222;
          }
          .invoice-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
          }
          .invoice-header { 
            text-align: center; 
            margin-bottom: 40px; 
            padding-bottom: 20px;
            border-bottom: 2px solid #c9a227;
          }
          .company { 
            font-size: 28px; 
            font-weight: 700; 
            color: #1a1a1a; 
            margin-bottom: 10px;
            font-family: 'Roboto Slab', serif;
          }
          .company span { color: #c9a227; }
          .invoice-title {
            font-size: 20px;
            color: #666666;
            text-transform: uppercase;
            letter-spacing: 3px;
          }
          .invoice-details { 
            margin: 30px 0; 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
          }
          .invoice-details div {
            margin-bottom: 10px;
          }
          .table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 30px 0; 
          }
          .table th, .table td { 
            border: 1px solid #e0e0e0; 
            padding: 12px; 
            text-align: left; 
          }
          .table th { 
            background: #f7f9fc; 
            color: #222222;
            font-weight: 600;
          }
          .total-row { 
            font-weight: 600; 
            background: #f7f9fc; 
          }
          .total-row td {
            border-top: 2px solid #e0e0e0;
          }
          .footer { 
            margin-top: 40px; 
            padding-top: 20px; 
            border-top: 2px solid #c9a227; 
            text-align: center;
          }
          .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
          }
          .status-pending { background: #fff8e1; color: #ffa500; }
          .status-processing { background: #e3f2fd; color: #007185; }
          .status-shipped { background: #f3e5f5; color: #b12704; }
          .status-delivered { background: #e8f5e8; color: #007600; }
        </style>
      </head>
      <body>
        <div class="invoice-container">
          <div class="invoice-header">
            <div class="company">IRYA <span>STONE</span></div>
            <div class="invoice-title">INVOICE</div>
          </div>
          
          <div class="invoice-details">
            <div>
              <strong>Invoice Number:</strong> ${order.orderNumber || 'N/A'}<br>
              <strong>Invoice Date:</strong> ${formatDate(order.createdAt)}<br>
              <strong>Status:</strong> 
              <span class="status-badge ${getStatusClass(order.shippingStatus || order.status)}">
                ${getStatusText(order.shippingStatus || order.status)}
              </span>
            </div>
            <div style="text-align: right;">
              <strong>Customer:</strong> ${order.userName || 'Customer'}<br>
              <strong>Payment Method:</strong> 
              ${order.paymentMethod === 'bank' ? 'Bank Transfer' : 
                order.paymentMethod === 'stripe' ? 'Credit Card' : 
                order.paymentMethod === 'paypal' ? 'PayPal' : 'N/A'}<br>
              <strong>Email:</strong> ${order.userEmail || 'N/A'}
            </div>
          </div>
          
          <table class="table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              ${order.items ? order.items.map(item => `
                <tr>
                  <td>${item.name || item.stoneName || item.productName || 'Product'}</td>
                  <td>${item.quantity || 1}</td>
                  <td>¬£${item.price?.toFixed(2) || '0.00'}</td>
                  <td>¬£${item.calculatedPrice?.toFixed(2) || item.totalPrice?.toFixed(2) || '0.00'}</td>
                </tr>
              `).join('') : '<tr><td colspan="4">No items</td></tr>'}
              
              <tr class="total-row">
                <td colspan="3" style="text-align: right;">Subtotal:</td>
                <td>¬£${order.total?.toFixed(2) || '0.00'}</td>
              </tr>
              <tr class="total-row">
                <td colspan="3" style="text-align: right;">Shipping:</td>
                <td>¬£${order.shippingCost?.toFixed(2) || '0.00'}</td>
              </tr>
              <tr class="total-row">
                <td colspan="3" style="text-align: right;">Tax:</td>
                <td>¬£${order.tax?.toFixed(2) || '0.00'}</td>
              </tr>
              <tr class="total-row">
                <td colspan="3" style="text-align: right;"><strong>Total:</strong></td>
                <td><strong>¬£${order.total?.toFixed(2) || '0.00'}</strong></td>
              </tr>
              <tr class="total-row">
                <td colspan="3" style="text-align: right;">Amount Paid:</td>
                <td>¬£${(order.submittedAmount || order.advancePayment || 0).toFixed(2)}</td>
              </tr>
              <tr class="total-row">
                <td colspan="3" style="text-align: right;">Balance Due:</td>
                <td>¬£${(order.remainingPayment || 0).toFixed(2)}</td>
              </tr>
            </tbody>
          </table>
          
          <div class="footer">
            <p><strong>Thank you for your business!</strong></p>
            <p>IRYA STONE &copy; ${new Date().getFullYear()}</p>
            <p>For any queries, contact us at: support@iryastone.com</p>
          </div>
        </div>
      </body>
      </html>
    `);
    
    win.document.close();
    
    setTimeout(() => {
      win.print();
    }, 500);
    
  } catch (error) {
    console.error("‚ùå Error downloading invoice:", error);
    showMessage("Failed to generate invoice");
  }
}

function trackOrder(trackingNumber) {
  showMessage(`Tracking number: ${trackingNumber}`);
  // In real implementation, redirect to tracking service
  // window.open(`https://tracking-url.com/${trackingNumber}`, '_blank');
}

// ============================================
// UI FUNCTIONS
// ============================================

function toggleNotifications() {
  const dropdown = document.getElementById("notificationDropdown");
  dropdown.classList.toggle("active");
}

function closeNotifications() {
  document.getElementById("notificationDropdown").classList.remove("active");
}

// Close notifications when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById("notificationDropdown");
  const button = document.querySelector('.notification-btn');
  
  if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
    dropdown.classList.remove("active");
  }
});

// ============================================
// INITIALIZATION
// ============================================

// Initialize when page loads
document.addEventListener('DOMContentLoaded', async function() {
  try {
    console.log("üì± Orders page loaded");
    
    // Load orders
    await loadOrders();
    
    // Setup periodic refresh (every 2 minutes)
    setInterval(() => {
      console.log("üîÑ Auto-refreshing orders...");
      loadOrders();
    }, 2 * 60 * 1000);
    
  } catch (error) {
    console.error("‚ùå Error initializing:", error);
  }
});

// Clean up listeners when page unloads
window.addEventListener('beforeunload', () => {
  if (ordersUnsubscribe) ordersUnsubscribe();
  if (notificationsUnsubscribe) notificationsUnsubscribe();
});

// Make functions available globally
window.filterOrders = filterOrders;
window.searchOrders = searchOrders;
window.showOrderTopView = showOrderTopView;
window.closeOrderTopView = closeOrderTopView;
window.downloadInvoice = downloadInvoice;
window.downloadOrderInvoice = downloadOrderInvoice;
window.trackOrder = trackOrder;
window.toggleNotifications = toggleNotifications;
window.markAllAsRead = markAllAsRead;
</script>

</body>
</html>

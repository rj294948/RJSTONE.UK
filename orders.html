<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Orders | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ICONS -->
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f1f3f6;
  margin:0;
}
header{
  background:#131921;
  color:#fff;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header h2{margin:0;font-size:18px;}
.notify{
  position:relative;
  font-size:22px;
}
.notify span{
  position:absolute;
  top:-6px;
  right:-8px;
  background:red;
  color:#fff;
  font-size:11px;
  padding:2px 6px;
  border-radius:50%;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:15px;
}
.order-card{
  background:#fff;
  margin-bottom:15px;
  border-radius:6px;
  padding:15px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.order-header{
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
}
.badge{
  padding:4px 8px;
  font-size:12px;
  border-radius:4px;
  color:#fff;
}
.paid{background:#2ecc71;}
.pending{background:#f39c12;}
.shipped{background:#3498db;}
.timeline{
  display:flex;
  margin-top:12px;
  gap:10px;
}
.step{
  flex:1;
  text-align:center;
  font-size:12px;
}
.step i{
  font-size:18px;
  margin-bottom:5px;
  display:block;
}
.active{color:#2ecc71;}
.btn{
  background:#ffd814;
  border:none;
  padding:8px 12px;
  cursor:pointer;
  font-size:13px;
  border-radius:4px;
}
.small{font-size:13px;color:#555;}
</style>
</head>

<body>

<header>
  <h2>My Orders</h2>
  <div class="notify">
    <i class="fa-solid fa-bell"></i>
    <span id="notifyCount">0</span>
  </div>
</header>

<div class="container" id="orders"></div>

<!-- ðŸ”¥ FIREBASE -->
<script type="module">
import { initializeApp } from
"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore,
  collection,
  query,
  orderBy,
  onSnapshot
} from
"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* âœ… USER ID FROM account.html */
const userId = localStorage.getItem("userId");

if(!userId){
  alert("Please login first");
  location.href="login.html";
}

/* ================= ORDERS ================= */

const ordersDiv = document.getElementById("orders");

const q = query(
  collection(db,"users",userId,"orders"),
  orderBy("createdAt","desc")
);

onSnapshot(q,(snap)=>{
  ordersDiv.innerHTML="";
  snap.forEach(doc=>{
    const o = doc.data();

    const fullyPaid = o.paymentStatus==="fully_paid";
    const shipped = o.status==="shipped";

    ordersDiv.innerHTML += `
      <div class="order-card">
        <div class="order-header">
          <div>
            <b>${o.orderNumber}</b><br>
            <span class="small">${o.createdAt}</span>
          </div>
          <div>
            <span class="badge ${fullyPaid?"paid":"pending"}">
              ${o.paymentStatus}
            </span>
          </div>
        </div>

        <p class="small">
          Product: <b>${o.items[0].stoneName}</b><br>
          Total: <b>Â£${o.total}</b><br>
          Paid: <b>Â£${o.advancePayment || o.total}</b><br>
          Remaining: <b>Â£${fullyPaid?0:o.remainingPayment}</b>
        </p>

        <div class="timeline">
          <div class="step active">
            <i class="fa-solid fa-cart-shopping"></i>Ordered
          </div>
          <div class="step ${fullyPaid?"active":""}">
            <i class="fa-solid fa-credit-card"></i>Paid
          </div>
          <div class="step ${shipped?"active":""}">
            <i class="fa-solid fa-truck"></i>Shipped
          </div>
          <div class="step ${o.status==="delivered"?"active":""}">
            <i class="fa-solid fa-box"></i>Delivered
          </div>
        </div>

        ${shipped ? `
          <p class="small">
            Tracking No: <b>${o.trackingNumber}</b>
          </p>` : ""}

        <button class="btn" onclick="downloadInvoice('${o.orderNumber}')">
          Download Invoice
        </button>
      </div>
    `;
  });
});

/* ================= NOTIFICATIONS ================= */

const notifyRef = collection(db,"users",userId,"notifications");

onSnapshot(notifyRef,(snap)=>{
  let unread=0;
  snap.forEach(d=>{
    if(!d.data().read) unread++;
  });
  document.getElementById("notifyCount").innerText=unread;
});

/* ================= INVOICE ================= */

window.downloadInvoice = (orderNo)=>{
  alert("Invoice download for "+orderNo+" (PDF integration next)");
};
</script>

</body>
</html>

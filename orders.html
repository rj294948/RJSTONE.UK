<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Orders | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ===== AMAZON STYLE THEME ===== -->
<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#eaeded;
}
header{
  background:#131921;
  color:#fff;
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header h2{ margin:0; font-size:18px; }
.bell{
  position:relative;
  cursor:pointer;
}
.bell span{
  position:absolute;
  top:-6px;
  right:-6px;
  background:red;
  color:#fff;
  border-radius:50%;
  font-size:11px;
  padding:2px 6px;
}

.container{
  padding:15px;
}
.order{
  background:#fff;
  border-radius:8px;
  margin-bottom:12px;
  padding:15px;
}
.order-header{
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
}
.badge{
  padding:4px 8px;
  border-radius:4px;
  font-size:12px;
}
.advance{ background:#f0ad4e; color:#000; }
.full{ background:#198754; color:#fff; }

button{
  background:#ffd814;
  border:1px solid #fcd200;
  padding:6px 10px;
  cursor:pointer;
  margin-top:8px;
  border-radius:4px;
}
button.secondary{
  background:#e7e9ec;
  border:1px solid #adb1b8;
}

/* ===== MODAL ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
}
.modal-content{
  background:#fff;
  max-width:600px;
  margin:5% auto;
  padding:20px;
  border-radius:8px;
}
.close{
  float:right;
  cursor:pointer;
  font-size:18px;
}

/* ===== NOTIFICATIONS ===== */
#notifications{
  display:none;
  position:fixed;
  top:60px;
  right:10px;
  background:#fff;
  width:320px;
  max-height:400px;
  overflow:auto;
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,.3);
}
.note{
  padding:10px;
  border-bottom:1px solid #eee;
}
.note.unread{ font-weight:bold; }
small{ color:#666; }
</style>
</head>

<body>

<header>
  <h2>IRYA STONE ‚Äì My Orders</h2>
  <div class="bell" onclick="toggleNotes()">
    üîî
    <span id="noteCount" style="display:none">0</span>
  </div>
</header>

<div class="container" id="orders">Loading orders‚Ä¶</div>

<!-- ===== ORDER DETAILS MODAL ===== -->
<div class="modal" id="orderModal">
  <div class="modal-content" id="orderDetails">
    <span class="close" onclick="closeModal()">‚úñ</span>
  </div>
</div>

<!-- ===== NOTIFICATION PANEL ===== -->
<div id="notifications"></div>

<!-- ===== FIREBASE + LOGIC ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, getDoc,
  query, orderBy, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== USER ID (login ke baad dynamic) ===== */
const userId = "dCVM344so3VCKQGNdsHm2aUZrKA3";

/* ================= ORDERS ================= */
const ordersDiv = document.getElementById("orders");

const snap = await getDocs(collection(db,"users",userId,"orders"));
ordersDiv.innerHTML = "";

snap.forEach(d=>{
  const o = d.data();
  const isFull = o.submittedAmount >= o.total;

  ordersDiv.innerHTML += `
    <div class="order">
      <div class="order-header">
        <div>
          <b>${o.orderNumber}</b><br>
          <small>${o.createdAt}</small>
        </div>
        <span class="badge ${isFull?"full":"advance"}">
          ${isFull?"FULL PAID":"30% ADVANCE"}
        </span>
      </div>

      <p>Total: ¬£${o.total}</p>
      <p>Paid: ¬£${o.submittedAmount}</p>
      <p>Remaining: ¬£${o.remainingPayment}</p>
      <p>Status: ${o.shippingStatus || "Processing"}</p>

      <button onclick="viewOrder('${d.id}')">View Order</button>
      <button class="secondary" onclick="downloadInvoice('${d.id}')">
        Download Invoice
      </button>
    </div>
  `;
});

/* ================= ORDER DETAILS ================= */
window.viewOrder = async (orderId)=>{
  const o = (await getDoc(doc(db,"users",userId,"orders",orderId))).data();

  document.getElementById("orderDetails").innerHTML = `
    <span class="close" onclick="closeModal()">‚úñ</span>
    <h3>Order ${o.orderNumber}</h3>

    <p><b>Product:</b> ${o.items[0].name}</p>
    <p><b>Payment Method:</b> ${o.paymentMethod}</p>
    <p><b>Transaction Ref:</b> ${o.transactionReference || "-"}</p>

    <p><b>Paid:</b> ¬£${o.submittedAmount}</p>
    <p><b>Remaining:</b> ¬£${o.remainingPayment}</p>

    <p><b>Shipping:</b> ${o.shippingStatus || "Pending"}</p>
    <p><b>Tracking:</b> ${o.trackingNumber || "Not assigned"}</p>
  `;
  document.getElementById("orderModal").style.display="block";
};

window.closeModal = ()=> {
  document.getElementById("orderModal").style.display="none";
};

/* ================= INVOICE ================= */
window.downloadInvoice = async (orderId)=>{
  const o = (await getDoc(doc(db,"users",userId,"orders",orderId))).data();
  const w = window.open("","_blank");
  w.document.write(`
    <h2>IRYA STONE ‚Äì Invoice</h2>
    <p>Order: ${o.orderNumber}</p>
    <p>Name: ${o.userName}</p>
    <p>Total: ¬£${o.total}</p>
    <p>Paid: ¬£${o.submittedAmount}</p>
    <p>Remaining: ¬£${o.remainingPayment}</p>
  `);
  w.print();
};

/* ================= NOTIFICATIONS ================= */
const notesDiv = document.getElementById("notifications");
const countSpan = document.getElementById("noteCount");

const q = query(
  collection(db,"users",userId,"notifications"),
  orderBy("createdAt","desc")
);

onSnapshot(q, snap=>{
  notesDiv.innerHTML="";
  let unread=0;

  snap.forEach(d=>{
    const n=d.data();

    /* ‚ùå FULL PAYMENT USER KO REMAINING PAYMENT NOTICE NAHI */
    if(n.type==="payment" && n.message.includes("remaining") && n.ignoreIfFull){
      return;
    }

    if(!n.read) unread++;

    notesDiv.innerHTML+=`
      <div class="note ${n.read?"":"unread"}">
        <b>${n.title}</b>
        <p>${n.message}</p>
        <small>${n.createdAt}</small>
      </div>
    `;
  });

  countSpan.style.display = unread? "block":"none";
  countSpan.innerText = unread;
});

window.toggleNotes = ()=>{
  notesDiv.style.display =
    notesDiv.style.display==="block"?"none":"block";
};
</script>

</body>
</html>

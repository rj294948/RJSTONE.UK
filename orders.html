<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Orders | IRYA STONE</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

    // --- 1. CONFIGURATION AND INITIALIZATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
        authDomain: "iryastone-uk.firebaseapp.com",
        projectId: "iryastone-uk"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // This ID should ideally be fetched from Firebase Authentication
    const userId = "dCVM344so3VCKQGNdsHm2aUZrKA3"; 
    const ordersDiv = document.getElementById("orders");
    const loadingMessage = '<div style="text-align: center; padding: 50px; color: var(--text-light);"><i class="fas fa-spinner fa-spin"></i> Loading your order history...</div>';
    ordersDiv.innerHTML = loadingMessage;

    // --- 2. HELPER FUNCTIONS ---

    /** Formats a Firebase Timestamp or date string */
    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        try {
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        } catch {
            return String(timestamp).substring(0, 10); // Fallback
        }
    }

    /** Returns HTML for a styled status badge */
    function getStatusBadge(status, paymentStatus) {
        let text;
        let className;
        
        if (status === 'cancelled') {
            text = 'CANCELLED';
            className = 'cancelled';
        } else if (status === 'delivered') {
            text = 'DELIVERED';
            className = 'ok';
        } else if (paymentStatus === 'fully_paid') {
            text = 'FULL PAID';
            className = 'ok';
        } else if (paymentStatus === 'pending_bank_transfer' || paymentStatus === 'advance_paid') {
            text = 'PAYMENT PENDING';
            className = 'pending';
        } else {
            text = 'PROCESSING';
            className = 'processing';
        }

        return `<span class="badge ${className}">${text}</span>`;
    }

    /** Creates the three-step timeline HTML */
    function createStepTimeline(order) {
        const paid = order.paymentStatus === "fully_paid" || (order.remainingPayment === 0);
        const shipped = order.status === "shipped" || order.status === "delivered";
        const delivered = order.status === "delivered";

        return `
            <div class="step-timeline">
                <div class="step-item">
                    <span class="icon ${paid ? 'done' : 'wait'}"><i class="fas fa-money-check-alt"></i></span>
                    <span class="label">Payment</span>
                </div>
                <div class="step-item">
                    <span class="icon ${shipped ? 'done' : 'wait'}"><i class="fas fa-truck-moving"></i></span>
                    <span class="label">Shipped</span>
                </div>
                <div class="step-item">
                    <span class="icon ${delivered ? 'done' : 'wait'}"><i class="fas fa-box-open"></i></span>
                    <span class="label">Delivered</span>
                </div>
            </div>
        `;
    }

    /** Opens an Order Details page (assuming you have order-details.html) */
    window.viewDetails = (orderId) => {
        window.location.href = `order-details.html?id=${orderId}`;
    };

    /** Handles invoice download (placeholder) */
    window.downloadInvoice = (orderId) => {
        alert('Generating invoice for Order: ' + orderId);
        // In a real application, you would call a backend function here.
    };

    // --- 3. REALTIME DATA LISTENER ---
    const q = query(
        collection(db, "users", userId, "orders"),
        orderBy("createdAt", "desc")
    );

    onSnapshot(q, snap => {
        ordersDiv.innerHTML = "";
        if (snap.empty) {
            ordersDiv.innerHTML = '<div style="text-align: center; padding: 50px; color: var(--text-light);">You have no orders yet.</div>';
            return;
        }

        snap.forEach(doc => {
            const order = { id: doc.id, ...doc.data() };
            const firstItem = order.items?.[0] || { stoneName: 'N/A' };
            const total = (order.total || 0).toFixed(2);
            const paid = Number(order.advancePayment || order.amountToPay || 0).toFixed(2);
            const remaining = Number(order.remainingPayment || 0).toFixed(2);

            ordersDiv.innerHTML += `
                <article class="order-card">
                    <div class="order-header">
                        <div class="order-info">
                            <span class="order-number">Order #${order.orderNumber}</span>
                            <small class="order-date">Placed on ${formatDate(order.createdAt)}</small>
                        </div>
                        ${getStatusBadge(order.status, order.paymentStatus)}
                    </div>

                    <div class="order-body">
                        <div class="item-summary">
                            <i class="fas fa-tag"></i>
                            <p><strong>Main Product:</strong> ${firstItem.stoneName} (+ ${order.items.length - 1} more items)</p>
                        </div>
                        <div class="price-summary">
                            <p><strong>Total:</strong> <span class="price-value">£${total}</span></p>
                            <p><strong>Paid:</strong> <span class="price-paid">£${paid}</span></p>
                            ${remaining > 0 ? `<p class="remaining"><strong>Remaining:</strong> <span class="price-value gold">£${remaining}</span></p>` : ''}
                        </div>
                        
                        ${createStepTimeline(order)}

                        <div class="order-actions">
                            <button class="btn-details" onclick="viewDetails('${order.id}')">
                                View Details & Tracking
                            </button>
                            <button class="btn-invoice" onclick="downloadInvoice('${order.orderNumber}')">
                                <i class="fas fa-download"></i> Invoice
                            </button>
                        </div>
                    </div>
                </article>
            `;
        });
    });
</script>

<style>
/* 1. Base Reset & Typography */
:root {
    --primary-gold: #c19a6b;
    --text-dark: #333;
    --text-light: #6c757d;
    --bg-light: #f4f4f9;
}
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: var(--bg-light);
    color: var(--text-dark);
}

/* 2. Header and Layout */
header {
    background: var(--text-dark);
    color: #fff;
    padding: 15px 20px;
    font-size: 1.2em;
    font-weight: 600;
}
.container {
    max-width: 900px;
    margin: 20px auto;
    padding: 0 15px;
}

/* 3. Order Card */
.order-card {
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border-top: 5px solid var(--primary-gold);
}

/* Order Header */
.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding-bottom: 15px;
    margin-bottom: 15px;
}
.order-info {
    line-height: 1.4;
}
.order-number {
    font-weight: 700;
    font-size: 1.1em;
    color: var(--text-dark);
}
.order-date {
    display: block;
    color: var(--text-light);
    font-size: 0.85em;
    font-weight: 400;
    margin-top: 2px;
}

/* Badges */
.badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.ok { background: #198754; color: #fff; }
.pending { background: #ffc107; color: var(--text-dark); }
.processing { background: #0dcaf0; color: var(--text-dark); }
.cancelled { background: #dc3545; color: #fff; }

/* Order Body */
.order-body {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.item-summary, .price-summary {
    padding: 10px 0;
}

/* Price Summary */
.price-summary {
    display: flex;
    gap: 30px;
    border-top: 1px dashed #eee;
    padding-top: 15px;
    font-size: 0.95em;
}
.price-value {
    font-weight: 600;
    color: var(--text-dark);
}
.price-paid {
    font-weight: 500;
    color: #198754;
}
.remaining .price-value.gold {
    color: var(--primary-gold);
    font-weight: 700;
}

/* 4. Timeline (Better Design) */
.step-timeline {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 15px 10px 5px;
    position: relative;
    margin-top: 10px;
}
.step-timeline::before {
    content: '';
    position: absolute;
    top: 30px;
    left: 10%; 
    right: 10%;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
}
.step-item {
    flex: 1;
    text-align: center;
    z-index: 2;
    position: relative;
}
.step-item .icon {
    font-size: 1.5em; /* Icon size */
    display: flex;
    justify-content: center;
    align-items: center;
    width: 40px;
    height: 40px;
    margin: 0 auto 8px;
    border-radius: 50%;
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}
.step-item .label {
    font-size: 0.85em;
    font-weight: 500;
    color: var(--text-light);
    display: block;
}
.step-item .done {
    color: #fff;
    background: var(--primary-gold);
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 3px rgba(193, 154, 107, 0.5);
}
.step-item .wait {
    color: var(--text-light);
}

/* 5. Action Buttons */
.order-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}
.order-actions button {
    padding: 10px 15px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease, border-color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}
.btn-details {
    background: var(--primary-gold);
    color: white;
    border: 1px solid var(--primary-gold);
    flex-grow: 1;
}
.btn-details:hover {
    background: #a9855f;
    border-color: #a9855f;
}
.btn-invoice {
    background: #f8f9fa;
    color: var(--text-dark);
    border: 1px solid #ced4da;
}
.btn-invoice:hover {
    background: #e9ecef;
}

/* Responsive adjustments */
@media (max-width: 600px) {
    .order-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    .order-header .badge {
        margin-top: 5px;
    }
    .price-summary {
        flex-direction: column;
        gap: 10px;
    }
    .order-actions {
        flex-direction: column;
    }
}
</style>

</body>
</html>

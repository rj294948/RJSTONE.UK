<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Orders | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#eaeded}
header{background:#131921;color:#fff;padding:12px;display:flex;justify-content:space-between}
.container{padding:15px}
.order{background:#fff;border-radius:8px;padding:15px;margin-bottom:15px}
.row{display:flex;justify-content:space-between;flex-wrap:wrap}
.badge{padding:4px 8px;border-radius:4px;font-size:12px}
.ok{background:#198754;color:#fff}
.pending{background:#f0ad4e}
.step{display:flex;gap:10px;margin-top:10px}
.step div{text-align:center;flex:1}
.step span{font-size:26px;display:block}
.done{color:#198754}
.wait{color:#999}
button{margin-top:10px;padding:6px 10px;background:#ffd814;border:1px solid #fcd200;border-radius:4px;cursor:pointer}
small{color:#666}
</style>
</head>

<body>

<header>
  <b>IRYA STONE â€“ My Orders</b>
</header>

<div class="container" id="orders">Loadingâ€¦</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const userId = "dCVM344so3VCKQGNdsHm2aUZrKA3";
const ordersDiv = document.getElementById("orders");

/* ===== REALTIME ORDERS ===== */
const q = query(
  collection(db,"users",userId,"orders"),
  orderBy("createdAt","desc")
);

onSnapshot(q, snap=>{
  ordersDiv.innerHTML="";
  snap.forEach(d=>{
    const o=d.data();

    const paid = Number(o.advancePayment || o.amountToPay || 0);
    const remaining = isNaN(o.remainingPayment) ? 0 : o.remainingPayment;

    const paymentDone = o.paymentStatus==="fully_paid" || remaining===0;
    const shipped = o.shippingStatus==="shipped";
    const delivered = o.status==="delivered";

    ordersDiv.innerHTML += `
    <div class="order">
      <div class="row">
        <div>
          <b>${o.orderNumber}</b><br>
          <small>${o.createdAt}</small>
        </div>
        <span class="badge ${paymentDone?"ok":"pending"}">
          ${paymentDone?"FULL PAID":"ADVANCE PAID"}
        </span>
      </div>

      <p><b>Product:</b> ${o.items[0].stoneName}</p>
      <p><b>Total:</b> Â£${o.total}</p>
      <p><b>Paid:</b> Â£${paid}</p>
      <p><b>Remaining:</b> Â£${remaining}</p>

      <p><b>Payment Method:</b> ${o.paymentMethod.toUpperCase()}</p>
      <p><b>Reference:</b> ${o.bankTransferDetails?.reference || "-"}</p>

      <p><b>Tracking:</b> ${o.trackingNumber || "Not Assigned"}</p>

      <!-- ===== STATUS STEPS ===== -->
      <div class="step">
        <div>
          <span class="${paymentDone?"done":"wait"}">ðŸ’³</span>
          Payment
        </div>
        <div>
          <span class="${shipped?"done":"wait"}">ðŸšš</span>
          Shipped
        </div>
        <div>
          <span class="${delivered?"done":"wait"}">ðŸ“¦</span>
          Delivered
        </div>
      </div>

      <button onclick="invoice('${o.orderNumber}','${o.userName}','${o.total}','${paid}','${remaining}')">
        Download Invoice
      </button>
    </div>
    `;
  });
});

/* ===== INVOICE ===== */
window.invoice=(id,name,total,paid,rem)=>{
  const w=window.open("");
  w.document.write(`
    <h2>IRYA STONE â€“ Invoice</h2>
    <p>Order: ${id}</p>
    <p>Name: ${name}</p>
    <p>Total: Â£${total}</p>
    <p>Paid: Â£${paid}</p>
    <p>Remaining: Â£${rem}</p>
  `);
  w.print();
};
</script>

</body>
</html>

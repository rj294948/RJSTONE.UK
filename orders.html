<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Orders | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ===== AMAZON-INSPIRED THEME ===== */
:root {
  --amazon-blue: #131921;
  --amazon-light-blue: #232f3e;
  --amazon-orange: #ff9900;
  --amazon-yellow: #ffd814;
  --amazon-gray: #eaeded;
  --text-dark: #0f1111;
  --text-light: #fff;
  --success: #007600;
  --warning: #ffa41c;
  --pending: #ffa500;
  --processing: #007185;
  --shipped: #b12704;
  --delivered: #007600;
  --cancelled: #d50000;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

body {
  background: var(--amazon-gray);
  color: var(--text-dark);
  line-height: 1.5;
}

/* ===== HEADER ===== */
.header {
  background: var(--amazon-blue);
  color: var(--text-light);
  padding: 12px 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.header-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 20px;
  font-weight: 600;
  text-decoration: none;
  color: var(--text-light);
}

.logo i {
  color: var(--amazon-orange);
}

.notification-btn {
  position: relative;
  background: none;
  border: none;
  color: var(--text-light);
  font-size: 18px;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: background 0.2s;
}

.notification-btn:hover {
  background: rgba(255,255,255,0.1);
}

.notification-badge {
  position: absolute;
  top: -2px;
  right: -2px;
  background: var(--amazon-orange);
  color: var(--text-dark);
  font-size: 10px;
  font-weight: bold;
  min-width: 16px;
  height: 16px;
  border-radius: 50%;
  display: none;
  align-items: center;
  justify-content: center;
}

/* ===== MAIN CONTAINER ===== */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px 16px;
}

/* ===== ORDERS GRID ===== */
.orders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

@media (max-width: 768px) {
  .orders-grid {
    grid-template-columns: 1fr;
  }
}

/* ===== ORDER CARD ===== */
.order-card {
  background: var(--text-light);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
  border: 1px solid #ddd;
}

.order-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.order-header {
  padding: 16px;
  background: linear-gradient(to right, #f7f7f7, #fff);
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.order-info h3 {
  font-size: 16px;
  color: var(--text-dark);
  margin-bottom: 4px;
  font-weight: 600;
}

.order-date {
  font-size: 12px;
  color: #666;
}

.order-status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-pending { background: #fff8e1; color: var(--pending); }
.status-processing { background: #e3f2fd; color: var(--processing); }
.status-shipped { background: #f3e5f5; color: var(--shipped); }
.status-delivered { background: #e8f5e8; color: var(--delivered); }
.status-cancelled { background: #ffebee; color: var(--cancelled); }

.order-body {
  padding: 16px;
}

.order-item {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid #eee;
}

.item-image {
  width: 80px;
  height: 80px;
  border-radius: 6px;
  overflow: hidden;
  background: #f5f5f5;
  flex-shrink: 0;
}

.item-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.item-details {
  flex: 1;
}

.item-name {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 4px;
  color: var(--text-dark);
}

.item-meta {
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
}

.item-price {
  font-weight: 600;
  color: var(--text-dark);
  font-size: 14px;
}

/* ===== ORDER SUMMARY ===== */
.order-summary {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 16px;
}

.summary-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.summary-label {
  font-size: 12px;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.summary-value {
  font-weight: 600;
  font-size: 14px;
  color: var(--text-dark);
}

.summary-value.paid { color: var(--delivered); }
.summary-value.remaining { color: var(--pending); }
.summary-value.total { color: var(--amazon-blue); }

/* ===== TRACKING PROGRESS ===== */
.tracking-progress {
  margin: 20px 0;
}

.progress-steps {
  display: flex;
  justify-content: space-between;
  position: relative;
  padding: 0 10px;
}

.progress-steps::before {
  content: '';
  position: absolute;
  top: 12px;
  left: 10%;
  right: 10%;
  height: 2px;
  background: #e0e0e0;
  z-index: 1;
}

.progress-bar {
  position: absolute;
  top: 12px;
  left: 10%;
  height: 2px;
  background: var(--amazon-orange);
  z-index: 2;
  transition: width 0.3s;
}

.step {
  position: relative;
  z-index: 3;
  text-align: center;
  flex: 1;
}

.step-icon {
  width: 26px;
  height: 26px;
  background: #fff;
  border: 2px solid #e0e0e0;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 8px;
  font-size: 12px;
  color: #666;
  transition: all 0.3s;
}

.step.active .step-icon {
  background: var(--amazon-orange);
  border-color: var(--amazon-orange);
  color: var(--text-light);
}

.step.completed .step-icon {
  background: var(--delivered);
  border-color: var(--delivered);
  color: var(--text-light);
}

.step-label {
  font-size: 11px;
  color: #666;
  font-weight: 500;
  text-transform: uppercase;
}

.step.active .step-label {
  color: var(--amazon-orange);
  font-weight: 600;
}

.step.completed .step-label {
  color: var(--delivered);
  font-weight: 600;
}

/* ===== ORDER ACTIONS ===== */
.order-actions {
  display: flex;
  gap: 10px;
  padding: 16px;
  border-top: 1px solid #eee;
  background: #fafafa;
}

.btn {
  flex: 1;
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
}

.btn-primary {
  background: var(--amazon-yellow);
  color: var(--text-dark);
  border: 1px solid #fcd200;
}

.btn-primary:hover {
  background: #f7ca00;
  border-color: #f2a900;
}

.btn-secondary {
  background: #fff;
  color: var(--text-dark);
  border: 1px solid #d5d9d9;
}

.btn-secondary:hover {
  background: #f7f7f7;
  border-color: #b2b5b5;
}

.btn-outline {
  background: transparent;
  color: var(--amazon-blue);
  border: 1px solid var(--amazon-blue);
}

.btn-outline:hover {
  background: rgba(19, 25, 33, 0.05);
}

/* ===== NOTIFICATIONS PANEL ===== */
.notifications-panel {
  display: none;
  position: fixed;
  top: 60px;
  right: 20px;
  width: 350px;
  max-height: 500px;
  background: var(--text-light);
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 1000;
  border: 1px solid #ddd;
  overflow: hidden;
}

.notifications-header {
  padding: 16px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fafafa;
}

.notifications-header h3 {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-dark);
}

.notifications-actions {
  display: flex;
  gap: 8px;
}

.notifications-actions button {
  background: none;
  border: none;
  color: var(--amazon-blue);
  font-size: 12px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
}

.notifications-actions button:hover {
  background: rgba(19, 25, 33, 0.1);
}

.notifications-list {
  max-height: 400px;
  overflow-y: auto;
}

.notification-item {
  padding: 14px 16px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background 0.2s;
}

.notification-item:hover {
  background: #f9f9f9;
}

.notification-item.unread {
  background: rgba(255, 153, 0, 0.05);
  border-left: 3px solid var(--amazon-orange);
}

.notification-title {
  font-weight: 600;
  font-size: 14px;
  color: var(--text-dark);
  margin-bottom: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notification-message {
  font-size: 13px;
  color: #666;
  line-height: 1.4;
  margin-bottom: 6px;
}

.notification-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 11px;
  color: #999;
}

.notification-type {
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
}

.type-order { background: #e8f4ff; color: var(--processing); }
.type-payment { background: #e8f8e8; color: var(--delivered); }
.type-shipping { background: #f0e8ff; color: var(--shipped); }

/* ===== LOADING STATE ===== */
.loading {
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(0,0,0,0.1);
  border-top-color: var(--amazon-orange);
  border-radius: 50%;
  animation: spin 1s ease-in-out infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ===== EMPTY STATE ===== */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  background: var(--text-light);
  border-radius: 8px;
  border: 1px solid #ddd;
  grid-column: 1 / -1;
}

.empty-state i {
  font-size: 48px;
  color: #ccc;
  margin-bottom: 20px;
}

.empty-state h3 {
  color: #666;
  margin-bottom: 10px;
  font-weight: 600;
}

/* ===== MODAL ===== */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1001;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-content {
  background: var(--text-light);
  border-radius: 8px;
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.modal-header {
  padding: 20px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fafafa;
}

.modal-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-dark);
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: #666;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.modal-close:hover {
  background: rgba(0,0,0,0.1);
}

.modal-body {
  padding: 20px;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 480px) {
  .container {
    padding: 16px 12px;
  }
  
  .order-summary {
    grid-template-columns: 1fr;
  }
  
  .order-actions {
    flex-direction: column;
  }
  
  .notifications-panel {
    width: calc(100% - 40px);
    right: 10px;
    left: 10px;
  }
}
</style>
</head>

<body>

<!-- Header -->
<header class="header">
  <div class="header-container">
    <a href="index.html" class="logo">
      <i class="fas fa-gem"></i>
      <span>IRYA STONE</span>
    </a>
    
    <button class="notification-btn" onclick="toggleNotifications()">
      <i class="fas fa-bell"></i>
      <span class="notification-badge" id="notificationBadge">0</span>
    </button>
  </div>
</header>

<!-- Main Container -->
<main class="container">
  <h1 style="font-size: 24px; margin-bottom: 10px; color: var(--text-dark);">My Orders</h1>
  <p style="color: #666; margin-bottom: 20px;">Track and manage all your orders</p>
  
  <div class="orders-grid" id="orders">
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Loading your orders...</p>
    </div>
  </div>
</main>

<!-- Notifications Panel -->
<div class="notifications-panel" id="notificationsPanel">
  <div class="notifications-header">
    <h3><i class="fas fa-bell"></i> Notifications</h3>
    <div class="notifications-actions">
      <button onclick="markAllAsRead()">Mark all read</button>
      <button onclick="clearNotifications()">Clear all</button>
    </div>
  </div>
  <div class="notifications-list" id="notificationsList">
    <!-- Notifications will be loaded here -->
  </div>
</div>

<!-- Order Details Modal -->
<div class="modal" id="orderModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Order Details</h3>
      <button class="modal-close" onclick="closeModal()">×</button>
    </div>
    <div class="modal-body" id="orderDetails">
      <!-- Order details will be loaded here -->
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  query, 
  orderBy, 
  onSnapshot,
  getDocs,
  updateDoc,
  doc,
  deleteDoc,
  where,
  limit
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5",
  measurementId: "G-6YM1FLYN48"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Global variables
let userId = null;
let orders = [];
let notifications = [];
let ordersUnsubscribe = null;
let notificationsUnsubscribe = null;

// ============================================
// USER ID MANAGEMENT
// ============================================

async function getUserId() {
  try {
    // First check for saved user ID
    const savedUserId = localStorage.getItem('irya_user_id');
    if (savedUserId) {
      userId = savedUserId;
      return userId;
    }

    // Check if user is logged in via Firebase
    // (You would implement proper auth here)
    const authUser = null; // Replace with actual auth user
    
    if (authUser) {
      userId = authUser.uid;
    } else {
      // Create or get guest user ID
      let guestId = localStorage.getItem('irya_guest_id');
      if (!guestId) {
        guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('irya_guest_id', guestId);
      }
      userId = guestId;
    }
    
    localStorage.setItem('irya_user_id', userId);
    return userId;
    
  } catch (error) {
    console.error("Error getting user ID:", error);
    return 'guest_' + Date.now();
  }
}

// ============================================
// ORDERS MANAGEMENT - REAL-TIME
// ============================================

async function loadOrders() {
  try {
    const ordersDiv = document.getElementById("orders");
    
    // Get user ID
    userId = await getUserId();
    console.log("Loading orders for user:", userId);
    
    // Setup real-time listener for orders
    setupOrdersListener();
    
  } catch (error) {
    console.error("Error loading orders:", error);
    showEmptyState("Failed to load orders. Please try again.");
  }
}

function setupOrdersListener() {
  const ordersDiv = document.getElementById("orders");
  
  // Clean up previous listener
  if (ordersUnsubscribe) ordersUnsubscribe();
  
  // Try to get from user's orders collection
  let ordersQuery;
  
  try {
    const userOrdersRef = collection(db, "users", userId, "orders");
    ordersQuery = query(userOrdersRef, orderBy("createdAt", "desc"));
  } catch (error) {
    console.log("Trying main orders collection...");
    // Try main orders collection with user filter
    const ordersRef = collection(db, "orders");
    ordersQuery = query(
      ordersRef, 
      where("userId", "==", userId),
      orderBy("createdAt", "desc")
    );
  }
  
  ordersUnsubscribe = onSnapshot(ordersQuery, 
    (snapshot) => {
      orders = [];
      
      if (snapshot.empty) {
        showEmptyState("You haven't placed any orders yet.");
        return;
      }
      
      snapshot.forEach((doc) => {
        const orderData = doc.data();
        orderData.id = doc.id;
        orders.push(orderData);
      });
      
      displayOrders(orders);
      
    }, 
    (error) => {
      console.error("Error in orders listener:", error);
      ordersDiv.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Connection Error</h3>
          <p>Please check your internet connection</p>
          <button class="btn btn-primary" onclick="loadOrders()" style="margin-top: 20px;">
            <i class="fas fa-redo"></i> Retry
          </button>
        </div>
      `;
    }
  );
}

function displayOrders(ordersList) {
  const ordersDiv = document.getElementById("orders");
  
  if (!ordersList || ordersList.length === 0) {
    showEmptyState("You haven't placed any orders yet.");
    return;
  }
  
  let ordersHTML = '';
  
  ordersList.forEach((order) => {
    // Format date
    const orderDate = formatDate(order.createdAt);
    
    // Payment status
    const isFullPaid = order.paymentStatus === 'fully_paid' || 
                      (order.advancePayment && order.advancePayment >= order.total) ||
                      (order.submittedAmount && order.submittedAmount >= order.total);
    
    // Shipping status
    const shippingStatus = order.shippingStatus || order.status || 'pending';
    const statusClass = getStatusClass(shippingStatus);
    const statusText = getStatusText(shippingStatus);
    
    // Calculate payments
    const paidAmount = order.submittedAmount || order.advancePayment || 0;
    const remainingAmount = isFullPaid ? 0 : (order.remainingPayment || order.total - paidAmount);
    
    // Get first item for preview
    let itemName = 'Multiple Items';
    let itemImage = 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?w=200';
    
    if (order.items && order.items.length > 0) {
      const firstItem = order.items[0];
      itemName = firstItem.name || firstItem.stoneName || 'Product';
      if (firstItem.image) itemImage = firstItem.image;
    }
    
    // Progress calculation
    const progressWidth = calculateProgressWidth(order);
    
    ordersHTML += `
      <div class="order-card">
        <div class="order-header">
          <div class="order-info">
            <h3>${order.orderNumber || 'Order #' + order.id.substring(0, 8)}</h3>
            <div class="order-date">Placed on ${orderDate}</div>
          </div>
          <div class="order-status ${statusClass}">
            <i class="fas ${getStatusIcon(shippingStatus)}"></i>
            ${statusText}
          </div>
        </div>
        
        <div class="order-body">
          <div class="order-item">
            <div class="item-image">
              <img src="${itemImage}" alt="${itemName}" onerror="this.src='https://images.unsplash.com/photo-1544931170-3ca1337cce88?w=200'">
            </div>
            <div class="item-details">
              <div class="item-name">${itemName}</div>
              <div class="item-meta">
                ${order.items ? order.items.length : 1} item${order.items && order.items.length !== 1 ? 's' : ''} 
                • ${order.paymentMethod === 'bank' ? 'Bank Transfer' : 'Card Payment'}
              </div>
              <div class="item-price">£${order.total?.toFixed(2) || '0.00'}</div>
            </div>
          </div>
          
          <div class="order-summary">
            <div class="summary-item">
              <span class="summary-label">Total</span>
              <span class="summary-value total">£${order.total?.toFixed(2) || '0.00'}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Paid</span>
              <span class="summary-value paid">£${paidAmount.toFixed(2)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Remaining</span>
              <span class="summary-value remaining">£${remainingAmount.toFixed(2)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Payment</span>
              <span class="summary-value ${isFullPaid ? 'paid' : 'remaining'}">
                ${isFullPaid ? 'Paid' : 'Advance'}
              </span>
            </div>
          </div>
          
          <div class="tracking-progress">
            <div class="progress-steps">
              <div class="progress-bar" style="width: ${progressWidth}%"></div>
              ${createProgressSteps(order)}
            </div>
          </div>
        </div>
        
        <div class="order-actions">
          <button class="btn btn-primary" onclick="viewOrderDetails('${order.id}')">
            <i class="fas fa-eye"></i> View Details
          </button>
          <button class="btn btn-secondary" onclick="downloadInvoice('${order.id}')">
            <i class="fas fa-file-invoice"></i> Invoice
          </button>
          ${order.trackingNumber ? `
            <button class="btn btn-outline" onclick="trackOrder('${order.trackingNumber}')">
              <i class="fas fa-truck"></i> Track
            </button>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  ordersDiv.innerHTML = ordersHTML;
}

function createProgressSteps(order) {
  const steps = [
    { key: 'payment', icon: 'fa-credit-card', label: 'Payment', status: order.paymentStatus },
    { key: 'processing', icon: 'fa-cog', label: 'Processing', status: order.status },
    { key: 'shipped', icon: 'fa-shipping-fast', label: 'Shipped', status: order.shippingStatus },
    { key: 'delivered', icon: 'fa-check-circle', label: 'Delivered', status: order.status }
  ];
  
  let completedSteps = 0;
  
  // Calculate completed steps
  if (order.paymentStatus === 'fully_paid' || order.paymentStatus === 'payment_verified') completedSteps++;
  if (order.status === 'processing' || order.status === 'shipped' || order.status === 'delivered') completedSteps++;
  if (order.shippingStatus === 'shipped' || order.status === 'shipped' || order.status === 'delivered') completedSteps++;
  if (order.status === 'delivered') completedSteps++;
  
  return steps.map((step, index) => {
    let stepClass = '';
    if (index < completedSteps) stepClass = 'completed';
    else if (index === completedSteps) stepClass = 'active';
    
    return `
      <div class="step ${stepClass}">
        <div class="step-icon">
          <i class="fas ${step.icon}"></i>
        </div>
        <div class="step-label">${step.label}</div>
      </div>
    `;
  }).join('');
}

function calculateProgressWidth(order) {
  let progress = 0;
  
  if (order.paymentStatus === 'fully_paid' || order.paymentStatus === 'payment_verified') progress = 25;
  if (order.status === 'processing') progress = 50;
  if (order.shippingStatus === 'shipped' || order.status === 'shipped') progress = 75;
  if (order.status === 'delivered') progress = 100;
  
  return progress;
}

// ============================================
// NOTIFICATIONS - REAL-TIME
// ============================================

async function loadNotifications() {
  try {
    userId = await getUserId();
    setupNotificationsListener();
  } catch (error) {
    console.error("Error loading notifications:", error);
  }
}

function setupNotificationsListener() {
  const notificationList = document.getElementById("notificationsList");
  
  // Clean up previous listener
  if (notificationsUnsubscribe) notificationsUnsubscribe();
  
  try {
    const notificationsRef = collection(db, "users", userId, "notifications");
    const notificationsQuery = query(notificationsRef, orderBy("createdAt", "desc"), limit(50));
    
    notificationsUnsubscribe = onSnapshot(notificationsQuery,
      (snapshot) => {
        notifications = [];
        notificationList.innerHTML = '';
        
        if (snapshot.empty) {
          notificationList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-bell-slash" style="font-size: 36px; margin-bottom: 15px;"></i>
              <p>No notifications yet</p>
            </div>
          `;
          updateNotificationBadge();
          return;
        }
        
        snapshot.forEach((doc) => {
          const note = doc.data();
          note.id = doc.id;
          notifications.push(note);
          
          // Add to UI
          const noteElement = createNotificationElement(note);
          notificationList.appendChild(noteElement);
        });
        
        updateNotificationBadge();
        
      },
      (error) => {
        console.error("Error in notifications listener:", error);
        notificationList.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #666;">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Failed to load notifications</p>
          </div>
        `;
      }
    );
    
  } catch (error) {
    console.error("Error setting up notifications listener:", error);
  }
}

function createNotificationElement(note) {
  const div = document.createElement('div');
  div.className = `notification-item ${note.read ? '' : 'unread'}`;
  div.onclick = () => viewNotification(note.id, note.orderId);
  
  const timeAgo = getTimeAgo(note.createdAt);
  const typeClass = `notification-type type-${note.type || 'order'}`;
  
  div.innerHTML = `
    <div class="notification-title">
      <span>${note.title || 'Notification'}</span>
      <span class="${typeClass}">${(note.type || 'order').toUpperCase()}</span>
    </div>
    <div class="notification-message">${note.message || ''}</div>
    <div class="notification-meta">
      <span>${timeAgo}</span>
      ${note.read ? '' : '<span style="color: #ff9900; font-size: 10px;"><i class="fas fa-circle"></i></span>'}
    </div>
  `;
  
  return div;
}

async function viewNotification(notificationId, orderId) {
  try {
    // Mark as read
    const notificationRef = doc(db, "users", userId, "notifications", notificationId);
    await updateDoc(notificationRef, {
      read: true,
      readAt: new Date().toISOString()
    });
    
    // Update UI
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
      notification.read = true;
      updateNotificationBadge();
    }
    
    // If notification has orderId, open order details
    if (orderId) {
      closeNotifications();
      setTimeout(() => {
        viewOrderDetails(orderId);
      }, 300);
    }
    
  } catch (error) {
    console.error("Error viewing notification:", error);
  }
}

async function markAllAsRead() {
  try {
    const batchPromises = notifications
      .filter(n => !n.read)
      .map(async (note) => {
        const noteRef = doc(db, "users", userId, "notifications", note.id);
        await updateDoc(noteRef, {
          read: true,
          readAt: new Date().toISOString()
        });
      });
    
    await Promise.all(batchPromises);
    
    // Update UI
    notifications.forEach(n => n.read = true);
    updateNotificationBadge();
    
    document.querySelectorAll('.notification-item.unread').forEach(item => {
      item.classList.remove('unread');
    });
    
  } catch (error) {
    console.error("Error marking all as read:", error);
    alert("Failed to mark all notifications as read");
  }
}

async function clearNotifications() {
  try {
    if (confirm("Are you sure you want to clear all notifications?")) {
      const batchPromises = notifications.map(async (note) => {
        const noteRef = doc(db, "users", userId, "notifications", note.id);
        await deleteDoc(noteRef);
      });
      
      await Promise.all(batchPromises);
      
      notifications = [];
      updateNotificationBadge();
      document.getElementById("notificationsList").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #666;">
          <i class="fas fa-check-circle" style="font-size: 36px; margin-bottom: 15px;"></i>
          <p>All notifications cleared</p>
        </div>
      `;
    }
  } catch (error) {
    console.error("Error clearing notifications:", error);
    alert("Failed to clear notifications");
  }
}

function updateNotificationBadge() {
  const unreadCount = notifications.filter(n => !n.read).length;
  const badge = document.getElementById("notificationBadge");
  
  if (unreadCount > 0) {
    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

// ============================================
// ORDER DETAILS MODAL
// ============================================

async function viewOrderDetails(orderId) {
  try {
    const modal = document.getElementById("orderModal");
    const detailsDiv = document.getElementById("orderDetails");
    
    detailsDiv.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading-spinner"></div>
        <p>Loading order details...</p>
      </div>
    `;
    
    modal.style.display = "flex";
    
    // Find order in local data first
    const order = orders.find(o => o.id === orderId);
    
    if (order) {
      displayOrderDetails(order);
    } else {
      // Fetch from Firebase
      await fetchOrderDetails(orderId);
    }
    
  } catch (error) {
    console.error("Error viewing order:", error);
    document.getElementById("orderDetails").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ffc107; margin-bottom: 20px;"></i>
        <h3>Error Loading Order</h3>
        <p>${error.message}</p>
      </div>
    `;
  }
}

function displayOrderDetails(order) {
  const detailsDiv = document.getElementById("orderDetails");
  
  const orderDate = formatDate(order.createdAt);
  const isFullPaid = order.paymentStatus === 'fully_paid';
  
  let itemsHTML = '';
  if (order.items && order.items.length > 0) {
    itemsHTML = order.items.map(item => `
      <div style="display: flex; gap: 15px; padding: 12px; background: #f9f9f9; border-radius: 6px; margin-bottom: 10px;">
        <img src="${item.image || 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?w=100'}" 
             alt="${item.name}" 
             style="width: 60px; height: 60px; border-radius: 6px; object-fit: cover;"
             onerror="this.src='https://images.unsplash.com/photo-1544931170-3ca1337cce88?w=100'">
        <div style="flex: 1;">
          <div style="font-weight: bold; margin-bottom: 5px;">${item.name}</div>
          <div style="font-size: 13px; color: #666;">
            Quantity: ${item.quantity || 1} × £${item.price?.toFixed(2) || '0.00'}
          </div>
          ${item.customRequirements ? `
            <div style="font-size: 12px; color: #ff9900; margin-top: 5px;">
              <i class="fas fa-edit"></i> Custom: ${item.customRequirements}
            </div>
          ` : ''}
        </div>
        <div style="font-weight: bold; color: #131921;">
          £${item.calculatedPrice?.toFixed(2) || item.totalPrice?.toFixed(2) || '0.00'}
        </div>
      </div>
    `).join('');
  }
  
  let bankDetailsHTML = '';
  if (order.bankTransferDetails) {
    bankDetailsHTML = `
      <div style="background: #e8f4ff; padding: 15px; border-radius: 6px; margin: 20px 0;">
        <h4 style="margin-bottom: 10px; color: #0066c0;">
          <i class="fas fa-university"></i> Bank Transfer Details
        </h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div><strong>Reference:</strong> ${order.bankTransferDetails.reference}</div>
          <div><strong>Amount:</strong> £${order.bankTransferDetails.amount?.toFixed(2) || '0.00'}</div>
          ${order.bankTransferDetails.accountNumber ? `
            <div><strong>Account:</strong> ${order.bankTransferDetails.accountNumber}</div>
          ` : ''}
          ${order.bankTransferDetails.sortCode ? `
            <div><strong>Sort Code:</strong> ${order.bankTransferDetails.sortCode}</div>
          ` : ''}
        </div>
      </div>
    `;
  }
  
  detailsDiv.innerHTML = `
    <h3 style="color: #131921; margin-bottom: 20px;">${order.orderNumber}</h3>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
      <div style="background: #f9f9f9; padding: 15px; border-radius: 6px;">
        <h4 style="margin-bottom: 10px; color: #666;">Order Information</h4>
        <p><strong>Order Date:</strong> ${orderDate}</p>
        <p><strong>Status:</strong> ${getStatusText(order.shippingStatus || order.status)}</p>
        <p><strong>Payment Method:</strong> ${order.paymentMethod === 'bank' ? 'Bank Transfer' : 'Card'}</p>
        <p><strong>Payment Type:</strong> ${order.paymentType === 'advance' ? '30% Advance' : 'Full Payment'}</p>
        ${order.trackingNumber ? `<p><strong>Tracking:</strong> ${order.trackingNumber}</p>` : ''}
      </div>
      
      <div style="background: #f9f9f9; padding: 15px; border-radius: 6px;">
        <h4 style="margin-bottom: 10px; color: #666;">Payment Summary</h4>
        <p><strong>Total Amount:</strong> £${order.total?.toFixed(2) || '0.00'}</p>
        <p><strong>Paid Amount:</strong> £${order.submittedAmount?.toFixed(2) || order.advancePayment?.toFixed(2) || '0.00'}</p>
        <p><strong>Remaining:</strong> £${order.remainingPayment?.toFixed(2) || '0.00'}</p>
        <p><strong>Payment Status:</strong> ${getPaymentStatusText(order.paymentStatus)}</p>
      </div>
    </div>
    
    ${bankDetailsHTML}
    
    <div style="margin: 20px 0;">
      <h4 style="margin-bottom: 10px; color: #666;">Order Items</h4>
      ${itemsHTML || '<p>No items found</p>'}
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 30px;">
      <button class="btn btn-primary" onclick="downloadInvoice('${order.id}')" style="flex: 1;">
        <i class="fas fa-file-pdf"></i> Download Invoice
      </button>
      <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
        <i class="fas fa-times"></i> Close
      </button>
    </div>
  `;
}

async function fetchOrderDetails(orderId) {
  // Implement Firebase fetch if needed
  // This is a placeholder - implement based on your data structure
  console.log("Fetching order details from Firebase:", orderId);
}

function closeModal() {
  document.getElementById("orderModal").style.display = "none";
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  } catch (error) {
    return dateString;
  }
}

function getTimeAgo(dateString) {
  if (!dateString) return 'Just now';
  
  try {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short'
    });
  } catch (error) {
    return dateString;
  }
}

function getStatusClass(status) {
  if (!status) return 'status-pending';
  
  const statusLower = status.toLowerCase();
  if (statusLower.includes('processing') || statusLower.includes('payment_verified')) return 'status-processing';
  if (statusLower.includes('shipped')) return 'status-shipped';
  if (statusLower.includes('delivered')) return 'status-delivered';
  if (statusLower.includes('cancelled')) return 'status-cancelled';
  return 'status-pending';
}

function getStatusText(status) {
  if (!status) return 'Pending';
  
  const statusMap = {
    'pending': 'Pending',
    'processing': 'Processing',
    'shipped': 'Shipped',
    'delivered': 'Delivered',
    'cancelled': 'Cancelled',
    'payment_verified': 'Payment Verified',
    'pending_bank_transfer': 'Awaiting Payment'
  };
  
  return statusMap[status.toLowerCase()] || status;
}

function getStatusIcon(status) {
  if (!status) return 'fa-clock';
  
  const statusLower = status.toLowerCase();
  if (statusLower.includes('processing') || statusLower.includes('payment_verified')) return 'fa-cog';
  if (statusLower.includes('shipped')) return 'fa-shipping-fast';
  if (statusLower.includes('delivered')) return 'fa-check-circle';
  if (statusLower.includes('cancelled')) return 'fa-times-circle';
  return 'fa-clock';
}

function getPaymentStatusText(paymentStatus) {
  if (!paymentStatus) return 'Pending';
  
  const statusMap = {
    'pending': 'Pending',
    'pending_bank_transfer': 'Awaiting Payment',
    'payment_verified': 'Payment Verified',
    'fully_paid': 'Fully Paid',
    'advance_paid': 'Advance Paid',
    'paid': 'Paid'
  };
  
  return statusMap[paymentStatus] || paymentStatus;
}

function showEmptyState(message) {
  const ordersDiv = document.getElementById("orders");
  ordersDiv.innerHTML = `
    <div class="empty-state">
      <i class="fas fa-box-open"></i>
      <h3>${message}</h3>
      <p>Start shopping to see your orders here</p>
      <button class="btn btn-primary" onclick="window.location.href='products.html'" style="margin-top: 20px;">
        <i class="fas fa-shopping-bag"></i> Shop Now
      </button>
    </div>
  `;
}

// ============================================
// UI FUNCTIONS
// ============================================

window.toggleNotifications = function() {
  const panel = document.getElementById("notificationsPanel");
  if (panel.style.display === "block") {
    panel.style.display = "none";
  } else {
    panel.style.display = "block";
    // Load notifications if not already loaded
    if (notifications.length === 0) {
      loadNotifications();
    }
  }
};

function closeNotifications() {
  document.getElementById("notificationsPanel").style.display = "none";
}

window.downloadInvoice = async function(orderId) {
  try {
    const order = orders.find(o => o.id === orderId);
    if (!order) {
      alert("Order not found");
      return;
    }
    
    const win = window.open("", "_blank");
    win.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Invoice - ${order.orderNumber}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
          .invoice-header { text-align: center; margin-bottom: 30px; }
          .company { font-size: 24px; font-weight: bold; color: #131921; }
          .invoice-details { margin: 20px 0; }
          .table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          .table th, .table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
          .table th { background: #f8f9fa; }
          .total-row { font-weight: bold; background: #f8f9fa; }
          .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd; }
        </style>
      </head>
      <body>
        <div class="invoice-header">
          <div class="company">IRYA STONE</div>
          <div>INVOICE</div>
        </div>
        
        <div class="invoice-details">
          <div><strong>Invoice Number:</strong> ${order.orderNumber}</div>
          <div><strong>Invoice Date:</strong> ${formatDate(order.createdAt)}</div>
          <div><strong>Customer:</strong> ${order.userName || 'Customer'}</div>
          ${order.shippingAddress ? `<div><strong>Address:</strong> ${order.shippingAddress.address1}, ${order.shippingAddress.city}</div>` : ''}
        </div>
        
        <table class="table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${order.items ? order.items.map(item => `
              <tr>
                <td>${item.name}</td>
                <td>${item.quantity || 1}</td>
                <td>£${item.price?.toFixed(2) || '0.00'}</td>
                <td>£${item.calculatedPrice?.toFixed(2) || item.totalPrice?.toFixed(2) || '0.00'}</td>
              </tr>
            `).join('') : ''}
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Subtotal:</td>
              <td>£${order.subtotal?.toFixed(2) || '0.00'}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Shipping:</td>
              <td>£${order.shipping?.toFixed(2) || '0.00'}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Tax:</td>
              <td>£${order.tax?.toFixed(2) || '0.00'}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Grand Total:</td>
              <td>£${order.total?.toFixed(2) || '0.00'}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Amount Paid:</td>
              <td>£${order.submittedAmount?.toFixed(2) || order.advancePayment?.toFixed(2) || '0.00'}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Balance Due:</td>
              <td>£${order.remainingPayment?.toFixed(2) || '0.00'}</td>
            </tr>
          </tbody>
        </table>
        
        <div class="footer">
          <p><strong>Payment Status:</strong> ${getPaymentStatusText(order.paymentStatus)}</p>
          ${order.bankTransferDetails ? `
            <p><strong>Bank Reference:</strong> ${order.bankTransferDetails.reference}</p>
          ` : ''}
          <p>Thank you for your business!</p>
        </div>
      </body>
      </html>
    `);
    
    win.document.close();
    
    setTimeout(() => {
      win.print();
    }, 500);
    
  } catch (error) {
    console.error("Error downloading invoice:", error);
    alert("Failed to generate invoice: " + error.message);
  }
};

window.trackOrder = function(trackingNumber) {
  // Implement tracking functionality
  alert("Tracking number: " + trackingNumber + "\nTracking will open in a new window.");
  // window.open(`https://tracking-url.com/${trackingNumber}`, '_blank');
};

// ============================================
// INITIALIZATION
// ============================================

// Initialize when page loads
document.addEventListener('DOMContentLoaded', async function() {
  try {
    // Get user ID first
    await getUserId();
    
    // Load orders
    await loadOrders();
    
    // Load notifications
    await loadNotifications();
    
    // Setup periodic refresh (every 2 minutes)
    setInterval(() => {
      console.log("Auto-refreshing data...");
      // Listeners will automatically update
    }, 2 * 60 * 1000);
    
  } catch (error) {
    console.error("Error initializing:", error);
  }
});

// Clean up listeners when page unloads
window.addEventListener('beforeunload', () => {
  if (ordersUnsubscribe) ordersUnsubscribe();
  if (notificationsUnsubscribe) notificationsUnsubscribe();
});

// Close notifications when clicking outside
document.addEventListener('click', function(event) {
  const panel = document.getElementById("notificationsPanel");
  const btn = document.querySelector('.notification-btn');
  
  if (panel && btn && !panel.contains(event.target) && !btn.contains(event.target)) {
    panel.style.display = "none";
  }
  
  // Close modal when clicking outside
  const modal = document.getElementById("orderModal");
  if (modal && modal.style.display === "flex" && !event.target.closest('.modal-content')) {
    closeModal();
  }
});

</script>

</body>
</html>

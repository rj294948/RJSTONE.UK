<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Notifications | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
    --primary-gold: #c9a227;
    --bg-light: #f7f9fc;
    --white: #ffffff;
    --text-dark: #222222;
    --text-light: #666666;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding: 20px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--primary-gold);
}

.header h1 {
    color: var(--primary-gold);
    display: flex;
    align-items: center;
    gap: 10px;
}

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--white);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    background: var(--primary-gold);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-info h3 {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 5px;
}

.stat-info .count {
    font-size: 24px;
    font-weight: bold;
    color: var(--text-dark);
}

.notifications-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.notification-card {
    background: var(--white);
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid var(--primary-gold);
    transition: transform 0.3s ease;
}

.notification-card:hover {
    transform: translateY(-5px);
}

.notification-card.unread {
    border-left-color: #ff4757;
    background: #fff5f5;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
}

.notification-title {
    font-weight: 600;
    color: var(--text-dark);
    flex: 1;
}

.notification-time {
    font-size: 12px;
    color: var(--text-light);
}

.notification-message {
    color: var(--text-light);
    font-size: 14px;
    margin-bottom: 15px;
    line-height: 1.5;
}

.notification-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.action-btn {
    padding: 8px 15px;
    border-radius: 5px;
    border: none;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

.action-btn.view {
    background: var(--primary-gold);
    color: white;
}

.action-btn.mark-read {
    background: #f1f2f6;
    color: var(--text-dark);
}

.action-btn.clear {
    background: #ff4757;
    color: white;
}

.empty-state {
    text-align: center;
    padding: 50px 20px;
    grid-column: 1 / -1;
}

.empty-state i {
    font-size: 48px;
    color: var(--text-light);
    opacity: 0.5;
    margin-bottom: 20px;
}

.loading {
    text-align: center;
    padding: 50px;
    grid-column: 1 / -1;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-gold);
    animation: spin 1s ease-in-out infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1><i class="fas fa-bell"></i> Admin Notifications</h1>
        <button onclick="markAllAsRead()" class="action-btn mark-read">
            <i class="fas fa-check-double"></i> Mark All as Read
        </button>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div class="stat-info">
                <h3>Total Notifications</h3>
                <div class="count" id="totalCount">0</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #ff4757;">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="stat-info">
                <h3>Unread</h3>
                <div class="count" id="unreadCount">0</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #2ed573;">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h3>Action Required</h3>
                <div class="count" id="actionCount">0</div>
            </div>
        </div>
    </div>
    
    <div class="notifications-grid" id="notificationsGrid">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading notifications...</p>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5",
    measurementId: "G-6YM1FLYN48"
};

let firebaseApp, firebaseDB, firebaseAuth;
let currentUser = null;

document.addEventListener('DOMContentLoaded', async function() {
    // Initialize Firebase
    await initializeFirebase();
    
    // Check if user is admin
    await checkAdminStatus();
    
    // Load notifications
    loadNotifications();
});

async function initializeFirebase() {
    try {
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
        } else {
            firebaseApp = firebase.app();
        }
        
        firebaseDB = firebase.firestore();
        firebaseAuth = firebase.auth();
        
        // Listen for auth state
        firebaseAuth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
            } else {
                // Not logged in, redirect to login
                window.location.href = 'sign.html?redirect=admin-notifications.html';
            }
        });
        
    } catch (error) {
        console.error('Firebase init error:', error);
    }
}

async function checkAdminStatus() {
    try {
        if (!currentUser) return false;
        
        const adminDoc = await firebaseDB.collection('admins').doc(currentUser.uid).get();
        
        if (!adminDoc.exists) {
            // Not admin, redirect to home
            alert('Admin access required');
            window.location.href = 'index.html';
            return false;
        }
        
        return true;
    } catch (error) {
        console.error('Admin check error:', error);
        return false;
    }
}

function loadNotifications() {
    if (!currentUser || !firebaseDB) return;
    
    const notificationsGrid = document.getElementById('notificationsGrid');
    notificationsGrid.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading notifications...</p>
        </div>
    `;
    
    // Listen for admin notifications
    firebaseDB.collection('users').doc(currentUser.uid)
        .collection('adminNotifications')
        .orderBy('createdAt', 'desc')
        .onSnapshot((snapshot) => {
            if (snapshot.empty) {
                showEmptyState();
                updateStats(0, 0, 0);
                return;
            }
            
            let total = 0;
            let unread = 0;
            let actionRequired = 0;
            let notificationsHTML = '';
            
            snapshot.forEach(doc => {
                const notification = doc.data();
                total++;
                
                if (!notification.isRead) unread++;
                if (notification.requiresAction) actionRequired++;
                
                notificationsHTML += createNotificationCard(doc.id, notification);
            });
            
            notificationsGrid.innerHTML = notificationsHTML;
            updateStats(total, unread, actionRequired);
        });
}

function createNotificationCard(id, notification) {
    const timeAgo = getTimeAgo(notification.createdAt);
    const unreadClass = notification.isRead ? '' : 'unread';
    
    return `
        <div class="notification-card ${unreadClass}" data-id="${id}">
            <div class="notification-header">
                <div class="notification-title">${notification.title}</div>
                <div class="notification-time">${timeAgo}</div>
            </div>
            <div class="notification-message">${notification.message}</div>
            <div class="notification-message">
                <strong>Order:</strong> ${notification.orderNumber}<br>
                <strong>Customer:</strong> ${notification.userName || 'N/A'}
            </div>
            <div class="notification-actions">
                <button class="action-btn view" onclick="viewOrder('${notification.orderId}')">
                    <i class="fas fa-eye"></i> View Order
                </button>
                ${!notification.isRead ? `
                    <button class="action-btn mark-read" onclick="markAsRead('${id}')">
                        <i class="fas fa-check"></i> Mark Read
                    </button>
                ` : ''}
                <button class="action-btn clear" onclick="clearNotification('${id}')">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </div>
        </div>
    `;
}

function showEmptyState() {
    const notificationsGrid = document.getElementById('notificationsGrid');
    notificationsGrid.innerHTML = `
        <div class="empty-state">
            <i class="far fa-bell-slash"></i>
            <h3>No Notifications</h3>
            <p>You don't have any notifications yet.</p>
        </div>
    `;
}

function updateStats(total, unread, actionRequired) {
    document.getElementById('totalCount').textContent = total;
    document.getElementById('unreadCount').textContent = unread;
    document.getElementById('actionCount').textContent = actionRequired;
}

function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString();
}

async function markAsRead(notificationId) {
    try {
        await firebaseDB.collection('users').doc(currentUser.uid)
            .collection('adminNotifications').doc(notificationId)
            .update({ isRead: true });
    } catch (error) {
        console.error('Error marking as read:', error);
    }
}

async function markAllAsRead() {
    try {
        const snapshot = await firebaseDB.collection('users').doc(currentUser.uid)
            .collection('adminNotifications')
            .where('isRead', '==', false)
            .get();
        
        const batch = firebaseDB.batch();
        
        snapshot.forEach(doc => {
            batch.update(doc.ref, { isRead: true });
        });
        
        await batch.commit();
        
        alert('All notifications marked as read');
    } catch (error) {
        console.error('Error marking all as read:', error);
    }
}

async function clearNotification(notificationId) {
    if (!confirm('Delete this notification?')) return;
    
    try {
        await firebaseDB.collection('users').doc(currentUser.uid)
            .collection('adminNotifications').doc(notificationId)
            .delete();
    } catch (error) {
        console.error('Error clearing notification:', error);
    }
}

function viewOrder(orderId) {
    window.open(`order-details.html?id=${orderId}`, '_blank');
}
</script>
</body>
</html>
